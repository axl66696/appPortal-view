(self.webpackChunkapp_portal=self.webpackChunkapp_portal||[]).push([[4799,3395,4864,9191,3894],{9159:(_t,Ce,q)=>{q.r(Ce),q.d(Ce,{AckPolicy:()=>Yn,DeliverPolicy:()=>Qn,JSONCodec:()=>ze,JetstreamWsService:()=>Wr,RetentionPolicy:()=>Xn,SubscribeType:()=>mr});var d=q(5861),C=q(7582),h=q(5863),T=q(5126),J=q(6296);function se(n,e){this.v=n,this.k=e}function oe(n){return new se(n,0)}function _e(n){var e,t;function r(i,o){try{var c=n[i](o),p=c.value,m=p instanceof se;Promise.resolve(m?p.v:p).then(function(y){if(m){var g="return"===i?"return":"next";if(!p.k||y.done)return r(g,y);y=n[g](y).value}s(c.done?"return":"normal",y)},function(y){r("throw",y)})}catch(y){s("throw",y)}}function s(i,o){switch(i){case"return":e.resolve({value:o,done:!0});break;case"throw":e.reject(o);break;default:e.resolve({value:o,done:!1})}(e=e.next)?r(e.key,e.arg):t=null}this._invoke=function(i,o){return new Promise(function(c,p){var m={key:i,arg:o,resolve:c,reject:p,next:null};t?t=t.next=m:(e=t=m,r(i,o))})},"function"!=typeof n.return&&(this.return=void 0)}function je(n){return function(){return new _e(n.apply(this,arguments))}}_e.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},_e.prototype.next=function(n){return this._invoke("next",n)},_e.prototype.throw=function(n){return this._invoke("throw",n)},_e.prototype.return=function(n){return this._invoke("return",n)};const ge=new Uint8Array(0),we=new TextEncoder,de=new TextDecoder;function Se(...n){const e=[];for(let t=0;t<n.length;t++)e.push(we.encode(n[t]));return 0===e.length?ge:1===e.length?e[0]:function Ve(...n){let e=0;for(let s=0;s<n.length;s++)e+=n[s].length;const t=new Uint8Array(e);let r=0;for(let s=0;s<n.length;s++)t.set(n[s],r),r+=n[s].length;return t}(...e)}function Ze(n){return n&&0!==n.length?de.decode(n):""}const Me="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";const Pe=new class ae{buf;seq;inc;constructor(){this.buf=new Uint8Array(22),this.init()}init(){this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(0xcfd41b9100000*Math.random()),this.inc=Math.floor(300*Math.random()+33)}setPre(){const e=new Uint8Array(12);!function te(n){globalThis?.crypto?.getRandomValues?globalThis.crypto.getRandomValues(n):function H(n){for(let e=0;e<n.length;e++)n[e]=Math.floor(255*Math.random())}(n)}(e);for(let t=0;t<12;t++)this.buf[t]=Me.charCodeAt(e[t]%36)}fillSeq(){let e=this.seq;for(let t=21;t>=12;t--)this.buf[t]=Me.charCodeAt(e%36),e=Math.floor(e/36)}next(){return this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}};var Le=function(n){return n.Disconnect="disconnect",n.Reconnect="reconnect",n.Update="update",n.LDM="ldm",n.Error="error",n}(Le||{}),nt=function(n){return n.Reconnecting="reconnecting",n.PingTimer="pingTimer",n.StaleConnection="staleConnection",n}(nt||{}),A=function(n){return n.ApiError="BAD API",n.BadAuthentication="BAD_AUTHENTICATION",n.BadCreds="BAD_CREDS",n.BadHeader="BAD_HEADER",n.BadJson="BAD_JSON",n.BadPayload="BAD_PAYLOAD",n.BadSubject="BAD_SUBJECT",n.Cancelled="CANCELLED",n.ConnectionClosed="CONNECTION_CLOSED",n.ConnectionDraining="CONNECTION_DRAINING",n.ConnectionRefused="CONNECTION_REFUSED",n.ConnectionTimeout="CONNECTION_TIMEOUT",n.Disconnect="DISCONNECT",n.InvalidOption="INVALID_OPTION",n.InvalidPayload="INVALID_PAYLOAD",n.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",n.NoResponders="503",n.NotFunction="NOT_FUNC",n.RequestError="REQUEST_ERROR",n.ServerOptionNotAvailable="SERVER_OPT_NA",n.SubClosed="SUB_CLOSED",n.SubDraining="SUB_DRAINING",n.Timeout="TIMEOUT",n.Tls="TLS",n.Unknown="UNKNOWN_ERROR",n.WssRequired="WSS_REQUIRED",n.JetStreamInvalidAck="JESTREAM_INVALID_ACK",n.JetStream404NoMessages="404",n.JetStream408RequestTimeout="408",n.JetStream409MaxAckPendingExceeded="409",n.JetStream409="409",n.JetStreamNotEnabled="503",n.JetStreamIdleHeartBeat="IDLE_HEARTBEAT",n.AuthorizationViolation="AUTHORIZATION_VIOLATION",n.AuthenticationExpired="AUTHENTICATION_EXPIRED",n.ProtocolError="NATS_PROTOCOL_ERR",n.PermissionsViolation="PERMISSIONS_VIOLATION",n.AuthenticationTimeout="AUTHENTICATION_TIMEOUT",n}(A||{});class Z{messages;constructor(){this.messages=new Map,this.messages.set(A.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(A.BadJson,"Bad JSON"),this.messages.set(A.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(e){return Q.getMessage(e)}getMessage(e){return this.messages.get(e)||e}}const Q=new Z;class N extends Error{name;message;code;permissionContext;chainedError;api_error;constructor(e,t,r){super(e),this.name="NatsError",this.message=e,this.code=t,this.chainedError=r}static errorForCode(e,t){const r=Z.getMessage(e);return new N(r,e,t)}isAuthError(){return this.code===A.AuthenticationExpired||this.code===A.AuthorizationViolation}isAuthTimeout(){return this.code===A.AuthenticationTimeout}isPermissionError(){return this.code===A.PermissionsViolation}isProtocolError(){return this.code===A.ProtocolError}isJetStreamError(){return void 0!==this.api_error}jsError(){return this.api_error?this.api_error:null}}var ie=function(n){return n[n.Exact=0]="Exact",n[n.CanonicalMIME=1]="CanonicalMIME",n[n.IgnoreCase=2]="IgnoreCase",n}(ie||{}),ke=function(n){return n.Timer="timer",n.Count="count",n.JitterTimer="jitterTimer",n.SentinelMsg="sentinelMsg",n}(ke||{}),gt=function(n){return n.STATS="io.nats.micro.v1.stats_response",n.INFO="io.nats.micro.v1.info_response",n.PING="io.nats.micro.v1.ping_response",n}(gt||{});const x="Nats-Service-Error",w="Nats-Service-Error-Code";class P extends Error{code;constructor(e,t){super(t),this.code=e}static isServiceError(e){return null!==P.toServiceError(e)}static toServiceError(e){const t=e?.headers?.get(w)||"";if(""!==t){const r=parseInt(t)||400,s=e?.headers?.get(x)||"";return new P(r,s.length?s:t)}return null}}function S(n=""){if("string"!=typeof(n=n||"_INBOX"))throw new Error("prefix must be a string");return n.split(".").forEach(e=>{if("*"===e||">"===e)throw new Error(`inbox prefixes cannot have wildcards '${n}'`)}),`${n}.${Pe.next()}`}const $="127.0.0.1";var D=function(n){return n.PING="PING",n.STATS="STATS",n.INFO="INFO",n}(D||{});function I(n,...e){for(let t=0;t<e.length;t++){const r=e[t];Object.keys(r).forEach(function(s){n[s]=r[s]})}return n}function K(n){return de.decode(n).replace(/\n/g,"\u240a").replace(/\r/g,"\u240d")}function F(n){const e=N.errorForCode(A.Timeout);let t,r;const s=new Promise((i,o)=>{t={cancel:()=>{r&&clearTimeout(r)}},r=setTimeout(()=>{o(e)},n)});return Object.assign(s,t)}function U(n=0){return new Promise(e=>{setTimeout(()=>{e()},n)})}function R(){let n={};const e=new Promise((t,r)=>{n={resolve:t,reject:r}});return Object.assign(e,n)}function ee(n){for(let e=n.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[n[e],n[t]]=[n[t],n[e]]}return n}class ye{buffers;byteLength;constructor(){this.buffers=[],this.byteLength=0}static concat(...e){let t=0;for(let i=0;i<e.length;i++)t+=e[i].length;const r=new Uint8Array(t);let s=0;for(let i=0;i<e.length;i++)r.set(e[i],s),s+=e[i].length;return r}static fromAscii(e){return e||(e=""),we.encode(e)}static toAscii(e){return de.decode(e)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){const e=new Uint8Array(this.byteLength);let t=0;for(let r=0;r<this.buffers.length;r++)e.set(this.buffers[r],t),t+=this.buffers[r].length;this.buffers.length=0,this.buffers.push(e)}}shift(){if(this.buffers.length){const e=this.buffers.shift();if(e)return this.byteLength-=e.length,e}return new Uint8Array(0)}drain(e){if(this.buffers.length){this.pack();const t=this.buffers.pop();if(t){const r=this.byteLength;(void 0===e||e>r)&&(e=r);const s=t.subarray(0,e);return r>e&&this.buffers.push(t.subarray(e)),this.byteLength=r-e,s}}return new Uint8Array(0)}fill(e,...t){e&&(this.buffers.push(e),this.byteLength+=e.length);for(let r=0;r<t.length;r++)t[r]&&t[r].length&&(this.buffers.push(t[r]),this.byteLength+=t[r].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}let be;function Ue(){return void 0!==be&&void 0!==be.defaultPort?be.defaultPort:4222}function He(){return void 0!==be&&be.urlParseFn?be.urlParseFn:void 0}function hn(){return void 0!==be&&be.dnsResolveFn?be.dnsResolveFn:void 0}const nr=ye.fromAscii("\r\n"),ps=new Uint8Array(nr)[0],ms=new Uint8Array(nr)[1];const bs=4,fn=48,ys=65,xs=97;function Or(n){return void 0!==function ws(n){for(let e=0;e<n.length;e++)switch(n[e]){case".":return pn(n);case":":return Ss(n)}}(n)}function pn(n){const e=new Uint8Array(4);for(let t=0;t<4;t++){if(0===n.length)return;if(t>0){if("."!==n[0])return;n=n.substring(1)}const{n:r,c:s,ok:i}=Es(n);if(!i||r>255)return;n=n.substring(s),e[t]=r}return function vs(n,e,t,r){const s=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach((o,c)=>{s[c]=o}),s[12]=n,s[13]=e,s[14]=t,s[15]=r,s}(e[0],e[1],e[2],e[3])}function Ss(n){const e=new Uint8Array(16);let t=-1;if(n.length>=2&&":"===n[0]&&":"===n[1]&&(t=0,0===(n=n.substring(2)).length))return e;let r=0;for(;r<16;){const{n:s,c:i,ok:o}=Cs(n);if(!o||s>65535)return;if(i<n.length&&"."===n[i]){if(t<0&&12!=r||r+4>16)return;const c=pn(n);if(void 0===c)return;e[r]=c[12],e[r+1]=c[13],e[r+2]=c[14],e[r+3]=c[15],n="",r+=bs;break}if(e[r]=s>>8,e[r+1]=s,r+=2,0===(n=n.substring(i)).length)break;if(":"!==n[0]||1==n.length)return;if(":"===(n=n.substring(1))[0]){if(t>=0)return;if(t=r,0===(n=n.substring(1)).length)break}}if(0===n.length){if(r<16){if(t<0)return;const s=16-r;for(let i=r-1;i>=t;i--)e[i+s]=e[i];for(let i=t+s-1;i>=t;i--)e[i]=0}else if(t>=0)return;return e}}function Es(n){let e=0,t=0;for(e=0;e<n.length&&48<=n.charCodeAt(e)&&n.charCodeAt(e)<=57;e++)if(t=10*t+(n.charCodeAt(e)-fn),t>=16777215)return{n:16777215,c:e,ok:!1};return 0===e?{n:0,c:0,ok:!1}:{n:t,c:e,ok:!0}}function Cs(n){let e=0,t=0;for(t=0;t<n.length;t++){if(48<=n.charCodeAt(t)&&n.charCodeAt(t)<=57)e*=16,e+=n.charCodeAt(t)-fn;else if(97<=n.charCodeAt(t)&&n.charCodeAt(t)<=102)e*=16,e+=n.charCodeAt(t)-xs+10;else{if(!(65<=n.charCodeAt(t)&&n.charCodeAt(t)<=70))break;e*=16,e+=n.charCodeAt(t)-ys+10}if(e>=16777215)return{n:0,c:t,ok:!1}}return 0===t?{n:0,c:t,ok:!1}:{n:e,c:t,ok:!0}}function Ar(n){return!function Ps(n){return-1!==n.indexOf(".")||-1===n.indexOf("[")&&-1===n.indexOf("::")&&n.split(":").length<=2}(n)}class Ut{src;listen;hostname;port;didConnect;reconnects;lastConnect;gossiped;tlsName;resolves;constructor(e,t=!1){this.src=e,this.tlsName="";const r=function As(n){(n=n.trim()).match(/^(.*:\/\/)(.*)/m)&&(n=n.replace(/^(.*:\/\/)(.*)/gm,"$2")),n=function Os(n){const t=n.toUpperCase().indexOf("::FFFF:");if(-1!==t&&-1!==n.indexOf(".")){let r=n.substring(t+7);return r=r.replace("[",""),r.replace("]","")}return n}(n),Ar(n)&&-1===n.indexOf("[")&&(n=`[${n}]`);const e=Ar(n)?n.match(/(]:)(\d+)/):n.match(/(:)(\d+)/),t=e&&3===e.length&&e[1]&&e[2]?parseInt(e[2]):4222,s=new URL(`${80===t?"https":"http"}://${n}`);s.port=`${t}`;let i=s.hostname;return"["===i.charAt(0)&&(i=i.substring(1,i.length-1)),{listen:s.host,hostname:i,port:t}}(e);this.listen=r.listen,this.hostname=r.hostname,this.port=r.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=t}toString(){return this.listen}resolve(e){var t=this;return(0,d.Z)(function*(){if(!e.fn)return[t];const r=[];if(Or(t.hostname))return[t];{const s=yield e.fn(t.hostname);e.debug&&console.log(`resolve ${t.hostname} = ${s.join(",")}`);for(const i of s){const c=new URL(`${80===t.port?"https":"http"}://${Ar(i)?"["+i+"]":i}`);c.port=`${t.port}`;const p=new Ut(c.host,!1);p.tlsName=t.hostname,r.push(p)}}return e.randomize&&ee(r),t.resolves=r,r})()}}class Ms{firstSelect;servers;currentServer;tlsName;randomize;constructor(e=[],t={}){this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=t.randomize||!1;const r=He();e&&(e.forEach(s=>{s=r?r(s):s,this.servers.push(new Ut(s))}),this.randomize&&(this.servers=ee(this.servers))),0===this.servers.length&&this.addServer(`${$}:${Ue()}`,!1),this.currentServer=this.servers[0]}clear(){this.servers.length=0}updateTLSName(){const e=this.getCurrentServer();Or(e.hostname)||(this.tlsName=e.hostname,this.servers.forEach(t=>{t.gossiped&&(t.tlsName=this.tlsName)}))}getCurrentServer(){return this.currentServer}addServer(e,t=!1){const r=He();e=r?r(e):e;const s=new Ut(e,t);Or(s.hostname)&&(s.tlsName=this.tlsName),this.servers.push(s)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;const e=this.servers.shift();return e&&(this.servers.push(e),this.currentServer=e),e}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(e){if(e){const t=this.servers.indexOf(e);this.servers.splice(t,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(e){const t=[];let r=[];const s=He(),i=new Map;e.connect_urls&&e.connect_urls.length>0&&e.connect_urls.forEach(c=>{c=s?s(c):c;const p=new Ut(c,!0);i.set(c,p)});const o=[];return this.servers.forEach((c,p)=>{const m=c.listen;c.gossiped&&this.currentServer.listen!==m&&void 0===i.get(m)&&o.push(p),i.delete(m)}),o.reverse(),o.forEach(c=>{const p=this.servers.splice(c,1);r=r.concat(p[0].listen)}),i.forEach((c,p)=>{this.servers.push(c),t.push(p)}),{added:t,deleted:r}}}class Te{inflight;processed;received;noIterator;iterClosed;done;signal;yields;filtered;pendingFiltered;ingestionFilterFn;protocolFilterFn;dispatchedFn;ctx;_data;err;time;constructor(){this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=R(),this.yields=[],this.iterClosed=R(),this.time=0}[Symbol.asyncIterator](){return this.iterate()}push(e){if(this.done)return;if("function"==typeof e)return this.yields.push(e),void this.signal.resolve();const{ingest:t,protocol:r}=this.ingestionFilterFn?this.ingestionFilterFn(e,this.ctx||this):{ingest:!0,protocol:!1};t&&(r&&(this.filtered++,this.pendingFiltered++),this.yields.push(e),this.signal.resolve())}iterate(){var e=this;return je(function*(){if(e.noIterator)throw new N("unsupported iterator",A.ApiError);try{for(;;){if(0===e.yields.length&&(yield oe(e.signal)),e.err)throw e.err;const t=e.yields;e.inflight=t.length,e.yields=[];for(let r=0;r<t.length;r++)if("function"!=typeof t[r]){if(!e.protocolFilterFn||e.protocolFilterFn(t[r])){e.processed++;const i=Date.now();yield t[r],e.time=Date.now()-i,e.dispatchedFn&&t[r]&&e.dispatchedFn(t[r])}else e.pendingFiltered--;e.inflight--}else{const i=t[r];try{i()}catch(o){throw o}if(e.err)throw e.err}if(e.done)break;0===e.yields.length&&(t.length=0,e.yields=t,e.signal=R())}}finally{e.stop()}})()}stop(e){this.done||(this.err=e,this.done=!0,this.signal.resolve(),this.iterClosed.resolve())}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}function mn(n){let r=!0;const s=new Array(n.length);for(let i=0;i<n.length;i++){let o=n.charCodeAt(i);if(58===o||o<33||o>126)throw new N(`'${n[i]}' is not a valid character for a header key`,A.BadHeader);r&&97<=o&&o<=122?o-=32:!r&&65<=o&&o<=90&&(o+=32),s[i]=o,r=45==o}return String.fromCharCode(...s)}function ot(n=0,e=""){if(0===n&&""!==e||n>0&&""===e)throw new Error("setting status requires both code and description");return new dt(n,e)}const Mr="NATS/1.0";class dt{_code;headers;_description;constructor(e=0,t=""){this._code=e,this._description=t,this.headers=new Map}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(e){if(e&&this.headers.size===e.headers.size&&this._code===e._code){for(const[t,r]of this.headers){const s=e.values(t);if(r.length!==s.length)return!1;const i=[...r].sort(),o=[...s].sort();for(let c=0;c<i.length;c++)if(i[c]!==o[c])return!1}return!0}return!1}static decode(e){const t=new dt,s=de.decode(e).split("\r\n"),i=s[0];if(i!==Mr){let o=i.replace(Mr,"").trim();if(o.length>0){t._code=parseInt(o,10),isNaN(t._code)&&(t._code=0);const c=t._code.toString();o=o.replace(c,""),t._description=o.trim()}}return s.length>=1&&s.slice(1).map(o=>{if(o){const c=o.indexOf(":");if(c>-1){const p=o.slice(0,c),m=o.slice(c+1).trim();t.append(p,m)}}}),t}toString(){if(0===this.headers.size&&0===this._code)return"";let e=Mr;this._code>0&&""!==this._description&&(e+=` ${this._code} ${this._description}`);for(const[t,r]of this.headers)for(let s=0;s<r.length;s++)e=`${e}\r\n${t}: ${r[s]}`;return`${e}\r\n\r\n`}encode(){return we.encode(this.toString())}static validHeaderValue(e){if(/[\r\n]/.test(e))throw new N("invalid header value - \\r and \\n are not allowed.",A.BadHeader);return e.trim()}keys(){const e=[];for(const t of this.headers.keys())e.push(t);return e}findKeys(e,t=ie.Exact){const r=this.keys();switch(t){case ie.Exact:return r.filter(s=>s===e);case ie.CanonicalMIME:return e=mn(e),r.filter(s=>s===e);default:{const s=e.toLowerCase();return r.filter(i=>s===i.toLowerCase())}}}get(e,t=ie.Exact){const r=this.findKeys(e,t);if(r.length){const s=this.headers.get(r[0]);if(s)return Array.isArray(s)?s[0]:s}return""}has(e,t=ie.Exact){return this.findKeys(e,t).length>0}set(e,t,r=ie.Exact){this.delete(e,r),this.append(e,t,r)}append(e,t,r=ie.Exact){const s=mn(e);r===ie.CanonicalMIME&&(e=s);const i=this.findKeys(e,r);e=i.length>0?i[0]:e;const o=dt.validHeaderValue(t);let c=this.headers.get(e);c||(c=[],this.headers.set(e,c)),c.push(o)}values(e,t=ie.Exact){const r=[];return this.findKeys(e,t).forEach(i=>{const o=this.headers.get(i);o&&r.push(...o)}),r}delete(e,t=ie.Exact){this.findKeys(e,t).forEach(s=>{this.headers.delete(s)})}get hasError(){return this._code>=300}get status(){return`${this._code} ${this._description}`.trim()}toRecord(){const e={};return this.keys().forEach(t=>{e[t]=this.values(t)}),e}get code(){return this._code}get description(){return this._description}static fromRecord(e){const t=new dt;for(const r in e)t.headers.set(r,e[r]);return t}}function ze(n){return{encode(e){try{return void 0===e&&(e=null),we.encode(JSON.stringify(e))}catch(t){throw N.errorForCode(A.BadJson,t)}},decode(e){try{return JSON.parse(de.decode(e),n)}catch(t){throw N.errorForCode(A.BadJson,t)}}}}function _n(n){return n&&0===n.data.length&&503===n.headers?.code?N.errorForCode(A.NoResponders):null}let gn=(()=>class n{_headers;_msg;_rdata;_reply;_subject;publisher;static jc;constructor(t,r,s){this._msg=t,this._rdata=r,this.publisher=s}get subject(){return this._subject||(this._subject=de.decode(this._msg.subject)),this._subject}get reply(){return this._reply||(this._reply=de.decode(this._msg.reply)),this._reply}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){const t=this._rdata.subarray(0,this._msg.hdr);this._headers=dt.decode(t)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(t=ge,r){return!!this.reply&&(this.publisher.publish(this.reply,t,r),!0)}size(){return this._msg.subject.length+(this._msg.reply?.length||0)+(-1===this._msg.size?0:this._msg.size)}json(t){return ze(t).decode(this.data)}string(){return de.decode(this.data)}})();class Is{baseInbox;reqs;constructor(){this.reqs=new Map}size(){return this.reqs.size}init(e){return this.baseInbox=`${S(e)}.`,this.baseInbox}add(e){isNaN(e.received)||(e.received=0),this.reqs.set(e.token,e)}get(e){return this.reqs.get(e)}cancel(e){this.reqs.delete(e.token)}getToken(e){const t=e.subject||"";return 0===t.indexOf(this.baseInbox)?t.substring(this.baseInbox.length):null}all(){return Array.from(this.reqs.values())}handleError(e,t){if(t&&t.permissionContext){if(e)return this.all().forEach(s=>{s.resolver(t,{})}),!0;const r=t.permissionContext;if("publish"===r.operation){const s=this.all().find(i=>i.requestSubject===r.subject);if(s)return s.resolver(t,{}),!0}}return!1}dispatcher(){return(e,t)=>{const r=this.getToken(t);if(r){const s=this.get(r);s&&(null===e&&t.headers&&(e=_n(t)),s.resolver(e,t))}}}close(){const e=N.errorForCode(A.Timeout);this.reqs.forEach(t=>{t.resolver(e,{})})}}class js{ph;interval;maxOut;timer;pendings;constructor(e,t,r){this.ph=e,this.interval=t,this.maxOut=r,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(e){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),e&&this.ph.disconnect()}_schedule(){this.timer=setTimeout(()=>{if(this.ph.dispatchStatus({type:nt.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut)return void this.cancel(!0);const e=R();this.ph.flush(e).then(()=>{this._reset()}).catch(()=>{this.cancel()}),this.pendings.push(e),this._schedule()},this.interval)}_reset(){this.pendings=this.pendings.filter(e=>(e.resolve(),!1))}}class Ts extends Error{constructor(e){super(e),this.name="AssertionError"}}const kr=2**32-2;function sr(n,e,t=0){const r=e.byteLength-t;return n.byteLength>r&&(n=n.subarray(0,r)),e.set(n,t),n.byteLength}class Ir{_buf;_off;constructor(e){this._off=0,this._buf=null!=e?new Uint8Array(e):new Uint8Array(0)}bytes(e={copy:!0}){return!1===e.copy?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(e){if(0!==e){if(e<0||e>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+e)}else this.reset()}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(e){const t=this._buf.byteLength;return e<=this.capacity-t?(this._reslice(t+e),t):-1}_reslice(e){(function Ns(n,e="Assertion failed."){if(!n)throw new Ts(e)})(e<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,e)}readByte(){const e=new Uint8Array(1);return this.read(e)?e[0]:null}read(e){if(this.empty())return this.reset(),0===e.byteLength?0:null;const t=sr(this._buf.subarray(this._off),e);return this._off+=t,t}writeByte(e){return this.write(Uint8Array.of(e))}writeString(e){return this.write(we.encode(e))}write(e){const t=this._grow(e.byteLength);return sr(e,this._buf,t)}_grow(e){const t=this.length;0===t&&0!==this._off&&this.reset();const r=this._tryGrowByReslice(e);if(r>=0)return r;const s=this.capacity;if(e<=Math.floor(s/2)-t)sr(this._buf.subarray(this._off),this._buf);else{if(s+e>kr)throw new Error("The buffer cannot be grown beyond the maximum size.");{const i=new Uint8Array(Math.min(2*s+e,kr));sr(this._buf.subarray(this._off),i),this._buf=i}}return this._off=0,this._reslice(Math.min(t+e,kr)),t}grow(e){if(e<0)throw Error("Buffer._grow: negative count");const t=this._grow(e);this._reslice(t)}readFrom(e){let t=0;const r=new Uint8Array(32768);for(;;){const s=this.capacity-this.length<32768,i=s?r:new Uint8Array(this._buf.buffer,this.length),o=e.read(i);if(null===o)return t;s?this.write(i.subarray(0,o)):this._reslice(this.length+o),t+=o}}}var Be=function(n){return n[n.OK=0]="OK",n[n.ERR=1]="ERR",n[n.MSG=2]="MSG",n[n.INFO=3]="INFO",n[n.PING=4]="PING",n[n.PONG=5]="PONG",n}(Be||{});class xn{dispatcher;state;as;drop;hdr;ma;argBuf;msgBuf;constructor(e){this.dispatcher=e,this.state=z.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(e){let t;for(t=0;t<e.length;t++){const r=e[t];switch(this.state){case z.OP_START:switch(r){case G.M:case G.m:this.state=z.OP_M,this.hdr=-1,this.ma={sid:-1,hdr:-1,size:-1};break;case G.H:case G.h:this.state=z.OP_H,this.hdr=0,this.ma={sid:-1,hdr:-1,size:-1};break;case G.P:case G.p:this.state=z.OP_P;break;case G.PLUS:this.state=z.OP_PLUS;break;case G.MINUS:this.state=z.OP_MINUS;break;case G.I:case G.i:this.state=z.OP_I;break;default:throw this.fail(e.subarray(t))}break;case z.OP_H:switch(r){case G.M:case G.m:this.state=z.OP_M;break;default:throw this.fail(e.subarray(t))}break;case z.OP_M:switch(r){case G.S:case G.s:this.state=z.OP_MS;break;default:throw this.fail(e.subarray(t))}break;case z.OP_MS:switch(r){case G.G:case G.g:this.state=z.OP_MSG;break;default:throw this.fail(e.subarray(t))}break;case z.OP_MSG:switch(r){case G.SPACE:case G.TAB:this.state=z.OP_MSG_SPC;break;default:throw this.fail(e.subarray(t))}break;case z.OP_MSG_SPC:switch(r){case G.SPACE:case G.TAB:continue;default:this.state=z.MSG_ARG,this.as=t}break;case z.MSG_ARG:switch(r){case G.CR:this.drop=1;break;case G.NL:{const s=this.argBuf?this.argBuf.bytes():e.subarray(this.as,t-this.drop);this.processMsgArgs(s),this.drop=0,this.as=t+1,this.state=z.MSG_PAYLOAD,t=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(r)}break;case z.MSG_PAYLOAD:if(this.msgBuf)if(this.msgBuf.length>=this.ma.size){const s=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:Be.MSG,msg:this.ma,data:s}),this.argBuf=void 0,this.msgBuf=void 0,this.state=z.MSG_END}else{let s=this.ma.size-this.msgBuf.length;const i=e.length-t;i<s&&(s=i),s>0?(this.msgBuf.write(e.subarray(t,t+s)),t=t+s-1):this.msgBuf.writeByte(r)}else t-this.as>=this.ma.size&&(this.dispatcher.push({kind:Be.MSG,msg:this.ma,data:e.subarray(this.as,t)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=z.MSG_END);break;case z.MSG_END:if(r!==G.NL)continue;this.drop=0,this.as=t+1,this.state=z.OP_START;break;case z.OP_PLUS:switch(r){case G.O:case G.o:this.state=z.OP_PLUS_O;break;default:throw this.fail(e.subarray(t))}break;case z.OP_PLUS_O:switch(r){case G.K:case G.k:this.state=z.OP_PLUS_OK;break;default:throw this.fail(e.subarray(t))}break;case z.OP_PLUS_OK:r===G.NL&&(this.dispatcher.push({kind:Be.OK}),this.drop=0,this.state=z.OP_START);break;case z.OP_MINUS:switch(r){case G.E:case G.e:this.state=z.OP_MINUS_E;break;default:throw this.fail(e.subarray(t))}break;case z.OP_MINUS_E:switch(r){case G.R:case G.r:this.state=z.OP_MINUS_ER;break;default:throw this.fail(e.subarray(t))}break;case z.OP_MINUS_ER:switch(r){case G.R:case G.r:this.state=z.OP_MINUS_ERR;break;default:throw this.fail(e.subarray(t))}break;case z.OP_MINUS_ERR:switch(r){case G.SPACE:case G.TAB:this.state=z.OP_MINUS_ERR_SPC;break;default:throw this.fail(e.subarray(t))}break;case z.OP_MINUS_ERR_SPC:switch(r){case G.SPACE:case G.TAB:continue;default:this.state=z.MINUS_ERR_ARG,this.as=t}break;case z.MINUS_ERR_ARG:switch(r){case G.CR:this.drop=1;break;case G.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:Be.ERR,data:s}),this.drop=0,this.as=t+1,this.state=z.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(r))}break;case z.OP_P:switch(r){case G.I:case G.i:this.state=z.OP_PI;break;case G.O:case G.o:this.state=z.OP_PO;break;default:throw this.fail(e.subarray(t))}break;case z.OP_PO:switch(r){case G.N:case G.n:this.state=z.OP_PON;break;default:throw this.fail(e.subarray(t))}break;case z.OP_PON:switch(r){case G.G:case G.g:this.state=z.OP_PONG;break;default:throw this.fail(e.subarray(t))}break;case z.OP_PONG:r===G.NL&&(this.dispatcher.push({kind:Be.PONG}),this.drop=0,this.state=z.OP_START);break;case z.OP_PI:switch(r){case G.N:case G.n:this.state=z.OP_PIN;break;default:throw this.fail(e.subarray(t))}break;case z.OP_PIN:switch(r){case G.G:case G.g:this.state=z.OP_PING;break;default:throw this.fail(e.subarray(t))}break;case z.OP_PING:r===G.NL&&(this.dispatcher.push({kind:Be.PING}),this.drop=0,this.state=z.OP_START);break;case z.OP_I:switch(r){case G.N:case G.n:this.state=z.OP_IN;break;default:throw this.fail(e.subarray(t))}break;case z.OP_IN:switch(r){case G.F:case G.f:this.state=z.OP_INF;break;default:throw this.fail(e.subarray(t))}break;case z.OP_INF:switch(r){case G.O:case G.o:this.state=z.OP_INFO;break;default:throw this.fail(e.subarray(t))}break;case z.OP_INFO:switch(r){case G.SPACE:case G.TAB:this.state=z.OP_INFO_SPC;break;default:throw this.fail(e.subarray(t))}break;case z.OP_INFO_SPC:switch(r){case G.SPACE:case G.TAB:continue;default:this.state=z.INFO_ARG,this.as=t}break;case z.INFO_ARG:switch(r){case G.CR:this.drop=1;break;case G.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:Be.INFO,data:s}),this.drop=0,this.as=t+1,this.state=z.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(r)}break;default:throw this.fail(e.subarray(t))}}(this.state===z.MSG_ARG||this.state===z.MINUS_ERR_ARG||this.state===z.INFO_ARG)&&!this.argBuf&&(this.argBuf=new Ir(e.subarray(this.as,t-this.drop))),this.state===z.MSG_PAYLOAD&&!this.msgBuf&&(this.argBuf||this.cloneMsgArg(),this.msgBuf=new Ir(e.subarray(this.as)))}cloneMsgArg(){const e=this.ma.subject.length,r=new Uint8Array(e+(this.ma.reply?this.ma.reply.length:0));r.set(this.ma.subject),this.ma.reply&&r.set(this.ma.reply,e),this.argBuf=new Ir(r),this.ma.subject=r.subarray(0,e),this.ma.reply&&(this.ma.reply=r.subarray(e))}processMsgArgs(e){if(this.hdr>=0)return this.processHeaderMsgArgs(e);const t=[];let r=-1;for(let s=0;s<e.length;s++)switch(e[s]){case G.SPACE:case G.TAB:case G.CR:case G.NL:r>=0&&(t.push(e.subarray(r,s)),r=-1);break;default:r<0&&(r=s)}switch(r>=0&&t.push(e.subarray(r)),t.length){case 3:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(t[2]);break;case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.size=this.protoParseInt(t[3]);break;default:throw this.fail(e,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(e,"processMsgArgs Bad or Missing Size Error")}fail(e,t=""){return t=t?`${t} [${this.state}]`:`parse error [${this.state}]`,new Error(`${t}: ${de.decode(e)}`)}processHeaderMsgArgs(e){const t=[];let r=-1;for(let s=0;s<e.length;s++)switch(e[s]){case G.SPACE:case G.TAB:case G.CR:case G.NL:r>=0&&(t.push(e.subarray(r,s)),r=-1);break;default:r<0&&(r=s)}switch(r>=0&&t.push(e.subarray(r)),t.length){case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(t[2]),this.ma.size=this.protoParseInt(t[3]);break;case 5:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.hdr=this.protoParseInt(t[3]),this.ma.size=this.protoParseInt(t[4]);break;default:throw this.fail(e,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(e){if(0===e.length)return-1;let t=0;for(let r=0;r<e.length;r++){if(e[r]<48||e[r]>57)return-1;t=10*t+(e[r]-48)}return t}}var z=function(n){return n[n.OP_START=0]="OP_START",n[n.OP_PLUS=1]="OP_PLUS",n[n.OP_PLUS_O=2]="OP_PLUS_O",n[n.OP_PLUS_OK=3]="OP_PLUS_OK",n[n.OP_MINUS=4]="OP_MINUS",n[n.OP_MINUS_E=5]="OP_MINUS_E",n[n.OP_MINUS_ER=6]="OP_MINUS_ER",n[n.OP_MINUS_ERR=7]="OP_MINUS_ERR",n[n.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",n[n.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",n[n.OP_M=10]="OP_M",n[n.OP_MS=11]="OP_MS",n[n.OP_MSG=12]="OP_MSG",n[n.OP_MSG_SPC=13]="OP_MSG_SPC",n[n.MSG_ARG=14]="MSG_ARG",n[n.MSG_PAYLOAD=15]="MSG_PAYLOAD",n[n.MSG_END=16]="MSG_END",n[n.OP_H=17]="OP_H",n[n.OP_P=18]="OP_P",n[n.OP_PI=19]="OP_PI",n[n.OP_PIN=20]="OP_PIN",n[n.OP_PING=21]="OP_PING",n[n.OP_PO=22]="OP_PO",n[n.OP_PON=23]="OP_PON",n[n.OP_PONG=24]="OP_PONG",n[n.OP_I=25]="OP_I",n[n.OP_IN=26]="OP_IN",n[n.OP_INF=27]="OP_INF",n[n.OP_INFO=28]="OP_INFO",n[n.OP_INFO_SPC=29]="OP_INFO_SPC",n[n.INFO_ARG=30]="INFO_ARG",n}(z||{}),G=function(n){return n[n.CR="\r".charCodeAt(0)]="CR",n[n.E="E".charCodeAt(0)]="E",n[n.e="e".charCodeAt(0)]="e",n[n.F="F".charCodeAt(0)]="F",n[n.f="f".charCodeAt(0)]="f",n[n.G="G".charCodeAt(0)]="G",n[n.g="g".charCodeAt(0)]="g",n[n.H="H".charCodeAt(0)]="H",n[n.h="h".charCodeAt(0)]="h",n[n.I="I".charCodeAt(0)]="I",n[n.i="i".charCodeAt(0)]="i",n[n.K="K".charCodeAt(0)]="K",n[n.k="k".charCodeAt(0)]="k",n[n.M="M".charCodeAt(0)]="M",n[n.m="m".charCodeAt(0)]="m",n[n.MINUS="-".charCodeAt(0)]="MINUS",n[n.N="N".charCodeAt(0)]="N",n[n.n="n".charCodeAt(0)]="n",n[n.NL="\n".charCodeAt(0)]="NL",n[n.O="O".charCodeAt(0)]="O",n[n.o="o".charCodeAt(0)]="o",n[n.P="P".charCodeAt(0)]="P",n[n.p="p".charCodeAt(0)]="p",n[n.PLUS="+".charCodeAt(0)]="PLUS",n[n.R="R".charCodeAt(0)]="R",n[n.r="r".charCodeAt(0)]="r",n[n.S="S".charCodeAt(0)]="S",n[n.s="s".charCodeAt(0)]="s",n[n.SPACE=" ".charCodeAt(0)]="SPACE",n[n.TAB="\t".charCodeAt(0)]="TAB",n}(G||{});function bt(n=""){const e=n.match(/(\d+).(\d+).(\d+)/);if(e)return{major:parseInt(e[1]),minor:parseInt(e[2]),micro:parseInt(e[3])};throw new Error(`'${n}' is not a semver value`)}function jr(n,e){return n.major<e.major?-1:n.major>e.major?1:n.minor<e.minor?-1:n.minor>e.minor?1:n.micro<e.micro?-1:n.micro>e.micro?1:0}var le=function(n){return n.JS_KV="js_kv",n.JS_OBJECTSTORE="js_objectstore",n.JS_PULL_MAX_BYTES="js_pull_max_bytes",n.JS_NEW_CONSUMER_CREATE_API="js_new_consumer_create",n.JS_ALLOW_DIRECT="js_allow_direct",n.JS_MULTIPLE_CONSUMER_FILTER="js_multiple_consumer_filter",n.JS_SIMPLIFICATION="js_simplification",n.JS_STREAM_CONSUMER_METADATA="js_stream_consumer_metadata",n.JS_CONSUMER_FILTER_SUBJECTS="js_consumer_filter_subjects",n.JS_STREAM_FIRST_SEQ="js_stream_first_seq",n.JS_STREAM_SUBJECT_TRANSFORM="js_stream_subject_transform",n.JS_STREAM_SOURCE_SUBJECT_TRANSFORM="js_stream_source_subject_transform",n.JS_STREAM_COMPRESSION="js_stream_compression",n.JS_DEFAULT_CONSUMER_LIMITS="js_default_consumer_limits",n}(le||{});class Ls{server;features;disabled;constructor(e){this.features=new Map,this.disabled=[],this.update(e)}resetDisabled(){this.disabled.length=0,this.update(this.server)}disable(e){this.disabled.push(e),this.update(this.server)}isDisabled(e){return-1!==this.disabled.indexOf(e)}update(e){"string"==typeof e&&(e=bt(e)),this.server=e,this.set(le.JS_KV,"2.6.2"),this.set(le.JS_OBJECTSTORE,"2.6.3"),this.set(le.JS_PULL_MAX_BYTES,"2.8.3"),this.set(le.JS_NEW_CONSUMER_CREATE_API,"2.9.0"),this.set(le.JS_ALLOW_DIRECT,"2.9.0"),this.set(le.JS_MULTIPLE_CONSUMER_FILTER,"2.10.0"),this.set(le.JS_SIMPLIFICATION,"2.9.4"),this.set(le.JS_STREAM_CONSUMER_METADATA,"2.10.0"),this.set(le.JS_CONSUMER_FILTER_SUBJECTS,"2.10.0"),this.set(le.JS_STREAM_FIRST_SEQ,"2.10.0"),this.set(le.JS_STREAM_SUBJECT_TRANSFORM,"2.10.0"),this.set(le.JS_STREAM_SOURCE_SUBJECT_TRANSFORM,"2.10.0"),this.set(le.JS_STREAM_COMPRESSION,"2.10.0"),this.set(le.JS_DEFAULT_CONSUMER_LIMITS,"2.10.0"),this.disabled.forEach(t=>{this.features.delete(t)})}set(e,t){this.features.set(e,{min:t,ok:jr(this.server,bt(t))>=0})}get(e){return this.features.get(e)||{min:"unknown",ok:!1}}supports(e){return this.get(e)?.ok||!1}require(e){return"string"==typeof e&&(e=bt(e)),jr(this.server,e)>=0}}!function(n){"use strict";var e=function(a,u){this.hi=0|a,this.lo=0|u},t=function(a){var u,l=new Float64Array(16);if(a)for(u=0;u<a.length;u++)l[u]=a[u];return l},r=function(){throw new Error("no PRNG")},s=new Uint8Array(16),i=new Uint8Array(32);i[0]=9;var o=t(),c=t([1]),p=t([56129,1]),m=t([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),y=t([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),g=t([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),E=t([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),O=t([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function j(a,u){return a<<u|a>>>32-u}function B(a,u){var l=255&a[u+3];return(l=(l=l<<8|255&a[u+2])<<8|255&a[u+1])<<8|255&a[u+0]}function ue(a,u){return new e(a[u]<<24|a[u+1]<<16|a[u+2]<<8|a[u+3],a[u+4]<<24|a[u+5]<<16|a[u+6]<<8|a[u+7])}function X(a,u,l){var f;for(f=0;f<4;f++)a[u+f]=255&l,l>>>=8}function Oe(a,u,l){a[u]=l.hi>>24&255,a[u+1]=l.hi>>16&255,a[u+2]=l.hi>>8&255,a[u+3]=255&l.hi,a[u+4]=l.lo>>24&255,a[u+5]=l.lo>>16&255,a[u+6]=l.lo>>8&255,a[u+7]=255&l.lo}function Ae(a,u,l,f,_){var b,k=0;for(b=0;b<_;b++)k|=a[u+b]^l[f+b];return(1&k-1>>>8)-1}function Ye(a,u,l,f){return Ae(a,u,l,f,16)}function pt(a,u,l,f){return Ae(a,u,l,f,32)}function At(a,u,l,f,_){var M,V,ne,b=new Uint32Array(16),k=new Uint32Array(16),L=new Uint32Array(16),v=new Uint32Array(4);for(M=0;M<4;M++)k[5*M]=B(f,4*M),k[1+M]=B(l,4*M),k[6+M]=B(u,4*M),k[11+M]=B(l,16+4*M);for(M=0;M<16;M++)L[M]=k[M];for(M=0;M<20;M++){for(V=0;V<4;V++){for(ne=0;ne<4;ne++)v[ne]=k[(5*V+4*ne)%16];for(v[1]^=j(v[0]+v[3]|0,7),v[2]^=j(v[1]+v[0]|0,9),v[3]^=j(v[2]+v[1]|0,13),v[0]^=j(v[3]+v[2]|0,18),ne=0;ne<4;ne++)b[4*V+(V+ne)%4]=v[ne]}for(ne=0;ne<16;ne++)k[ne]=b[ne]}if(_){for(M=0;M<16;M++)k[M]=k[M]+L[M]|0;for(M=0;M<4;M++)k[5*M]=k[5*M]-B(f,4*M)|0,k[6+M]=k[6+M]-B(u,4*M)|0;for(M=0;M<4;M++)X(a,4*M,k[5*M]),X(a,16+4*M,k[6+M])}else for(M=0;M<16;M++)X(a,4*M,k[M]+L[M]|0)}function _r(a,u,l,f){return At(a,u,l,f,!1),0}function yt(a,u,l,f){return At(a,u,l,f,!0),0}var Xe=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function Mt(a,u,l,f,_,b,k){var M,V,L=new Uint8Array(16),v=new Uint8Array(64);if(!_)return 0;for(V=0;V<16;V++)L[V]=0;for(V=0;V<8;V++)L[V]=b[V];for(;_>=64;){for(_r(v,L,k,Xe),V=0;V<64;V++)a[u+V]=(l?l[f+V]:0)^v[V];for(M=1,V=8;V<16;V++)L[V]=255&(M=M+(255&L[V])|0),M>>>=8;_-=64,u+=64,l&&(f+=64)}if(_>0)for(_r(v,L,k,Xe),V=0;V<_;V++)a[u+V]=(l?l[f+V]:0)^v[V];return 0}function gr(a,u,l,f,_){return Mt(a,u,null,0,l,f,_)}function kt(a,u,l,f,_){var b=new Uint8Array(32);return yt(b,f,_,Xe),gr(a,u,l,f.subarray(16),b)}function Wt(a,u,l,f,_,b,k){var L=new Uint8Array(32);return yt(L,b,k,Xe),Mt(a,u,l,f,_,b.subarray(16),L)}function mt(a,u){var l,f=0;for(l=0;l<17;l++)a[l]=255&(f=f+(a[l]+u[l]|0)|0),f>>>=8}var Eo=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function Yr(a,u,l,f,_,b){var k,L,v,M,V=new Uint32Array(17),ne=new Uint32Array(17),ve=new Uint32Array(17),tt=new Uint32Array(17),Rt=new Uint32Array(17);for(v=0;v<17;v++)ne[v]=ve[v]=0;for(v=0;v<16;v++)ne[v]=b[v];for(ne[3]&=15,ne[4]&=252,ne[7]&=15,ne[8]&=252,ne[11]&=15,ne[12]&=252,ne[15]&=15;_>0;){for(v=0;v<17;v++)tt[v]=0;for(v=0;v<16&&v<_;++v)tt[v]=l[f+v];for(tt[v]=1,f+=v,_-=v,mt(ve,tt),L=0;L<17;L++)for(V[L]=0,v=0;v<17;v++)V[L]=0|V[L]+ve[v]*(v<=L?ne[L-v]:320*ne[L+17-v]|0);for(L=0;L<17;L++)ve[L]=V[L];for(M=0,v=0;v<16;v++)ve[v]=255&(M=M+ve[v]|0),M>>>=8;for(ve[16]=3&(M=M+ve[16]|0),M=5*(M>>>2)|0,v=0;v<16;v++)ve[v]=255&(M=M+ve[v]|0),M>>>=8;ve[16]=M=M+ve[16]|0}for(v=0;v<17;v++)Rt[v]=ve[v];for(mt(ve,Eo),k=0|-(ve[16]>>>7),v=0;v<17;v++)ve[v]^=k&(Rt[v]^ve[v]);for(v=0;v<16;v++)tt[v]=b[v+16];for(tt[16]=0,mt(ve,tt),v=0;v<16;v++)a[u+v]=ve[v];return 0}function es(a,u,l,f,_,b){var k=new Uint8Array(16);return Yr(k,0,l,f,_,b),Ye(a,u,k,0)}function Xr(a,u,l,f,_){var b;if(l<32)return-1;for(Wt(a,0,u,0,l,f,_),Yr(a,16,a,32,l-32,a),b=0;b<16;b++)a[b]=0;return 0}function Qr(a,u,l,f,_){var b,k=new Uint8Array(32);if(l<32||(kt(k,0,32,f,_),0!==es(u,16,u,32,l-32,k)))return-1;for(Wt(a,0,u,0,l,f,_),b=0;b<32;b++)a[b]=0;return 0}function lt(a,u){var l;for(l=0;l<16;l++)a[l]=0|u[l]}function Yt(a){var u,l;for(l=0;l<16;l++)a[l]+=65536,u=Math.floor(a[l]/65536),a[(l+1)*(l<15?1:0)]+=u-1+37*(u-1)*(15===l?1:0),a[l]-=65536*u}function It(a,u,l){for(var f,_=~(l-1),b=0;b<16;b++)a[b]^=f=_&(a[b]^u[b]),u[b]^=f}function jt(a,u){var l,f,_,b=t(),k=t();for(l=0;l<16;l++)k[l]=u[l];for(Yt(k),Yt(k),Yt(k),f=0;f<2;f++){for(b[0]=k[0]-65517,l=1;l<15;l++)b[l]=k[l]-65535-(b[l-1]>>16&1),b[l-1]&=65535;b[15]=k[15]-32767-(b[14]>>16&1),_=b[15]>>16&1,b[14]&=65535,It(k,b,1-_)}for(l=0;l<16;l++)a[2*l]=255&k[l],a[2*l+1]=k[l]>>8}function ts(a,u){var l=new Uint8Array(32),f=new Uint8Array(32);return jt(l,a),jt(f,u),pt(l,0,f,0)}function rs(a){var u=new Uint8Array(32);return jt(u,a),1&u[0]}function en(a,u){var l;for(l=0;l<16;l++)a[l]=u[2*l]+(u[2*l+1]<<8);a[15]&=32767}function Qe(a,u,l){var f;for(f=0;f<16;f++)a[f]=u[f]+l[f]|0}function et(a,u,l){var f;for(f=0;f<16;f++)a[f]=u[f]-l[f]|0}function re(a,u,l){var f,_,b=new Float64Array(31);for(f=0;f<31;f++)b[f]=0;for(f=0;f<16;f++)for(_=0;_<16;_++)b[f+_]+=u[f]*l[_];for(f=0;f<15;f++)b[f]+=38*b[f+16];for(f=0;f<16;f++)a[f]=b[f];Yt(a),Yt(a)}function We(a,u){re(a,u,u)}function ns(a,u){var f,l=t();for(f=0;f<16;f++)l[f]=u[f];for(f=253;f>=0;f--)We(l,l),2!==f&&4!==f&&re(l,l,u);for(f=0;f<16;f++)a[f]=l[f]}function ss(a,u){var f,l=t();for(f=0;f<16;f++)l[f]=u[f];for(f=250;f>=0;f--)We(l,l),1!==f&&re(l,l,u);for(f=0;f<16;f++)a[f]=l[f]}function br(a,u,l){var b,k,f=new Uint8Array(32),_=new Float64Array(80),L=t(),v=t(),M=t(),V=t(),ne=t(),ve=t();for(k=0;k<31;k++)f[k]=u[k];for(f[31]=127&u[31]|64,f[0]&=248,en(_,l),k=0;k<16;k++)v[k]=_[k],V[k]=L[k]=M[k]=0;for(L[0]=V[0]=1,k=254;k>=0;--k)It(L,v,b=f[k>>>3]>>>(7&k)&1),It(M,V,b),Qe(ne,L,M),et(L,L,M),Qe(M,v,V),et(v,v,V),We(V,ne),We(ve,L),re(L,M,L),re(M,v,ne),Qe(ne,L,M),et(L,L,M),We(v,L),et(M,V,ve),re(L,M,p),Qe(L,L,V),re(M,M,L),re(L,V,ve),re(V,v,_),We(v,ne),It(L,v,b),It(M,V,b);for(k=0;k<16;k++)_[k+16]=L[k],_[k+32]=M[k],_[k+48]=v[k],_[k+64]=V[k];var tt=_.subarray(32),Rt=_.subarray(16);return ns(tt,tt),re(Rt,Rt,tt),jt(a,Rt),0}function yr(a,u){return br(a,u,i)}function is(a,u){return r(u,32),yr(a,u)}function xr(a,u,l){var f=new Uint8Array(32);return br(f,l,u),yt(a,s,f,Xe)}var os=Xr,Co=Qr;function Xt(){var b,k,L,a=0,u=0,l=0,f=0,_=65535;for(L=0;L<arguments.length;L++)a+=(b=arguments[L].lo)&_,u+=b>>>16,l+=(k=arguments[L].hi)&_,f+=k>>>16;return new e((l+=(u+=a>>>16)>>>16)&_|(f+=l>>>16)<<16,a&_|u<<16)}function as(a,u){return new e(a.hi>>>u,a.lo>>>u|a.hi<<32-u)}function vr(){var l,a=0,u=0;for(l=0;l<arguments.length;l++)a^=arguments[l].lo,u^=arguments[l].hi;return new e(u,a)}function it(a,u){var l,f,_=32-u;return u<32?(l=a.hi>>>u|a.lo<<_,f=a.lo>>>u|a.hi<<_):u<64&&(l=a.lo>>>u|a.hi<<_,f=a.hi>>>u|a.lo<<_),new e(l,f)}function Ao(a,u,l){return new e(a.hi&u.hi^~a.hi&l.hi,a.lo&u.lo^~a.lo&l.lo)}function Mo(a,u,l){return new e(a.hi&u.hi^a.hi&l.hi^u.hi&l.hi,a.lo&u.lo^a.lo&l.lo^u.lo&l.lo)}function ko(a){return vr(it(a,28),it(a,34),it(a,39))}function Io(a){return vr(it(a,14),it(a,18),it(a,41))}function jo(a){return vr(it(a,1),it(a,8),as(a,7))}function To(a){return vr(it(a,19),it(a,61),as(a,6))}var No=[new e(1116352408,3609767458),new e(1899447441,602891725),new e(3049323471,3964484399),new e(3921009573,2173295548),new e(961987163,4081628472),new e(1508970993,3053834265),new e(2453635748,2937671579),new e(2870763221,3664609560),new e(3624381080,2734883394),new e(310598401,1164996542),new e(607225278,1323610764),new e(1426881987,3590304994),new e(1925078388,4068182383),new e(2162078206,991336113),new e(2614888103,633803317),new e(3248222580,3479774868),new e(3835390401,2666613458),new e(4022224774,944711139),new e(264347078,2341262773),new e(604807628,2007800933),new e(770255983,1495990901),new e(1249150122,1856431235),new e(1555081692,3175218132),new e(1996064986,2198950837),new e(2554220882,3999719339),new e(2821834349,766784016),new e(2952996808,2566594879),new e(3210313671,3203337956),new e(3336571891,1034457026),new e(3584528711,2466948901),new e(113926993,3758326383),new e(338241895,168717936),new e(666307205,1188179964),new e(773529912,1546045734),new e(1294757372,1522805485),new e(1396182291,2643833823),new e(1695183700,2343527390),new e(1986661051,1014477480),new e(2177026350,1206759142),new e(2456956037,344077627),new e(2730485921,1290863460),new e(2820302411,3158454273),new e(3259730800,3505952657),new e(3345764771,106217008),new e(3516065817,3606008344),new e(3600352804,1432725776),new e(4094571909,1467031594),new e(275423344,851169720),new e(430227734,3100823752),new e(506948616,1363258195),new e(659060556,3750685593),new e(883997877,3785050280),new e(958139571,3318307427),new e(1322822218,3812723403),new e(1537002063,2003034995),new e(1747873779,3602036899),new e(1955562222,1575990012),new e(2024104815,1125592928),new e(2227730452,2716904306),new e(2361852424,442776044),new e(2428436474,593698344),new e(2756734187,3733110249),new e(3204031479,2999351573),new e(3329325298,3815920427),new e(3391569614,3928383900),new e(3515267271,566280711),new e(3940187606,3454069534),new e(4118630271,4000239992),new e(116418474,1914138554),new e(174292421,2731055270),new e(289380356,3203993006),new e(460393269,320620315),new e(685471733,587496836),new e(852142971,1086792851),new e(1017036298,365543100),new e(1126000580,2618297676),new e(1288033470,3409855158),new e(1501505948,4234509866),new e(1607167915,987167468),new e(1816402316,1246189591)];function cs(a,u,l){var L,v,M,f=[],_=[],b=[],k=[];for(v=0;v<8;v++)f[v]=b[v]=ue(a,8*v);for(var V=0;l>=128;){for(v=0;v<16;v++)k[v]=ue(u,8*v+V);for(v=0;v<80;v++){for(M=0;M<8;M++)_[M]=b[M];for(L=Xt(b[7],Io(b[4]),Ao(b[4],b[5],b[6]),No[v],k[v%16]),_[7]=Xt(L,ko(b[0]),Mo(b[0],b[1],b[2])),_[3]=Xt(_[3],L),M=0;M<8;M++)b[(M+1)%8]=_[M];if(v%16==15)for(M=0;M<16;M++)k[M]=Xt(k[M],k[(M+9)%16],jo(k[(M+1)%16]),To(k[(M+14)%16]))}for(v=0;v<8;v++)b[v]=Xt(b[v],f[v]),f[v]=b[v];V+=128,l-=128}for(v=0;v<8;v++)Oe(a,8*v,f[v]);return l}var Ro=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function xt(a,u,l){var b,f=new Uint8Array(64),_=new Uint8Array(256),k=l;for(b=0;b<64;b++)f[b]=Ro[b];for(cs(f,u,l),l%=128,b=0;b<256;b++)_[b]=0;for(b=0;b<l;b++)_[b]=u[k-l+b];for(_[l]=128,_[(l=256-128*(l<112?1:0))-9]=0,Oe(_,l-8,new e(k/536870912|0,k<<3)),cs(f,_,l),b=0;b<64;b++)a[b]=f[b];return 0}function wr(a,u){var l=t(),f=t(),_=t(),b=t(),k=t(),L=t(),v=t(),M=t(),V=t();et(l,a[1],a[0]),et(V,u[1],u[0]),re(l,l,V),Qe(f,a[0],a[1]),Qe(V,u[0],u[1]),re(f,f,V),re(_,a[3],u[3]),re(_,_,y),re(b,a[2],u[2]),Qe(b,b,b),et(k,f,l),et(L,b,_),Qe(v,b,_),Qe(M,f,l),re(a[0],k,L),re(a[1],M,v),re(a[2],v,L),re(a[3],k,M)}function ls(a,u,l){var f;for(f=0;f<4;f++)It(a[f],u[f],l)}function tn(a,u){var l=t(),f=t(),_=t();ns(_,u[2]),re(l,u[0],_),re(f,u[1],_),jt(a,f),a[31]^=rs(l)<<7}function rn(a,u,l){var f,_;for(lt(a[0],o),lt(a[1],c),lt(a[2],c),lt(a[3],o),_=255;_>=0;--_)ls(a,u,f=l[_/8|0]>>(7&_)&1),wr(u,a),wr(a,a),ls(a,u,f)}function Sr(a,u){var l=[t(),t(),t(),t()];lt(l[0],g),lt(l[1],E),lt(l[2],c),re(l[3],g,E),rn(a,l,u)}function nn(a,u,l){var b,f=new Uint8Array(64),_=[t(),t(),t(),t()];for(l||r(u,32),xt(f,u,32),f[0]&=248,f[31]&=127,f[31]|=64,Sr(_,f),tn(a,_),b=0;b<32;b++)u[b+32]=a[b];return 0}var a,Er=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function sn(a,u){var l,f,_,b;for(f=63;f>=32;--f){for(l=0,_=f-32,b=f-12;_<b;++_)u[_]+=l-16*u[f]*Er[_-(f-32)],l=Math.floor((u[_]+128)/256),u[_]-=256*l;u[_]+=l,u[f]=0}for(l=0,_=0;_<32;_++)u[_]+=l-(u[31]>>4)*Er[_],l=u[_]>>8,u[_]&=255;for(_=0;_<32;_++)u[_]-=l*Er[_];for(f=0;f<32;f++)u[f+1]+=u[f]>>8,a[f]=255&u[f]}function on(a){var l,u=new Float64Array(64);for(l=0;l<64;l++)u[l]=a[l];for(l=0;l<64;l++)a[l]=0;sn(a,u)}function us(a,u,l,f){var L,v,_=new Uint8Array(64),b=new Uint8Array(64),k=new Uint8Array(64),M=new Float64Array(64),V=[t(),t(),t(),t()];xt(_,f,32),_[0]&=248,_[31]&=127,_[31]|=64;var ne=l+64;for(L=0;L<l;L++)a[64+L]=u[L];for(L=0;L<32;L++)a[32+L]=_[32+L];for(xt(k,a.subarray(32),l+32),on(k),Sr(V,k),tn(a,V),L=32;L<64;L++)a[L]=f[L];for(xt(b,a,l+64),on(b),L=0;L<64;L++)M[L]=0;for(L=0;L<32;L++)M[L]=k[L];for(L=0;L<32;L++)for(v=0;v<32;v++)M[L+v]+=b[L]*_[v];return sn(a.subarray(32),M),ne}function an(a,u,l,f){var _,b=new Uint8Array(32),k=new Uint8Array(64),L=[t(),t(),t(),t()],v=[t(),t(),t(),t()];if(l<64||function Lo(a,u){var l=t(),f=t(),_=t(),b=t(),k=t(),L=t(),v=t();return lt(a[2],c),en(a[1],u),We(_,a[1]),re(b,_,m),et(_,_,a[2]),Qe(b,a[2],b),We(k,b),We(L,k),re(v,L,k),re(l,v,_),re(l,l,b),ss(l,l),re(l,l,_),re(l,l,b),re(l,l,b),re(a[0],l,b),We(f,a[0]),re(f,f,b),ts(f,_)&&re(a[0],a[0],O),We(f,a[0]),re(f,f,b),ts(f,_)?-1:(rs(a[0])===u[31]>>7&&et(a[0],o,a[0]),re(a[3],a[0],a[1]),0)}(v,f))return-1;for(_=0;_<l;_++)a[_]=u[_];for(_=0;_<32;_++)a[_+32]=f[_];if(xt(k,a,l),on(k),rn(L,v,k),Sr(v,u.subarray(32)),wr(L,v),tn(b,L),l-=64,pt(u,0,b,0)){for(_=0;_<l;_++)a[_]=0;return-1}for(_=0;_<l;_++)a[_]=u[_+64];return l}function hs(a,u){if(32!==a.length)throw new Error("bad key size");if(24!==u.length)throw new Error("bad nonce size")}function Ge(){for(var a=0;a<arguments.length;a++)if(!(arguments[a]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function fs(a){for(var u=0;u<a.length;u++)a[u]=0}n.lowlevel={crypto_core_hsalsa20:yt,crypto_stream_xor:Wt,crypto_stream:kt,crypto_stream_salsa20_xor:Mt,crypto_stream_salsa20:gr,crypto_onetimeauth:Yr,crypto_onetimeauth_verify:es,crypto_verify_16:Ye,crypto_verify_32:pt,crypto_secretbox:Xr,crypto_secretbox_open:Qr,crypto_scalarmult:br,crypto_scalarmult_base:yr,crypto_box_beforenm:xr,crypto_box_afternm:os,crypto_box:function Po(a,u,l,f,_,b){var k=new Uint8Array(32);return xr(k,_,b),os(a,u,l,f,k)},crypto_box_open:function Oo(a,u,l,f,_,b){var k=new Uint8Array(32);return xr(k,_,b),Co(a,u,l,f,k)},crypto_box_keypair:is,crypto_hash:xt,crypto_sign:us,crypto_sign_keypair:nn,crypto_sign_open:an,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:16,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:64,crypto_sign_PUBLICKEYBYTES:32,crypto_sign_SECRETKEYBYTES:64,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:t,D:m,L:Er,pack25519:jt,unpack25519:en,M:re,A:Qe,S:We,Z:et,pow2523:ss,add:wr,set25519:lt,modL:sn,scalarmult:rn,scalarbase:Sr},n.randomBytes=function(a){var u=new Uint8Array(a);return r(u,a),u},n.secretbox=function(a,u,l){Ge(a,u,l),hs(l,u);for(var f=new Uint8Array(32+a.length),_=new Uint8Array(f.length),b=0;b<a.length;b++)f[b+32]=a[b];return Xr(_,f,f.length,u,l),_.subarray(16)},n.secretbox.open=function(a,u,l){Ge(a,u,l),hs(l,u);for(var f=new Uint8Array(16+a.length),_=new Uint8Array(f.length),b=0;b<a.length;b++)f[b+16]=a[b];return f.length<32||0!==Qr(_,f,f.length,u,l)?null:_.subarray(32)},n.secretbox.keyLength=32,n.secretbox.nonceLength=24,n.secretbox.overheadLength=16,n.scalarMult=function(a,u){if(Ge(a,u),32!==a.length)throw new Error("bad n size");if(32!==u.length)throw new Error("bad p size");var l=new Uint8Array(32);return br(l,a,u),l},n.scalarMult.base=function(a){if(Ge(a),32!==a.length)throw new Error("bad n size");var u=new Uint8Array(32);return yr(u,a),u},n.scalarMult.scalarLength=32,n.scalarMult.groupElementLength=32,n.box=function(a,u,l,f){var _=n.box.before(l,f);return n.secretbox(a,u,_)},n.box.before=function(a,u){Ge(a,u),function Do(a,u){if(32!==a.length)throw new Error("bad public key size");if(32!==u.length)throw new Error("bad secret key size")}(a,u);var l=new Uint8Array(32);return xr(l,a,u),l},n.box.after=n.secretbox,n.box.open=function(a,u,l,f){var _=n.box.before(l,f);return n.secretbox.open(a,u,_)},n.box.open.after=n.secretbox.open,n.box.keyPair=function(){var a=new Uint8Array(32),u=new Uint8Array(32);return is(a,u),{publicKey:a,secretKey:u}},n.box.keyPair.fromSecretKey=function(a){if(Ge(a),32!==a.length)throw new Error("bad secret key size");var u=new Uint8Array(32);return yr(u,a),{publicKey:u,secretKey:new Uint8Array(a)}},n.box.publicKeyLength=32,n.box.secretKeyLength=32,n.box.sharedKeyLength=32,n.box.nonceLength=24,n.box.overheadLength=n.secretbox.overheadLength,n.sign=function(a,u){if(Ge(a,u),64!==u.length)throw new Error("bad secret key size");var l=new Uint8Array(64+a.length);return us(l,a,a.length,u),l},n.sign.open=function(a,u){if(Ge(a,u),32!==u.length)throw new Error("bad public key size");var l=new Uint8Array(a.length),f=an(l,a,a.length,u);if(f<0)return null;for(var _=new Uint8Array(f),b=0;b<_.length;b++)_[b]=l[b];return _},n.sign.detached=function(a,u){for(var l=n.sign(a,u),f=new Uint8Array(64),_=0;_<f.length;_++)f[_]=l[_];return f},n.sign.detached.verify=function(a,u,l){if(Ge(a,u,l),64!==u.length)throw new Error("bad signature size");if(32!==l.length)throw new Error("bad public key size");var b,f=new Uint8Array(64+a.length),_=new Uint8Array(64+a.length);for(b=0;b<64;b++)f[b]=u[b];for(b=0;b<a.length;b++)f[b+64]=a[b];return an(_,f,f.length,l)>=0},n.sign.keyPair=function(){var a=new Uint8Array(32),u=new Uint8Array(64);return nn(a,u),{publicKey:a,secretKey:u}},n.sign.keyPair.fromSecretKey=function(a){if(Ge(a),64!==a.length)throw new Error("bad secret key size");for(var u=new Uint8Array(32),l=0;l<u.length;l++)u[l]=a[32+l];return{publicKey:u,secretKey:new Uint8Array(a)}},n.sign.keyPair.fromSeed=function(a){if(Ge(a),32!==a.length)throw new Error("bad seed size");for(var u=new Uint8Array(32),l=new Uint8Array(64),f=0;f<32;f++)l[f]=a[f];return nn(u,l,!0),{publicKey:u,secretKey:l}},n.sign.publicKeyLength=32,n.sign.secretKeyLength=64,n.sign.seedLength=32,n.sign.signatureLength=64,n.hash=function(a){Ge(a);var u=new Uint8Array(64);return xt(u,a,a.length),u},n.hash.hashLength=64,n.verify=function(a,u){return Ge(a,u),0!==a.length&&0!==u.length&&a.length===u.length&&0===Ae(a,0,u,0,a.length)},n.setPRNG=function(a){r=a},(a=typeof globalThis<"u"?globalThis.crypto||globalThis.msCrypto:null)&&a.getRandomValues?n.setPRNG(function(l,f){var _,b=new Uint8Array(f);for(_=0;_<f;_+=65536)a.getRandomValues(b.subarray(_,_+Math.min(f-_,65536)));for(_=0;_<f;_++)l[_]=b[_];fs(b)}):typeof require<"u"&&(a=require("crypto"))&&a.randomBytes&&n.setPRNG(function(l,f){var _,b=a.randomBytes(f);for(_=0;_<f;_++)l[_]=b[_];fs(b)})}(typeof module<"u"&&module.exports?module.exports:globalThis.nacl=globalThis.nacl||{});const ir=typeof module<"u"&&module.exports?module.exports:globalThis.nacl,Us={fromSeed:ir.sign.keyPair.fromSeed,sign:ir.sign.detached,verify:ir.sign.detached.verify,randomBytes:ir.randomBytes};let vn;new Uint16Array([0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920]),Error,function Bs(n){vn=n}(Us);function ni(n){const e=`${$}:${Ue()}`;if((n=n||{servers:[e]}).servers=n.servers||[],"string"==typeof n.servers&&(n.servers=[n.servers]),n.servers.length>0&&n.port)throw new N("port and servers options are mutually exclusive",A.InvalidOption);0===n.servers.length&&n.port&&(n.servers=[`${$}:${n.port}`]),n.servers&&0===n.servers.length&&(n.servers=[e]);const t=I({maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:12e4,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:2e3,tls:void 0,verbose:!1,waitOnFirstConnect:!1,ignoreAuthErrorAbort:!1},n);if(t.authenticator=function ri(n){const e=[];return"function"==typeof n.authenticator&&e.push(n.authenticator),Array.isArray(n.authenticator)&&e.push(...n.authenticator),n.token&&e.push(function Ys(n){return()=>({auth_token:"function"==typeof n?n():n})}(n.token)),n.user&&e.push(function Ws(n,e){return()=>({user:"function"==typeof n?n():n,pass:"function"==typeof e?e():e})}(n.user,n.pass)),0===e.length?()=>{}:function Ks(n){return e=>{let t={};return n.forEach(r=>{const s=r(e)||{};t=Object.assign(t,s)}),t}}(e)}(t),["reconnectDelayHandler","authenticator"].forEach(r=>{if(t[r]&&"function"!=typeof t[r])throw new N(`${r} option should be a function`,A.NotFunction)}),t.reconnectDelayHandler||(t.reconnectDelayHandler=()=>{let r=t.tls?t.reconnectJitterTLS:t.reconnectJitter;return r&&(r++,r=Math.floor(Math.random()*r)),t.reconnectTimeWait+r}),t.inboxPrefix)try{S(t.inboxPrefix)}catch(r){throw new N(r.message,A.ApiError)}if(t.resolve&&"function"!=typeof hn())throw new N("'resolve' is not supported on this client",A.InvalidOption);return t}const oi=/^INFO\s+([^\r\n]+)\r\n/i,ai=Se("PONG\r\n"),On=Se("PING\r\n");class ci{echo;no_responders;protocol;verbose;pedantic;jwt;nkey;sig;user;pass;auth_token;tls_required;name;lang;version;headers;constructor(e,t,r){this.protocol=1,this.version=e.version,this.lang=e.lang,this.echo=!t.noEcho&&void 0,this.verbose=t.verbose,this.pedantic=t.pedantic,this.tls_required=!!t.tls||void 0,this.name=t.name,I(this,(t&&"function"==typeof t.authenticator?t.authenticator(r):{})||{})}}class An extends Te{sid;queue;draining;max;subject;drained;protocol;timer;info;cleanupFn;closed;requestSubject;constructor(e,t,r={}){super(),I(this,r),this.protocol=e,this.subject=t,this.draining=!1,this.noIterator="function"==typeof r.callback,this.closed=R(),r.timeout&&(this.timer=F(r.timeout),this.timer.then(()=>{this.timer=void 0}).catch(s=>{this.stop(s),this.noIterator&&this.callback(s,{})})),this.noIterator||this.iterClosed.then(()=>{this.closed.resolve(),this.unsubscribe()})}setPrePostHandlers(e){if(this.noIterator){const t=this.callback,r=e.ingestionFilterFn?e.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),s=e.protocolFilterFn?e.protocolFilterFn:()=>!0,i=e.dispatchedFn?e.dispatchedFn:()=>{};this.callback=(o,c)=>{const{ingest:p}=r(c);p&&s(c)&&(t(o,c),i(c))}}else this.protocolFilterFn=e.protocolFilterFn,this.dispatchedFn=e.dispatchedFn}callback(e,t){this.cancelTimeout(),e?this.stop(e):this.push(t)}close(){if(!this.isClosed()){this.cancelTimeout();const e=()=>{if(this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch{}this.closed.resolve()};this.noIterator?e():this.push(e)}}unsubscribe(e){this.protocol.unsubscribe(this,e)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){return this.protocol.isClosed()?Promise.reject(N.errorForCode(A.ConnectionClosed)):this.isClosed()?Promise.reject(N.errorForCode(A.SubClosed)):(this.drained||(this.draining=!0,this.protocol.unsub(this),this.drained=this.protocol.flush(R()).then(()=>{this.protocol.subscriptions.cancel(this)}).catch(()=>{this.protocol.subscriptions.cancel(this)})),this.drained)}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class li{mux;subs;sidCounter;constructor(){this.sidCounter=0,this.mux=null,this.subs=new Map}size(){return this.subs.size}add(e){return this.sidCounter++,e.sid=this.sidCounter,this.subs.set(e.sid,e),e}setMux(e){return this.mux=e,e}getMux(){return this.mux}get(e){return this.subs.get(e)}resub(e){return this.sidCounter++,this.subs.delete(e.sid),e.sid=this.sidCounter,this.subs.set(e.sid,e),e}all(){return Array.from(this.subs.values())}cancel(e){e&&(e.close(),this.subs.delete(e.sid))}handleError(e){if(e&&e.permissionContext){const t=e.permissionContext,r=this.all();let s;if("subscription"===t.operation&&(s=r.find(i=>i.subject===t.subject)),"publish"===t.operation&&(s=r.find(i=>i.requestSubject===t.subject)),s)return s.callback(e,{}),s.close(),this.subs.delete(s.sid),s!==this.mux}return!1}close(){this.subs.forEach(e=>{e.close()})}}class cr{connected;connectedOnce;infoReceived;info;muxSubscriptions;options;outbound;pongs;subscriptions;transport;noMorePublishing;connectError;publisher;_closed;closed;listeners;heartbeats;parser;outMsgs;inMsgs;outBytes;inBytes;pendingLimit;lastError;abortReconnect;servers;server;features;connectPromise;constructor(e,t){this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=32768,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=e,this.publisher=t,this.subscriptions=new li,this.muxSubscriptions=new Is,this.outbound=new ye,this.pongs=[],this.pendingLimit=e.pendingLimit||this.pendingLimit,this.features=new Ls({major:0,minor:0,micro:0}),this.connectPromise=null,this.servers=new Ms("string"==typeof e.servers?[e.servers]:e.servers,{randomize:!e.noRandomize}),this.closed=R(),this.parser=new xn(this),this.heartbeats=new js(this,this.options.pingInterval||12e4,this.options.maxPingOut||2)}resetOutbound(){this.outbound.reset();const e=this.pongs;this.pongs=[];const t=N.errorForCode(A.Disconnect);t.stack="",e.forEach(r=>{r.reject(t)}),this.parser=new xn(this),this.infoReceived=!1}dispatchStatus(e){this.listeners.forEach(t=>{t.push(e)})}status(){const e=new Te;return this.listeners.push(e),e}prepare(){var e=this;this.transport&&this.transport.discard(),this.info=void 0,this.resetOutbound();const t=R();return t.catch(()=>{}),this.pongs.unshift(t),this.connectError=r=>{t.reject(r)},this.transport=function wt(){if(!be||"function"!=typeof be.factory)throw new Error("transport fn is not set");return be.factory()}(),this.transport.closed().then(function(){var r=(0,d.Z)(function*(s){e.connected=!1,e.isClosed()||(yield e.disconnected(e.transport.closeError||e.lastError))});return function(s){return r.apply(this,arguments)}}()),t}disconnect(){this.dispatchStatus({type:nt.StaleConnection,data:""}),this.transport.disconnect()}disconnected(e){var t=this;return(0,d.Z)(function*(){t.dispatchStatus({type:Le.Disconnect,data:t.servers.getCurrentServer().toString()}),t.options.reconnect?yield t.dialLoop().then(()=>{t.dispatchStatus({type:Le.Reconnect,data:t.servers.getCurrentServer().toString()}),t.lastError?.code===A.AuthenticationExpired&&(t.lastError=void 0)}).catch(r=>{t._close(r)}):yield t._close(e)})()}dial(e){var t=this;return(0,d.Z)(function*(){const r=t.prepare();let s;try{s=F(t.options.timeout||2e4);const i=t.transport.connect(e,t.options);yield Promise.race([i,s]),(0,d.Z)(function*(){try{var p,o=!1,c=!1;try{for(var y,m=(0,J.Z)(t.transport);o=!(y=yield m.next()).done;o=!1)t.parser.parse(y.value)}catch(g){c=!0,p=g}finally{try{o&&null!=m.return&&(yield m.return())}finally{if(c)throw p}}}catch(g){console.log("reader closed",g)}})().then()}catch(i){r.reject(i)}try{yield Promise.race([s,r]),s&&s.cancel(),t.connected=!0,t.connectError=void 0,t.sendSubscriptions(),t.connectedOnce=!0,t.server.didConnect=!0,t.server.reconnects=0,t.flushPending(),t.heartbeats.start()}catch(i){throw s&&s.cancel(),yield t.transport.close(i),i}})()}_doDial(e){var t=this;return(0,d.Z)(function*(){const r=yield e.resolve({fn:hn(),debug:t.options.debug,randomize:!t.options.noRandomize});let s=null;for(const i of r)try{return s=null,t.dispatchStatus({type:nt.Reconnecting,data:i.toString()}),void(yield t.dial(i))}catch(o){s=o}throw s})()}dialLoop(){return null===this.connectPromise&&(this.connectPromise=this.dodialLoop(),this.connectPromise.then(()=>{}).catch(()=>{}).finally(()=>{this.connectPromise=null})),this.connectPromise}dodialLoop(){var e=this;return(0,d.Z)(function*(){let t;for(;;){e._closed&&e.servers.clear();const r=e.options.reconnectDelayHandler?e.options.reconnectDelayHandler():2e3;let s=r;const i=e.selectServer();if(!i||e.abortReconnect)throw t||(e.lastError?e.lastError:N.errorForCode(A.ConnectionRefused));const o=Date.now();if(0===i.lastConnect||i.lastConnect+r<=o){i.lastConnect=Date.now();try{yield e._doDial(i);break}catch(c){if(t=c,!e.connectedOnce){if(e.options.waitOnFirstConnect)continue;e.servers.removeCurrentServer()}i.reconnects++;const p=e.options.maxReconnectAttempts||0;-1!==p&&i.reconnects>=p&&e.servers.removeCurrentServer()}}else s=Math.min(s,i.lastConnect+r-o),yield U(s)}})()}static connect(e,t){return(0,d.Z)(function*(){const r=new cr(e,t);return yield r.dialLoop(),r})()}static toError(e){const t=e?e.toLowerCase():"";if(-1!==t.indexOf("permissions violation")){const r=new N(e,A.PermissionsViolation),s=e.match(/(Publish|Subscription) to "(\S+)"/);return s&&(r.permissionContext={operation:s[1].toLowerCase(),subject:s[2]}),r}return-1!==t.indexOf("authorization violation")?new N(e,A.AuthorizationViolation):-1!==t.indexOf("user authentication expired")?new N(e,A.AuthenticationExpired):-1!==t.indexOf("authentication timeout")?new N(e,A.AuthenticationTimeout):new N(e,A.ProtocolError)}processMsg(e,t){if(this.inMsgs++,this.inBytes+=t.length,!this.subscriptions.sidCounter)return;const r=this.subscriptions.get(e.sid);r&&(r.received+=1,r.callback&&r.callback(null,new gn(e,t,this)),void 0!==r.max&&r.received>=r.max&&r.unsubscribe())}processError(e){const t=Ze(e),r=cr.toError(t),s={type:Le.Error,data:r.code};if(r.isPermissionError()){let i=!1;r.permissionContext&&(s.permissionContext=r.permissionContext,i=this.subscriptions.getMux()?.subject===r.permissionContext.subject),this.subscriptions.handleError(r),this.muxSubscriptions.handleError(i,r),i&&this.subscriptions.setMux(null)}this.dispatchStatus(s),this.handleError(r)}handleError(e){e.isAuthError()?this.handleAuthError(e):(e.isProtocolError()||e.isAuthTimeout())&&(this.lastError=e),e.isPermissionError()||(this.lastError=e)}handleAuthError(e){this.lastError&&e.code===this.lastError.code&&!1===this.options.ignoreAuthErrorAbort&&(this.abortReconnect=!0),this.connectError?this.connectError(e):this.disconnect()}processPing(){this.transport.send(ai)}processPong(){const e=this.pongs.shift();e&&e.resolve()}processInfo(e){const t=JSON.parse(Ze(e));this.info=t;const r=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(t);if(!this.infoReceived){this.features.update(bt(t.version)),this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();const{version:i,lang:o}=this.transport;try{const c=new ci({version:i,lang:o},this.options,t.nonce);t.headers&&(c.headers=!0,c.no_responders=!0);const p=JSON.stringify(c);this.transport.send(Se(`CONNECT ${p}\r\n`)),this.transport.send(On)}catch(c){this._close(c)}}r&&this.dispatchStatus({type:Le.Update,data:r}),void 0!==t.ldm&&t.ldm&&this.dispatchStatus({type:Le.LDM,data:this.servers.getCurrentServer().toString()})}push(e){switch(e.kind){case Be.MSG:{const{msg:t,data:r}=e;this.processMsg(t,r);break}case Be.OK:break;case Be.ERR:this.processError(e.data);break;case Be.PING:this.processPing();break;case Be.PONG:this.processPong();break;case Be.INFO:this.processInfo(e.data)}}sendCommand(e,...t){const r=this.outbound.length();let s;s="string"==typeof e?Se(e):e,this.outbound.fill(s,...t),0===r?queueMicrotask(()=>{this.flushPending()}):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(e,t=ge,r){let s;if(t instanceof Uint8Array)s=t;else{if("string"!=typeof t)throw N.errorForCode(A.BadPayload);s=we.encode(t)}let i=s.length;(r=r||{}).reply=r.reply||"";let p,o=ge,c=0;if(r.headers){if(this.info&&!this.info.headers)throw new N("headers",A.ServerOptionNotAvailable);o=r.headers.encode(),c=o.length,i=s.length+c}if(this.info&&i>this.info.max_payload)throw N.errorForCode(A.MaxPayloadExceeded);this.outBytes+=i,this.outMsgs++,r.headers?(p=r.reply?`HPUB ${e} ${r.reply} ${c} ${i}\r\n`:`HPUB ${e} ${c} ${i}\r\n`,this.sendCommand(p,o,s,nr)):(p=r.reply?`PUB ${e} ${r.reply} ${i}\r\n`:`PUB ${e} ${i}\r\n`,this.sendCommand(p,s,nr))}request(e){return this.initMux(),this.muxSubscriptions.add(e),e}subscribe(e){return this.subscriptions.add(e),this._subunsub(e),e}_sub(e){this.sendCommand(e.queue?`SUB ${e.subject} ${e.queue} ${e.sid}\r\n`:`SUB ${e.subject} ${e.sid}\r\n`)}_subunsub(e){return this._sub(e),e.max&&this.unsubscribe(e,e.max),e}unsubscribe(e,t){this.unsub(e,t),(void 0===e.max||e.received>=e.max)&&this.subscriptions.cancel(e)}unsub(e,t){!e||this.isClosed()||(this.sendCommand(t?`UNSUB ${e.sid} ${t}\r\n`:`UNSUB ${e.sid}\r\n`),e.max=t)}resub(e,t){!e||this.isClosed()||(e.subject=t,this.subscriptions.resub(e),this._sub(e))}flush(e){return e||(e=R()),this.pongs.push(e),this.outbound.fill(On),this.flushPending(),e}sendSubscriptions(){const e=[];this.subscriptions.all().forEach(t=>{e.push(t.queue?`SUB ${t.subject} ${t.queue} ${t.sid}\r\n`:`SUB ${t.subject} ${t.sid}\r\n`)}),e.length&&this.transport.send(Se(e.join("")))}_close(e){var t=this;return(0,d.Z)(function*(){t._closed||(t.heartbeats.cancel(),t.connectError&&(t.connectError(e),t.connectError=void 0),t.muxSubscriptions.close(),t.subscriptions.close(),t.listeners.forEach(r=>{r.stop()}),t._closed=!0,yield t.transport.close(e),yield t.closed.resolve(e))})()}close(){return this._close()}isClosed(){return this._closed}drain(){var e=this;const t=this.subscriptions.all(),r=[];return t.forEach(s=>{r.push(s.drain())}),Promise.all(r).then((0,d.Z)(function*(){return e.noMorePublishing=!0,yield e.flush(),e.close()})).catch(()=>{})}flushPending(){if(this.infoReceived&&this.connected&&this.outbound.size()){const e=this.outbound.drain();this.transport.send(e)}}initMux(){if(!this.subscriptions.getMux()){const t=this.muxSubscriptions.init(this.options.inboxPrefix),r=new An(this,`${t}*`);r.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(r),this.subscribe(r)}}selectServer(){const e=this.servers.selectServer();if(void 0!==e)return this.server=e,this.server}getServer(){return this.server}}class Mn{token;received;ctx;requestSubject;mux;constructor(e,t){this.mux=e,this.requestSubject=t,this.received=0,this.token=Pe.next(),this.ctx=new Error}}class ui extends Mn{callback;done;timer;max;opts;constructor(e,t,r={maxWait:1e3}){if(super(e,t),this.opts=r,"function"!=typeof this.opts.callback)throw new Error("callback is required");this.callback=this.opts.callback,this.max="number"==typeof r.maxMessages&&r.maxMessages>0?r.maxMessages:-1,this.done=R(),this.done.then(()=>{this.callback(null,null)}),this.timer=setTimeout(()=>{this.cancel()},r.maxWait)}cancel(e){e&&this.callback(e,null),clearTimeout(this.timer),this.mux.cancel(this),this.done.resolve()}resolver(e,t){e?(e.stack+=`\n\n${this.ctx.stack}`,this.cancel(e)):(this.callback(null,t),this.opts.strategy===ke.Count&&(this.max--,0===this.max&&this.cancel()),this.opts.strategy===ke.JitterTimer&&(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.cancel()},this.opts.jitter||300)),this.opts.strategy===ke.SentinelMsg&&t&&0===t.data.length&&this.cancel())}}class kn extends Mn{deferred;timer;constructor(e,t,r={timeout:1e3}){super(e,t),this.deferred=R(),this.timer=F(r.timeout)}resolver(e,t){this.timer&&this.timer.cancel(),e?(e.stack+=`\n\n${this.ctx.stack}`,this.deferred.reject(e)):this.deferred.resolve(t),this.cancel()}cancel(e){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(e||N.errorForCode(A.Cancelled))}}function Et(n){return Nr("durable",n)}function De(n){return Nr("stream",n)}function Nr(n,e=""){if(""===e)throw Error(`${n} name required`);return[".","*",">","/","\\"," ","\t","\n","\r"].forEach(r=>{if(-1!==e.indexOf(r)){switch(r){case"\n":r="\\n";break;case"\r":r="\\r";break;case"\t":r="\\t"}throw Error(`invalid ${n} name - ${n} name cannot contain '${r}'`)}}),""}function Bt(n,e=""){if(""===e)throw Error(`${n} name required`);const t=function di(n=""){if(""===n)throw Error("name required");const e=/^[-\w]+$/g;if(null===n.match(e))for(const r of n.split(""))if(null===r.match(e))return`cannot contain '${r}'`;return""}(e);if(t.length)throw new Error(`invalid ${n} name - ${n} name ${t}`)}function xe(n){return 1e6*n}function Rr(n){return Math.floor(n/1e6)}function Lr(n){if(n.data.length>0)return!1;const e=n.headers;return!!e&&e.code>=100&&e.code<200}function Ur(n){return Lr(n)&&"Idle Heartbeat"===n.headers?.description}function Ct(n){if(0!==n.data.length)return null;const e=n.headers;return e?In(e.code,e.description):null}var Ke=function(n){return n.MaxBatchExceeded="exceeded maxrequestbatch of",n.MaxExpiresExceeded="exceeded maxrequestexpires of",n.MaxBytesExceeded="exceeded maxrequestmaxbytes of",n.MaxMessageSizeExceeded="message size exceeds maxbytes",n.PushConsumer="consumer is push based",n.MaxWaitingExceeded="exceeded maxwaiting",n.IdleHeartbeatMissed="idle heartbeats missed",n.ConsumerDeleted="consumer deleted",n}(Ke||{});let fi=!1;function In(n,e=""){if(n<300)return null;switch(e=e.toLowerCase(),n){case 404:return new N(e,A.JetStream404NoMessages);case 408:return new N(e,A.JetStream408RequestTimeout);case 409:{const t=e.startsWith(Ke.IdleHeartbeatMissed)?A.JetStreamIdleHeartBeat:A.JetStream409;return new N(e,t)}case 503:return N.errorForCode(A.JetStreamNotEnabled,new Error(e));default:return""===e&&(e=A.Unknown),new N(e,`${n}`)}}class Dt{nc;opts;prefix;timeout;jc;constructor(e,t){this.nc=e,this.opts=function _i(n){return(n=n||{}).domain&&(n.apiPrefix=`$JS.${n.domain}.API`,delete n.domain),I({apiPrefix:"$JS.API",timeout:5e3},n)}(t),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=ze()}getOptions(){return Object.assign({},this.opts)}_parseOpts(){let e=this.opts.apiPrefix;if(!e||0===e.length)throw new Error("invalid empty prefix");"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),this.opts.apiPrefix=e}_request(e,t=null,r){var s=this;return(0,d.Z)(function*(){(r=r||{}).timeout=s.timeout;let i=ge;t&&(i=s.jc.encode(t));const o=yield s.nc.request(e,i,r);return s.parseJsResponse(o)})()}findStream(e){var t=this;return(0,d.Z)(function*(){const r={subject:e},i=yield t._request(`${t.prefix}.STREAM.NAMES`,r);if(!i.streams||1!==i.streams.length)throw new Error("no stream matches subject");return i.streams[0]})()}getConnection(){return this.nc}parseJsResponse(e){const t=this.jc.decode(e.data),r=t;if(r.error){const s=In(r.error.code,r.error.description);if(null!==s)throw s.api_error=r.error,s}return t}}class gi{static encode(e){if("string"==typeof e)return btoa(e);const t=Array.from(e);return btoa(String.fromCharCode(...t))}static decode(e,t=!1){const r=atob(e);return t?Uint8Array.from(r,s=>s.charCodeAt(0)):r}}class Ft{static encode(e){return Ft.toB64URLEncoding(gi.encode(e))}static decode(e,t=!1){return Ft.decode(Ft.fromB64URLEncoding(e),t)}static toB64URLEncoding(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}static fromB64URLEncoding(e){return e.replace(/_/g,"/").replace(/-/g,"+")}}var jn=function(n){return n.Limits="limits",n.Interest="interest",n.Workqueue="workqueue",n}(jn||{}),lr=function(n){return n.Old="old",n.New="new",n}(lr||{}),Tn=function(n){return n.File="file",n.Memory="memory",n}(Tn||{}),Ee=function(n){return n.All="all",n.Last="last",n.New="new",n.StartSequence="by_start_sequence",n.StartTime="by_start_time",n.LastPerSubject="last_per_subject",n}(Ee||{}),Ie=function(n){return n.None="none",n.All="all",n.Explicit="explicit",n.NotSet="",n}(Ie||{}),$t=function(n){return n.Instant="instant",n.Original="original",n}($t||{}),Br=function(n){return n.CreateOrUpdate="",n.Update="update",n.Create="create",n}(Br||{}),Fe=function(n){return n.StreamSourceHdr="Nats-Stream-Source",n.LastConsumerSeqHdr="Nats-Last-Consumer",n.LastStreamSeqHdr="Nats-Last-Stream",n.ConsumerStalledHdr="Nats-Consumer-Stalled",n.MessageSizeHdr="Nats-Msg-Size",n.RollupHdr="Nats-Rollup",n.RollupValueSubject="sub",n.RollupValueAll="all",n.PendingMessagesHdr="Nats-Pending-Messages",n.PendingBytesHdr="Nats-Pending-Bytes",n}(Fe||{}),st=function(n){return n.LastValue="",n.AllHistory="history",n.UpdatesOnly="updates",n}(st||{}),qt=function(n){return n.Stream="Nats-Stream",n.Sequence="Nats-Sequence",n.TimeStamp="Nats-Time-Stamp",n.Subject="Nats-Subject",n}(qt||{});const Je="KV_";class wi{config;ordered;mack;stream;callbackFn;max;qname;isBind;filters;constructor(e){this.stream="",this.mack=!1,this.ordered=!1,this.config=function yi(n,e={}){return Object.assign({name:n,deliver_policy:Ee.All,ack_policy:Ie.Explicit,ack_wait:xe(3e4),replay_policy:$t.Instant},e)}("",e||{})}getOpts(){const e={};if(e.config=Object.assign({},this.config),e.config.filter_subject&&(this.filterSubject(e.config.filter_subject),e.config.filter_subject=void 0),e.config.filter_subjects&&(e.config.filter_subjects?.forEach(t=>{this.filterSubject(t)}),e.config.filter_subjects=void 0),e.mack=this.mack,e.stream=this.stream,e.callbackFn=this.callbackFn,e.max=this.max,e.queue=this.qname,e.ordered=this.ordered,e.config.ack_policy=e.ordered?Ie.None:e.config.ack_policy,e.isBind=e.isBind||!1,this.filters)switch(this.filters.length){case 0:break;case 1:e.config.filter_subject=this.filters[0];break;default:e.config.filter_subjects=this.filters}return e}description(e){return this.config.description=e,this}deliverTo(e){return this.config.deliver_subject=e,this}durable(e){return Et(e),this.config.durable_name=e,this}startSequence(e){if(e<=0)throw new Error("sequence must be greater than 0");return this.config.deliver_policy=Ee.StartSequence,this.config.opt_start_seq=e,this}startTime(e){return this.config.deliver_policy=Ee.StartTime,this.config.opt_start_time=e.toISOString(),this}deliverAll(){return this.config.deliver_policy=Ee.All,this}deliverLastPerSubject(){return this.config.deliver_policy=Ee.LastPerSubject,this}deliverLast(){return this.config.deliver_policy=Ee.Last,this}deliverNew(){return this.config.deliver_policy=Ee.New,this}startAtTimeDelta(e){return this.startTime(new Date(Date.now()-e)),this}headersOnly(){return this.config.headers_only=!0,this}ackNone(){return this.config.ack_policy=Ie.None,this}ackAll(){return this.config.ack_policy=Ie.All,this}ackExplicit(){return this.config.ack_policy=Ie.Explicit,this}ackWait(e){return this.config.ack_wait=xe(e),this}maxDeliver(e){return this.config.max_deliver=e,this}filterSubject(e){return this.filters=this.filters||[],this.filters.push(e),this}replayInstantly(){return this.config.replay_policy=$t.Instant,this}replayOriginal(){return this.config.replay_policy=$t.Original,this}sample(e){if((e=Math.trunc(e))<0||e>100)throw new Error("value must be between 0-100");return this.config.sample_freq=`${e}%`,this}limit(e){return this.config.rate_limit_bps=e,this}maxWaiting(e){return this.config.max_waiting=e,this}maxAckPending(e){return this.config.max_ack_pending=e,this}idleHeartbeat(e){return this.config.idle_heartbeat=xe(e),this}flowControl(){return this.config.flow_control=!0,this}deliverGroup(e){return this.queue(e),this}manualAck(){return this.mack=!0,this}maxMessages(e){return this.max=e,this}callback(e){return this.callbackFn=e,this}queue(e){return this.qname=e,this.config.deliver_group=e,this}orderedConsumer(){return this.ordered=!0,this}bind(e,t){return this.stream=e,this.config.durable_name=t,this.isBind=!0,this}bindStream(e){return this.stream=e,this}inactiveEphemeralThreshold(e){return this.config.inactive_threshold=xe(e),this}maxPullBatch(e){return this.config.max_batch=e,this}maxPullRequestExpires(e){return this.config.max_expires=xe(e),this}memory(){return this.config.mem_storage=!0,this}numReplicas(e){return this.config.num_replicas=e,this}}function ft(n){return new wi(n)}function Nn(n){return"function"==typeof n.getOpts}function Rn(n){const e=n.length;let t=n.indexOf("=");return-1===t&&(t=e),[t,t===e?0:4-t%4]}const Ln=[],Un=[],Dr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";for(let n=0,e=64;n<e;++n)Ln[n]=Dr[n],Un[Dr.charCodeAt(n)]=n;const{toUint8Array:Ei,fromUint8Array:Ci}=function Si(n,e,t=!1){function r(o,c){return Math.floor(3*(o+c)/4-c)}function s(o){return n[o>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]}function i(o,c,p){const m=new Array((p-c)/3);for(let y=c,g=0;y<p;y+=3)m[g++]=s((o[y]<<16)+(o[y+1]<<8)+o[y+2]);return m.join("")}return{byteLength:o=>r.apply(null,Rn(o)),toUint8Array(o){const[c,p]=Rn(o),m=new Uint8Array(r(c,p)),y=p?c-4:c;let g,O,E=0;for(O=0;O<y;O+=4)g=e[o.charCodeAt(O)]<<18|e[o.charCodeAt(O+1)]<<12|e[o.charCodeAt(O+2)]<<6|e[o.charCodeAt(O+3)],m[E++]=g>>16&255,m[E++]=g>>8&255,m[E++]=255&g;return 2===p?(g=e[o.charCodeAt(O)]<<2|e[o.charCodeAt(O+1)]>>4,m[E++]=255&g):1===p&&(g=e[o.charCodeAt(O)]<<10|e[o.charCodeAt(O+1)]<<4|e[o.charCodeAt(O+2)]>>2,m[E++]=g>>8&255,m[E++]=255&g),m},fromUint8Array(o){const p=o.length,m=p%3,y=p-m,g=new Array(Math.ceil(y/16383)+(m?1:0));let O,j,E=0;for(let B=0;B<y;B+=16383)O=B+16383,g[E++]=i(o,B,O>y?y:O);return 1===m?(j=o[y],g[E]=n[j>>2]+n[j<<4&63],t||(g[E]+="==")):2===m&&(j=o[y]<<8|255&o[y+1],g[E]=n[j>>10]+n[j>>4&63]+n[j<<2&63],t||(g[E]+="=")),g.join("")}}}(Ln,Un,!0),Pi=new TextDecoder,Oi=new TextEncoder;class Bn{hashSize=32;_buf;_bufIdx;_count;_K;_H;_finalized;constructor(){this._buf=new Uint8Array(64),this._K=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),this.init()}init(){return this._H=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),this._bufIdx=0,this._count=new Uint32Array(2),this._buf.fill(0),this._finalized=!1,this}update(e,t){if(null===e)throw new TypeError("msg must be a string or Uint8Array.");"string"==typeof e&&(e=function Ii(n,e="utf8"){if(/^utf-?8$/i.test(e))return Oi.encode(n);if(/^base64$/i.test(e))return Ei(n);if(/^hex(?:adecimal)?$/i.test(e))return function Mi(n){const e=n.length;if(e%2||!/^[0-9a-fA-F]+$/.test(n))throw new TypeError("Invalid hex string.");n=n.toLowerCase();const t=new Uint8Array(Math.floor(e/2)),r=e/2;for(let s=0;s<r;++s)t[s]=parseInt(n.substr(2*s,2),16);return t}(n);throw new TypeError("Unsupported string encoding.")}(e,t));for(let s=0,i=e.length;s<i;s++)this._buf[this._bufIdx++]=e[s],64===this._bufIdx&&(this._transform(),this._bufIdx=0);const r=this._count;return(r[0]+=e.length<<3)<e.length<<3&&r[1]++,r[1]+=e.length>>>29,this}digest(e){if(this._finalized)throw new Error("digest has already been called.");this._finalized=!0;const t=this._buf;let r=this._bufIdx;for(t[r++]=128;56!==r;)64===r&&(this._transform(),r=0),t[r++]=0;const s=this._count;t[56]=s[1]>>>24&255,t[57]=s[1]>>>16&255,t[58]=s[1]>>>8&255,t[59]=s[1]>>>0&255,t[60]=s[0]>>>24&255,t[61]=s[0]>>>16&255,t[62]=s[0]>>>8&255,t[63]=s[0]>>>0&255,this._transform();const i=new Uint8Array(32);for(let o=0;o<8;o++)i[0+(o<<2)]=this._H[o]>>>24&255,i[1+(o<<2)]=this._H[o]>>>16&255,i[2+(o<<2)]=this._H[o]>>>8&255,i[3+(o<<2)]=this._H[o]>>>0&255;return this.init(),e?function ki(n,e="utf8"){if(/^utf-?8$/i.test(e))return Pi.decode(n);if(/^base64$/i.test(e))return Ci(n);if(/^hex(?:adecimal)?$/i.test(e))return function Ai(n){return n.reduce((e,t)=>`${e}${t<16?"0":""}${t.toString(16)}`,"")}(n);throw new TypeError("Unsupported string encoding.")}(i,e):i}_transform(){const e=this._H;let t=e[0],r=e[1],s=e[2],i=e[3],o=e[4],c=e[5],p=e[6],m=e[7];const y=new Uint32Array(16);let g;for(g=0;g<16;g++)y[g]=this._buf[3+(g<<2)]|this._buf[2+(g<<2)]<<8|this._buf[1+(g<<2)]<<16|this._buf[g<<2]<<24;for(g=0;g<64;g++){let E;if(g<16)E=y[g];else{let O=y[g+1&15],j=y[g+14&15];E=y[15&g]=(O>>>7^O>>>18^O>>>3^O<<25^O<<14)+(j>>>17^j>>>19^j>>>10^j<<15^j<<13)+y[15&g]+y[g+9&15]|0}E=E+m+(o>>>6^o>>>11^o>>>25^o<<26^o<<21^o<<7)+(p^o&(c^p))+this._K[g]|0,m=p,p=c,c=o,o=i+E,i=s,s=r,r=t,t=E+(r&s^i&(r^s))+(r>>>2^r>>>13^r>>>22^r<<30^r<<19^r<<10)|0}e[0]=e[0]+t|0,e[1]=e[1]+r|0,e[2]=e[2]+s|0,e[3]=e[3]+i|0,e[4]=e[4]+o|0,e[5]=e[5]+c|0,e[6]=e[6]+p|0,e[7]=e[7]+m|0}}class zt{err;offset;pageInfo;subject;jsm;filter;payload;constructor(e,t,r,s){if(!e)throw new Error("subject is required");this.subject=e,this.jsm=r,this.offset=0,this.pageInfo={},this.filter=t,this.payload=s||{}}next(){var e=this;return(0,d.Z)(function*(){if(e.err)return[];if(e.pageInfo&&e.offset>=e.pageInfo.total)return[];const t={offset:e.offset};e.payload&&Object.assign(t,e.payload);try{const r=yield e.jsm._request(e.subject,t,{timeout:e.jsm.timeout});return e.pageInfo=r,e.offset+=e.countResponse(r),e.filter(r)}catch(r){throw e.err=r,r}})()}countResponse(e){switch(e?.type){case"io.nats.jetstream.api.v1.stream_names_response":case"io.nats.jetstream.api.v1.stream_list_response":return e.streams.length;case"io.nats.jetstream.api.v1.consumer_list_response":return e.consumers.length;default:return console.error(`jslister.ts: unknown API response for paged output: ${e?.type}`),e.streams?.length||0}return 0}[Symbol.asyncIterator](){var e=this;return je(function*(){let t=yield oe(e.next());for(;t.length>0;){for(const r of t)yield r;t=yield oe(e.next())}})()}}class Fr extends Dt{constructor(e,t){super(e,t)}add(e,t,r=Br.Create){var s=this;return(0,d.Z)(function*(){if(De(e),t.deliver_group&&t.flow_control)throw new Error("jetstream flow control is not supported with queue groups");if(t.deliver_group&&t.idle_heartbeat)throw new Error("jetstream idle heartbeat is not supported with queue groups");const i={};i.config=t,i.stream_name=e,i.action=r,i.config.durable_name&&Et(i.config.durable_name);const o=s.nc;let{min:c,ok:p}=o.features.get(le.JS_NEW_CONSUMER_CREATE_API);const m=""===t.name?void 0:t.name;if(m&&!p)throw new Error(`consumer 'name' requires server ${c}`);if(m)try{Nr("name",m)}catch(O){const j=O.message,B=j.indexOf("cannot contain");throw-1!==B?new Error(`consumer 'name' ${j.substring(B)}`):O}let y,g="";if(Array.isArray(t.filter_subjects)){const{min:O,ok:j}=o.features.get(le.JS_MULTIPLE_CONSUMER_FILTER);if(!j)throw new Error(`consumer 'filter_subjects' requires server ${O}`);p=!1}if(t.metadata){const{min:O,ok:j}=o.features.get(le.JS_STREAM_CONSUMER_METADATA);if(!j)throw new Error(`consumer 'metadata' requires server ${O}`)}if(p&&(g=t.name??t.durable_name??""),""!==g){let O=t.filter_subject??void 0;">"===O&&(O=void 0),y=void 0!==O?`${s.prefix}.CONSUMER.CREATE.${e}.${g}.${O}`:`${s.prefix}.CONSUMER.CREATE.${e}.${g}`}else y=t.durable_name?`${s.prefix}.CONSUMER.DURABLE.CREATE.${e}.${t.durable_name}`:`${s.prefix}.CONSUMER.CREATE.${e}`;return yield s._request(y,i)})()}update(e,t,r){var s=this;return(0,d.Z)(function*(){const i=yield s.info(e,t);return s.add(e,Object.assign(i.config,r),Br.Update)})()}info(e,t){var r=this;return(0,d.Z)(function*(){return De(e),Et(t),yield r._request(`${r.prefix}.CONSUMER.INFO.${e}.${t}`)})()}delete(e,t){var r=this;return(0,d.Z)(function*(){return De(e),Et(t),(yield r._request(`${r.prefix}.CONSUMER.DELETE.${e}.${t}`)).success})()}list(e){return De(e),new zt(`${this.prefix}.CONSUMER.LIST.${e}`,s=>s.consumers,this)}}const Dn=Uint8Array.of(43,65,67,75),ji=Uint8Array.of(45,78,65,75),Gt=Uint8Array.of(43,87,80,73),Ti=Uint8Array.of(43,78,88,84),Ni=Uint8Array.of(43,84,69,82,77),Ri=Uint8Array.of(32);function Vt(n){return new Ui(n)}class Ui{msg;di;didAck;constructor(e){this.msg=e,this.didAck=!1}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=function Li(n){const e=n.split(".");if(9===e.length&&e.splice(2,0,"_",""),e.length<11||"$JS"!==e[0]||"ACK"!==e[1])throw new Error("not js message");const t={};return t.domain="_"===e[2]?"":e[2],t.account_hash=e[3],t.stream=e[4],t.consumer=e[5],t.redeliveryCount=parseInt(e[6],10),t.redelivered=t.redeliveryCount>1,t.streamSequence=parseInt(e[7],10),t.deliverySequence=parseInt(e[8],10),t.timestampNanos=parseInt(e[9],10),t.pending=parseInt(e[10],10),t}(this.reply)),this.di}get redelivered(){return this.info.redeliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(e){this.didAck||(this.didAck=!this.isWIP(e),this.msg.respond(e))}isWIP(e){return 4===e.length&&e[0]===Gt[0]&&e[1]===Gt[1]&&e[2]===Gt[2]&&e[3]===Gt[3]}ackAck(){var e=this;return(0,d.Z)(function*(){if(!e.didAck&&(e.didAck=!0,e.msg.reply)){const r=e.msg.publisher,s=new kn(r.muxSubscriptions,e.msg.reply);r.request(s);try{r.publish(e.msg.reply,Dn,{reply:`${r.muxSubscriptions.baseInbox}${s.token}`})}catch(i){s.cancel(i)}try{return yield Promise.race([s.timer,s.deferred]),!0}catch(i){s.cancel(i)}}return!1})()}ack(){this.doAck(Dn)}nak(e){let t=ji;e&&(t=function ks(){return{encode:n=>we.encode(n),decode:n=>de.decode(n)}}().encode(`-NAK ${JSON.stringify({delay:xe(e)})}`)),this.doAck(t)}working(){this.doAck(Gt)}next(e,t={batch:1}){const r={};r.batch=t.batch||1,r.no_wait=t.no_wait||!1,t.expires&&t.expires>0&&(r.expires=xe(t.expires));const s=ze().encode(r),i=ye.concat(Ti,Ri,s);this.msg.respond(i,e?{reply:e}:void 0)}term(){this.doAck(Ni)}json(){return this.msg.json()}string(){return this.msg.string()}}function Pt(n,e,t=!1){if(!0===t&&!n)throw N.errorForCode(A.ApiError,new Error(`${e} is not a function`));if(n&&"function"!=typeof n)throw N.errorForCode(A.ApiError,new Error(`${e} is not a function`))}class Bi extends Te{sub;adapter;subIterDone;constructor(e,t,r){var s;super(),s=this,Pt(r.adapter,"adapter",!0),this.adapter=r.adapter,r.callback&&Pt(r.callback,"callback"),this.noIterator="function"==typeof r.callback,r.ingestionFilterFn&&(Pt(r.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=r.ingestionFilterFn),r.protocolFilterFn&&(Pt(r.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=r.protocolFilterFn),r.dispatchedFn&&(Pt(r.dispatchedFn,"dispatchedFn"),this.dispatchedFn=r.dispatchedFn),r.cleanupFn&&Pt(r.cleanupFn,"cleanupFn");let i=(y,g)=>{this.callback(y,g)};if(r.callback){const y=r.callback;i=(g,E)=>{const[O,j]=this.adapter(g,E);if(O)return void y(O,null);const{ingest:B}=this.ingestionFilterFn?this.ingestionFilterFn(j,this):{ingest:!0};B&&(!this.protocolFilterFn||this.protocolFilterFn(j))&&(y(O,j),this.dispatchedFn&&j&&this.dispatchedFn(j))}}const{max:o,queue:c,timeout:p}=r,m={queue:c,timeout:p,callback:i};var y;o&&o>0&&(m.max=o),this.sub=e.subscribe(t,m),r.cleanupFn&&(this.sub.cleanupFn=r.cleanupFn),this.noIterator||this.iterClosed.then(()=>{this.unsubscribe()}),this.subIterDone=R(),Promise.all([this.sub.closed,this.iterClosed]).then(()=>{this.subIterDone.resolve()}).catch(()=>{this.subIterDone.resolve()}),(y=(0,d.Z)(function*(g){yield g.closed,s.stop()}),function(g){return y.apply(this,arguments)})(this.sub).then().catch()}unsubscribe(e){this.sub.unsubscribe(e)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(e,t){this.sub.cancelTimeout();const[r,s]=this.adapter(e,t);r&&this.stop(r),s&&this.push(s)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}class $r{interval;maxOut;cancelAfter;timer;autoCancelTimer;last;missed;count;callback;constructor(e,t,r={maxOut:2}){this.interval=e,this.maxOut=r?.maxOut||2,this.cancelAfter=r?.cancelAfter||0,this.last=Date.now(),this.missed=0,this.count=0,this.callback=t,this._schedule()}cancel(){this.autoCancelTimer&&clearTimeout(this.autoCancelTimer),this.timer&&clearInterval(this.timer),this.timer=0,this.autoCancelTimer=0}work(){this.last=Date.now(),this.missed=0}_change(e,t=0,r=2){this.interval=e,this.maxOut=r,this.cancelAfter=t,this.restart()}restart(){this.cancel(),this._schedule()}_schedule(){this.cancelAfter>0&&(this.autoCancelTimer=setTimeout(()=>{this.cancel()},this.cancelAfter)),this.timer=setInterval(()=>{if(this.count++,Date.now()-this.last>this.interval&&this.missed++,this.missed>=this.maxOut)try{!0===this.callback(this.missed)&&this.cancel()}catch(e){console.log(e)}},this.interval)}}var ct,at=function(n){return n[n.Unset=-1]="Unset",n[n.Consume=0]="Consume",n[n.Fetch=1]="Fetch",n}(at||{}),qr=function(n){return n.HeartbeatsMissed="heartbeats_missed",n}(qr||{}),ur=function(n){return n.DebugEvent="debug",n.Discard="discard",n.Next="next",n}(ur||{});class zr extends Te{consumer;opts;sub;monitor;pending;inbox;refilling;stack;pong;callback;timeout;cleanupHandler;listeners;statusIterator;constructor(e,t,r=!1){var s;super(),s=this,this.consumer=e,this.opts=this.parseOptions(t,r),this.callback=t.callback||null,this.noIterator="function"==typeof this.callback,this.monitor=null,this.pong=null,this.pending={msgs:0,bytes:0,requests:0},this.refilling=r,this.stack=(new Error).stack.split("\n").slice(1).join("\n"),this.timeout=null,this.inbox=S(e.api.nc.options.inboxPrefix),this.listeners=[];const{max_messages:i,max_bytes:o,idle_heartbeat:c,threshold_bytes:p,threshold_messages:m}=this.opts;this.closed().then(()=>{if(this.cleanupHandler)try{this.cleanupHandler()}catch{}});const{sub:y}=this;y&&y.unsubscribe(),this.sub=e.api.nc.subscribe(this.inbox,{callback:(g,E)=>{if(g)this.stop();else{if(this.monitor?.work(),E.subject===this.inbox){if(Ur(E))return;const j=E.headers?.code,B=E.headers?.description?.toLowerCase()||"unknown",{msgsLeft:ue,bytesLeft:X}=this.parseDiscard(E.headers);if(ue>0||X>0)this.pending.msgs-=ue,this.pending.bytes-=X,this.pending.requests--,this.notify(ur.Discard,{msgsLeft:ue,bytesLeft:X});else{const Oe=()=>{const Ae=new N(B,`${j}`);return Ae.stack+=`\n\n${this.stack}`,Ae};if(400===j){const Ae=Oe();this._push(()=>{this.stop(Ae)})}else if(409===j&&"consumer deleted"===B){const Ae=Oe();this.stop(Ae)}else this.notify(ur.DebugEvent,`${j} ${B}`)}}else this._push(Vt(E)),this.received++,this.pending.msgs&&this.pending.msgs--,this.pending.bytes&&(this.pending.bytes-=E.size());if(0===this.pending.msgs&&0===this.pending.bytes&&(this.pending.requests=0),this.refilling){if(i&&this.pending.msgs<=m||o&&this.pending.bytes<=p){const j=this.pullOptions();this.pull(j)}}else 0===this.pending.requests&&this._push(()=>{this.stop()})}}}),this.sub.closed.then(()=>{this.sub.draining&&this._push(()=>{this.stop()})}),c&&(this.monitor=new $r(c,g=>(this.notify(qr.HeartbeatsMissed,g),this.resetPending().then(()=>{}).catch(()=>{}),!1),{maxOut:2})),(0,d.Z)(function*(){const g=e.api.nc.status();s.statusIterator=g;var j,E=!1,O=!1;try{for(var ue,B=(0,J.Z)(g);E=!(ue=yield B.next()).done;E=!1)switch(ue.value.type){case Le.Disconnect:s.monitor?.cancel();break;case Le.Reconnect:s.resetPending().then(Oe=>{Oe&&s.monitor?.restart()}).catch(()=>{})}}catch(X){O=!0,j=X}finally{try{E&&null!=B.return&&(yield B.return())}finally{if(O)throw j}}})(),this.pull(this.pullOptions())}_push(e){if(this.callback){const t="function"==typeof e?e:null;try{t?t():this.callback(e)}catch(r){this.stop(r)}}else super.push(e)}notify(e,t){this.listeners.length>0&&this.listeners.forEach(r=>{r.done||r.push({type:e,data:t})})}resetPending(){return this.consumer.info().then(e=>(this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),!0)).catch(e=>("consumer not found"===e.message&&this.stop(e),!1))}pull(e){this.pending.bytes+=e.max_bytes??0,this.pending.msgs+=e.batch??0,this.pending.requests++;const t=this.consumer.api.nc;this._push(()=>{t.publish(`${this.consumer.api.prefix}.CONSUMER.MSG.NEXT.${this.consumer.stream}.${this.consumer.name}`,this.consumer.api.jc.encode(e),{reply:this.inbox}),this.notify(ur.Next,e)})}pullOptions(){return{batch:this.opts.max_messages-this.pending.msgs,max_bytes:this.opts.max_bytes-this.pending.bytes,idle_heartbeat:xe(this.opts.idle_heartbeat),expires:xe(this.opts.expires)}}parseDiscard(e){const t={msgsLeft:0,bytesLeft:0},r=e?.get(Fe.PendingMessagesHdr);r&&(t.msgsLeft=parseInt(r));const s=e?.get(Fe.PendingBytesHdr);return s&&(t.bytesLeft=parseInt(s)),t}trackTimeout(e){this.timeout=e}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}clearTimers(){this.monitor?.cancel(),this.monitor=null,this.timeout?.cancel(),this.timeout=null}setCleanupHandler(e){this.cleanupHandler=e}stop(e){this.sub?.unsubscribe(),this.clearTimers(),this.statusIterator?.stop(),this._push(()=>{super.stop(e),this.listeners.forEach(t=>{t.stop()})})}parseOptions(e,t=!1){const r=e||{};if(r.max_messages=r.max_messages||0,r.max_bytes=r.max_bytes||0,0!==r.max_messages&&0!==r.max_bytes)throw new Error("only specify one of max_messages or max_bytes");if(0===r.max_messages&&(r.max_messages=100),r.expires=r.expires||3e4,r.expires<1e3)throw new Error("expires should be at least 1000ms");if(r.idle_heartbeat=r.idle_heartbeat||r.expires/2,r.idle_heartbeat=r.idle_heartbeat>3e4?3e4:r.idle_heartbeat,t){const s=Math.round(.75*r.max_messages)||1;r.threshold_messages=r.threshold_messages||s;const i=Math.round(.75*r.max_bytes)||1;r.threshold_bytes=r.threshold_bytes||i}return r}status(){const e=new Te;return this.listeners.push(e),Promise.resolve(e)}}class Fn extends Te{src;constructor(){super()}setSource(e){this.src&&(this.src.setCleanupHandler(),this.src.stop()),this.src=e,this.src.setCleanupHandler(()=>{this.close().catch()})}stop(e){this.src?.stop(e),super.stop(e)}close(){return this.stop(),this.iterClosed}status(){return Promise.reject(new Error("ordered consumers don't report consumer status"))}}class $n{api;_info;stream;name;constructor(e,t){this.api=e,this._info=t,this.stream=t.stream_name,this.name=t.name}consume(e={max_messages:100,expires:3e4}){return Promise.resolve(new zr(this,e,!0))}fetch(e={max_messages:100,expires:3e4}){const t=new zr(this,e,!1),s=F(Math.round(1.05*t.opts.expires));return t.closed().then(()=>{s.cancel()}),s.catch(()=>{t.close().catch()}),t.trackTimeout(s),Promise.resolve(t)}next(e={expires:3e4}){const t=R(),r=e;r.max_messages=1;const s=new zr(this,r,!1),i=Math.round(1.05*s.opts.expires);i>=6e4&&(0,d.Z)(function*(){var m,c=!1,p=!1;try{for(var g,y=(0,J.Z)(yield s.status());c=!(g=yield y.next()).done;c=!1){const E=g.value;if(E.type===qr.HeartbeatsMissed&&E.data>=2){t.reject(new Error("consumer missed heartbeats"));break}}}catch(E){p=!0,m=E}finally{try{c&&null!=y.return&&(yield y.return())}finally{if(p)throw m}}})().catch(),(0,d.Z)(function*(){var m,c=!1,p=!1;try{for(var g,y=(0,J.Z)(s);c=!(g=yield y.next()).done;c=!1){t.resolve(g.value);break}}catch(E){p=!0,m=E}finally{try{c&&null!=y.return&&(yield y.return())}finally{if(p)throw m}}})().catch();const o=F(i);return s.closed().then(()=>{t.resolve(null),o.cancel()}).catch(c=>{t.reject(c)}),o.catch(c=>{t.resolve(null),s.close().catch()}),s.trackTimeout(o),t}delete(){const{stream_name:e,name:t}=this._info;return this.api.delete(e,t)}info(e=!1){if(e)return Promise.resolve(this._info);const{stream_name:t,name:r}=this._info;return this.api.info(t,r).then(s=>(this._info=s,this._info))}}class Di{api;consumerOpts;consumer;opts;cursor;stream;namePrefix;serial;currentConsumer;userCallback;iter;type;startSeq;constructor(e,t,r={}){this.api=e,this.stream=t,this.cursor={stream_seq:1,deliver_seq:0},this.namePrefix=Pe.next(),this.serial=0,this.currentConsumer=null,this.userCallback=null,this.iter=null,this.type=at.Unset,this.consumerOpts=r,this.startSeq=this.consumerOpts.opt_start_seq||0,this.cursor.stream_seq=this.startSeq>0?this.startSeq-1:0}getConsumerOpts(e){this.serial++;const r={name:`${this.namePrefix}_${this.serial}`,deliver_policy:Ee.StartSequence,opt_start_seq:e=0===e?1:e,ack_policy:Ie.None,inactive_threshold:xe(3e5),num_replicas:1};return!0===this.consumerOpts.headers_only&&(r.headers_only=!0),Array.isArray(this.consumerOpts.filterSubjects)&&(r.filter_subjects=this.consumerOpts.filterSubjects),"string"==typeof this.consumerOpts.filterSubjects&&(r.filter_subject=this.consumerOpts.filterSubjects),e===this.startSeq+1&&(r.deliver_policy=this.consumerOpts.deliver_policy||Ee.StartSequence,(this.consumerOpts.deliver_policy===Ee.LastPerSubject||this.consumerOpts.deliver_policy===Ee.New||this.consumerOpts.deliver_policy===Ee.Last)&&(delete r.opt_start_seq,r.deliver_policy=this.consumerOpts.deliver_policy),r.deliver_policy===Ee.LastPerSubject&&typeof r.filter_subjects>"u"&&typeof r.filter_subject>"u"&&(r.filter_subject=">"),this.consumerOpts.opt_start_time&&(delete r.opt_start_seq,r.deliver_policy=Ee.StartTime,r.opt_start_time=this.consumerOpts.opt_start_time),this.consumerOpts.inactive_threshold&&(r.inactive_threshold=xe(this.consumerOpts.inactive_threshold))),r}resetConsumer(e=0){var t=this;return(0,d.Z)(function*(){if(t.consumer)for(;;)try{yield t.delete();break}catch(i){if("TIMEOUT"!==i.message)throw i}e=0===e?1:e,t.cursor.deliver_seq=0;const r=t.getConsumerOpts(e);let s;for(r.max_deliver=1,r.mem_storage=!0;;)try{s=yield t.api.add(t.stream,r);break}catch(i){if("TIMEOUT"!==i.message)throw i}return s})()}internalHandler(e){return t=>{if(this.serial!==e)return;const r=t.info.deliverySequence;r===this.cursor.deliver_seq+1?(this.cursor.deliver_seq=r,this.cursor.stream_seq=t.info.streamSequence,this.userCallback?this.userCallback(t):this.iter?.push(t)):this.reset(this.opts)}}reset(e={max_messages:100,expires:3e4},t=!1){var r=this;return(0,d.Z)(function*(){r.currentConsumer=yield r.resetConsumer(r.cursor.stream_seq+1),null===r.iter&&(r.iter=new Fn),r.consumer=new $n(r.api,r.currentConsumer),e.callback=r.internalHandler(r.serial);let i=null;if(r.type===at.Fetch&&t)i=yield r.consumer.fetch(e);else{if(r.type!==at.Consume)return Promise.reject("reset called with unset consumer type");i=yield r.consumer.consume(e)}return r.iter.setSource(i),r.iter})()}consume(e={max_messages:100,expires:3e4}){if(this.type===at.Fetch)return Promise.reject(new Error("ordered consumer initialized as fetch"));if(this.type===at.Consume)return Promise.reject(new Error("ordered consumer doesn't support concurrent consume"));const{callback:t}=e;return t&&(this.userCallback=t),this.type=at.Consume,this.opts=e,this.reset(e)}fetch(e={max_messages:100,expires:3e4}){if(this.type===at.Consume)return Promise.reject(new Error("ordered consumer already initialized as consume"));if(!1===this.iter?.done)return Promise.reject(new Error("ordered consumer doesn't support concurrent fetch"));const{callback:t}=e;return t&&(this.userCallback=t),this.type=at.Fetch,this.opts=e,this.iter=new Fn,this.reset(e,!0)}next(e={expires:3e4}){var t=this;return(0,d.Z)(function*(){const r=R(),s=e;return s.max_messages=1,s.callback=o=>{t.userCallback=null,r.resolve(o)},(yield t.fetch(s)).iterClosed.then(()=>{r.resolve(null)}).catch(o=>{r.reject(o)}),r})()}delete(){return this.currentConsumer?this.api.delete(this.stream,this.currentConsumer.name).then(e=>Promise.resolve(e)).catch(e=>Promise.reject(e)).finally(()=>{this.currentConsumer=null}):Promise.resolve(!1)}info(e){var t=this;return(0,d.Z)(function*(){return null==t.currentConsumer?(t.currentConsumer=yield t.resetConsumer(t.serial),Promise.resolve(t.currentConsumer)):e&&t.currentConsumer?Promise.resolve(t.currentConsumer):t.api.info(t.stream,t.currentConsumer.name)})()}}function dr(n){if(void 0===n)return;const{domain:e}=n;if(void 0===e)return n;const t=Object.assign({},n);if(delete t.domain,""===e)return t;if(t.external)throw new Error("domain and external are both set");return t.external={api:`$JS.${e}.API`},t}const Gr="OBJ_";class qn{api;notified;constructor(e){this.api=e,this.notified=!1}checkVersion(){const e=this.api.nc.features.get(le.JS_SIMPLIFICATION);return e.ok?Promise.resolve():Promise.reject(new Error(`consumers framework is only supported on servers ${e.min} or better`))}get(e,t={}){var r=this;return(0,d.Z)(function*(){return"object"==typeof t?r.ordered(e,t):(yield r.checkVersion(),r.api.info(e,t).then(s=>void 0!==s.config.deliver_subject?Promise.reject(new Error("push consumer not supported")):new $n(r.api,s)).catch(s=>Promise.reject(s)))})()}ordered(e,t){var r=this;return(0,d.Z)(function*(){yield r.checkVersion();const s=r.api;return new Zr(s.nc,s.opts).info(e).then(o=>Promise.resolve(new Di(r.api,e,t))).catch(o=>Promise.reject(o))})()}}class hr{api;_info;constructor(e,t){this.api=e,this._info=t}get name(){return this._info.config.name}alternates(){return this.info().then(e=>e.alternates?e.alternates:[])}best(){var e=this;return(0,d.Z)(function*(){if(yield e.info(),e._info.alternates){const t=yield e.api.info(e._info.alternates[0].name);return new hr(e.api,t)}return e})()}info(e=!1,t){return e?Promise.resolve(this._info):this.api.info(this.name,t).then(r=>(this._info=r,this._info))}getConsumer(e){return new qn(new Fr(this.api.nc,this.api.opts)).get(this.name,e)}getMessage(e){return this.api.getMessage(this.name,e)}deleteMessage(e,t){return this.api.deleteMessage(this.name,e,t)}}const fr="KV-Operation",$i=/^[-/=.\w]+$/,qi=/^[-/=.>*\w]+$/,zi=/^[-\w]+$/;function Gi(n){if(n.startsWith(".")||n.endsWith(".")||!$i.test(n))throw new Error(`invalid key: ${n}`)}function Vi(n){if(n.startsWith(".")||n.endsWith(".")||!qi.test(n))throw new Error(`invalid key: ${n}`)}function Zi(n){if(n.startsWith(".")||n.endsWith("."))throw new Error(`invalid key: ${n}`);const e=n.split(".");let t=!1;for(let r=0;r<e.length;r++)switch(e[r]){case"*":t=!0;break;case">":if(r!==e.length-1)throw new Error(`invalid key: ${n}`);t=!0}return t}function pr(n){if(!zi.test(n))throw new Error(`invalid bucket name: ${n}`)}var n;(n=ct||(ct={})).MsgIdHdr="Nats-Msg-Id",n.ExpectedStreamHdr="Nats-Expected-Stream",n.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",n.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",n.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence";class Zt{js;jsm;stream;bucket;direct;codec;prefix;editPrefix;useJsPrefix;_prefixLen;constructor(e,t,r){pr(e),this.js=t,this.jsm=r,this.bucket=e,this.prefix="$KV",this.editPrefix="",this.useJsPrefix=!1,this._prefixLen=0}static create(e,t,r={}){return(0,d.Z)(function*(){pr(t);const s=yield e.jetstreamManager(),i=new Zt(t,e,s);return yield i.init(r),i})()}static bind(e,t,r={}){return(0,d.Z)(function*(){const s=yield e.jetstreamManager(),i=yield s.streams.info(`${Je}${t}`);pr(i.config.name);const o=new Zt(t,e,s);return Object.assign(o,i),o.codec=r.codec||{key:{encode:n=>n,decode:n=>n},value:{encode:n=>n,decode:n=>n}},o.direct=i.config.allow_direct??!1,o.initializePrefixes(i),o})()}init(e={}){var t=this;return(0,d.Z)(function*(){const r=Object.assign(function Fi(){return{replicas:1,history:1,timeout:2e3,maxBucketSize:-1,maxValueSize:-1,codec:{key:{encode:n=>n,decode:n=>n},value:{encode:n=>n,decode:n=>n}},storage:Tn.File}}(),e);t.codec=r.codec;const s={};t.stream=s.name=e.streamName??t.bucketName(),s.retention=jn.Limits,s.max_msgs_per_subject=r.history,r.maxBucketSize&&(r.max_bytes=r.maxBucketSize),r.max_bytes&&(s.max_bytes=r.max_bytes),s.max_msg_size=r.maxValueSize,s.storage=r.storage;const i=e.placementCluster??"";if(i&&(e.placement={},e.placement.cluster=i,e.placement.tags=[]),e.placement&&(s.placement=e.placement),e.republish&&(s.republish=e.republish),e.description&&(s.description=e.description),e.mirror){const E=Object.assign({},e.mirror);E.name.startsWith(Je)||(E.name=`${Je}${E.name}`),s.mirror=E,s.mirror_direct=!0}else if(e.sources){const E=e.sources.map(O=>{const j=Object.assign({},O);j.name.startsWith(Je)||(j.name=`${Je}${j.name}`)});s.sources=E}else s.subjects=[t.subjectForBucket()];e.metadata&&(s.metadata=e.metadata);const o=t.js.nc,c=o.getServerVersion(),p=!!c&&jr(c,bt("2.7.2"))>=0;s.discard=p?lr.New:lr.Old;const{ok:m,min:y}=o.features.get(le.JS_ALLOW_DIRECT);if(!m&&!0===e.allow_direct)return Promise.reject(new Error(`allow_direct is not available on server version ${c?`${c.major}.${c.minor}.${c.micro}`:"unknown"} - requires ${y}`));let g;e.allow_direct="boolean"==typeof e.allow_direct?e.allow_direct:m,s.allow_direct=e.allow_direct,t.direct=s.allow_direct,s.num_replicas=r.replicas,r.ttl&&(s.max_age=xe(r.ttl)),s.allow_rollup_hdrs=!0;try{g=yield t.jsm.streams.info(s.name),!g.config.allow_direct&&!0===t.direct&&(t.direct=!1)}catch(E){if("stream not found"!==E.message)throw E;g=yield t.jsm.streams.add(s)}t.initializePrefixes(g)})()}initializePrefixes(e){this._prefixLen=0,this.prefix=`$KV.${this.bucket}`,this.useJsPrefix="$JS.API"!==this.js.apiPrefix;const{mirror:t}=e.config;if(t){let r=t.name;if(r.startsWith(Je)&&(r=r.substring(3)),t.external&&""!==t.external.api){const s=t.name.substring(3);this.useJsPrefix=!1,this.prefix=`$KV.${s}`,this.editPrefix=`${t.external.api}.$KV.${r}`}else this.editPrefix=this.prefix}}bucketName(){return this.stream??`${Je}${this.bucket}`}subjectForBucket(){return`${this.prefix}.${this.bucket}.>`}subjectForKey(e,t=!1){const r=[];return t?(this.useJsPrefix&&r.push(this.js.apiPrefix),r.push(""!==this.editPrefix?this.editPrefix:this.prefix)):this.prefix&&r.push(this.prefix),r.push(e),r.join(".")}fullKeyName(e){return""!==this.prefix?`${this.prefix}.${e}`:`$KV.${this.bucket}.${e}`}get prefixLen(){return 0===this._prefixLen&&(this._prefixLen=this.prefix.length+1),this._prefixLen}encodeKey(e){const t=[];for(const r of e.split("."))switch(r){case">":case"*":t.push(r);break;default:t.push(this.codec.key.encode(r))}return t.join(".")}decodeKey(e){const t=[];for(const r of e.split("."))switch(r){case">":case"*":t.push(r);break;default:t.push(this.codec.key.decode(r))}return t.join(".")}validateKey=Gi;validateSearchKey=Vi;hasWildcards=Zi;close(){return Promise.resolve()}dataLen(e,t){const r=t&&t.get(Fe.MessageSizeHdr)||"";return""!==r?parseInt(r,10):e.length}smToEntry(e){return new Yi(this.bucket,this.prefixLen,e)}jmToEntry(e){const t=this.decodeKey(e.subject.substring(this.prefixLen));return new Xi(this.bucket,t,e)}create(e,t){var r=this;return(0,d.Z)(function*(){let s;try{const o=yield r.put(e,t,{previousSeq:0});return Promise.resolve(o)}catch(o){if(s=o,10071!==o?.api_error?.err_code)return Promise.reject(o)}let i=0;try{const o=yield r.get(e);return"DEL"===o?.operation||"PURGE"===o?.operation?(i=null!==o?o.revision:0,r.update(e,t,i)):Promise.reject(s)}catch(o){return Promise.reject(o)}})()}update(e,t,r){if(r<=0)throw new Error("version must be greater than 0");return this.put(e,t,{previousSeq:r})}put(e,t,r={}){var s=this;return(0,d.Z)(function*(){const i=s.encodeKey(e);s.validateKey(i);const o={};if(void 0!==r.previousSeq){const c=ot();o.headers=c,c.set(ct.ExpectedLastSubjectSequenceHdr,`${r.previousSeq}`)}try{return(yield s.js.publish(s.subjectForKey(i,!0),t,o)).seq}catch(c){const p=c;return p.isJetStreamError()?(p.message=p.api_error?.description,p.code=`${p.api_error?.code}`,Promise.reject(p)):Promise.reject(c)}})()}get(e,t){var r=this;return(0,d.Z)(function*(){const s=r.encodeKey(e);r.validateKey(s);let o,i={last_by_subj:r.subjectForKey(s)};t&&t.revision>0&&(i={seq:t.revision});try{o=r.direct?yield r.jsm.direct.getMessage(r.bucketName(),i):yield r.jsm.streams.getMessage(r.bucketName(),i);const c=r.smToEntry(o);return c.key!==s?null:c}catch(c){if(c.code===A.JetStream404NoMessages)return null;throw c}})()}purge(e){return this._deleteOrPurge(e,"PURGE")}delete(e){return this._deleteOrPurge(e,"DEL")}purgeDeletes(e=18e5){var t=this;return(0,d.Z)(function*(){const r=R(),s=[],i=yield t.watch({key:">",initializedFn:()=>{r.resolve()}});(0,d.Z)(function*(){var g,m=!1,y=!1;try{for(var O,E=(0,J.Z)(i);m=!(O=yield E.next()).done;m=!1){const j=O.value;("DEL"===j.operation||"PURGE"===j.operation)&&s.push(j)}}catch(j){y=!0,g=j}finally{try{m&&null!=E.return&&(yield E.return())}finally{if(y)throw g}}})().then(),yield r,i.stop();const o=Date.now()-e,c=s.map(m=>{const y=t.subjectForKey(m.key);return m.created.getTime()>=o?t.jsm.streams.purge(t.stream,{filter:y,keep:1}):t.jsm.streams.purge(t.stream,{filter:y,keep:0})}),p=yield Promise.all(c);return p.unshift({success:!0,purged:0}),p.reduce((m,y)=>(m.purged+=y.purged,m))})()}_deleteOrPurge(e,t){var r=this;return(0,d.Z)(function*(){if(!r.hasWildcards(e))return r._doDeleteOrPurge(e,t);const s=yield r.keys(e),i=[];var p,o=!1,c=!1;try{for(var y,m=(0,J.Z)(s);o=!(y=yield m.next()).done;o=!1)i.push(r._doDeleteOrPurge(y.value,t)),100===i.length&&(yield Promise.all(i),i.length=0)}catch(g){c=!0,p=g}finally{try{o&&null!=m.return&&(yield m.return())}finally{if(c)throw p}}i.length>0&&(yield Promise.all(i))})()}_doDeleteOrPurge(e,t){var r=this;return(0,d.Z)(function*(){const s=r.encodeKey(e);r.validateKey(s);const i=ot();i.set(fr,t),"PURGE"===t&&i.set(Fe.RollupHdr,Fe.RollupValueSubject),yield r.js.publish(r.subjectForKey(s,!0),ge,{headers:i})})()}_buildCC(e,t,r={}){const s=this.encodeKey(e);this.validateSearchKey(e);let i=Ee.LastPerSubject;return t===st.AllHistory&&(i=Ee.All),t===st.UpdatesOnly&&(i=Ee.New),Object.assign({deliver_policy:i,ack_policy:Ie.None,filter_subject:this.fullKeyName(s),flow_control:!0,idle_heartbeat:xe(5e3)},r)}remove(e){return this.purge(e)}history(e={}){var t=this;return(0,d.Z)(function*(){const r=e.key??">",s=new Te,i={};let o;i.headers_only=e.headers_only||!1,o=()=>{s.stop()};let c=0;const p=t._buildCC(r,st.AllHistory,i),m=p.filter_subject,y=ft(p);y.bindStream(t.stream),y.orderedConsumer(),y.callback((E,O)=>{if(E)s.stop(E);else if(O){const j=t.jmToEntry(O);s.push(j),s.received++,(o&&c>0&&s.received>=c||0===O.info.pending)&&(s.push(o),o=void 0)}});const g=yield t.js.subscribe(m,y);if(o){const{info:{last:E}}=g,O=E.num_pending+E.delivered.consumer_seq;if(0===O||s.received>=O)try{o()}catch(j){s.stop(j)}finally{o=void 0}else c=O}return s._data=g,s.iterClosed.then(()=>{g.unsubscribe()}),g.closed.then(()=>{s.stop()}).catch(E=>{s.stop(E)}),s})()}watch(e={}){var t=this;return(0,d.Z)(function*(){const r=e.key??">",s=new Te,i={};i.headers_only=e.headers_only||!1;let o=st.LastValue;e.include===st.AllHistory?o=st.AllHistory:e.include===st.UpdatesOnly&&(o=st.UpdatesOnly);const c=!0===e.ignoreDeletes;let p=e.initializedFn,m=0;const y=t._buildCC(r,o,i),g=y.filter_subject,E=ft(y);E.bindStream(t.stream),E.orderedConsumer(),E.callback((j,B)=>{if(j)s.stop(j);else if(B){const ue=t.jmToEntry(B);if(c&&"DEL"===ue.operation)return;s.push(ue),s.received++,p&&(m>0&&s.received>=m||0===B.info.pending)&&(s.push(p),p=void 0)}});const O=yield t.js.subscribe(g,E);if(p){const{info:{last:j}}=O,B=j.num_pending+j.delivered.consumer_seq;if(0===B||s.received>=B)try{p()}catch(ue){s.stop(ue)}finally{p=void 0}else m=B}return s._data=O,s.iterClosed.then(()=>{O.unsubscribe()}),O.closed.then(()=>{s.stop()}).catch(j=>{s.stop(j)}),s})()}keys(e=">"){var t=this;return(0,d.Z)(function*(){const r=new Te,s=t._buildCC(e,st.LastValue,{headers_only:!0}),i=s.filter_subject,o=ft(s);o.bindStream(t.stream),o.orderedConsumer();const c=yield t.js.subscribe(i,o);return(0,d.Z)(function*(){var g,m=!1,y=!1;try{for(var O,E=(0,J.Z)(c);m=!(O=yield E.next()).done;m=!1){const j=O.value;{const B=j.headers?.get(fr);if("DEL"!==B&&"PURGE"!==B){const ue=t.decodeKey(j.subject.substring(t.prefixLen));r.push(ue)}0===j.info.pending&&c.unsubscribe()}}}catch(j){y=!0,g=j}finally{try{m&&null!=E.return&&(yield E.return())}finally{if(y)throw g}}})().then(()=>{r.stop()}).catch(m=>{r.stop(m)}),0===c.info.last.num_pending&&c.unsubscribe(),r})()}purgeBucket(e){return this.jsm.streams.purge(this.bucketName(),e)}destroy(){return this.jsm.streams.delete(this.bucketName())}status(){var e=this;return(0,d.Z)(function*(){const r=e.js.nc.info?.cluster??"",s=e.bucketName(),i=yield e.jsm.streams.info(s);return new Vn(i,r)})()}}class Vn{si;cluster;constructor(e,t=""){this.si=e,this.cluster=t}get bucket(){return this.si.config.name.startsWith(Je)?this.si.config.name.substring(3):this.si.config.name}get values(){return this.si.state.messages}get history(){return this.si.config.max_msgs_per_subject}get ttl(){return Rr(this.si.config.max_age)}get bucket_location(){return this.cluster}get backingStore(){return this.si.config.storage}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get description(){return this.si.config.description??""}get maxBucketSize(){return this.si.config.max_bytes}get maxValueSize(){return this.si.config.max_msg_size}get max_bytes(){return this.si.config.max_bytes}get placement(){return this.si.config.placement||{cluster:"",tags:[]}}get placementCluster(){return this.si.config.placement?.cluster??""}get republish(){return this.si.config.republish??{src:"",dest:""}}get streamInfo(){return this.si}get size(){return this.si.state.bytes}get metadata(){return this.si.config.metadata??{}}}const Zn="SHA-256=";class Vr{si;backingStore;constructor(e){this.si=e,this.backingStore="JetStream"}get bucket(){return function Ki(n){return n.startsWith(Gr)?n.substring(4):n}(this.si.config.name)}get description(){return this.si.config.description??""}get ttl(){return this.si.config.max_age}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get sealed(){return this.si.config.sealed}get size(){return this.si.state.bytes}get streamInfo(){return this.si}get metadata(){return this.si.config.metadata}}class Zr extends Dt{constructor(e,t){super(e,t)}checkStreamConfigVersions(e){const t=this.nc;if(e.metadata){const{min:s,ok:i}=t.features.get(le.JS_STREAM_CONSUMER_METADATA);if(!i)throw new Error(`stream 'metadata' requires server ${s}`)}if(e.first_seq){const{min:s,ok:i}=t.features.get(le.JS_STREAM_FIRST_SEQ);if(!i)throw new Error(`stream 'first_seq' requires server ${s}`)}if(e.subject_transform){const{min:s,ok:i}=t.features.get(le.JS_STREAM_SUBJECT_TRANSFORM);if(!i)throw new Error(`stream 'subject_transform' requires server ${s}`)}if(e.compression){const{min:s,ok:i}=t.features.get(le.JS_STREAM_COMPRESSION);if(!i)throw new Error(`stream 'compression' requires server ${s}`)}if(e.consumer_limits){const{min:s,ok:i}=t.features.get(le.JS_DEFAULT_CONSUMER_LIMITS);if(!i)throw new Error(`stream 'consumer_limits' requires server ${s}`)}function r(s,i){if((i.subject_transforms?.length||0)>0){const{min:c,ok:p}=t.features.get(le.JS_STREAM_SOURCE_SUBJECT_TRANSFORM);if(!p)throw new Error(`${s} 'subject_transforms' requires server ${c}`)}}e.sources&&e.sources.forEach(s=>{r("stream sources",s)}),e.mirror&&r("stream mirror",e.mirror)}add(e={}){var t=this;return(0,d.Z)(function*(){t.checkStreamConfigVersions(e),De(e.name),e.mirror=dr(e.mirror),e.sources=e.sources?.map(dr);const s=yield t._request(`${t.prefix}.STREAM.CREATE.${e.name}`,e);return t._fixInfo(s),s})()}delete(e){var t=this;return(0,d.Z)(function*(){return De(e),(yield t._request(`${t.prefix}.STREAM.DELETE.${e}`)).success})()}update(e,t={}){var r=this;return(0,d.Z)(function*(){if("object"==typeof e){const p=e;e=p.name,t=p,console.trace("\x1b[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  \x1b[0m")}r.checkStreamConfigVersions(t),De(e);const s=yield r.info(e),i=Object.assign(s.config,t);i.mirror=dr(i.mirror),i.sources=i.sources?.map(dr);const c=yield r._request(`${r.prefix}.STREAM.UPDATE.${e}`,i);return r._fixInfo(c),c})()}info(e,t){var r=this;return(0,d.Z)(function*(){De(e);const s=`${r.prefix}.STREAM.INFO.${e}`;let o=yield r._request(s,t),{total:c,limit:p}=o,m=o.state.subjects?Object.getOwnPropertyNames(o.state.subjects).length:1;if(c&&c>m){const y=[o],g=t||{};let E=0;for(;c>m;){E++,g.offset=p*E;const j=yield r._request(s,g);c=j.total,y.push(j);const B=Object.getOwnPropertyNames(j.state.subjects).length;if(m+=B,B<p)break}let O={};for(let j=0;j<y.length;j++)o=y[j],o.state.subjects&&(O=Object.assign(O,o.state.subjects));o.offset=0,o.total=0,o.limit=0,o.state.subjects=O}return r._fixInfo(o),o})()}list(e=""){return new zt(`${this.prefix}.STREAM.LIST`,i=>{const o=i;return o.streams.forEach(c=>{this._fixInfo(c)}),o.streams},this,e?.length?{subject:e}:{})}_fixInfo(e){e.config.sealed=e.config.sealed||!1,e.config.deny_delete=e.config.deny_delete||!1,e.config.deny_purge=e.config.deny_purge||!1,e.config.allow_rollup_hdrs=e.config.allow_rollup_hdrs||!1}purge(e,t){var r=this;return(0,d.Z)(function*(){if(t){const{keep:i,seq:o}=t;if("number"==typeof i&&"number"==typeof o)throw new Error("can specify one of keep or seq")}return De(e),yield r._request(`${r.prefix}.STREAM.PURGE.${e}`,t)})()}deleteMessage(e,t,r=!0){var s=this;return(0,d.Z)(function*(){De(e);const i={seq:t};return r||(i.no_erase=!0),(yield s._request(`${s.prefix}.STREAM.MSG.DELETE.${e}`,i)).success})()}getMessage(e,t){var r=this;return(0,d.Z)(function*(){De(e);const i=yield r._request(`${r.prefix}.STREAM.MSG.GET.${e}`,t);return new Ji(i)})()}find(e){return this.findStream(e)}listKvs(){return new zt(`${this.prefix}.STREAM.LIST`,r=>{const i=r.streams.filter(p=>p.config.name.startsWith(Je));i.forEach(p=>{this._fixInfo(p)});let o="";return i.length&&(o=this.nc.info?.cluster??""),i.map(p=>new Vn(p,o))},this)}listObjectStores(){return new zt(`${this.prefix}.STREAM.LIST`,r=>{const i=r.streams.filter(c=>c.config.name.startsWith(Gr));return i.forEach(c=>{this._fixInfo(c)}),i.map(c=>new Vr(c))},this)}names(e=""){return new zt(`${this.prefix}.STREAM.NAMES`,i=>i.streams,this,e?.length?{subject:e}:{})}get(e){var t=this;return(0,d.Z)(function*(){const r=yield t.info(e);return Promise.resolve(new hr(t,r))})()}}let Ji=(()=>class n{_header;smr;static jc;constructor(t){this.smr=t}get subject(){return this.smr.message.subject}get seq(){return this.smr.message.seq}get timestamp(){return this.smr.message.time}get time(){return new Date(Date.parse(this.timestamp))}get data(){return this.smr.message.data?this._parse(this.smr.message.data):ge}get header(){if(!this._header)if(this.smr.message.hdrs){const t=this._parse(this.smr.message.hdrs);this._header=dt.decode(t)}else this._header=ot();return this._header}_parse(t){const r=atob(t),s=r.length,i=new Uint8Array(s);for(let o=0;o<s;o++)i[o]=r.charCodeAt(o);return i}json(t){return ze(t).decode(this.data)}string(){return de.decode(this.data)}})();class Wi{api;constructor(e){this.api=e}get(e){return this.api.info(e).then(t=>new hr(this.api,t))}}class Yi{bucket;sm;prefixLen;constructor(e,t,r){this.bucket=e,this.prefixLen=t,this.sm=r}get key(){return this.sm.subject.substring(this.prefixLen)}get value(){return this.sm.data}get delta(){return 0}get created(){return this.sm.time}get revision(){return this.sm.seq}get operation(){return this.sm.header.get(fr)||"PUT"}get length(){const e=this.sm.header.get(Fe.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class Xi{bucket;key;sm;constructor(e,t,r){this.bucket=e,this.key=t,this.sm=r}get value(){return this.sm.data}get created(){return new Date(Rr(this.sm.info.timestampNanos))}get revision(){return this.sm.seq}get operation(){return this.sm.headers?.get(fr)||"PUT"}get delta(){return this.sm.info.pending}get length(){const e=this.sm.headers?.get(Fe.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class Hr{info;hdrs;constructor(e){this.info=e}get name(){return this.info.name}get description(){return this.info.description??""}get headers(){return this.hdrs||(this.hdrs=dt.fromRecord(this.info.headers||{})),this.hdrs}get options(){return this.info.options}get bucket(){return this.info.bucket}get chunks(){return this.info.chunks}get deleted(){return this.info.deleted??!1}get digest(){return this.info.digest}get mtime(){return this.info.mtime}get nuid(){return this.info.nuid}get size(){return this.info.size}get revision(){return this.info.revision}get metadata(){return this.info.metadata||{}}isLink(){return void 0!==this.info.options?.link}}function Hn(n){const e={name:n.name,description:n.description??"",options:n.options,metadata:n.metadata};return n.headers&&(e.headers=n.headers.toRecord()),e}class Ht{jsm;js;stream;name;constructor(e,t,r){this.name=e,this.jsm=t,this.js=r}_checkNotEmpty(e){return e&&0!==e.length?{name:e}:{name:e,error:new Error("name cannot be empty")}}info(e){var t=this;return(0,d.Z)(function*(){const r=yield t.rawInfo(e);return r?new Hr(r):null})()}list(){var e=this;return(0,d.Z)(function*(){const t=[],r=yield e.watch({ignoreDeletes:!0,includeHistory:!0});var o,s=!1,i=!1;try{for(var p,c=(0,J.Z)(r);s=!(p=yield c.next()).done;s=!1){const m=p.value;if(null===m)break;t.push(m)}}catch(m){i=!0,o=m}finally{try{s&&null!=c.return&&(yield c.return())}finally{if(i)throw o}}return Promise.resolve(t)})()}rawInfo(e){var t=this;return(0,d.Z)(function*(){const{name:r,error:s}=t._checkNotEmpty(e);if(s)return Promise.reject(s);const i=t._metaSubject(r);try{const o=yield t.jsm.streams.getMessage(t.stream,{last_by_subj:i}),p=ze().decode(o.data);return p.revision=o.seq,p}catch(o){return"404"===o.code?null:Promise.reject(o)}})()}_si(e){var t=this;return(0,d.Z)(function*(){try{return yield t.jsm.streams.info(t.stream,e)}catch(r){return"404"===r.code?null:Promise.reject(r)}})()}seal(){var e=this;return(0,d.Z)(function*(){let t=yield e._si();return null===t?Promise.reject(new Error("object store not found")):(t.config.sealed=!0,t=yield e.jsm.streams.update(e.stream,t.config),Promise.resolve(new Vr(t)))})()}status(e){var t=this;return(0,d.Z)(function*(){const r=yield t._si(e);return null===r?Promise.reject(new Error("object store not found")):Promise.resolve(new Vr(r))})()}destroy(){return this.jsm.streams.delete(this.stream)}_put(e,t,r){var s=this;return(0,d.Z)(function*(){const i=s.js.getOptions();(r=r||{timeout:i.timeout}).timeout=r.timeout||i.timeout,r.previousRevision=r.previousRevision??void 0;const{timeout:o,previousRevision:c}=r,m=s.js.nc.info?.max_payload||1024;(e=e||{}).options=e.options||{};let y=e.options?.max_chunk_size||131072;y=y>m?m:y,e.options.max_chunk_size=y;const g=yield s.info(e.name),{name:E,error:O}=s._checkNotEmpty(e.name);if(O)return Promise.reject(O);const j=Pe.next(),B=s._chunkSubject(j),ue=s._metaSubject(E),X=Object.assign({bucket:s.name,nuid:j,size:0,chunks:0},Hn(e)),Oe=R(),Ae=[],Ye=new ye;try{const pt=t?t.getReader():null,At=new Bn;for(;;){const{done:_r,value:yt}=pt?yield pt.read():{done:!0,value:void 0};if(_r){if(Ye.size()>0){const mt=Ye.drain();At.update(mt),X.chunks++,X.size+=mt.length,Ae.push(s.js.publish(B,mt,{timeout:o}))}yield Promise.all(Ae),Ae.length=0,X.mtime=(new Date).toISOString();const Xe=At.digest("base64"),Mt=Xe.length%3,gr=Mt>0?"=".repeat(Mt):"";X.digest=`${Zn}${Xe}${gr}`,X.deleted=!1;const kt=ot();"number"==typeof c&&kt.set(ct.ExpectedLastSubjectSequenceHdr,`${c}`),kt.set(Fe.RollupHdr,Fe.RollupValueSubject);const Wt=yield s.js.publish(ue,ze().encode(X),{headers:kt,timeout:o});if(X.revision=Wt.seq,g)try{yield s.jsm.streams.purge(s.stream,{filter:`$O.${s.name}.C.${g.nuid}`})}catch{}Oe.resolve(new Hr(X));break}if(yt)for(Ye.fill(yt);Ye.size()>y;){X.chunks++,X.size+=y;const Xe=Ye.drain(e.options.max_chunk_size);At.update(Xe),Ae.push(s.js.publish(B,Xe,{timeout:o}))}}}catch(pt){yield s.jsm.streams.purge(s.stream,{filter:B}),Oe.reject(pt)}return Oe})()}putBlob(e,t,r){return null===t&&(t=new Uint8Array(0)),this.put(e,function s(i){return new ReadableStream({pull(o){o.enqueue(i),o.close()}})}(t),r)}put(e,t,r){return e?.options?.link?Promise.reject(new Error("link cannot be set when putting the object in bucket")):this._put(e,t,r)}getBlob(e){var t=this;return(0,d.Z)(function*(){function s(){return(s=(0,d.Z)(function*(c){const p=new ye,m=c.getReader();for(;;){const{done:y,value:g}=yield m.read();if(y)return p.drain();g&&g.length&&p.fill(g)}})).apply(this,arguments)}const i=yield t.get(e);if(null===i)return Promise.resolve(null);const o=yield Promise.all([i.error,function r(c){return s.apply(this,arguments)}(i.data)]);return o[0]?Promise.reject(o[0]):Promise.resolve(o[1])})()}get(e){var t=this;return(0,d.Z)(function*(){const r=yield t.rawInfo(e);if(null===r||r.deleted)return Promise.resolve(null);if(r.options&&r.options.link){const g=r.options.link.name||"";if(""===g)throw new Error("link is a bucket");return(r.options.link.bucket!==t.name?yield Ht.create(t.js,r.options.link.bucket):t).get(g)}const s=R(),i={info:new Hr(r),error:s};if(0===r.size)return i.data=function Qi(){return new ReadableStream({pull(n){n.enqueue(new Uint8Array(0)),n.close()}})}(),s.resolve(null),Promise.resolve(i);let o;const c=ft();c.orderedConsumer();const p=new Bn,m=`$O.${t.name}.C.${r.nuid}`,y=yield t.js.subscribe(m,c);return(0,d.Z)(function*(){var O,g=!1,E=!1;try{for(var B,j=(0,J.Z)(y);g=!(B=yield j.next()).done;g=!1){const ue=B.value;if(ue.data.length>0&&(p.update(ue.data),o.enqueue(ue.data)),0===ue.info.pending){const X=p.digest("base64"),Oe=X.length%3,Ae=Oe>0?"=".repeat(Oe):"",Ye=`${Zn}${X}${Ae}`;Ye!==r.digest?o.error(new Error(`received a corrupt object, digests do not match received: ${r.digest} calculated ${Ye}`)):o.close(),y.unsubscribe()}}}catch(ue){E=!0,O=ue}finally{try{g&&null!=j.return&&(yield j.return())}finally{if(E)throw O}}})().then(()=>{s.resolve()}).catch(g=>{o.error(g),s.reject(g)}),i.data=new ReadableStream({start(g){o=g},cancel(){y.unsubscribe()}}),i})()}linkStore(e,t){if(!(t instanceof Ht))return Promise.reject("bucket required");const r=t,{name:s,error:i}=this._checkNotEmpty(e);return i?Promise.reject(i):this._put({name:s,options:{link:{bucket:r.name}}},null)}link(e,t){var r=this;return(0,d.Z)(function*(){const{name:s,error:i}=r._checkNotEmpty(e);if(i)return Promise.reject(i);if(t.deleted)return Promise.reject(new Error("src object is deleted"));if(t.isLink())return Promise.reject(new Error("src object is a link"));const o=yield r.rawInfo(e);if(null!==o&&!o.deleted)return Promise.reject(new Error("an object already exists with that name"));const p={name:s,options:{link:{bucket:t.bucket,name:t.name}}};yield r.js.publish(r._metaSubject(e),JSON.stringify(p));const m=yield r.info(e);return Promise.resolve(m)})()}delete(e){var t=this;return(0,d.Z)(function*(){const r=yield t.rawInfo(e);if(null===r)return Promise.resolve({purged:0,success:!1});r.deleted=!0,r.size=0,r.chunks=0,r.digest="";const s=ze(),i=ot();return i.set(Fe.RollupHdr,Fe.RollupValueSubject),yield t.js.publish(t._metaSubject(r.name),s.encode(r),{headers:i}),t.jsm.streams.purge(t.stream,{filter:t._chunkSubject(r.nuid)})})()}update(e,t={}){var r=this;return(0,d.Z)(function*(){const s=yield r.rawInfo(e);if(null===s)return Promise.reject(new Error("object not found"));if(s.deleted)return Promise.reject(new Error("cannot update meta for a deleted object"));t.name=t.name??s.name;const{name:i,error:o}=r._checkNotEmpty(t.name);if(o)return Promise.reject(o);if(e!==t.name){const m=yield r.info(t.name);if(m&&!m.deleted)return Promise.reject(new Error("an object already exists with that name"))}t.name=i;const c=Object.assign({},s,Hn(t)),p=yield r.js.publish(r._metaSubject(c.name),JSON.stringify(c));return e!==t.name&&(yield r.jsm.streams.purge(r.stream,{filter:r._metaSubject(e)})),Promise.resolve(p)})()}watch(e={}){var t=this;return(0,d.Z)(function*(){e.includeHistory=e.includeHistory??!1,e.ignoreDeletes=e.ignoreDeletes??!1;let r=!1;const s=new Te,i=t._metaSubjectAll();try{yield t.jsm.streams.getMessage(t.stream,{last_by_subj:i})}catch(m){"404"===m.code?(s.push(null),r=!0):s.stop(m)}const o=ze(),c=ft();c.orderedConsumer(),e.includeHistory?c.deliverLastPerSubject():(r=!0,c.deliverNew()),c.callback((m,y)=>{if(m)s.stop(m);else if(null!==y){const g=o.decode(y.data);g.deleted&&!0===e.ignoreDeletes||s.push(g),0===y.info?.pending&&!r&&(r=!0,s.push(null))}});const p=yield t.js.subscribe(i,c);return s._data=p,s.iterClosed.then(()=>{p.unsubscribe()}),p.closed.then(()=>{s.stop()}).catch(m=>{s.stop(m)}),s})()}_chunkSubject(e){return`$O.${this.name}.C.${e}`}_metaSubject(e){return`$O.${this.name}.M.${Ft.encode(e)}`}_metaSubjectAll(){return`$O.${this.name}.M.>`}init(e={}){var t=this;return(0,d.Z)(function*(){try{t.stream=function Hi(n){return pr(n),`${Gr}${n}`}(t.name)}catch(i){return Promise.reject(i)}const r=e?.ttl||0;delete e.ttl;const s=Object.assign({max_age:r},e);s.name=t.stream,s.allow_direct=!0,s.allow_rollup_hdrs=!0,s.discard=lr.New,s.subjects=[`$O.${t.name}.C.>`,`$O.${t.name}.M.>`],e.placement&&(s.placement=e.placement),e.metadata&&(s.metadata=e.metadata);try{yield t.jsm.streams.info(s.name)}catch(i){"stream not found"===i.message&&(yield t.jsm.streams.add(s))}})()}static create(e,t,r={}){return(0,d.Z)(function*(){const s=yield e.jetstreamManager(),i=new Ht(t,s,e);return yield i.init(r),Promise.resolve(i)})()}}class eo{js;jsm;constructor(e){this.js=e}kv(e,t={}){const r=this.js,{ok:s,min:i}=r.nc.features.get(le.JS_KV);return s?t.bindOnly?Zt.bind(this.js,e):Zt.create(this.js,e,t):Promise.reject(new Error(`kv is only supported on servers ${i} or better`))}os(e,t={}){if("function"!=typeof crypto?.subtle?.digest)return Promise.reject(new Error("objectstore: unable to calculate hashes - crypto.subtle.digest with sha256 support is required"));const r=this.js,{ok:s,min:i}=r.nc.features.get(le.JS_OBJECTSTORE);return s?Ht.create(this.js,e,t):Promise.reject(new Error(`objectstore is only supported on servers ${i} or better`))}}class Kr extends Dt{consumers;streams;consumerAPI;streamAPI;constructor(e,t){super(e,t),this.consumerAPI=new Fr(e,t),this.streamAPI=new Zr(e,t),this.consumers=new qn(this.consumerAPI),this.streams=new Wi(this.streamAPI)}jetstreamManager(){return this.nc.jetstreamManager(this.opts)}get apiPrefix(){return this.prefix}get views(){return new eo(this)}publish(e,t=ge,r){var s=this;return(0,d.Z)(function*(){(r=r||{}).expect=r.expect||{};const i=r?.headers||ot();r&&(r.msgID&&i.set(ct.MsgIdHdr,r.msgID),r.expect.lastMsgID&&i.set(ct.ExpectedLastMsgIdHdr,r.expect.lastMsgID),r.expect.streamName&&i.set(ct.ExpectedStreamHdr,r.expect.streamName),"number"==typeof r.expect.lastSequence&&i.set(ct.ExpectedLastSeqHdr,`${r.expect.lastSequence}`),"number"==typeof r.expect.lastSubjectSequence&&i.set(ct.ExpectedLastSubjectSequenceHdr,`${r.expect.lastSubjectSequence}`));const o=r.timeout||s.timeout,c={};o&&(c.timeout=o),r&&(c.headers=i);let y,{retries:p,retry_delay:m}=r;p=p||1,m=m||250;for(let E=0;E<p;E++)try{y=yield s.nc.request(e,t,c);break}catch(O){if(!("503"===O.code&&E+1<p))throw O;yield U(m)}const g=s.parseJsResponse(y);if(""===g.stream)throw N.errorForCode(A.JetStreamInvalidAck);return g.duplicate=!!g.duplicate&&g.duplicate,g})()}pull(e,t,r=0){var s=this;return(0,d.Z)(function*(){De(e),Et(t);let i=s.timeout;r>i&&(i=r);const o={batch:1,no_wait:0===(r=r<0?0:xe(r)),expires:r},c=yield s.nc.request(`${s.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,s.jc.encode(o),{noMux:!0,timeout:i}),p=Ct(c);if(p)throw p;return Vt(c)})()}fetch(e,t,r={}){De(e),Et(t);let s=null;const i=(r.max_bytes??0)>0;let o=0;const c=i?r.max_bytes:0;let p=null;const m={};if(m.batch=r.batch||1,c){const X=this.nc.features.get(le.JS_PULL_MAX_BYTES);if(!X.ok)throw new Error(`max_bytes is only supported on servers ${X.min} or better`);m.max_bytes=c}m.no_wait=r.no_wait||!1,m.no_wait&&m.expires&&(m.expires=0);const y=r.expires||0;if(y&&(m.expires=xe(y)),0===y&&!1===m.no_wait)throw new Error("expires or no_wait is required");const g=r.idle_heartbeat||0;g&&(m.idle_heartbeat=xe(g),!0===r.delay_heartbeat&&(m.idle_heartbeat=xe(4*g)));const E=new Te,O=m.batch;let j=0;E.protocolFilterFn=(X,Oe=!1)=>!Ur(X.msg)||(p?.work(),!1),E.dispatchedFn=X=>{if(X){if(i&&(o+=X.data.length),j++,s&&0===X.info.pending)return;(1===E.getPending()&&0===X.info.pending||O===j||c>0&&o>=c)&&E.stop()}};const B=S(this.nc.options.inboxPrefix),ue=this.nc.subscribe(B,{max:r.batch,callback:(X,Oe)=>{null===X&&(X=Ct(Oe)),null!==X?(s&&(s.cancel(),s=null),function $e(n){return"string"==typeof n.code}(X)?E.stop(null===Jn(X)?void 0:X):E.stop(X)):(p?.work(),E.received++,E.push(Vt(Oe)))}});return y&&(s=F(y),s.catch(()=>{ue.isClosed()||(ue.drain().catch(()=>{}),s=null),p&&p.cancel()})),(0,d.Z)(function*(){try{g&&(p=new $r(g,X=>(E.push(()=>{E.err=new N(`${Ke.IdleHeartbeatMissed}: ${X}`,A.JetStreamIdleHeartBeat)}),!0)))}catch{}yield ue.closed,null!==s&&(s.cancel(),s=null),p&&p.cancel(),E.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(m),{reply:B}),E}pullSubscribe(e,t=ft()){var r=this;return(0,d.Z)(function*(){const s=yield r._processOptions(e,t);if(s.ordered)throw new Error("pull subscribers cannot be be ordered");if(s.config.deliver_subject)throw new Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");const i=s.config.ack_policy;if(i===Ie.None||i===Ie.All)throw new Error("ack policy for pull consumers must be explicit");const o=r._buildTypedSubscriptionOpts(s),c=new to(r,s.deliver,o);c.info=s;try{yield r._maybeCreateConsumer(s)}catch(p){throw c.unsubscribe(),p}return c})()}subscribe(e,t=ft()){var r=this;return(0,d.Z)(function*(){const s=yield r._processOptions(e,t);if(!s.isBind&&!s.config.deliver_subject)throw new Error("push consumer requires deliver_subject");const i=r._buildTypedSubscriptionOpts(s),o=new Kn(r,s.deliver,i);o.info=s;try{yield r._maybeCreateConsumer(s)}catch(c){throw o.unsubscribe(),c}return o._maybeSetupHbMonitoring(),o})()}_processOptions(e,t=ft()){var r=this;return(0,d.Z)(function*(){const s=Nn(t)?t.getOpts():t;if(s.isBind=!!Nn(t)&&t.isBind,s.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},s.ordered){if(s.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},s.config.ack_policy!==Ie.NotSet&&s.config.ack_policy!==Ie.None)throw new N("ordered consumer: ack_policy can only be set to 'none'",A.ApiError);if(s.config.durable_name&&s.config.durable_name.length>0)throw new N("ordered consumer: durable_name cannot be set",A.ApiError);if(s.config.deliver_subject&&s.config.deliver_subject.length>0)throw new N("ordered consumer: deliver_subject cannot be set",A.ApiError);if(void 0!==s.config.max_deliver&&s.config.max_deliver>1)throw new N("ordered consumer: max_deliver cannot be set",A.ApiError);if(s.config.deliver_group&&s.config.deliver_group.length>0)throw new N("ordered consumer: deliver_group cannot be set",A.ApiError);s.config.deliver_subject=S(r.nc.options.inboxPrefix),s.config.ack_policy=Ie.None,s.config.max_deliver=1,s.config.flow_control=!0,s.config.idle_heartbeat=s.config.idle_heartbeat||xe(5e3),s.config.ack_wait=xe(792e5),s.config.mem_storage=!0,s.config.num_replicas=1}if(s.config.ack_policy===Ie.NotSet&&(s.config.ack_policy=Ie.All),s.api=r,s.config=s.config||{},s.stream=s.stream?s.stream:yield r.findStream(e),s.attached=!1,s.config.durable_name)try{const i=yield r.consumerAPI.info(s.stream,s.config.durable_name);if(i){if(i.config.filter_subject&&i.config.filter_subject!==e)throw new Error("subject does not match consumer");const o=s.config.deliver_group??"";if(""===o&&!0===i.push_bound)throw new Error("duplicate subscription");const c=i.config.deliver_group??"";if(o!==c)throw""===c?new Error("durable requires no queue group"):new Error(`durable requires queue group '${c}'`);s.last=i,s.config=i.config,s.attached=!0,s.config.durable_name||(s.name=i.name)}}catch(i){if("404"!==i.code)throw i}return!s.attached&&void 0===s.config.filter_subject&&void 0===s.config.filter_subjects&&(s.config.filter_subject=e),s.deliver=s.config.deliver_subject||S(r.nc.options.inboxPrefix),s})()}_buildTypedSubscriptionOpts(e){const t={};return t.adapter=function ro(n){return n?so:no}(void 0===e.callbackFn),t.ingestionFilterFn=Kr.ingestionFn(e.ordered),t.protocolFilterFn=(r,s=!1)=>{const i=r;return!Lr(i.msg)||(s||i.msg.respond(),!1)},!e.mack&&e.config.ack_policy!==Ie.None&&(t.dispatchedFn=io),e.callbackFn&&(t.callback=e.callbackFn),t.max=e.max||0,t.queue=e.queue,t}_maybeCreateConsumer(e){var t=this;return(0,d.Z)(function*(){if(e.attached)return;if(e.isBind)throw new Error(`unable to bind - durable consumer ${e.config.durable_name} doesn't exist in ${e.stream}`);e.config=Object.assign({deliver_policy:Ee.All,ack_policy:Ie.Explicit,ack_wait:xe(3e4),replay_policy:$t.Instant},e.config);const r=yield t.consumerAPI.add(e.stream,e.config);if(Array.isArray(e.config.filter_subjects&&!Array.isArray(r.config.filter_subjects)))throw new Error("jetstream server doesn't support consumers with multiple filter subjects");e.name=r.name,e.config=r.config,e.last=r})()}static ingestionFn(e){return(t,r)=>{const s=r;if(!t)return{ingest:!1,protocol:!1};const i=t;if(Ct(i.msg)||s.monitor?.work(),Ur(i.msg)){const c=!e||s._checkHbOrderConsumer(i.msg);return e||s.info.flow_control.heartbeat_count++,{ingest:c,protocol:!0}}return Lr(i.msg)?(s.info.flow_control.fc_count++,{ingest:!0,protocol:!0}):{ingest:!e||s._checkOrderedConsumer(t),protocol:!1}}}}class Kn extends Bi{js;monitor;constructor(e,t,r){super(e.nc,t,r),this.js=e,this.monitor=null,this.sub.closed.then(()=>{this.monitor&&this.monitor.cancel()})}set info(e){this.sub.info=e}get info(){return this.sub.info}_resetOrderedConsumer(e){if(null===this.info||this.sub.isClosed())return;const t=S(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,t);const s=this.info;s.ordered_consumer_sequence.delivery_seq=0,s.flow_control.heartbeat_count=0,s.flow_control.fc_count=0,s.flow_control.consumer_restarts++,s.deliver=t,s.config.deliver_subject=t,s.config.deliver_policy=Ee.StartSequence,s.config.opt_start_seq=e;const i={};i.stream_name=this.info.stream,i.config=s.config,this.js._request(`${s.api.prefix}.CONSUMER.CREATE.${s.stream}`,i).then(c=>{const p=c;this.info.config=p.config,this.info.name=p.name}).catch(c=>{const p=new N(`unable to recreate ordered consumer ${s.stream} at seq ${e}`,A.RequestError,c);this.sub.callback(p,{})})}_maybeSetupHbMonitoring(){const e=this.info?.config?.idle_heartbeat||0;e&&this._setupHbMonitoring(Rr(e))}_setupHbMonitoring(e,t=0){const r={cancelAfter:0,maxOut:2};t&&(r.cancelAfter=t);const s=this.sub;this.monitor=new $r(e,o=>{const c=function hi(n,e,t){const r=ot(n,e),i=new gn({hdr:1,sid:0,size:0},ge,{});return i._headers=r,i._subject=t,i}(409,`${Ke.IdleHeartbeatMissed}: ${o}`,this.sub.subject);return this.info?.ordered?!!this.js.nc.protocol.connected&&(this._resetOrderedConsumer((this.info?.ordered_consumer_sequence?.stream_seq||0)+1),!1):(this.sub.callback(null,c),!s.noIterator)},r)}_checkHbOrderConsumer(e){const t=e.headers.get(Fe.ConsumerStalledHdr);""!==t&&this.js.nc.publish(t);const r=parseInt(e.headers.get(Fe.LastConsumerSeqHdr),10),s=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,r!==s.delivery_seq&&this._resetOrderedConsumer(s.stream_seq+1),!1}_checkOrderedConsumer(e){const t=this.info.ordered_consumer_sequence,r=e.info.streamSequence,s=e.info.deliverySequence;return s!=t.delivery_seq+1?(this._resetOrderedConsumer(t.stream_seq+1),!1):(t.delivery_seq=s,t.stream_seq=r,!0)}destroy(){var e=this;return(0,d.Z)(function*(){e.isClosed()||(yield e.drain());const t=e.sub.info,s=`${t.api.prefix}.CONSUMER.DELETE.${t.stream}.${t.config.durable_name||t.name}`;yield t.api._request(s)})()}consumerInfo(){var e=this;return(0,d.Z)(function*(){const t=e.sub.info,s=`${t.api.prefix}.CONSUMER.INFO.${t.stream}.${t.config.durable_name||t.name}`,i=yield t.api._request(s);return t.last=i,i})()}}class to extends Kn{constructor(e,t,r){super(e,t,r)}pull(e={batch:1}){const{stream:t,config:r,name:s}=this.sub.info,i=r.durable_name??s,o={};if(o.batch=e.batch||1,o.no_wait=e.no_wait||!1,(e.max_bytes??0)>0){const m=this.js.nc.features.get(le.JS_PULL_MAX_BYTES);if(!m.ok)throw new Error(`max_bytes is only supported on servers ${m.min} or better`);o.max_bytes=e.max_bytes}let c=0;e.expires&&e.expires>0&&(c=e.expires,o.expires=xe(c));let p=0;if(e.idle_heartbeat&&e.idle_heartbeat>0&&(p=e.idle_heartbeat,o.idle_heartbeat=xe(p)),p&&0===c)throw new Error("idle_heartbeat requires expires");if(p>c)throw new Error("expires must be greater than idle_heartbeat");if(this.info){this.monitor&&this.monitor.cancel(),c&&p&&(this.monitor?this.monitor._change(p,c):this._setupHbMonitoring(p,c));const m=this.info.api,g=this.sub.subject;m.nc.publish(`${m.prefix}.CONSUMER.MSG.NEXT.${t}.${i}`,m.jc.encode(o),{reply:g})}}}function no(n,e){return n||(n=Ct(e))?[n,null]:[null,Vt(e)]}function so(n,e){if(n)return[n,null];const t=Ct(e);return null!==t?[Jn(t),null]:[null,Vt(e)]}function Jn(n){if(null!==n)switch(n.code){case A.JetStream404NoMessages:case A.JetStream408RequestTimeout:return null;case A.JetStream409:return function pi(n){if(n.code!==A.JetStream409)return!1;const e=[Ke.MaxBatchExceeded,Ke.MaxExpiresExceeded,Ke.MaxBytesExceeded,Ke.MaxMessageSizeExceeded,Ke.PushConsumer,Ke.IdleHeartbeatMissed,Ke.ConsumerDeleted];return fi&&e.push(Ke.MaxWaitingExceeded),void 0!==e.find(t=>-1!==n.message.indexOf(t))}(n)?n:null;default:return n}return null}function io(n){n&&n.ack()}class oo extends Dt{constructor(e,t){super(e,t)}getMessage(e,t){var r=this;return(0,d.Z)(function*(){De(e);let s=t;const{last_by_subj:i}=s;i&&(s=null);const o=s?r.jc.encode(s):ge,c=r.opts.apiPrefix||"$JS.API",p=i?`${c}.DIRECT.GET.${e}.${i}`:`${c}.DIRECT.GET.${e}`,m=yield r.nc.request(p,o),y=Ct(m);if(y)return Promise.reject(y);const g=new ao(m);return Promise.resolve(g)})()}}let ao=(()=>class n{data;header;static jc;constructor(t){if(!t.headers)throw new Error("headers expected");this.data=t.data,this.header=t.headers}get subject(){return this.header.get(qt.Subject)}get seq(){const t=this.header.get(qt.Sequence);return"string"==typeof t?parseInt(t):0}get time(){return new Date(Date.parse(this.timestamp))}get timestamp(){return this.header.get(qt.TimeStamp)}get stream(){return this.header.get(qt.Stream)}json(t){return ze(t).decode(this.data)}string(){return de.decode(this.data)}})();class co extends Dt{streams;consumers;direct;constructor(e,t){super(e,t),this.streams=new Zr(e,t),this.consumers=new Fr(e,t),this.direct=new oo(e,t)}getAccountInfo(){var e=this;return(0,d.Z)(function*(){return yield e._request(`${e.prefix}.INFO`)})()}jetstream(){return this.nc.jetstream(this.getOptions())}advisories(){const e=new Te;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(t,r)=>{if(t)throw t;try{const s=this.parseJsResponse(r),i=s.type.split(".");e.push({kind:i[i.length-1],data:s})}catch(s){e.stop(s)}}}),e}}class Wn{msg;constructor(e){this.msg=e}get data(){return this.msg.data}get sid(){return this.msg.sid}get subject(){return this.msg.subject}get reply(){return this.msg.reply||""}get headers(){return this.msg.headers}respond(e,t){return this.msg.respond(e,t)}respondError(e,t,r,s){return(s=s||{}).headers=s.headers||ot(),s.headers?.set(w,`${e}`),s.headers?.set(x,t),this.msg.respond(r,s)}json(e){return this.msg.json(e)}string(){return this.msg.string()}}class Kt{subject;queue;srv;constructor(e,t="",r=""){""!==t&&function ho(n,e){if(-1!==e.indexOf(" "))throw new Error(`${n} cannot contain spaces: '${e}'`);e.split(".").forEach(r=>{if(">"===r)throw new Error(`${n} name cannot contain internal '>': '${e}'`)})}("service group",t);let s="";if(e instanceof Jt)this.srv=e,s="";else{if(!(e instanceof Kt))throw new Error("unknown ServiceGroup type");{const i=e;this.srv=i.srv,""===r&&""!==i.queue&&(r=i.queue),s=i.subject}}this.subject=this.calcSubject(s,t),this.queue=r}calcSubject(e,t=""){return""===t?e:""!==e?`${e}.${t}`:t}addEndpoint(e="",t){const r="function"==typeof(t=t||{subject:e})?{handler:t,subject:e}:t;Bt("endpoint",e);let{subject:s,handler:i,metadata:o,queue:c}=r;return s=s||e,c=c||this.queue,function uo(n,e){if(""===e)throw new Error(`${n} cannot be empty`);if(-1!==e.indexOf(" "))throw new Error(`${n} cannot contain spaces: '${e}'`);const t=e.split(".");t.forEach((r,s)=>{if(">"===r&&s!==t.length-1)throw new Error(`${n} cannot have internal '>': '${e}'`)})}("endpoint subject",s),s=this.calcSubject(this.subject,s),this.srv._addEndpoint({name:e,subject:s,queue:c,handler:i,metadata:o})}addGroup(e="",t=""){return new Kt(this,e,t)}}class Jt{nc;_id;config;handlers;internal;_stopped;_done;started;static controlSubject(e,t="",r="",s){const i=s??"$SRV";return""===t&&""===r?`${i}.${e}`:(Bt("control subject name",t),""!==r?(Bt("control subject id",r),`${i}.${e}.${t}.${r}`):`${i}.${e}.${t}`)}constructor(e,t={name:"",version:""}){this.nc=e,this.config=Object.assign({},t),this.config.queue||(this.config.queue="q"),Bt("name",this.config.name),Bt("queue",this.config.queue),bt(this.config.version),this._id=Pe.next(),this.internal=[],this._done=R(),this._stopped=!1,this.handlers=[],this.started=(new Date).toISOString(),this.reset(),this.nc.closed().then(()=>{this.close().catch()}).catch(r=>{this.close(r).catch()})}get subjects(){return this.handlers.filter(e=>!1===e.internal).map(e=>e.subject)}get id(){return this._id}get name(){return this.config.name}get description(){return this.config.description??""}get version(){return this.config.version}get metadata(){return this.config.metadata}errorToHeader(e){const t=ot();if(e instanceof P){const r=e;t.set(x,r.message),t.set(w,`${r.code}`)}else t.set(x,e.message),t.set(w,"500");return t}setupHandler(e,t=!1){const r=t?"":e.queue?e.queue:this.config.queue,{name:s,subject:i,handler:o}=e,c=e;c.internal=t,t&&this.internal.push(c),c.stats=new fo(s,i,r),c.queue=r;const p=o?(m,y)=>{if(m)return void this.close(m);const g=Date.now();try{o(m,new Wn(y))}catch(E){c.stats.countError(E),y?.respond(ge,{headers:this.errorToHeader(E)})}finally{c.stats.countLatency(g)}}:void 0;return c.sub=this.nc.subscribe(i,{callback:p,queue:r}),c.sub.closed.then(()=>{this._stopped||this.close(new Error(`required subscription ${e.subject} stopped`)).catch()}).catch(m=>{if(!this._stopped){const y=new Error(`required subscription ${e.subject} errored: ${m.message}`);y.stack=m.stack,this.close(y).catch()}}),c}info(){return{type:gt.INFO,name:this.name,id:this.id,version:this.version,description:this.description,metadata:this.metadata,endpoints:this.endpoints()}}endpoints(){return this.handlers.map(e=>{const{subject:t,metadata:r,name:s,queue:i}=e;return{subject:t,metadata:r,name:s,queue_group:i}})}stats(){var e=this;return(0,d.Z)(function*(){const t=[];for(const r of e.handlers){if("function"==typeof e.config.statsHandler)try{r.stats.data=yield e.config.statsHandler(r)}catch(s){r.stats.countError(s)}t.push(r.stats.stats(r.qi))}return{type:gt.STATS,name:e.name,id:e.id,version:e.version,started:e.started,metadata:e.metadata,endpoints:t}})()}addInternalHandler(e,t){const r=`${e}`.toUpperCase();this._doAddInternalHandler(`${r}-all`,e,t),this._doAddInternalHandler(`${r}-kind`,e,t,this.name),this._doAddInternalHandler(`${r}`,e,t,this.name,this.id)}_doAddInternalHandler(e,t,r,s="",i=""){const o={};o.name=e,o.subject=Jt.controlSubject(t,s,i),o.handler=r,this.setupHandler(o,!0)}start(){const e=ze(),s=e.encode(this.ping());return this.addInternalHandler(D.PING,(o,c)=>o?(this.close(o).then().catch(),Promise.reject(o)):(c.respond(s),Promise.resolve())),this.addInternalHandler(D.STATS,(o,c)=>o?(this.close(o),Promise.reject(o)):this.stats().then(p=>(c?.respond(e.encode(p)),Promise.resolve()))),this.addInternalHandler(D.INFO,(o,c)=>o?(this.close(o),Promise.reject(o)):(c?.respond(e.encode(this.info())),Promise.resolve())),this.handlers.forEach(o=>{const{subject:c}=o;"string"==typeof c&&null!==o.handler&&this.setupHandler(o)}),Promise.resolve(this)}close(e){if(this._stopped)return this._done;this._stopped=!0;let t=[];return this.nc.isClosed()||(t=this.handlers.concat(this.internal).map(r=>r.sub.drain())),Promise.allSettled(t).then(()=>{this._done.resolve(e||null)}),this._done}get stopped(){return this._done}get isStopped(){return this._stopped}stop(e){return this.close(e)}ping(){return{type:gt.PING,name:this.name,id:this.id,version:this.version,metadata:this.metadata}}reset(){if(this.started=(new Date).toISOString(),this.handlers)for(const e of this.handlers)e.stats.reset(e.qi)}addGroup(e,t){return new Kt(this,e,t)}addEndpoint(e,t){return new Kt(this).addEndpoint(e,t)}_addEndpoint(e){const t=new Te;t.noIterator="function"==typeof e.handler,t.noIterator||(e.handler=(s,i)=>{s?this.stop(s).catch():t.push(new Wn(i))},t.iterClosed.then(()=>{this.close().catch()}));const r=this.setupHandler(e,!1);return r.qi=t,this.handlers.push(r),t}}class fo{name;subject;average_processing_time;num_requests;processing_time;num_errors;last_error;data;metadata;queue;constructor(e,t,r=""){this.name=e,this.subject=t,this.average_processing_time=0,this.num_errors=0,this.num_requests=0,this.processing_time=0,this.queue=r}reset(e){this.num_requests=0,this.processing_time=0,this.average_processing_time=0,this.num_errors=0,this.last_error=void 0,this.data=void 0;const t=e;t&&(t.time=0,t.processed=0)}countLatency(e){this.num_requests++,this.processing_time+=xe(Date.now()-e),this.average_processing_time=Math.round(this.processing_time/this.num_requests)}countError(e){this.num_errors++,this.last_error=e.message}_stats(){const{name:e,subject:t,average_processing_time:r,num_errors:s,num_requests:i,processing_time:o,last_error:c,data:p,queue:m}=this;return{name:e,subject:t,average_processing_time:r,num_errors:s,num_requests:i,processing_time:o,last_error:c,data:p,queue_group:m}}stats(e){const t=e;return!1===t?.noIterator&&(this.processing_time=t.time,this.num_requests=t.processed,this.average_processing_time=this.processing_time>0&&this.num_requests>0?this.processing_time/this.num_requests:0),this._stats()}}class po{nc;prefix;opts;constructor(e,t={strategy:ke.JitterTimer,maxWait:2e3},r){this.nc=e,this.prefix=r,this.opts=t}ping(e="",t=""){return this.q(D.PING,e,t)}stats(e="",t=""){return this.q(D.STATS,e,t)}info(e="",t=""){return this.q(D.INFO,e,t)}q(e,t="",r=""){var s=this;return(0,d.Z)(function*(){const i=new Te,o=ze(),c=Jt.controlSubject(e,t,r,s.prefix),p=yield s.nc.requestMany(c,ge,s.opts);return(0,d.Z)(function*(){var g,m=!1,y=!1;try{for(var O,E=(0,J.Z)(p);m=!(O=yield E.next()).done;m=!1){const j=O.value;try{const B=o.decode(j.data);i.push(B)}catch(B){i.push(()=>{i.stop(B)})}}}catch(j){y=!0,g=j}finally{try{m&&null!=E.return&&(yield E.return())}finally{if(y)throw g}}i.push(()=>{i.stop()})})().catch(m=>{i.stop(m)}),i})()}}class Jr{options;protocol;draining;listeners;_services;constructor(e){this.draining=!1,this.options=ni(e),this.listeners=[]}static connect(e={}){return new Promise((t,r)=>{const s=new Jr(e);cr.connect(s.options,s).then(i=>{s.protocol=i,(0,d.Z)(function*(){var p,o=!1,c=!1;try{for(var y,m=(0,J.Z)(i.status());o=!(y=yield m.next()).done;o=!1){const g=y.value;s.listeners.forEach(E=>{E.push(g)})}}catch(g){c=!0,p=g}finally{try{o&&null!=m.return&&(yield m.return())}finally{if(c)throw p}}})(),t(s)}).catch(i=>{r(i)})})}closed(){return this.protocol.closed}close(){var e=this;return(0,d.Z)(function*(){yield e.protocol.close()})()}_check(e,t,r){if(this.isClosed())throw N.errorForCode(A.ConnectionClosed);if(t&&this.isDraining()||r&&this.protocol.noMorePublishing)throw N.errorForCode(A.ConnectionDraining);if(0===(e=e||"").length)throw N.errorForCode(A.BadSubject)}publish(e,t,r){this._check(e,!1,!0),this.protocol.publish(e,t,r)}subscribe(e,t={}){this._check(e,!0,!1);const r=new An(this.protocol,e,t);return this.protocol.subscribe(r),r}_resub(e,t,r){this._check(t,!0,!1);const s=e;s.max=r,r&&(s.max=r+s.received),this.protocol.resub(s,t)}requestMany(e,t=ge,r={maxWait:1e3,maxMessages:-1}){try{this._check(e,!0,!0)}catch(c){return Promise.reject(c)}if(r.strategy=r.strategy||ke.Timer,r.maxWait=r.maxWait||1e3,r.maxWait<1)return Promise.reject(new N("timeout",A.InvalidOption));const s=new Te;function i(c){s.push(()=>{s.stop(c)})}function o(c,p){c||null===p?i(null===c?void 0:c):s.push(p)}if(r.noMux){const c=(new Error).stack;let p="number"==typeof r.maxMessages&&r.maxMessages>0?r.maxMessages:-1;const m=this.subscribe(S(this.options.inboxPrefix),{callback:(O,j)=>{if(0===j?.data?.length&&j?.headers?.status===A.NoResponders&&(O=N.errorForCode(A.NoResponders)),O)return O.stack+=`\n\n${c}`,void y(O);o(null,j),r.strategy===ke.Count&&(p--,0===p&&y()),r.strategy===ke.JitterTimer&&(E(),g=setTimeout(()=>{y()},300)),r.strategy===ke.SentinelMsg&&j&&0===j.data.length&&y()}});m.closed.then(()=>{i()}).catch(O=>{s.stop(O)});const y=O=>{O&&s.push(()=>{throw O}),E(),m.drain().then(()=>{i()}).catch(j=>{i()})};s.iterClosed.then(()=>{E(),m?.unsubscribe()}).catch(O=>{E(),m?.unsubscribe()});try{this.publish(e,t,{reply:m.getSubject()})}catch(O){y(O)}let g=setTimeout(()=>{y()},r.maxWait);const E=()=>{g&&clearTimeout(g)}}else{const c=r;c.callback=o,s.iterClosed.then(()=>{p.cancel()}).catch(m=>{p.cancel(m)});const p=new ui(this.protocol.muxSubscriptions,e,c);this.protocol.request(p);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${p.token}`,headers:r.headers})}catch(m){p.cancel(m)}}return Promise.resolve(s)}request(e,t,r={timeout:1e3,noMux:!1}){try{this._check(e,!0,!0)}catch(s){return Promise.reject(s)}if(r.timeout=r.timeout||1e3,r.timeout<1)return Promise.reject(new N("timeout",A.InvalidOption));if(!r.noMux&&r.reply)return Promise.reject(new N("reply can only be used with noMux",A.InvalidOption));if(r.noMux){const s=r.reply?r.reply:S(this.options.inboxPrefix),i=R(),o=new Error;return this.subscribe(s,{max:1,timeout:r.timeout,callback:(p,m)=>{p?(p.code!==A.Timeout&&(p.stack+=`\n\n${o.stack}`),i.reject(p)):(p=_n(m))?(p.stack+=`\n\n${o.stack}`,i.reject(p)):i.resolve(m)}}).requestSubject=e,this.protocol.publish(e,t,{reply:s,headers:r.headers}),i}{const s=new kn(this.protocol.muxSubscriptions,e,r);this.protocol.request(s);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${s.token}`,headers:r.headers})}catch(o){s.cancel(o)}const i=Promise.race([s.timer,s.deferred]);return i.catch(()=>{s.cancel()}),i}}flush(){return this.isClosed()?Promise.reject(N.errorForCode(A.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(N.errorForCode(A.ConnectionClosed)):this.isDraining()?Promise.reject(N.errorForCode(A.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){const e=this.protocol.getServer();return e?e.listen:""}status(){const e=new Te;return e.iterClosed.then(()=>{const t=this.listeners.indexOf(e);this.listeners.splice(t,1)}),this.listeners.push(e),e}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}jetstreamManager(e={}){var t=this;return(0,d.Z)(function*(){const r=new co(t,e);try{yield r.getAccountInfo()}catch(s){const i=s;throw i.code===A.NoResponders&&(i.code=A.JetStreamNotEnabled),i}return r})()}jetstream(e={}){return new Kr(this,e)}getServerVersion(){const e=this.info;return e?bt(e.version):void 0}rtt(){var e=this;return(0,d.Z)(function*(){if(!e.protocol._closed&&!e.protocol.connected)throw N.errorForCode(A.Disconnect);const t=Date.now();return yield e.flush(),Date.now()-t})()}get features(){return this.protocol.features}get services(){return this._services||(this._services=new mo(this)),this._services}}class mo{nc;constructor(e){this.nc=e}add(e){try{return new Jt(this.nc,e).start()}catch(t){return Promise.reject(t)}}client(e,t){return new po(this.nc,e,t)}}class vo{version;lang;closeError;connected;done;socket;options;socketClosed;encrypted;peeked;yields;signal;closedNotification;constructor(){this.version="1.18.0",this.lang="nats.ws",this.connected=!1,this.done=!1,this.socketClosed=!1,this.encrypted=!1,this.peeked=!1,this.yields=[],this.signal=R(),this.closedNotification=R()}connect(e,t){var r=this;return(0,d.Z)(function*(){const i=R();if(t.tls)return i.reject(new N("tls",A.InvalidOption)),i;r.options=t;const o=e.src;if(t.wsFactory){const{socket:c,encrypted:p}=yield t.wsFactory(e.src,t);r.socket=c,r.encrypted=p}else r.encrypted=0===o.indexOf("wss://"),r.socket=new WebSocket(o);return r.socket.binaryType="arraybuffer",r.socket.onopen=()=>{r.isDiscarded()},r.socket.onmessage=c=>{if(r.isDiscarded())return;if(r.yields.push(new Uint8Array(c.data)),r.peeked)return void r.signal.resolve();const p=ye.concat(...r.yields),m=function gs(n){const e=function _s(n){for(let e=0;e<n.length;e++){const t=e+1;if(n.byteLength>t&&n[e]===ps&&n[t]===ms)return t+1}return 0}(n);if(e>0){const r=new Uint8Array(n).slice(0,e);return de.decode(r)}return""}(p);if(""!==m){const y=oi.exec(m);if(!y)return t.debug&&console.error("!!!",K(p)),void i.reject(new Error("unexpected response from server"));try{(function si(n,e){const{proto:t,tls_required:r,tls_available:s}=n;if((void 0===t||t<1)&&e.noEcho)throw new N("noEcho",A.ServerOptionNotAvailable);if(e.tls&&!r&&!s)throw new N("tls",A.ServerOptionNotAvailable)})(JSON.parse(y[1]),r.options),r.peeked=!0,r.connected=!0,r.signal.resolve(),i.resolve()}catch(g){return void i.reject(g)}}},r.socket.onclose=c=>{if(r.isDiscarded())return;let p;r.socketClosed=!0,r.done||(c.wasClean||(p=new Error(c.reason)),r._closed(p))},r.socket.onerror=c=>{if(r.isDiscarded())return;const m=new N(c.message,A.Unknown,new Error(c.error));i.reject(m)},i})()}disconnect(){this._closed(void 0,!0)}_closed(e,t=!0){var r=this;return(0,d.Z)(function*(){if(!r.isDiscarded()&&r.connected&&!r.done){if(r.closeError=e,!e)for(;!r.socketClosed&&r.socket.bufferedAmount>0;)yield U(100);r.done=!0;try{r.socket.close(e?1002:1e3,e?e.message:void 0)}catch{}t&&r.closedNotification.resolve(e)}})()}get isClosed(){return this.done}[Symbol.asyncIterator](){return this.iterate()}iterate(){var e=this;return je(function*(){for(;;){if(e.isDiscarded())return;0===e.yields.length&&(yield oe(e.signal));const t=e.yields;e.yields=[];for(let r=0;r<t.length;r++)e.options.debug&&console.info(`> ${K(t[r])}`),yield t[r];if(e.done)break;0===e.yields.length&&(t.length=0,e.yields=t,e.signal=R())}})()}isEncrypted(){return this.connected&&this.encrypted}send(e){if(!this.isDiscarded())try{return this.socket.send(e.buffer),void(this.options.debug&&console.info(`< ${K(e)}`))}catch(t){this.options.debug&&console.error(`!!! ${K(e)}: ${t}`)}}close(e){return this._closed(e,!1)}closed(){return this.closedNotification}isDiscarded(){return!!this.done&&(this.discard(),!0)}discard(){this.done=!0;try{this.socket?.close()}catch{}}}function wo(n){/^(.*:\/\/)(.*)/.test(n)||(n=`https://${n}`);let t=new URL(n);const r=t.protocol.toLowerCase();let s,i;"https:"!==r&&"http"!==r&&(n=n.replace(/^(.*:\/\/)(.*)/gm,"$2"),t=new URL(`http://${n}`));const o=t.hostname,c=t.pathname,p=t.search||"";switch(r){case"http:":case"ws:":case"nats:":i=t.port||"80",s="ws:";break;default:i=t.port||"443",s="wss:"}return`${s}//${o}:${i}${c}${p}`}q(6021);let Wr=class{#t;#e;#r;#n=ze();#s;constructor(e){this.#t=e||{name:""}}connect(e,t,r){var s=this;return(0,d.Z)(function*(){try{s.#e=yield function So(n={}){return function qe(n){be=n}({defaultPort:443,urlParseFn:wo,factory:()=>new vo}),Jr.connect(n)}({servers:e,user:t,pass:r})}catch(i){console.error(i)}s.#r=yield s.#e.jetstream()})()}publish(e,t){var r=this;return(0,d.Z)(function*(){try{const s={data:t};yield r.#r.publish(e,r.#n.encode(s))}catch(s){console.log(s)}})()}unsubscribe(){void 0!==this.#s?this.#s.close():console.error("Should have subscribed first")}subscribe(e=mr.Pull,t,r){return new T.Observable(s=>{(e===mr.Pull?this.#o(t):this.#i(t,r)).then(o=>{this.#s=o,s.next(o)})})}#i(e,t){var r=this;return(0,d.Z)(function*(){return t?(yield r.#r.consumers.get(r.#t.name,{filterSubjects:e,inactive_threshold:1e3,deliver_policy:t})).consume():(yield r.#r.consumers.get(r.#t.name,{filterSubjects:e,inactive_threshold:1e3})).consume()})()}#o(e){var t=this;return(0,d.Z)(function*(){return(yield t.#r.consumers.get(t.#t.name,e)).consume()})()}request(e,t){const r=new T.Subject;let s;return s=(0,T.from)(null!=t&&""!==t&&0!==t&&!1!==t?this.#e.request(`core.${e}`,this.#n.encode({data:t})):this.#e.request(`core.${e}`,this.#n.encode({data:{}}))),s.subscribe(c=>{r.next(this.#n.decode(c.data))}),r.asObservable()}drain(){var e=this;return(0,d.Z)(function*(){yield e.#e.drain()})()}};Wr=(0,C.gn)([(0,h.Injectable)({providedIn:"root"})],Wr);var mr=function(n){return n.Pull="pull",n.Push="push",n}(mr||{}),Yn=function(n){return n.None="none",n.All="all",n.Explicit="explicit",n.NotSet="",n}(Yn||{}),Xn=function(n){return n.Limits="limits",n.Interest="interest",n.Workqueue="workqueue",n}(Xn||{}),Qn=function(n){return n.All="all",n.Last="last",n.New="new",n.StartSequence="by_start_sequence",n.StartTime="by_start_time",n.LastPerSubject="last_per_subject",n}(Qn||{})},9191:(_t,Ce,q)=>{q.r(Ce),q.d(Ce,{AppStoreComponent:()=>nt,AppStoreService:()=>ae});var d=q(5861),C=q(5863),h=q(6701),T=q(9159),J=q(2182),se=q(575),oe=q(8426),_e=q(743),je=q(1189),ge=q(2998),we=q(7842),de=q(6107),Ve=q(6984),Se=q(3433),Ze=q(6488),Me=q(25);function Re(A,$e){if(1&A&&(C.\u0275\u0275elementStart(0,"span"),C.\u0275\u0275text(1),C.\u0275\u0275elementEnd()),2&A){const Z=$e.$implicit;C.\u0275\u0275classMap(Z.icon),C.\u0275\u0275advance(1),C.\u0275\u0275textInterpolate1(" ",Z.label," ")}}function rt(A,$e){if(1&A){const Z=C.\u0275\u0275getCurrentView();C.\u0275\u0275elementContainerStart(0),C.\u0275\u0275elementStart(1,"his-card-list",19),C.\u0275\u0275listener("setChange",function(N){C.\u0275\u0275restoreView(Z);const ie=C.\u0275\u0275nextContext(2);return C.\u0275\u0275resetView(ie.appStoreService.onFavoriteClick(N))})("clickCard",function(N){C.\u0275\u0275restoreView(Z);const ie=C.\u0275\u0275nextContext(2);return C.\u0275\u0275resetView(ie.appStoreService.onNavAppClick(N))}),C.\u0275\u0275elementEnd(),C.\u0275\u0275elementContainerEnd()}if(2&A){const Z=$e.$implicit;C.\u0275\u0275advance(1),C.\u0275\u0275property("myAppStore",Z)}}function pe(A,$e){if(1&A&&(C.\u0275\u0275elementContainerStart(0),C.\u0275\u0275elementStart(1,"div",15),C.\u0275\u0275element(2,"p-divider",16),C.\u0275\u0275elementStart(3,"div",17),C.\u0275\u0275template(4,rt,2,1,"ng-container",18),C.\u0275\u0275elementEnd()(),C.\u0275\u0275elementContainerEnd()),2&A){const Z=C.\u0275\u0275nextContext();C.\u0275\u0275advance(4),C.\u0275\u0275property("ngForOf",Z.appStoreService.myAppStores())}}function Y(A,$e){if(1&A){const Z=C.\u0275\u0275getCurrentView();C.\u0275\u0275elementContainerStart(0),C.\u0275\u0275elementStart(1,"his-card-list",22),C.\u0275\u0275listener("setChange",function(N){C.\u0275\u0275restoreView(Z);const ie=C.\u0275\u0275nextContext(2);return C.\u0275\u0275resetView(ie.appStoreService.onFavoriteClick(N))})("clickCard",function(N){C.\u0275\u0275restoreView(Z);const ie=C.\u0275\u0275nextContext(2);return C.\u0275\u0275resetView(ie.appStoreService.onNavAppClick(N))}),C.\u0275\u0275elementEnd(),C.\u0275\u0275elementContainerEnd()}if(2&A){const Z=$e.$implicit;C.\u0275\u0275advance(1),C.\u0275\u0275property("myAppStore",Z)("isListView",!0)}}function W(A,$e){if(1&A&&(C.\u0275\u0275elementStart(0,"div",20),C.\u0275\u0275element(1,"p-divider",16),C.\u0275\u0275elementStart(2,"div",21),C.\u0275\u0275template(3,Y,2,2,"ng-container",18),C.\u0275\u0275elementEnd()()),2&A){const Z=C.\u0275\u0275nextContext();C.\u0275\u0275advance(3),C.\u0275\u0275property("ngForOf",Z.appStoreService.myAppStores())}}let te=(()=>{class A{#t="ws://localhost:8080";#e=(0,C.inject)(T.JetstreamWsService);connect(){var Z=this;return(0,d.Z)(function*(){console.log("connected"),yield Z.#e.connect(Z.#t)})()}disconnect(){var Z=this;return(0,d.Z)(function*(){yield Z.#e.drain()})()}static#r=this.\u0275fac=function(Q){return new(Q||A)};static#n=this.\u0275prov=C.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"root"})}return A})(),ae=(()=>{class A{constructor(){this.myAppStores=(0,C.signal)([]),this.userAppStores=(0,C.signal)([]),this.appOpenedIndex=[],this.#t=(0,C.inject)(h.Router),this.#e=(0,C.inject)(T.JetstreamWsService),this.#r=(0,C.inject)(J.SharedService),this.#n=(0,C.inject)(te)}#t;#e;#r;#n;convertToExtended(Z){return Z.map(Q=>({...Q,isOpen:!0}))}getAppStoreList(Z){var Q=this;return(0,d.Z)(function*(){Q.#e.request("UserAppStore.myAppStore",Z).subscribe(N=>{Q.myAppStores.set(Q.convertToExtended(N))})})()}getUserStoreList(Z){var Q=this;return(0,d.Z)(function*(){Q.#e.request("UserAppStore.list",Z).subscribe(N=>{Q.userAppStores.set(N)})})()}getAppStoresByKeyword(Z){return Z?this.myAppStores().filter(Q=>Q.title.includes(Z)):this.myAppStores()}getAppStore(Z){return this.myAppStores().filter(N=>N.url===Z)[0]}pubUserAppStoreFavorite(Z){var Q=this;return(0,d.Z)(function*(){yield Q.#e.publish("UserAppStore.update.isFavorite",Z)})()}initAppStore(){var Z=this;return(0,d.Z)(function*(){const Q=yield Z.#r.getValue(history.state.token);console.log("get token",Q),yield Z.getAppStoreList(Q.userCode.code),yield Z.getUserStoreList(Q.userCode.code)})()}onFavoriteClick(Z){this.myAppStores.update(Q=>(console.log("userAppStores",this.userAppStores()),Q.map(N=>{if(N.appId===Z){N.isFavorite=!N.isFavorite;const ie=this.userAppStores().find(ke=>ke.appId===Z);console.log("appId",Z),console.log("userAppStoreID",ie?.appId),ie&&(ie.isFavorite=N.isFavorite,this.pubUserAppStoreFavorite(ie))}return N})))}onNavAppClick(Z){this.#t.navigate([Z])}setAppClose(Z){if(this.myAppStores.update(Q=>Q.map(N=>(N.appId===Z&&(N.isOpen=!1),N))),console.log(this.appOpenedIndex),this.appOpenedIndex.length>1){const Q=this.appOpenedIndex.findIndex(N=>N._id===Z);this.appOpenedIndex.splice(Q,1),console.log(Q),console.log(this.appOpenedIndex[this.appOpenedIndex.length-1]),this.#t.navigate([this.appOpenedIndex[this.appOpenedIndex.length-1].url])}else this.appOpenedIndex.splice(1,1),this.#t.navigateByUrl("/home")}static#s=this.\u0275fac=function(Q){return new(Q||A)};static#i=this.\u0275prov=C.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"root"})}return A})();var Le=Object.freeze({__proto__:null,default:[{icon:"material-symbols-outlined",label:"grid_view",value:"grid"},{icon:"material-symbols-outlined",label:"view_agenda",value:"list"}]});let nt=(()=>{class A{constructor(){this.isGridView=(0,C.signal)(!0),this.Options=[],this.value="grid",this.appStoreService=(0,C.inject)(ae),this.userAccountService=(0,C.inject)(Ze.N),this.#t=(0,C.inject)(J.SharedService),this.#e=(0,C.inject)(Se.TranslateService)}#t;#e;ngOnInit(){var Z=this;return(0,d.Z)(function*(){Z.#e.setDefaultLang("zh-Hant"),Z.Options=Object.values(Le)[0]})()}onBackClick(){window.history.back()}onSelectedChange(){this.isGridView.set("grid"===this.value)}static#r=this.\u0275fac=function(Q){return new(Q||A)};static#n=this.\u0275cmp=C.\u0275\u0275defineComponent({type:A,selectors:[["his-app-store"]],standalone:!0,features:[C.\u0275\u0275StandaloneFeature],decls:21,vars:9,consts:[[1,"content-container"],[1,"top-bar-container"],["styleClass","mr-2","size","xlarge","shape","circle",3,"image"],[1,"title"],[1,"toolbar-container"],[1,"icon-container","title-box"],["pButton","","pRipple","","type","button","icon","pi pi-angle-left",1,"p-button-rounded","p-button-secondary","p-button-outlined",3,"click"],[1,"icon-container"],[1,"p-input-icon-left"],[1,"pi","pi-search"],["type","text","pInputText","","placeholder","\u67e5\u8a62"],["optionLabel","name","optionValue","value",3,"options","ngModel","ngModelChange","onOptionClick"],["pTemplate",""],[4,"ngIf","ngIfElse"],["listView",""],[1,"appstore-container"],[1,"first-class"],[1,"flex","flex-wrap","card-content"],[4,"ngFor","ngForOf"],[1,"grid-style",3,"myAppStore","setChange","clickCard"],[1,"appstore-container","listView"],[1,"flex","flex-wrap","list-content"],[1,"list-style",3,"myAppStore","isListView","setChange","clickCard"]],template:function(Q,N){if(1&Q&&(C.\u0275\u0275elementStart(0,"div",0)(1,"div",1),C.\u0275\u0275element(2,"p-avatar",2),C.\u0275\u0275elementStart(3,"div",3),C.\u0275\u0275text(4),C.\u0275\u0275pipe(5,"translate"),C.\u0275\u0275elementEnd()(),C.\u0275\u0275elementStart(6,"div",4)(7,"div",5)(8,"button",6),C.\u0275\u0275listener("click",function(){return N.onBackClick()}),C.\u0275\u0275elementEnd(),C.\u0275\u0275elementStart(9,"div")(10,"h3"),C.\u0275\u0275text(11,"\u7a0b\u5f0f\u96c6"),C.\u0275\u0275elementEnd()()(),C.\u0275\u0275elementStart(12,"div",7)(13,"span",8),C.\u0275\u0275element(14,"i",9)(15,"input",10),C.\u0275\u0275elementEnd(),C.\u0275\u0275elementStart(16,"p-selectButton",11),C.\u0275\u0275listener("ngModelChange",function(ke){return N.value=ke})("onOptionClick",function(){return N.onSelectedChange()}),C.\u0275\u0275template(17,Re,2,3,"ng-template",12),C.\u0275\u0275elementEnd()()(),C.\u0275\u0275template(18,pe,5,1,"ng-container",13),C.\u0275\u0275template(19,W,4,1,"ng-template",null,14,C.\u0275\u0275templateRefExtractor),C.\u0275\u0275elementEnd()),2&Q){const ie=C.\u0275\u0275reference(20);C.\u0275\u0275advance(2),C.\u0275\u0275propertyInterpolate("image",N.userAccountService.userImage().image),C.\u0275\u0275advance(2),C.\u0275\u0275textInterpolate2(" ",N.userAccountService.userAccount().userCode.display,",",C.\u0275\u0275pipeBind1(5,7,"\u6b61\u8fce\u56de\u4f86")," "),C.\u0275\u0275advance(12),C.\u0275\u0275property("options",N.Options)("ngModel",N.value),C.\u0275\u0275advance(2),C.\u0275\u0275property("ngIf",N.isGridView())("ngIfElse",ie)}},dependencies:[se.CommonModule,se.NgForOf,se.NgIf,je.ButtonModule,je.ButtonDirective,Me.PrimeTemplate,we.DividerModule,we.Divider,_e.SelectButtonModule,_e.SelectButton,oe.FormsModule,oe.NgControlStatus,oe.NgModel,ge.InputTextModule,ge.InputText,de.AvatarModule,de.Avatar,Ve.D,Se.TranslateModule,Se.TranslatePipe],styles:["[_nghost-%COMP%]     .grid-style{margin:6px;width:calc(20% - 12px);max-width:320px}[_nghost-%COMP%]     .grid-style.second-class .p-image.p-component{background:linear-gradient(0deg,rgba(0,0,0,.2) 0%,rgba(0,0,0,0) 100%),var(--tertiary-main)}[_nghost-%COMP%]     .grid-style.third-class .p-image.p-component{background:linear-gradient(0deg,rgba(0,0,0,.2) 0%,rgba(0,0,0,0) 100%),var(--indigo-500)}[_nghost-%COMP%]     .grid-style.fourth-class .p-image.p-component{background:linear-gradient(0deg,rgba(0,0,0,.2) 0%,rgba(0,0,0,0) 100%),var(--orange-500)}[_nghost-%COMP%]     .list-style .p-image.p-component{width:56px;height:56px}[_nghost-%COMP%]     .p-selectbutton .p-button{border-radius:0}[_nghost-%COMP%]     .p-selectbutton .p-button:first-child{border-radius:6px 0 0 6px}[_nghost-%COMP%]     .p-selectbutton .p-button:last-child{border-radius:0 6px 6px 0}.content-container[_ngcontent-%COMP%]{padding:32px;height:100%;display:flex;flex-direction:column;background-color:var(--surface-ground);overflow:auto}.appstore-container[_ngcontent-%COMP%]{padding:var(--spacing-xs) var(--spacing-lg)}.appstore-container.listView[_ngcontent-%COMP%]{width:100%;margin:0 auto}.appstore-container[_ngcontent-%COMP%]   .card-content[_ngcontent-%COMP%]{width:95%;margin:0 auto;transform:translate(-6px);padding-bottom:var(--spacing-md)}.appstore-container[_ngcontent-%COMP%]   .list-content[_ngcontent-%COMP%]{gap:12px}.top-bar-container[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center}.icon-container[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:8px}.icon-container[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.5rem;font-style:normal;font-weight:700;line-height:2rem;letter-spacing:.03rem;color:var(--surface-on-surface)}.list-style[_ngcontent-%COMP%]{cursor:pointer;width:100%}[_nghost-%COMP%]     .p-buttonset .p-button-icon-only{justify-content:center;width:2rem;height:2rem}[_nghost-%COMP%]     .p-buttonset .p-button-icon-only .p-button-icon{font-size:1rem;padding-left:3px}[_nghost-%COMP%]     .p-divider.p-divider-horizontal{margin:12px 0}[_nghost-%COMP%]     .first-class .p-divider-solid.p-divider-horizontal:before{border-color:var(--primary-main);border-width:4px}[_nghost-%COMP%]     .second-class .p-divider-solid.p-divider-horizontal:before{border-color:var(--tertiary-main);border-width:4px}[_nghost-%COMP%]     .third-class .p-divider-solid.p-divider-horizontal:before{border-color:var(--indigo-500);border-width:4px}[_nghost-%COMP%]     .fourth-class .p-divider-solid.p-divider-horizontal:before{border-color:var(--orange-500);border-width:4px}.title[_ngcontent-%COMP%]{padding-left:24px;font-size:28px;font-weight:700;line-height:40px;letter-spacing:1.12px;color:var(--primary-main)}.toolbar-container[_ngcontent-%COMP%]{padding:var(--spacing-xs) var(--spacing-lg);display:flex;justify-content:space-between;width:100%;margin:var(--spacing-lg) 0 var(--spacing-sm)}"]})}return A})()},4799:(_t,Ce,q)=>{q.r(Ce),q.d(Ce,{UserProfileComponent:()=>rt,WsNatsService:()=>Re});var d=q(5861),C=q(6107),h=q(1189),T=q(5863),J=q(575),se=q(931),oe=q(6701),_e=q(2182),je=q(6984),ge=q(9191),we=q(9159),de=q(3433),Ve=q(6488);function Se(pe,Y){if(1&pe){const W=T.\u0275\u0275getCurrentView();T.\u0275\u0275elementContainerStart(0),T.\u0275\u0275elementStart(1,"his-card-list",13),T.\u0275\u0275listener("setChange",function(te){T.\u0275\u0275restoreView(W);const ae=T.\u0275\u0275nextContext(2);return T.\u0275\u0275resetView(ae.appStoreService.onFavoriteClick(te))})("clickCard",function(te){T.\u0275\u0275restoreView(W);const ae=T.\u0275\u0275nextContext(2);return T.\u0275\u0275resetView(ae.appStoreService.onNavAppClick(te))}),T.\u0275\u0275elementEnd(),T.\u0275\u0275elementContainerEnd()}if(2&pe){const W=T.\u0275\u0275nextContext().$implicit;T.\u0275\u0275advance(1),T.\u0275\u0275property("myAppStore",W)}}function Ze(pe,Y){if(1&pe&&(T.\u0275\u0275elementContainerStart(0),T.\u0275\u0275template(1,Se,2,1,"ng-container",12),T.\u0275\u0275elementContainerEnd()),2&pe){const W=Y.$implicit;T.\u0275\u0275advance(1),T.\u0275\u0275property("ngIf",!0===W.isFavorite)}}let Re=(()=>{class pe{#t="ws://localhost:8080";#e=(0,T.inject)(we.JetstreamWsService);connect(){var W=this;return(0,d.Z)(function*(){yield W.#e.connect(W.#t)})()}disconnect(){var W=this;return(0,d.Z)(function*(){yield W.#e.drain()})()}static#r=this.\u0275fac=function(H){return new(H||pe)};static#n=this.\u0275prov=T.\u0275\u0275defineInjectable({token:pe,factory:pe.\u0275fac,providedIn:"root"})}return pe})(),rt=(()=>{class pe{constructor(){this.appStoreService=(0,T.inject)(ge.AppStoreService),this.newsService=(0,T.inject)(se.NewsService),this.userAccountService=(0,T.inject)(Ve.N),this.#t=(0,T.inject)(oe.Router),this.#e=(0,T.inject)(_e.SharedService),this.#r=(0,T.inject)(Re),this.#n=(0,T.inject)(de.TranslateService)}#t;#e;#r;#n;onMoreNewsClick(){this.#e.sharedValue=null;const W=this.#e.setValue(this.userAccountService.userAccount());this.#t.navigate(["/news"],{state:{token:W}})}onNavNewsLinkClick(W,H){const te=this.#e.setValue(H);this.#t.navigate([W],{state:{token:te}})}onMoreAppListClick(){const W=this.#e.setValue(this.userAccountService.userAccount());this.#t.navigate(["/appStore"],{state:{token:W}})}static#s=this.\u0275fac=function(H){return new(H||pe)};static#i=this.\u0275cmp=T.\u0275\u0275defineComponent({type:pe,selectors:[["his-user-profile"]],standalone:!0,features:[T.\u0275\u0275StandaloneFeature],decls:24,vars:19,consts:[[1,"content-container"],[1,"top-bar-container"],["styleClass","mr-2","size","xlarge","shape","circle",3,"image"],[1,"title"],[1,"flex","flex-container"],[1,"newsArea","card","flex","justify-content-center","card-container"],[1,"see-more-container"],["pButton","","pRipple","",3,"label","click"],[1,"news-container",3,"news"],[1,"favoriteArea","card","flex","justify-content-center","card-container"],[1,"flex","grid-container"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"grid-style",3,"myAppStore","setChange","clickCard"]],template:function(H,te){1&H&&(T.\u0275\u0275elementStart(0,"div",0)(1,"div",1),T.\u0275\u0275element(2,"p-avatar",2),T.\u0275\u0275elementStart(3,"div",3),T.\u0275\u0275text(4),T.\u0275\u0275pipe(5,"translate"),T.\u0275\u0275elementEnd()(),T.\u0275\u0275elementStart(6,"div",4)(7,"div",5)(8,"div",6)(9,"h3"),T.\u0275\u0275text(10),T.\u0275\u0275pipe(11,"translate"),T.\u0275\u0275elementEnd(),T.\u0275\u0275elementStart(12,"button",7),T.\u0275\u0275listener("click",function(){return te.onMoreNewsClick()}),T.\u0275\u0275pipe(13,"translate"),T.\u0275\u0275elementEnd()(),T.\u0275\u0275element(14,"his-news-list",8),T.\u0275\u0275elementEnd(),T.\u0275\u0275elementStart(15,"div",9)(16,"div",6)(17,"h3"),T.\u0275\u0275text(18),T.\u0275\u0275pipe(19,"translate"),T.\u0275\u0275elementEnd(),T.\u0275\u0275elementStart(20,"button",7),T.\u0275\u0275listener("click",function(){return te.onMoreAppListClick()}),T.\u0275\u0275pipe(21,"translate"),T.\u0275\u0275elementEnd()(),T.\u0275\u0275elementStart(22,"div",10),T.\u0275\u0275template(23,Ze,2,1,"ng-container",11),T.\u0275\u0275elementEnd()()()()),2&H&&(T.\u0275\u0275advance(2),T.\u0275\u0275propertyInterpolate("image",te.userAccountService.userImage().image),T.\u0275\u0275advance(2),T.\u0275\u0275textInterpolate2(" ",te.userAccountService.userAccount().userCode.display,",",T.\u0275\u0275pipeBind1(5,9,"\u6b61\u8fce\u56de\u4f86")," "),T.\u0275\u0275advance(6),T.\u0275\u0275textInterpolate(T.\u0275\u0275pipeBind1(11,11,"\u6700\u65b0\u6d88\u606f")),T.\u0275\u0275advance(2),T.\u0275\u0275propertyInterpolate("label",T.\u0275\u0275pipeBind1(13,13,"\u67e5\u770b\u66f4\u591a")),T.\u0275\u0275advance(2),T.\u0275\u0275property("news",te.newsService.toDoList().concat(te.newsService.normalNews())),T.\u0275\u0275advance(4),T.\u0275\u0275textInterpolate(T.\u0275\u0275pipeBind1(19,15,"\u6211\u7684\u6700\u611b")),T.\u0275\u0275advance(2),T.\u0275\u0275propertyInterpolate("label",T.\u0275\u0275pipeBind1(21,17,"\u67e5\u770b\u66f4\u591a")),T.\u0275\u0275advance(3),T.\u0275\u0275property("ngForOf",te.appStoreService.myAppStores()))},dependencies:[J.CommonModule,J.NgForOf,J.NgIf,C.AvatarModule,C.Avatar,h.ButtonModule,h.ButtonDirective,je.D,se.NewsListComponent,de.TranslateModule,de.TranslatePipe],styles:["[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr:last-child td{border-bottom:0}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr td{padding:7.5px 0}[_nghost-%COMP%]     td .p-button .p-button-label{line-height:1.5rem}his-card-list[_ngcontent-%COMP%]{padding:4px}.content-container[_ngcontent-%COMP%]{padding:32px;height:100%;gap:16px;display:flex;flex-direction:column;background-color:var(--surface-ground)}.top-bar-container[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center}.title[_ngcontent-%COMP%]{padding-left:24px;font-size:28px;font-weight:700;line-height:40px;letter-spacing:1.12px;color:var(--primary-main)}.flex-container[_ngcontent-%COMP%]{display:flex;gap:16px;flex:1;width:100%}.grid-container[_ngcontent-%COMP%]{margin:-4px;flex:1;width:100%;align-content:flex-start;flex-wrap:wrap}.newsArea[_ngcontent-%COMP%]{width:40.63%}.favoriteArea[_ngcontent-%COMP%]{flex:1}.favoriteArea[_ngcontent-%COMP%]   his-card-list[_ngcontent-%COMP%]{height:-moz-fit-content;height:fit-content}.card-container[_ngcontent-%COMP%]{height:100%;border-radius:12px;background:var(--surface-section);padding:8px;display:flex;flex-direction:column;gap:8px}.see-more-container[_ngcontent-%COMP%]{width:100%;display:flex;justify-content:space-between;align-items:center}.news-container[_ngcontent-%COMP%]{background-color:var(--white);padding:var(--spacing-sm);border-radius:12px;overflow:hidden;width:100%;height:100%;box-shadow:0 2px 1px -1px #00000005,0 1px 1px #00000024,0 1px 3px #0000001f}.grid-style[_ngcontent-%COMP%]{cursor:pointer;width:33.3333333333%}"]})}return pe})()},931:(_t,Ce,q)=>{q.r(Ce),q.d(Ce,{NewsInfoComponent:()=>D,NewsListComponent:()=>$,NewsService:()=>S});var d=q(5861),C=q(6296),h=q(5863),T=q(5126),J=q(6753),se=q(575),oe=q(1496),_e=q(1189),je=q(3433),ge=q(6701),we=q(2182),de=q(25),Ve=q(9891),Se=q(6107),Ze=q(7752),Me=q(8426),Re=q(6488);function rt(I,K){1&I&&(h.\u0275\u0275elementContainerStart(0),h.\u0275\u0275element(1,"h1",4),h.\u0275\u0275pipe(2,"translate"),h.\u0275\u0275elementContainerEnd()),2&I&&(h.\u0275\u0275advance(1),h.\u0275\u0275property("innerText",h.\u0275\u0275pipeBind1(2,1,"\u6c92\u6709\u6700\u65b0\u6d88\u606f")))}function pe(I,K){if(1&I&&h.\u0275\u0275elementContainer(0,5),2&I){const F=h.\u0275\u0275nextContext(),U=h.\u0275\u0275reference(4);h.\u0275\u0275property("ngTemplateOutlet",U||F.customTemplate)}}function Y(I,K){if(1&I){const F=h.\u0275\u0275getCurrentView();h.\u0275\u0275elementStart(0,"span")(1,"button",10),h.\u0275\u0275listener("click",function(){h.\u0275\u0275restoreView(F);const R=h.\u0275\u0275nextContext().$implicit,ee=h.\u0275\u0275nextContext(2);return h.\u0275\u0275resetView(ee.onChangeStatus(R))}),h.\u0275\u0275pipe(2,"translate"),h.\u0275\u0275elementEnd()()}2&I&&(h.\u0275\u0275advance(1),h.\u0275\u0275property("label",h.\u0275\u0275pipeBind1(2,1,"\u5b8c\u6210")))}function W(I,K){if(1&I){const F=h.\u0275\u0275getCurrentView();h.\u0275\u0275elementStart(0,"span")(1,"p-button",11,12),h.\u0275\u0275listener("click",function(){h.\u0275\u0275restoreView(F);const R=h.\u0275\u0275nextContext().$implicit,ee=h.\u0275\u0275nextContext(2);return h.\u0275\u0275resetView(ee.onNavNewsClick(R.url,R.sharedData))}),h.\u0275\u0275pipe(3,"translate"),h.\u0275\u0275elementEnd()()}2&I&&(h.\u0275\u0275advance(1),h.\u0275\u0275property("label",h.\u0275\u0275pipeBind1(3,1,"clickToEnter")))}const H=function(){return[]},te=function(){return{hour12:!1}};function ae(I,K){if(1&I&&(h.\u0275\u0275elementStart(0,"tr")(1,"td"),h.\u0275\u0275template(2,Y,3,3,"span",8),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(3,"td")(4,"span",9),h.\u0275\u0275text(5),h.\u0275\u0275elementEnd()(),h.\u0275\u0275elementStart(6,"td")(7,"span",9),h.\u0275\u0275text(8),h.\u0275\u0275elementEnd()(),h.\u0275\u0275elementStart(9,"td"),h.\u0275\u0275template(10,W,4,3,"span",8),h.\u0275\u0275elementEnd()()),2&I){const F=K.$implicit;h.\u0275\u0275advance(2),h.\u0275\u0275property("ngIf","10"===F.execStatus.code),h.\u0275\u0275advance(3),h.\u0275\u0275textInterpolate(F.period.start.toLocaleString(h.\u0275\u0275pureFunction0(4,H),h.\u0275\u0275pureFunction0(5,te))),h.\u0275\u0275advance(3),h.\u0275\u0275textInterpolate(F.subject),h.\u0275\u0275advance(2),h.\u0275\u0275property("ngIf",F.url)}}const Pe=function(){return{width:"100%"}};function Le(I,K){if(1&I&&(h.\u0275\u0275elementStart(0,"p-table",6),h.\u0275\u0275template(1,ae,11,6,"ng-template",7),h.\u0275\u0275elementEnd()),2&I){const F=h.\u0275\u0275nextContext();h.\u0275\u0275property("value",F.news)("tableStyle",h.\u0275\u0275pureFunction0(2,Pe))}}function nt(I,K){if(1&I){const F=h.\u0275\u0275getCurrentView();h.\u0275\u0275elementStart(0,"span")(1,"button",13),h.\u0275\u0275listener("click",function(){h.\u0275\u0275restoreView(F);const R=h.\u0275\u0275nextContext().$implicit,ee=h.\u0275\u0275nextContext(2);return h.\u0275\u0275resetView(ee.onChangeStatus(R))}),h.\u0275\u0275pipe(2,"translate"),h.\u0275\u0275elementEnd()()}2&I&&(h.\u0275\u0275advance(1),h.\u0275\u0275property("label",h.\u0275\u0275pipeBind1(2,1,"\u5b8c\u6210")))}function A(I,K){if(1&I){const F=h.\u0275\u0275getCurrentView();h.\u0275\u0275elementStart(0,"span")(1,"p-button",14,12),h.\u0275\u0275listener("click",function(){h.\u0275\u0275restoreView(F);const R=h.\u0275\u0275nextContext().$implicit,ee=h.\u0275\u0275nextContext(2);return h.\u0275\u0275resetView(ee.onNavNewsClick(R.url,R.sharedData))}),h.\u0275\u0275pipe(3,"translate"),h.\u0275\u0275elementEnd()()}2&I&&(h.\u0275\u0275advance(1),h.\u0275\u0275property("label",h.\u0275\u0275pipeBind1(3,1,"\u8acb\u9ede\u9078\u9032\u5165")))}function $e(I,K){if(1&I&&(h.\u0275\u0275elementStart(0,"tr")(1,"td"),h.\u0275\u0275template(2,nt,3,3,"span",8),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(3,"td")(4,"span",9),h.\u0275\u0275text(5),h.\u0275\u0275elementEnd()(),h.\u0275\u0275elementStart(6,"td")(7,"span",9),h.\u0275\u0275text(8),h.\u0275\u0275elementEnd()(),h.\u0275\u0275elementStart(9,"td"),h.\u0275\u0275template(10,A,4,3,"span",8),h.\u0275\u0275elementEnd()()),2&I){const F=K.$implicit;h.\u0275\u0275advance(2),h.\u0275\u0275property("ngIf","10"===F.execStatus.code),h.\u0275\u0275advance(3),h.\u0275\u0275textInterpolate(F.period.start.toLocaleString(h.\u0275\u0275pureFunction0(4,te))),h.\u0275\u0275advance(3),h.\u0275\u0275textInterpolate(F.subject),h.\u0275\u0275advance(2),h.\u0275\u0275property("ngIf",F.url)}}function Z(I,K){if(1&I&&(h.\u0275\u0275elementStart(0,"p-table",6),h.\u0275\u0275template(1,$e,11,5,"ng-template",7),h.\u0275\u0275elementEnd()),2&I){const F=h.\u0275\u0275nextContext();h.\u0275\u0275property("value",F.news)("tableStyle",h.\u0275\u0275pureFunction0(2,Pe))}}function Q(I,K){1&I&&(h.\u0275\u0275elementStart(0,"div"),h.\u0275\u0275element(1,"span",19),h.\u0275\u0275elementEnd())}function N(I,K){1&I&&(h.\u0275\u0275elementStart(0,"div"),h.\u0275\u0275element(1,"span",20),h.\u0275\u0275elementEnd())}function ie(I,K){1&I&&(h.\u0275\u0275elementStart(0,"div"),h.\u0275\u0275element(1,"span",19),h.\u0275\u0275elementEnd())}function ke(I,K){1&I&&(h.\u0275\u0275elementStart(0,"div"),h.\u0275\u0275element(1,"span",20),h.\u0275\u0275elementEnd())}function gt(I,K){1&I&&(h.\u0275\u0275elementStart(0,"div"),h.\u0275\u0275element(1,"span",19),h.\u0275\u0275elementEnd())}function x(I,K){1&I&&(h.\u0275\u0275elementStart(0,"div"),h.\u0275\u0275element(1,"span",20),h.\u0275\u0275elementEnd())}function w(I,K){1&I&&(h.\u0275\u0275elementStart(0,"div"),h.\u0275\u0275element(1,"span",19),h.\u0275\u0275elementEnd())}function P(I,K){1&I&&(h.\u0275\u0275elementStart(0,"div"),h.\u0275\u0275element(1,"span",20),h.\u0275\u0275elementEnd())}let S=(()=>{class I{constructor(){this.originalNews=(0,h.signal)({}),this.allNormalNews=(0,h.signal)({}),this.allTodoList=(0,h.signal)({}),this.normalNews=(0,h.signal)({}),this.toDoList=(0,h.signal)({}),this.checkedNormalNews=(0,h.signal)({}),this.checkedToDoList=(0,h.signal)({}),this.#t="ws://localhost:8080",this.#e=new T.Subject,this.#n=(0,h.inject)(J.JetstreamWsService)}#t;#e;#r;#n;connect(){var F=this;return(0,d.Z)(function*(){yield F.#n.connect(F.#t)})()}disconnect(){var F=this;return(0,d.Z)(function*(){yield F.#n.drain()})()}getInitNews(F){return this.#n.request("news.appPortal.newsList",F)}changeStatus(F){const U=new Date;this.originalNews.mutate(R=>{const ee=R.findIndex(ce=>ce._id==F._id);R.splice(ee,1)}),F.execStatus={code:"60",display:"\u5df2\u8b80/\u5df2\u5b8c\u6210"},F.execTime=U,this.#n.publish("news.appPortal.setNews",F)}filterType(F,U){return U?F.filter(R=>R.type.code==U):F}filterStatus(F,U){return U?F.filter(R=>R.execStatus.code==U):F}filterOverdue(F){const U=new Date;return F.filter(ee=>U.valueOf()-ee.execTime.valueOf()<864e5)}filterSubject(F){const U=this.originalNews();this.upsertNews(U.filter(R=>R.subject.match(F)))}filterReset(){this.upsertNews(this.originalNews())}upsertNews(F){this.allNormalNews.set(this.filterType(F,"10")),this.allTodoList.set(this.filterType(F,"60")),this.normalNews.set(this.filterStatus(this.allNormalNews(),"10")),this.toDoList.set(this.filterStatus(this.allTodoList(),"10")),this.checkedNormalNews.set(this.filterOverdue(this.filterStatus(this.allNormalNews(),"60"))),this.checkedToDoList.set(this.filterOverdue(this.filterStatus(this.allTodoList(),"60")))}upsertAllNews(F){this.originalNews.set(F),this.upsertNews(F)}formatNews(F){const U=[];return F.forEach(R=>{const ee={_id:R._id,appId:R.appId,userCode:R.userCode,subject:R.subject,url:R.url,sharedData:R.sharedData,period:{start:new Date(R.period.start),end:new Date(R.period.end)},type:R.type,execTime:new Date(R.execTime),execStatus:R.execStatus,updatedBy:R.updatedBy,updatedAt:new Date(R.updatedAt)};U.push(ee)}),U}subMyNews(F){var U=this;return(0,d.Z)(function*(){U.#e=new T.Subject;const R=(0,J.JSONCodec)();U.#r=U.#n.subscribe(J.SubscribeType.Push,`news.appPortal.${F.code}`),U.#r.pipe((0,T.mergeMap)(function(){var ee=(0,d.Z)(function*(ce){var qe,ye=!1,be=!1;try{for(var He,Ue=(0,C.Z)(ce);ye=!(He=yield Ue.next()).done;ye=!1){const wt=He.value;U.#e.next(R.decode(wt.data)),wt.ack()}}catch(wt){be=!0,qe=wt}finally{try{ye&&null!=Ue.return&&(yield Ue.return())}finally{if(be)throw qe}}});return function(ce){return ee.apply(this,arguments)}}())).subscribe(()=>{}),U.#e.subscribe(ee=>{U.originalNews.mutate(ce=>{const ye=U.formatNews([ee]);ce.push(ye[0])}),U.upsertNews(U.originalNews())})})()}static#s=this.\u0275fac=function(U){return new(U||I)};static#i=this.\u0275prov=h.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac,providedIn:"root"})}return I})(),$=(()=>{class I{constructor(){this.newsService=(0,h.inject)(S),this.sharedService=(0,h.inject)(we.SharedService),this.#t=(0,h.inject)(ge.Router)}#t;onNavNewsClick(F,U){const R=this.sharedService.setValue(U);this.#t.navigate([F],{state:{token:R}})}onChangeStatus(F){var U=this;return(0,d.Z)(function*(){U.newsService.changeStatus(F)})()}static#e=this.\u0275fac=function(U){return new(U||I)};static#r=this.\u0275cmp=h.\u0275\u0275defineComponent({type:I,selectors:[["his-news-list"]],inputs:{news:"news",customTemplate:"customTemplate"},standalone:!0,features:[h.\u0275\u0275StandaloneFeature],decls:7,vars:2,consts:[[4,"ngIf","ngIfElse"],["ShowNews",""],["defaultTable",""],["customtemplate",""],[1,"p-datatable",3,"innerText"],[3,"ngTemplateOutlet"],[3,"value","tableStyle"],["pTemplate","body"],[4,"ngIf"],[1,"label-m"],["pButton","","pRipple","","type","button",1,"p-button-outlined","check-button",3,"label","click"],["styleclass","p-button-link",3,"label","click"],["navButton",""],["pButton","","pRipple","","type","button",1,"p-button-outlined",3,"label","click"],["styleClass","p-button-link",3,"label","click"]],template:function(U,R){if(1&U&&(h.\u0275\u0275template(0,rt,3,3,"ng-container",0),h.\u0275\u0275template(1,pe,1,1,"ng-template",null,1,h.\u0275\u0275templateRefExtractor),h.\u0275\u0275template(3,Le,2,3,"ng-template",null,2,h.\u0275\u0275templateRefExtractor),h.\u0275\u0275template(5,Z,2,3,"ng-template",null,3,h.\u0275\u0275templateRefExtractor)),2&U){const ee=h.\u0275\u0275reference(2);h.\u0275\u0275property("ngIf",R.news&&R.news.length<1)("ngIfElse",ee)}},dependencies:[se.CommonModule,se.NgIf,se.NgTemplateOutlet,oe.TableModule,oe.Table,de.PrimeTemplate,_e.ButtonModule,_e.ButtonDirective,_e.Button,je.TranslateModule,je.TranslatePipe],styles:[".check-button[_ngcontent-%COMP%]{width:88px;height:32px;padding:4px,12px,4px,12px;border-radius:20px;border:1px;gap:4px}[_nghost-%COMP%]     .p-datatable{height:100%;background:#fff;font-style:normal;font-weight:400;line-height:20px;letter-spacing:.16px;color:var(--surface-on-surface)}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr{width:100%}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr:last-child>td{border-bottom:none}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td{padding:8px 0}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td:first-child{width:5%;min-width:45px}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td:first-child .p-button{min-width:60px}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td:nth-child(2){width:13%}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td:last-child{width:13%}[_nghost-%COMP%]     .p-fieldset{border-radius:12px}[_nghost-%COMP%]     .p-fieldset .p-fieldset-content{padding:8px 12px}"]})}return I})(),D=(()=>{class I{constructor(){this.news=(0,h.computed)(()=>this.newsService.originalNews()),this.normalNews=(0,h.computed)(()=>this.newsService.normalNews()),this.toDoList=(0,h.computed)(()=>this.newsService.toDoList()),this.checkedNormalNews=(0,h.computed)(()=>this.newsService.checkedNormalNews()),this.checkedToDoList=(0,h.computed)(()=>this.newsService.checkedToDoList()),this.query="",this.newsService=(0,h.inject)(S),this.sharedService=(0,h.inject)(we.SharedService),this.httpClient=(0,h.inject)(Ze.HttpClient),this.userAccountService=(0,h.inject)(Re.N),this.#t=(0,h.inject)(ge.Router)}#t;onBackClick(){window.history.back()}onNavNewsClick(F,U){const R=this.sharedService.setValue(U);this.#t.navigate([F],{state:{token:R}})}filterSubject(){this.newsService.filterSubject(this.query)}filterReset(){this.newsService.filterReset()}static#e=this.\u0275fac=function(U){return new(U||I)};static#r=this.\u0275cmp=h.\u0275\u0275defineComponent({type:I,selectors:[["his-news-info"]],standalone:!0,features:[h.\u0275\u0275StandaloneFeature],decls:38,vars:32,consts:[[1,"content-container"],[1,"top-bar-container"],["styleClass","mr-2","size","xlarge","shape","circle",3,"image"],[1,"title"],[1,"toolbar-container"],[1,"icon-container"],["pButton","","pRipple","","type","button","icon","pi pi-angle-left",1,"p-button-rounded","p-button-secondary","p-button-outlined",3,"click"],[3,"innerText"],[1,"p-input-icon-left"],[1,"pi","pi-search"],["type","text","pinputtext","",1,"p-inputtext","p-component","p-element",3,"placeholder","ngModel","ngModelChange","keyup","keyup.excape"],[1,"flex","flex-column"],[1,"first",3,"legend","toggleable"],["pTemplate","expandicon"],["pTemplate","collapseicon"],[1,"news-container",3,"news"],[1,"second",3,"legend","toggleable"],[1,"third",3,"legend","toggleable"],[1,"fourth",3,"legend","toggleable"],[1,"pi","pi-chevron-down"],[1,"pi","pi-chevron-up"]],template:function(U,R){1&U&&(h.\u0275\u0275elementStart(0,"div",0)(1,"div",1),h.\u0275\u0275element(2,"p-avatar",2),h.\u0275\u0275elementStart(3,"div",3),h.\u0275\u0275text(4),h.\u0275\u0275pipe(5,"translate"),h.\u0275\u0275elementEnd()(),h.\u0275\u0275elementStart(6,"div",4)(7,"div",5)(8,"button",6),h.\u0275\u0275listener("click",function(){return R.onBackClick()}),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(9,"div"),h.\u0275\u0275element(10,"h3",7),h.\u0275\u0275pipe(11,"translate"),h.\u0275\u0275elementEnd()(),h.\u0275\u0275elementStart(12,"div")(13,"span",8),h.\u0275\u0275element(14,"i",9),h.\u0275\u0275elementStart(15,"input",10),h.\u0275\u0275listener("ngModelChange",function(ce){return R.query=ce})("keyup",function(){return R.filterSubject()})("keyup.excape",function(){return R.filterReset()}),h.\u0275\u0275pipe(16,"translate"),h.\u0275\u0275elementEnd()()()(),h.\u0275\u0275elementStart(17,"div",11)(18,"p-fieldset",12),h.\u0275\u0275pipe(19,"translate"),h.\u0275\u0275template(20,Q,2,0,"ng-template",13),h.\u0275\u0275template(21,N,2,0,"ng-template",14),h.\u0275\u0275element(22,"his-news-list",15),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(23,"p-fieldset",16),h.\u0275\u0275pipe(24,"translate"),h.\u0275\u0275template(25,ie,2,0,"ng-template",13),h.\u0275\u0275template(26,ke,2,0,"ng-template",14),h.\u0275\u0275element(27,"his-news-list",15),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(28,"p-fieldset",17),h.\u0275\u0275pipe(29,"translate"),h.\u0275\u0275template(30,gt,2,0,"ng-template",13),h.\u0275\u0275template(31,x,2,0,"ng-template",14),h.\u0275\u0275element(32,"his-news-list",15),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(33,"p-fieldset",18),h.\u0275\u0275pipe(34,"translate"),h.\u0275\u0275template(35,w,2,0,"ng-template",13),h.\u0275\u0275template(36,P,2,0,"ng-template",14),h.\u0275\u0275element(37,"his-news-list",15),h.\u0275\u0275elementEnd()()()),2&U&&(h.\u0275\u0275advance(2),h.\u0275\u0275propertyInterpolate("image",R.userAccountService.userImage().image),h.\u0275\u0275advance(2),h.\u0275\u0275textInterpolate2(" ",R.userAccountService.userAccount().userCode.display,",",h.\u0275\u0275pipeBind1(5,18,"\u6b61\u8fce\u56de\u4f86")," "),h.\u0275\u0275advance(6),h.\u0275\u0275property("innerText",h.\u0275\u0275pipeBind1(11,20,"\u6700\u65b0\u6d88\u606f")),h.\u0275\u0275advance(5),h.\u0275\u0275property("placeholder",h.\u0275\u0275pipeBind1(16,22,"\u641c\u5c0b"))("ngModel",R.query),h.\u0275\u0275advance(3),h.\u0275\u0275property("legend",h.\u0275\u0275pipeBind1(19,24,"\u4ee3\u8fa6\u5de5\u4f5c"))("toggleable",!0),h.\u0275\u0275advance(4),h.\u0275\u0275property("news",R.toDoList()),h.\u0275\u0275advance(1),h.\u0275\u0275property("legend",h.\u0275\u0275pipeBind1(24,26,"\u516c\u544a\u8a0a\u606f"))("toggleable",!0),h.\u0275\u0275advance(4),h.\u0275\u0275property("news",R.normalNews()),h.\u0275\u0275advance(1),h.\u0275\u0275property("legend",h.\u0275\u0275pipeBind1(29,28,"\u5b8c\u6210\u5de5\u4f5c"))("toggleable",!0),h.\u0275\u0275advance(4),h.\u0275\u0275property("news",R.checkedToDoList()),h.\u0275\u0275advance(1),h.\u0275\u0275property("legend",h.\u0275\u0275pipeBind1(34,30,"\u5df2\u8b80\u8a0a\u606f"))("toggleable",!0),h.\u0275\u0275advance(4),h.\u0275\u0275property("news",R.checkedNormalNews()))},dependencies:[se.CommonModule,$,oe.TableModule,de.PrimeTemplate,Ve.FieldsetModule,Ve.Fieldset,_e.ButtonModule,_e.ButtonDirective,Se.AvatarModule,Se.Avatar,je.TranslateModule,je.TranslatePipe,Me.FormsModule,Me.DefaultValueAccessor,Me.NgControlStatus,Me.NgModel],styles:[".top-bar-container[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center}.icon-container[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:12px}.icon-container[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.5rem;font-style:normal;font-weight:700;line-height:2rem;letter-spacing:.03rem;color:var(--surface-on-surface)}.content-container[_ngcontent-%COMP%]{padding:32px;height:100%;gap:16px;display:flex;flex-direction:column;background-color:var(--surface-ground)}.flex-column[_ngcontent-%COMP%]{gap:26px}[_nghost-%COMP%]     p-fieldset .p-fieldset-toggleable .p-fieldset-legend{padding:0;margin-left:-1px;width:129px;transition:background-color .2s,color .2s,box-shadow .2s}[_nghost-%COMP%]     p-fieldset .p-fieldset-toggleable .p-fieldset-legend a{min-height:34px;padding:var(--spacing-xs) var(--spacing-md)}[_nghost-%COMP%]     p-fieldset .p-fieldset-legend-text{font-weight:700}[_nghost-%COMP%]     p-fieldset .p-fieldset .p-fieldset-content{padding:8px 0}[_nghost-%COMP%]     p-fieldset .p-fieldset-legend>a{flex-direction:row-reverse}[_nghost-%COMP%]     p-fieldset .p-fieldset.p-fieldset-toggleable .p-fieldset-legend a .p-fieldset-toggler{margin-right:0;margin-left:18px}[_nghost-%COMP%]     p-fieldset.first .p-fieldset-toggleable .p-fieldset-legend{background-color:var(--tertiary-main)}[_nghost-%COMP%]     p-fieldset.first .p-fieldset-toggleable .p-fieldset-legend a{color:var(--white)}[_nghost-%COMP%]     p-fieldset.second .p-fieldset-toggleable .p-fieldset-legend{background-color:var(--primary-main)}[_nghost-%COMP%]     p-fieldset.second .p-fieldset-toggleable .p-fieldset-legend a{color:#f6f6f6}[_nghost-%COMP%]     p-fieldset.third .p-fieldset-toggleable .p-fieldset-legend{background-color:var(--surface-section)}[_nghost-%COMP%]     p-fieldset.third .p-fieldset-toggleable .p-fieldset-legend a{color:var(--surface-on-surface)}[_nghost-%COMP%]     .p-datatable{height:100%;background:#fff;font-style:normal;font-weight:400;line-height:20px;letter-spacing:.16px;color:var(--surface-on-surface)}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr{width:100%}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr:last-child>td{border-bottom:none}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td{padding:8px 0 8px 5px}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td:first-child{width:5%;padding-left:0;min-width:45px}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td:first-child .p-button{min-width:60px}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td:nth-child(2){width:10%;padding-left:14px}[_nghost-%COMP%]     .p-datatable .p-datatable-tbody>tr>td:last-child{width:10%;text-align:end}[_nghost-%COMP%]     .p-fieldset{border-radius:12px}[_nghost-%COMP%]     .p-fieldset .p-fieldset-content{padding:8px 0}.title[_ngcontent-%COMP%]{padding-left:24px;font-size:28px;font-weight:700;line-height:40px;letter-spacing:1.12px;color:var(--primary-main)}.toolbar-container[_ngcontent-%COMP%]{display:flex;flex-direction:row;width:100%;justify-content:space-between}.p-button[_ngcontent-%COMP%]{color:#fff;background:var(--primary-main);border:0 none;padding:4px 12px;font-size:1rem;transition:background-color .2s,border-color .2s,color .2s,box-shadow .2s,background-size .2s cubic-bezier(.64,.09,.08,1);border-radius:6px}.check-button[_ngcontent-%COMP%]{width:88px;height:32px;padding:4px,12px,4px,12px;border-radius:20px;border:1px;gap:4px}.p-input-icon-left[_ngcontent-%COMP%]{padding:0 3px 0 0;width:320px}.p-inputtext[_ngcontent-%COMP%]{width:100%}.pi[_ngcontent-%COMP%]{width:17.51px;height:17.51px}"]})}return I})()},6488:(_t,Ce,q)=>{q.d(Ce,{N:()=>T});var d=q(5863),C=q(9159);let T=(()=>{class J{constructor(){this.#t=(0,d.inject)(C.JetstreamWsService),this.userAccount=(0,d.signal)({}),this.userImage=(0,d.signal)({})}#t;getUserImage(oe){this.#t.request("UserImage.GetUserImage",oe).subscribe(_e=>{this.userImage.set(_e),console.log("get image",_e)})}static#e=this.\u0275fac=function(_e){return new(_e||J)};static#r=this.\u0275prov=d.\u0275\u0275defineInjectable({token:J,factory:J.\u0275fac,providedIn:"root"})}return J})()},6984:(_t,Ce,q)=>{q.d(Ce,{D:()=>pe});var d=q(5863),C=q(575),h=q(1189),T=q(7069),J=q(6701);function se(Y,W){if(1&Y&&(d.\u0275\u0275elementContainerStart(0),d.\u0275\u0275elementContainer(1,5),d.\u0275\u0275elementContainerEnd()),2&Y){const H=d.\u0275\u0275nextContext(2);d.\u0275\u0275advance(1),d.\u0275\u0275property("ngTemplateOutlet",H.footerTemplate)}}function oe(Y,W){if(1&Y){const H=d.\u0275\u0275getCurrentView();d.\u0275\u0275elementContainerStart(0),d.\u0275\u0275elementStart(1,"div",4),d.\u0275\u0275listener("click",function(){d.\u0275\u0275restoreView(H);const ae=d.\u0275\u0275nextContext();return d.\u0275\u0275resetView(ae.directToApp(ae.myAppStore.url))}),d.\u0275\u0275elementContainer(2,5)(3,5),d.\u0275\u0275template(4,se,2,1,"ng-container",0),d.\u0275\u0275elementEnd(),d.\u0275\u0275elementContainerEnd()}if(2&Y){const H=d.\u0275\u0275nextContext(),te=d.\u0275\u0275reference(3),ae=d.\u0275\u0275reference(5);d.\u0275\u0275advance(2),d.\u0275\u0275property("ngTemplateOutlet",te),d.\u0275\u0275advance(1),d.\u0275\u0275property("ngTemplateOutlet",ae),d.\u0275\u0275advance(1),d.\u0275\u0275property("ngIf",H.footerTemplate)}}function _e(Y,W){if(1&Y){const H=d.\u0275\u0275getCurrentView();d.\u0275\u0275elementContainerStart(0),d.\u0275\u0275elementStart(1,"div",6),d.\u0275\u0275listener("click",function(){d.\u0275\u0275restoreView(H);const ae=d.\u0275\u0275nextContext();return d.\u0275\u0275resetView(ae.directToApp(ae.myAppStore.url))}),d.\u0275\u0275elementContainer(2,5),d.\u0275\u0275elementEnd(),d.\u0275\u0275elementContainerEnd()}if(2&Y){d.\u0275\u0275nextContext();const H=d.\u0275\u0275reference(7);d.\u0275\u0275advance(2),d.\u0275\u0275property("ngTemplateOutlet",H)}}function je(Y,W){if(1&Y&&(d.\u0275\u0275elementStart(0,"div",7)(1,"div",8)(2,"span",9),d.\u0275\u0275text(3),d.\u0275\u0275elementEnd()()()),2&Y){const H=d.\u0275\u0275nextContext();d.\u0275\u0275advance(3),d.\u0275\u0275textInterpolate1(" ",H.myAppStore.icon," ")}}function ge(Y,W){1&Y&&(d.\u0275\u0275elementContainerStart(0),d.\u0275\u0275element(1,"span",15),d.\u0275\u0275elementContainerEnd())}function we(Y,W){1&Y&&(d.\u0275\u0275elementContainerStart(0),d.\u0275\u0275element(1,"span",16),d.\u0275\u0275elementContainerEnd())}function de(Y,W){if(1&Y){const H=d.\u0275\u0275getCurrentView();d.\u0275\u0275elementStart(0,"div",10)(1,"div",11)(2,"span",12),d.\u0275\u0275text(3),d.\u0275\u0275elementEnd(),d.\u0275\u0275elementStart(4,"button",13),d.\u0275\u0275listener("click",function(ae){d.\u0275\u0275restoreView(H);const Pe=d.\u0275\u0275nextContext();return Pe.changeFavorite(Pe.myAppStore.appId),d.\u0275\u0275resetView(ae.stopPropagation())}),d.\u0275\u0275template(5,ge,2,0,"ng-container",0),d.\u0275\u0275template(6,we,2,0,"ng-container",0),d.\u0275\u0275elementEnd()(),d.\u0275\u0275elementStart(7,"h5",14),d.\u0275\u0275text(8),d.\u0275\u0275elementEnd()()}if(2&Y){const H=d.\u0275\u0275nextContext();d.\u0275\u0275advance(3),d.\u0275\u0275textInterpolate(H.myAppStore.versionNo),d.\u0275\u0275advance(2),d.\u0275\u0275property("ngIf",1==H.myAppStore.isFavorite),d.\u0275\u0275advance(1),d.\u0275\u0275property("ngIf",!0!==H.myAppStore.isFavorite),d.\u0275\u0275advance(2),d.\u0275\u0275textInterpolate(H.myAppStore.title)}}function Ve(Y,W){1&Y&&(d.\u0275\u0275elementContainerStart(0),d.\u0275\u0275element(1,"span",15),d.\u0275\u0275elementContainerEnd())}function Se(Y,W){1&Y&&(d.\u0275\u0275elementContainerStart(0),d.\u0275\u0275element(1,"span",16),d.\u0275\u0275elementContainerEnd())}function Ze(Y,W){1&Y&&(d.\u0275\u0275elementStart(0,"span"),d.\u0275\u0275text(1,"\u3001"),d.\u0275\u0275elementEnd())}function Me(Y,W){if(1&Y&&(d.\u0275\u0275elementContainerStart(0),d.\u0275\u0275text(1),d.\u0275\u0275template(2,Ze,2,0,"span",0),d.\u0275\u0275elementContainerEnd()),2&Y){const H=W.$implicit,te=W.last;d.\u0275\u0275advance(1),d.\u0275\u0275textInterpolate1(" ",H.title,""),d.\u0275\u0275advance(1),d.\u0275\u0275property("ngIf",!te)}}function Re(Y,W){if(1&Y){const H=d.\u0275\u0275getCurrentView();d.\u0275\u0275elementStart(0,"div",17)(1,"button",13),d.\u0275\u0275listener("click",function(ae){d.\u0275\u0275restoreView(H);const Pe=d.\u0275\u0275nextContext();return Pe.changeFavorite(Pe.myAppStore.appId),d.\u0275\u0275resetView(ae.stopPropagation())}),d.\u0275\u0275template(2,Ve,2,0,"ng-container",0),d.\u0275\u0275template(3,Se,2,0,"ng-container",0),d.\u0275\u0275elementEnd(),d.\u0275\u0275elementStart(4,"div",8)(5,"span",9),d.\u0275\u0275text(6),d.\u0275\u0275elementEnd()(),d.\u0275\u0275elementStart(7,"div",14),d.\u0275\u0275text(8),d.\u0275\u0275elementEnd(),d.\u0275\u0275elementStart(9,"div",18),d.\u0275\u0275template(10,Me,3,2,"ng-container",19),d.\u0275\u0275elementEnd(),d.\u0275\u0275elementStart(11,"div",20),d.\u0275\u0275text(12),d.\u0275\u0275elementEnd(),d.\u0275\u0275elementStart(13,"div",20),d.\u0275\u0275text(14),d.\u0275\u0275elementEnd()()}if(2&Y){const H=d.\u0275\u0275nextContext();d.\u0275\u0275advance(2),d.\u0275\u0275property("ngIf",1==H.myAppStore.isFavorite),d.\u0275\u0275advance(1),d.\u0275\u0275property("ngIf",!0!==H.myAppStore.isFavorite),d.\u0275\u0275advance(3),d.\u0275\u0275textInterpolate1(" ",H.myAppStore.icon," "),d.\u0275\u0275advance(2),d.\u0275\u0275textInterpolate(H.myAppStore.title),d.\u0275\u0275advance(2),d.\u0275\u0275property("ngForOf",H.myAppStore.appPages),d.\u0275\u0275advance(2),d.\u0275\u0275textInterpolate1("\u7dad\u8b77\u4eba\u54e1\uff1a",H.myAppStore.home.maintainer.display,""),d.\u0275\u0275advance(2),d.\u0275\u0275textInterpolate(H.myAppStore.versionNo)}}let pe=(()=>{class Y{constructor(){this.setChange=new d.EventEmitter,this.clickCard=new d.EventEmitter}directToApp(H){console.log("in component directToApp",H),this.clickCard.emit(H)}changeFavorite(H){this.setChange.emit(H)}static#t=this.\u0275fac=function(te){return new(te||Y)};static#e=this.\u0275cmp=d.\u0275\u0275defineComponent({type:Y,selectors:[["his-card-list"]],inputs:{myAppStore:"myAppStore",isListView:"isListView",headerTemplate:"headerTemplate",bodyTemplate:"bodyTemplate",footerTemplate:"footerTemplate"},outputs:{setChange:"setChange",clickCard:"clickCard"},standalone:!0,features:[d.\u0275\u0275StandaloneFeature],decls:8,vars:2,consts:[[4,"ngIf"],["gridViewHeader",""],["gridViewBody",""],["listViewHeader",""],[1,"p-card","p-commponent","app-grid-card",3,"click"],[3,"ngTemplateOutlet"],[1,"p-card","p-commponent","app-list-card",3,"click"],[1,"grid-header-container"],[1,"p-image","p-component"],[1,"material-symbols-outlined","icon-style"],[1,"grid-body-container"],[1,"btnBox"],[1,"subtitle","caption-s"],[3,"click"],[1,"title","label-l"],[1,"pi","pi-star-fill","selected"],[1,"pi","pi-star"],[1,"list-header-container"],[1,"content","caption-l"],[4,"ngFor","ngForOf"],[1,"subtitle","caption-m"]],template:function(te,ae){1&te&&(d.\u0275\u0275template(0,oe,5,3,"ng-container",0),d.\u0275\u0275template(1,_e,3,1,"ng-container",0),d.\u0275\u0275template(2,je,4,1,"ng-template",null,1,d.\u0275\u0275templateRefExtractor),d.\u0275\u0275template(4,de,9,4,"ng-template",null,2,d.\u0275\u0275templateRefExtractor),d.\u0275\u0275template(6,Re,15,7,"ng-template",null,3,d.\u0275\u0275templateRefExtractor)),2&te&&(d.\u0275\u0275property("ngIf",!ae.isListView),d.\u0275\u0275advance(1),d.\u0275\u0275property("ngIf",ae.isListView))},dependencies:[C.CommonModule,C.NgForOf,C.NgIf,C.NgTemplateOutlet,T.ImageModule,h.ButtonModule,J.RouterModule],styles:[".app-grid-card[_ngcontent-%COMP%]{display:flex;padding:var(--spacing-md) var(--spacing-sm);gap:8px;border-radius:12px;height:100px;cursor:pointer}.app-list-card[_ngcontent-%COMP%]{display:flex;padding:4px 12px;flex-direction:row;gap:8px;border-radius:12px}.grid-header-container[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;align-items:flex-start}.list-header-container[_ngcontent-%COMP%]{height:100%;width:100%;display:flex;flex-direction:row;align-items:center;padding:var(--spacing-xs) var(--spacing-xxl);gap:var(--spacing-sm)}.list-header-container[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{color:var(--surface-on-surface)}.list-header-container[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{padding-left:5px;flex:1}.list-header-container[_ngcontent-%COMP%]   .pi[_ngcontent-%COMP%]{transition:all .3s}.list-header-container[_ngcontent-%COMP%]   .pi.selected[_ngcontent-%COMP%]{color:var(--yellow-500)}.grid-body-container[_ngcontent-%COMP%]{display:flex;flex:1;flex-direction:column}.grid-body-container[_ngcontent-%COMP%]   .btnBox[_ngcontent-%COMP%]{width:100%;display:flex;justify-content:flex-end;align-items:center;gap:var(--spacing-sm)}.grid-body-container[_ngcontent-%COMP%]   .btnBox[_ngcontent-%COMP%]   .pi[_ngcontent-%COMP%]{transition:all .3s}.grid-body-container[_ngcontent-%COMP%]   .btnBox[_ngcontent-%COMP%]   .pi.selected[_ngcontent-%COMP%]{color:var(--yellow-500)}button[_ngcontent-%COMP%]{cursor:pointer;background-color:transparent;border:none}.icon-style[_ngcontent-%COMP%]{width:100%;height:100%;display:flex;justify-content:center;align-items:center;color:var(--surface-a);font-size:48px}[_nghost-%COMP%]     .p-button{padding:0;color:var(--surface-on-surface)}[_nghost-%COMP%]     .body-container .p-button.p-button-icon-only{height:2rem}[_nghost-%COMP%]     .body-container .p-button.p-button-icon-only .pi{font-size:.7rem}[_nghost-%COMP%]     .p-image.p-component{display:block;width:72px;height:72px;background-color:var(--primary-main);border-radius:18px;overflow:hidden;padding:8px;position:relative;background:linear-gradient(0deg,rgba(0,0,0,.2) 0%,rgba(0,0,0,0) 100%),var(--primary-main);box-shadow:0 2px 1px -1px #00000005,0 1px 1px #00000024,0 1px 3px #0000001f}[_nghost-%COMP%]     .p-image.p-component img{display:block;width:100%;height:100%}[_nghost-%COMP%]     .app-grid-card .p-button{height:2rem}[_nghost-%COMP%]     .app-grid-card.p-card{transition:all .3s}[_nghost-%COMP%]     .app-grid-card.p-card:hover{transform:translateY(-3px);border-bottom:3px solid var(--primary-main)}[_nghost-%COMP%]     .app-list-card.p-card{transition:all .3s}"]})}return Y})()},6296:(_t,Ce,q)=>{function d(h){var T,J,se,oe=2;for(typeof Symbol<"u"&&(J=Symbol.asyncIterator,se=Symbol.iterator);oe--;){if(J&&null!=(T=h[J]))return T.call(h);if(se&&null!=(T=h[se]))return new C(T.call(h));J="@@asyncIterator",se="@@iterator"}throw new TypeError("Object is not async iterable")}function C(h){function T(J){if(Object(J)!==J)return Promise.reject(new TypeError(J+" is not an object."));var se=J.done;return Promise.resolve(J.value).then(function(oe){return{value:oe,done:se}})}return(C=function(se){this.s=se,this.n=se.next}).prototype={s:null,n:null,next:function(){return T(this.n.apply(this.s,arguments))},return:function(se){var oe=this.s.return;return void 0===oe?Promise.resolve({value:se,done:!0}):T(oe.apply(this.s,arguments))},throw:function(se){var oe=this.s.return;return void 0===oe?Promise.reject(se):T(oe.apply(this.s,arguments))}},new C(h)}q.d(Ce,{Z:()=>d})},7582:(_t,Ce,q)=>{function J(x,w,P,S){var I,$=arguments.length,D=$<3?w:null===S?S=Object.getOwnPropertyDescriptor(w,P):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)D=Reflect.decorate(x,w,P,S);else for(var K=x.length-1;K>=0;K--)(I=x[K])&&(D=($<3?I(D):$>3?I(w,P,D):I(w,P))||D);return $>3&&D&&Object.defineProperty(w,P,D),D}function de(x,w,P,S){return new(P||(P=Promise))(function(D,I){function K(R){try{U(S.next(R))}catch(ee){I(ee)}}function F(R){try{U(S.throw(R))}catch(ee){I(ee)}}function U(R){R.done?D(R.value):function $(D){return D instanceof P?D:new P(function(I){I(D)})}(R.value).then(K,F)}U((S=S.apply(x,w||[])).next())})}function W(x){return this instanceof W?(this.v=x,this):new W(x)}function H(x,w,P){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var $,S=P.apply(x,w||[]),D=[];return $={},I("next"),I("throw"),I("return"),$[Symbol.asyncIterator]=function(){return this},$;function I(ce){S[ce]&&($[ce]=function(ye){return new Promise(function(be,qe){D.push([ce,ye,be,qe])>1||K(ce,ye)})})}function K(ce,ye){try{!function F(ce){ce.value instanceof W?Promise.resolve(ce.value.v).then(U,R):ee(D[0][2],ce)}(S[ce](ye))}catch(be){ee(D[0][3],be)}}function U(ce){K("next",ce)}function R(ce){K("throw",ce)}function ee(ce,ye){ce(ye),D.shift(),D.length&&K(D[0][0],D[0][1])}}function ae(x){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var P,w=x[Symbol.asyncIterator];return w?w.call(x):(x=function Me(x){var w="function"==typeof Symbol&&Symbol.iterator,P=w&&x[w],S=0;if(P)return P.call(x);if(x&&"number"==typeof x.length)return{next:function(){return x&&S>=x.length&&(x=void 0),{value:x&&x[S++],done:!x}}};throw new TypeError(w?"Object is not iterable.":"Symbol.iterator is not defined.")}(x),P={},S("next"),S("throw"),S("return"),P[Symbol.asyncIterator]=function(){return this},P);function S(D){P[D]=x[D]&&function(I){return new Promise(function(K,F){!function $(D,I,K,F){Promise.resolve(F).then(function(U){D({value:U,done:K})},I)}(K,F,(I=x[D](I)).done,I.value)})}}}q.d(Ce,{FC:()=>H,KL:()=>ae,gn:()=>J,mG:()=>de,qq:()=>W}),"function"==typeof SuppressedError&&SuppressedError}}]);