(self.webpackChunkapp_portal=self.webpackChunkapp_portal||[]).push([[9191,3395],{9159:(Tt,Ne,Z)=>{Z.r(Ne),Z.d(Ne,{AckPolicy:()=>Wn,DeliverPolicy:()=>Xn,JSONCodec:()=>Re,JetstreamWsService:()=>Kr,RetentionPolicy:()=>Yn,SubscribeType:()=>pr});var h=Z(5861),C=Z(7582),xe=Z(5863),pe=Z(5126),K=Z(6296);function oe(n,e){this.v=n,this.k=e}function X(n){return new oe(n,0)}function Ue(n){var e,t;function r(i,o){try{var c=n[i](o),d=c.value,p=d instanceof oe;Promise.resolve(p?d.v:d).then(function(b){if(p){var _="return"===i?"return":"next";if(!d.k||b.done)return r(_,b);b=n[_](b).value}s(c.done?"return":"normal",b)},function(b){r("throw",b)})}catch(b){s("throw",b)}}function s(i,o){switch(i){case"return":e.resolve({value:o,done:!0});break;case"throw":e.reject(o);break;default:e.resolve({value:o,done:!1})}(e=e.next)?r(e.key,e.arg):t=null}this._invoke=function(i,o){return new Promise(function(c,d){var p={key:i,arg:o,resolve:c,reject:d,next:null};t?t=t.next=p:(e=t=p,r(i,o))})},"function"!=typeof n.return&&(this.return=void 0)}function je(n){return function(){return new Ue(n.apply(this,arguments))}}Ue.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},Ue.prototype.next=function(n){return this._invoke("next",n)},Ue.prototype.throw=function(n){return this._invoke("throw",n)},Ue.prototype.return=function(n){return this._invoke("return",n)};const ne=new Uint8Array(0),Ce=new TextEncoder,le=new TextDecoder;function Oe(...n){const e=[];for(let t=0;t<n.length;t++)e.push(Ce.encode(n[t]));return 0===e.length?ne:1===e.length?e[0]:function pt(...n){let e=0;for(let s=0;s<n.length;s++)e+=n[s].length;const t=new Uint8Array(e);let r=0;for(let s=0;s<n.length;s++)t.set(n[s],r),r+=n[s].length;return t}(...e)}function ot(n){return n&&0!==n.length?le.decode(n):""}const Ve="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";const Pe=new class he{buf;seq;inc;constructor(){this.buf=new Uint8Array(22),this.init()}init(){this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(0xcfd41b9100000*Math.random()),this.inc=Math.floor(300*Math.random()+33)}setPre(){const e=new Uint8Array(12);!function ge(n){globalThis?.crypto?.getRandomValues?globalThis.crypto.getRandomValues(n):function G(n){for(let e=0;e<n.length;e++)n[e]=Math.floor(255*Math.random())}(n)}(e);for(let t=0;t<12;t++)this.buf[t]=Ve.charCodeAt(e[t]%36)}fillSeq(){let e=this.seq;for(let t=21;t>=12;t--)this.buf[t]=Ve.charCodeAt(e%36),e=Math.floor(e/36)}next(){return this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}};var Le=function(n){return n.Disconnect="disconnect",n.Reconnect="reconnect",n.Update="update",n.LDM="ldm",n.Error="error",n}(Le||{}),ct=function(n){return n.Reconnecting="reconnecting",n.PingTimer="pingTimer",n.StaleConnection="staleConnection",n}(ct||{}),O=function(n){return n.ApiError="BAD API",n.BadAuthentication="BAD_AUTHENTICATION",n.BadCreds="BAD_CREDS",n.BadHeader="BAD_HEADER",n.BadJson="BAD_JSON",n.BadPayload="BAD_PAYLOAD",n.BadSubject="BAD_SUBJECT",n.Cancelled="CANCELLED",n.ConnectionClosed="CONNECTION_CLOSED",n.ConnectionDraining="CONNECTION_DRAINING",n.ConnectionRefused="CONNECTION_REFUSED",n.ConnectionTimeout="CONNECTION_TIMEOUT",n.Disconnect="DISCONNECT",n.InvalidOption="INVALID_OPTION",n.InvalidPayload="INVALID_PAYLOAD",n.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",n.NoResponders="503",n.NotFunction="NOT_FUNC",n.RequestError="REQUEST_ERROR",n.ServerOptionNotAvailable="SERVER_OPT_NA",n.SubClosed="SUB_CLOSED",n.SubDraining="SUB_DRAINING",n.Timeout="TIMEOUT",n.Tls="TLS",n.Unknown="UNKNOWN_ERROR",n.WssRequired="WSS_REQUIRED",n.JetStreamInvalidAck="JESTREAM_INVALID_ACK",n.JetStream404NoMessages="404",n.JetStream408RequestTimeout="408",n.JetStream409MaxAckPendingExceeded="409",n.JetStream409="409",n.JetStreamNotEnabled="503",n.JetStreamIdleHeartBeat="IDLE_HEARTBEAT",n.AuthorizationViolation="AUTHORIZATION_VIOLATION",n.AuthenticationExpired="AUTHENTICATION_EXPIRED",n.ProtocolError="NATS_PROTOCOL_ERR",n.PermissionsViolation="PERMISSIONS_VIOLATION",n.AuthenticationTimeout="AUTHENTICATION_TIMEOUT",n}(O||{});class L{messages;constructor(){this.messages=new Map,this.messages.set(O.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(O.BadJson,"Bad JSON"),this.messages.set(O.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(e){return H.getMessage(e)}getMessage(e){return this.messages.get(e)||e}}const H=new L;class I extends Error{name;message;code;permissionContext;chainedError;api_error;constructor(e,t,r){super(e),this.name="NatsError",this.message=e,this.code=t,this.chainedError=r}static errorForCode(e,t){const r=L.getMessage(e);return new I(r,e,t)}isAuthError(){return this.code===O.AuthenticationExpired||this.code===O.AuthorizationViolation}isAuthTimeout(){return this.code===O.AuthenticationTimeout}isPermissionError(){return this.code===O.PermissionsViolation}isProtocolError(){return this.code===O.ProtocolError}isJetStreamError(){return void 0!==this.api_error}jsError(){return this.api_error?this.api_error:null}}var V=function(n){return n[n.Exact=0]="Exact",n[n.CanonicalMIME=1]="CanonicalMIME",n[n.IgnoreCase=2]="IgnoreCase",n}(V||{}),fe=function(n){return n.Timer="timer",n.Count="count",n.JitterTimer="jitterTimer",n.SentinelMsg="sentinelMsg",n}(fe||{}),Nt=function(n){return n.STATS="io.nats.micro.v1.stats_response",n.INFO="io.nats.micro.v1.info_response",n.PING="io.nats.micro.v1.ping_response",n}(Nt||{});const x="Nats-Service-Error",v="Nats-Service-Error-Code";class P extends Error{code;constructor(e,t){super(t),this.code=e}static isServiceError(e){return null!==P.toServiceError(e)}static toServiceError(e){const t=e?.headers?.get(v)||"";if(""!==t){const r=parseInt(t)||400,s=e?.headers?.get(x)||"";return new P(r,s.length?s:t)}return null}}function S(n=""){if("string"!=typeof(n=n||"_INBOX"))throw new Error("prefix must be a string");return n.split(".").forEach(e=>{if("*"===e||">"===e)throw new Error(`inbox prefixes cannot have wildcards '${n}'`)}),`${n}.${Pe.next()}`}const R="127.0.0.1";var N=function(n){return n.PING="PING",n.STATS="STATS",n.INFO="INFO",n}(N||{});function q(n,...e){for(let t=0;t<e.length;t++){const r=e[t];Object.keys(r).forEach(function(s){n[s]=r[s]})}return n}function Q(n){return le.decode(n).replace(/\n/g,"\u240a").replace(/\r/g,"\u240d")}function be(n){const e=I.errorForCode(O.Timeout);let t,r;const s=new Promise((i,o)=>{t={cancel:()=>{r&&clearTimeout(r)}},r=setTimeout(()=>{o(e)},n)});return Object.assign(s,t)}function D(n=0){return new Promise(e=>{setTimeout(()=>{e()},n)})}function B(){let n={};const e=new Promise((t,r)=>{n={resolve:t,reject:r}});return Object.assign(e,n)}function ye(n){for(let e=n.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[n[e],n[t]]=[n[t],n[e]]}return n}class Se{buffers;byteLength;constructor(){this.buffers=[],this.byteLength=0}static concat(...e){let t=0;for(let i=0;i<e.length;i++)t+=e[i].length;const r=new Uint8Array(t);let s=0;for(let i=0;i<e.length;i++)r.set(e[i],s),s+=e[i].length;return r}static fromAscii(e){return e||(e=""),Ce.encode(e)}static toAscii(e){return le.decode(e)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){const e=new Uint8Array(this.byteLength);let t=0;for(let r=0;r<this.buffers.length;r++)e.set(this.buffers[r],t),t+=this.buffers[r].length;this.buffers.length=0,this.buffers.push(e)}}shift(){if(this.buffers.length){const e=this.buffers.shift();if(e)return this.byteLength-=e.length,e}return new Uint8Array(0)}drain(e){if(this.buffers.length){this.pack();const t=this.buffers.pop();if(t){const r=this.byteLength;(void 0===e||e>r)&&(e=r);const s=t.subarray(0,e);return r>e&&this.buffers.push(t.subarray(e)),this.byteLength=r-e,s}}return new Uint8Array(0)}fill(e,...t){e&&(this.buffers.push(e),this.byteLength+=e.length);for(let r=0;r<t.length;r++)t[r]&&t[r].length&&(this.buffers.push(t[r]),this.byteLength+=t[r].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}let de;function We(){return void 0!==de&&void 0!==de.defaultPort?de.defaultPort:4222}function et(){return void 0!==de&&de.urlParseFn?de.urlParseFn:void 0}function hn(){return void 0!==de&&de.dnsResolveFn?de.dnsResolveFn:void 0}const rr=Se.fromAscii("\r\n"),ps=new Uint8Array(rr)[0],ms=new Uint8Array(rr)[1];const bs=4,fn=48,ys=65,xs=97;function Pr(n){return void 0!==function ws(n){for(let e=0;e<n.length;e++)switch(n[e]){case".":return dn(n);case":":return Ss(n)}}(n)}function dn(n){const e=new Uint8Array(4);for(let t=0;t<4;t++){if(0===n.length)return;if(t>0){if("."!==n[0])return;n=n.substring(1)}const{n:r,c:s,ok:i}=Es(n);if(!i||r>255)return;n=n.substring(s),e[t]=r}return function vs(n,e,t,r){const s=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach((o,c)=>{s[c]=o}),s[12]=n,s[13]=e,s[14]=t,s[15]=r,s}(e[0],e[1],e[2],e[3])}function Ss(n){const e=new Uint8Array(16);let t=-1;if(n.length>=2&&":"===n[0]&&":"===n[1]&&(t=0,0===(n=n.substring(2)).length))return e;let r=0;for(;r<16;){const{n:s,c:i,ok:o}=Cs(n);if(!o||s>65535)return;if(i<n.length&&"."===n[i]){if(t<0&&12!=r||r+4>16)return;const c=dn(n);if(void 0===c)return;e[r]=c[12],e[r+1]=c[13],e[r+2]=c[14],e[r+3]=c[15],n="",r+=bs;break}if(e[r]=s>>8,e[r+1]=s,r+=2,0===(n=n.substring(i)).length)break;if(":"!==n[0]||1==n.length)return;if(":"===(n=n.substring(1))[0]){if(t>=0)return;if(t=r,0===(n=n.substring(1)).length)break}}if(0===n.length){if(r<16){if(t<0)return;const s=16-r;for(let i=r-1;i>=t;i--)e[i+s]=e[i];for(let i=t+s-1;i>=t;i--)e[i]=0}else if(t>=0)return;return e}}function Es(n){let e=0,t=0;for(e=0;e<n.length&&48<=n.charCodeAt(e)&&n.charCodeAt(e)<=57;e++)if(t=10*t+(n.charCodeAt(e)-fn),t>=16777215)return{n:16777215,c:e,ok:!1};return 0===e?{n:0,c:0,ok:!1}:{n:t,c:e,ok:!0}}function Cs(n){let e=0,t=0;for(t=0;t<n.length;t++){if(48<=n.charCodeAt(t)&&n.charCodeAt(t)<=57)e*=16,e+=n.charCodeAt(t)-fn;else if(97<=n.charCodeAt(t)&&n.charCodeAt(t)<=102)e*=16,e+=n.charCodeAt(t)-xs+10;else{if(!(65<=n.charCodeAt(t)&&n.charCodeAt(t)<=70))break;e*=16,e+=n.charCodeAt(t)-ys+10}if(e>=16777215)return{n:0,c:t,ok:!1}}return 0===t?{n:0,c:t,ok:!1}:{n:e,c:t,ok:!0}}function Ar(n){return!function Ps(n){return-1!==n.indexOf(".")||-1===n.indexOf("[")&&-1===n.indexOf("::")&&n.split(":").length<=2}(n)}class $t{src;listen;hostname;port;didConnect;reconnects;lastConnect;gossiped;tlsName;resolves;constructor(e,t=!1){this.src=e,this.tlsName="";const r=function Os(n){(n=n.trim()).match(/^(.*:\/\/)(.*)/m)&&(n=n.replace(/^(.*:\/\/)(.*)/gm,"$2")),n=function As(n){const t=n.toUpperCase().indexOf("::FFFF:");if(-1!==t&&-1!==n.indexOf(".")){let r=n.substring(t+7);return r=r.replace("[",""),r.replace("]","")}return n}(n),Ar(n)&&-1===n.indexOf("[")&&(n=`[${n}]`);const e=Ar(n)?n.match(/(]:)(\d+)/):n.match(/(:)(\d+)/),t=e&&3===e.length&&e[1]&&e[2]?parseInt(e[2]):4222,s=new URL(`${80===t?"https":"http"}://${n}`);s.port=`${t}`;let i=s.hostname;return"["===i.charAt(0)&&(i=i.substring(1,i.length-1)),{listen:s.host,hostname:i,port:t}}(e);this.listen=r.listen,this.hostname=r.hostname,this.port=r.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=t}toString(){return this.listen}resolve(e){var t=this;return(0,h.Z)(function*(){if(!e.fn)return[t];const r=[];if(Pr(t.hostname))return[t];{const s=yield e.fn(t.hostname);e.debug&&console.log(`resolve ${t.hostname} = ${s.join(",")}`);for(const i of s){const c=new URL(`${80===t.port?"https":"http"}://${Ar(i)?"["+i+"]":i}`);c.port=`${t.port}`;const d=new $t(c.host,!1);d.tlsName=t.hostname,r.push(d)}}return e.randomize&&ye(r),t.resolves=r,r})()}}class ks{firstSelect;servers;currentServer;tlsName;randomize;constructor(e=[],t={}){this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=t.randomize||!1;const r=et();e&&(e.forEach(s=>{s=r?r(s):s,this.servers.push(new $t(s))}),this.randomize&&(this.servers=ye(this.servers))),0===this.servers.length&&this.addServer(`${R}:${We()}`,!1),this.currentServer=this.servers[0]}clear(){this.servers.length=0}updateTLSName(){const e=this.getCurrentServer();Pr(e.hostname)||(this.tlsName=e.hostname,this.servers.forEach(t=>{t.gossiped&&(t.tlsName=this.tlsName)}))}getCurrentServer(){return this.currentServer}addServer(e,t=!1){const r=et();e=r?r(e):e;const s=new $t(e,t);Pr(s.hostname)&&(s.tlsName=this.tlsName),this.servers.push(s)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;const e=this.servers.shift();return e&&(this.servers.push(e),this.currentServer=e),e}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(e){if(e){const t=this.servers.indexOf(e);this.servers.splice(t,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(e){const t=[];let r=[];const s=et(),i=new Map;e.connect_urls&&e.connect_urls.length>0&&e.connect_urls.forEach(c=>{c=s?s(c):c;const d=new $t(c,!0);i.set(c,d)});const o=[];return this.servers.forEach((c,d)=>{const p=c.listen;c.gossiped&&this.currentServer.listen!==p&&void 0===i.get(p)&&o.push(d),i.delete(p)}),o.reverse(),o.forEach(c=>{const d=this.servers.splice(c,1);r=r.concat(d[0].listen)}),i.forEach((c,d)=>{this.servers.push(c),t.push(d)}),{added:t,deleted:r}}}class Ae{inflight;processed;received;noIterator;iterClosed;done;signal;yields;filtered;pendingFiltered;ingestionFilterFn;protocolFilterFn;dispatchedFn;ctx;_data;err;time;constructor(){this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=B(),this.yields=[],this.iterClosed=B(),this.time=0}[Symbol.asyncIterator](){return this.iterate()}push(e){if(this.done)return;if("function"==typeof e)return this.yields.push(e),void this.signal.resolve();const{ingest:t,protocol:r}=this.ingestionFilterFn?this.ingestionFilterFn(e,this.ctx||this):{ingest:!0,protocol:!1};t&&(r&&(this.filtered++,this.pendingFiltered++),this.yields.push(e),this.signal.resolve())}iterate(){var e=this;return je(function*(){if(e.noIterator)throw new I("unsupported iterator",O.ApiError);try{for(;;){if(0===e.yields.length&&(yield X(e.signal)),e.err)throw e.err;const t=e.yields;e.inflight=t.length,e.yields=[];for(let r=0;r<t.length;r++)if("function"!=typeof t[r]){if(!e.protocolFilterFn||e.protocolFilterFn(t[r])){e.processed++;const i=Date.now();yield t[r],e.time=Date.now()-i,e.dispatchedFn&&t[r]&&e.dispatchedFn(t[r])}else e.pendingFiltered--;e.inflight--}else{const i=t[r];try{i()}catch(o){throw o}if(e.err)throw e.err}if(e.done)break;0===e.yields.length&&(t.length=0,e.yields=t,e.signal=B())}}finally{e.stop()}})()}stop(e){this.done||(this.err=e,this.done=!0,this.signal.resolve(),this.iterClosed.resolve())}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}function pn(n){let r=!0;const s=new Array(n.length);for(let i=0;i<n.length;i++){let o=n.charCodeAt(i);if(58===o||o<33||o>126)throw new I(`'${n[i]}' is not a valid character for a header key`,O.BadHeader);r&&97<=o&&o<=122?o-=32:!r&&65<=o&&o<=90&&(o+=32),s[i]=o,r=45==o}return String.fromCharCode(...s)}function tt(n=0,e=""){if(0===n&&""!==e||n>0&&""===e)throw new Error("setting status requires both code and description");return new ut(n,e)}const Or="NATS/1.0";class ut{_code;headers;_description;constructor(e=0,t=""){this._code=e,this._description=t,this.headers=new Map}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(e){if(e&&this.headers.size===e.headers.size&&this._code===e._code){for(const[t,r]of this.headers){const s=e.values(t);if(r.length!==s.length)return!1;const i=[...r].sort(),o=[...s].sort();for(let c=0;c<i.length;c++)if(i[c]!==o[c])return!1}return!0}return!1}static decode(e){const t=new ut,s=le.decode(e).split("\r\n"),i=s[0];if(i!==Or){let o=i.replace(Or,"").trim();if(o.length>0){t._code=parseInt(o,10),isNaN(t._code)&&(t._code=0);const c=t._code.toString();o=o.replace(c,""),t._description=o.trim()}}return s.length>=1&&s.slice(1).map(o=>{if(o){const c=o.indexOf(":");if(c>-1){const d=o.slice(0,c),p=o.slice(c+1).trim();t.append(d,p)}}}),t}toString(){if(0===this.headers.size&&0===this._code)return"";let e=Or;this._code>0&&""!==this._description&&(e+=` ${this._code} ${this._description}`);for(const[t,r]of this.headers)for(let s=0;s<r.length;s++)e=`${e}\r\n${t}: ${r[s]}`;return`${e}\r\n\r\n`}encode(){return Ce.encode(this.toString())}static validHeaderValue(e){if(/[\r\n]/.test(e))throw new I("invalid header value - \\r and \\n are not allowed.",O.BadHeader);return e.trim()}keys(){const e=[];for(const t of this.headers.keys())e.push(t);return e}findKeys(e,t=V.Exact){const r=this.keys();switch(t){case V.Exact:return r.filter(s=>s===e);case V.CanonicalMIME:return e=pn(e),r.filter(s=>s===e);default:{const s=e.toLowerCase();return r.filter(i=>s===i.toLowerCase())}}}get(e,t=V.Exact){const r=this.findKeys(e,t);if(r.length){const s=this.headers.get(r[0]);if(s)return Array.isArray(s)?s[0]:s}return""}has(e,t=V.Exact){return this.findKeys(e,t).length>0}set(e,t,r=V.Exact){this.delete(e,r),this.append(e,t,r)}append(e,t,r=V.Exact){const s=pn(e);r===V.CanonicalMIME&&(e=s);const i=this.findKeys(e,r);e=i.length>0?i[0]:e;const o=ut.validHeaderValue(t);let c=this.headers.get(e);c||(c=[],this.headers.set(e,c)),c.push(o)}values(e,t=V.Exact){const r=[];return this.findKeys(e,t).forEach(i=>{const o=this.headers.get(i);o&&r.push(...o)}),r}delete(e,t=V.Exact){this.findKeys(e,t).forEach(s=>{this.headers.delete(s)})}get hasError(){return this._code>=300}get status(){return`${this._code} ${this._description}`.trim()}toRecord(){const e={};return this.keys().forEach(t=>{e[t]=this.values(t)}),e}get code(){return this._code}get description(){return this._description}static fromRecord(e){const t=new ut;for(const r in e)t.headers.set(r,e[r]);return t}}function Re(n){return{encode(e){try{return void 0===e&&(e=null),Ce.encode(JSON.stringify(e))}catch(t){throw I.errorForCode(O.BadJson,t)}},decode(e){try{return JSON.parse(le.decode(e),n)}catch(t){throw I.errorForCode(O.BadJson,t)}}}}function mn(n){return n&&0===n.data.length&&503===n.headers?.code?I.errorForCode(O.NoResponders):null}let _n=(()=>class n{_headers;_msg;_rdata;_reply;_subject;publisher;static jc;constructor(t,r,s){this._msg=t,this._rdata=r,this.publisher=s}get subject(){return this._subject||(this._subject=le.decode(this._msg.subject)),this._subject}get reply(){return this._reply||(this._reply=le.decode(this._msg.reply)),this._reply}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){const t=this._rdata.subarray(0,this._msg.hdr);this._headers=ut.decode(t)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(t=ne,r){return!!this.reply&&(this.publisher.publish(this.reply,t,r),!0)}size(){return this._msg.subject.length+(this._msg.reply?.length||0)+(-1===this._msg.size?0:this._msg.size)}json(t){return Re(t).decode(this.data)}string(){return le.decode(this.data)}})();class Is{baseInbox;reqs;constructor(){this.reqs=new Map}size(){return this.reqs.size}init(e){return this.baseInbox=`${S(e)}.`,this.baseInbox}add(e){isNaN(e.received)||(e.received=0),this.reqs.set(e.token,e)}get(e){return this.reqs.get(e)}cancel(e){this.reqs.delete(e.token)}getToken(e){const t=e.subject||"";return 0===t.indexOf(this.baseInbox)?t.substring(this.baseInbox.length):null}all(){return Array.from(this.reqs.values())}handleError(e,t){if(t&&t.permissionContext){if(e)return this.all().forEach(s=>{s.resolver(t,{})}),!0;const r=t.permissionContext;if("publish"===r.operation){const s=this.all().find(i=>i.requestSubject===r.subject);if(s)return s.resolver(t,{}),!0}}return!1}dispatcher(){return(e,t)=>{const r=this.getToken(t);if(r){const s=this.get(r);s&&(null===e&&t.headers&&(e=mn(t)),s.resolver(e,t))}}}close(){const e=I.errorForCode(O.Timeout);this.reqs.forEach(t=>{t.resolver(e,{})})}}class Ms{ph;interval;maxOut;timer;pendings;constructor(e,t,r){this.ph=e,this.interval=t,this.maxOut=r,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(e){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),e&&this.ph.disconnect()}_schedule(){this.timer=setTimeout(()=>{if(this.ph.dispatchStatus({type:ct.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut)return void this.cancel(!0);const e=B();this.ph.flush(e).then(()=>{this._reset()}).catch(()=>{this.cancel()}),this.pendings.push(e),this._schedule()},this.interval)}_reset(){this.pendings=this.pendings.filter(e=>(e.resolve(),!1))}}class Ts extends Error{constructor(e){super(e),this.name="AssertionError"}}const kr=2**32-2;function nr(n,e,t=0){const r=e.byteLength-t;return n.byteLength>r&&(n=n.subarray(0,r)),e.set(n,t),n.byteLength}class jr{_buf;_off;constructor(e){this._off=0,this._buf=null!=e?new Uint8Array(e):new Uint8Array(0)}bytes(e={copy:!0}){return!1===e.copy?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(e){if(0!==e){if(e<0||e>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+e)}else this.reset()}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(e){const t=this._buf.byteLength;return e<=this.capacity-t?(this._reslice(t+e),t):-1}_reslice(e){(function Ns(n,e="Assertion failed."){if(!n)throw new Ts(e)})(e<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,e)}readByte(){const e=new Uint8Array(1);return this.read(e)?e[0]:null}read(e){if(this.empty())return this.reset(),0===e.byteLength?0:null;const t=nr(this._buf.subarray(this._off),e);return this._off+=t,t}writeByte(e){return this.write(Uint8Array.of(e))}writeString(e){return this.write(Ce.encode(e))}write(e){const t=this._grow(e.byteLength);return nr(e,this._buf,t)}_grow(e){const t=this.length;0===t&&0!==this._off&&this.reset();const r=this._tryGrowByReslice(e);if(r>=0)return r;const s=this.capacity;if(e<=Math.floor(s/2)-t)nr(this._buf.subarray(this._off),this._buf);else{if(s+e>kr)throw new Error("The buffer cannot be grown beyond the maximum size.");{const i=new Uint8Array(Math.min(2*s+e,kr));nr(this._buf.subarray(this._off),i),this._buf=i}}return this._off=0,this._reslice(Math.min(t+e,kr)),t}grow(e){if(e<0)throw Error("Buffer._grow: negative count");const t=this._grow(e);this._reslice(t)}readFrom(e){let t=0;const r=new Uint8Array(32768);for(;;){const s=this.capacity-this.length<32768,i=s?r:new Uint8Array(this._buf.buffer,this.length),o=e.read(i);if(null===o)return t;s?this.write(i.subarray(0,o)):this._reslice(this.length+o),t+=o}}}var Ie=function(n){return n[n.OK=0]="OK",n[n.ERR=1]="ERR",n[n.MSG=2]="MSG",n[n.INFO=3]="INFO",n[n.PING=4]="PING",n[n.PONG=5]="PONG",n}(Ie||{});class yn{dispatcher;state;as;drop;hdr;ma;argBuf;msgBuf;constructor(e){this.dispatcher=e,this.state=$.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(e){let t;for(t=0;t<e.length;t++){const r=e[t];switch(this.state){case $.OP_START:switch(r){case U.M:case U.m:this.state=$.OP_M,this.hdr=-1,this.ma={sid:-1,hdr:-1,size:-1};break;case U.H:case U.h:this.state=$.OP_H,this.hdr=0,this.ma={sid:-1,hdr:-1,size:-1};break;case U.P:case U.p:this.state=$.OP_P;break;case U.PLUS:this.state=$.OP_PLUS;break;case U.MINUS:this.state=$.OP_MINUS;break;case U.I:case U.i:this.state=$.OP_I;break;default:throw this.fail(e.subarray(t))}break;case $.OP_H:switch(r){case U.M:case U.m:this.state=$.OP_M;break;default:throw this.fail(e.subarray(t))}break;case $.OP_M:switch(r){case U.S:case U.s:this.state=$.OP_MS;break;default:throw this.fail(e.subarray(t))}break;case $.OP_MS:switch(r){case U.G:case U.g:this.state=$.OP_MSG;break;default:throw this.fail(e.subarray(t))}break;case $.OP_MSG:switch(r){case U.SPACE:case U.TAB:this.state=$.OP_MSG_SPC;break;default:throw this.fail(e.subarray(t))}break;case $.OP_MSG_SPC:switch(r){case U.SPACE:case U.TAB:continue;default:this.state=$.MSG_ARG,this.as=t}break;case $.MSG_ARG:switch(r){case U.CR:this.drop=1;break;case U.NL:{const s=this.argBuf?this.argBuf.bytes():e.subarray(this.as,t-this.drop);this.processMsgArgs(s),this.drop=0,this.as=t+1,this.state=$.MSG_PAYLOAD,t=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(r)}break;case $.MSG_PAYLOAD:if(this.msgBuf)if(this.msgBuf.length>=this.ma.size){const s=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:Ie.MSG,msg:this.ma,data:s}),this.argBuf=void 0,this.msgBuf=void 0,this.state=$.MSG_END}else{let s=this.ma.size-this.msgBuf.length;const i=e.length-t;i<s&&(s=i),s>0?(this.msgBuf.write(e.subarray(t,t+s)),t=t+s-1):this.msgBuf.writeByte(r)}else t-this.as>=this.ma.size&&(this.dispatcher.push({kind:Ie.MSG,msg:this.ma,data:e.subarray(this.as,t)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=$.MSG_END);break;case $.MSG_END:if(r!==U.NL)continue;this.drop=0,this.as=t+1,this.state=$.OP_START;break;case $.OP_PLUS:switch(r){case U.O:case U.o:this.state=$.OP_PLUS_O;break;default:throw this.fail(e.subarray(t))}break;case $.OP_PLUS_O:switch(r){case U.K:case U.k:this.state=$.OP_PLUS_OK;break;default:throw this.fail(e.subarray(t))}break;case $.OP_PLUS_OK:r===U.NL&&(this.dispatcher.push({kind:Ie.OK}),this.drop=0,this.state=$.OP_START);break;case $.OP_MINUS:switch(r){case U.E:case U.e:this.state=$.OP_MINUS_E;break;default:throw this.fail(e.subarray(t))}break;case $.OP_MINUS_E:switch(r){case U.R:case U.r:this.state=$.OP_MINUS_ER;break;default:throw this.fail(e.subarray(t))}break;case $.OP_MINUS_ER:switch(r){case U.R:case U.r:this.state=$.OP_MINUS_ERR;break;default:throw this.fail(e.subarray(t))}break;case $.OP_MINUS_ERR:switch(r){case U.SPACE:case U.TAB:this.state=$.OP_MINUS_ERR_SPC;break;default:throw this.fail(e.subarray(t))}break;case $.OP_MINUS_ERR_SPC:switch(r){case U.SPACE:case U.TAB:continue;default:this.state=$.MINUS_ERR_ARG,this.as=t}break;case $.MINUS_ERR_ARG:switch(r){case U.CR:this.drop=1;break;case U.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:Ie.ERR,data:s}),this.drop=0,this.as=t+1,this.state=$.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(r))}break;case $.OP_P:switch(r){case U.I:case U.i:this.state=$.OP_PI;break;case U.O:case U.o:this.state=$.OP_PO;break;default:throw this.fail(e.subarray(t))}break;case $.OP_PO:switch(r){case U.N:case U.n:this.state=$.OP_PON;break;default:throw this.fail(e.subarray(t))}break;case $.OP_PON:switch(r){case U.G:case U.g:this.state=$.OP_PONG;break;default:throw this.fail(e.subarray(t))}break;case $.OP_PONG:r===U.NL&&(this.dispatcher.push({kind:Ie.PONG}),this.drop=0,this.state=$.OP_START);break;case $.OP_PI:switch(r){case U.N:case U.n:this.state=$.OP_PIN;break;default:throw this.fail(e.subarray(t))}break;case $.OP_PIN:switch(r){case U.G:case U.g:this.state=$.OP_PING;break;default:throw this.fail(e.subarray(t))}break;case $.OP_PING:r===U.NL&&(this.dispatcher.push({kind:Ie.PING}),this.drop=0,this.state=$.OP_START);break;case $.OP_I:switch(r){case U.N:case U.n:this.state=$.OP_IN;break;default:throw this.fail(e.subarray(t))}break;case $.OP_IN:switch(r){case U.F:case U.f:this.state=$.OP_INF;break;default:throw this.fail(e.subarray(t))}break;case $.OP_INF:switch(r){case U.O:case U.o:this.state=$.OP_INFO;break;default:throw this.fail(e.subarray(t))}break;case $.OP_INFO:switch(r){case U.SPACE:case U.TAB:this.state=$.OP_INFO_SPC;break;default:throw this.fail(e.subarray(t))}break;case $.OP_INFO_SPC:switch(r){case U.SPACE:case U.TAB:continue;default:this.state=$.INFO_ARG,this.as=t}break;case $.INFO_ARG:switch(r){case U.CR:this.drop=1;break;case U.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:Ie.INFO,data:s}),this.drop=0,this.as=t+1,this.state=$.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(r)}break;default:throw this.fail(e.subarray(t))}}(this.state===$.MSG_ARG||this.state===$.MINUS_ERR_ARG||this.state===$.INFO_ARG)&&!this.argBuf&&(this.argBuf=new jr(e.subarray(this.as,t-this.drop))),this.state===$.MSG_PAYLOAD&&!this.msgBuf&&(this.argBuf||this.cloneMsgArg(),this.msgBuf=new jr(e.subarray(this.as)))}cloneMsgArg(){const e=this.ma.subject.length,r=new Uint8Array(e+(this.ma.reply?this.ma.reply.length:0));r.set(this.ma.subject),this.ma.reply&&r.set(this.ma.reply,e),this.argBuf=new jr(r),this.ma.subject=r.subarray(0,e),this.ma.reply&&(this.ma.reply=r.subarray(e))}processMsgArgs(e){if(this.hdr>=0)return this.processHeaderMsgArgs(e);const t=[];let r=-1;for(let s=0;s<e.length;s++)switch(e[s]){case U.SPACE:case U.TAB:case U.CR:case U.NL:r>=0&&(t.push(e.subarray(r,s)),r=-1);break;default:r<0&&(r=s)}switch(r>=0&&t.push(e.subarray(r)),t.length){case 3:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(t[2]);break;case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.size=this.protoParseInt(t[3]);break;default:throw this.fail(e,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(e,"processMsgArgs Bad or Missing Size Error")}fail(e,t=""){return t=t?`${t} [${this.state}]`:`parse error [${this.state}]`,new Error(`${t}: ${le.decode(e)}`)}processHeaderMsgArgs(e){const t=[];let r=-1;for(let s=0;s<e.length;s++)switch(e[s]){case U.SPACE:case U.TAB:case U.CR:case U.NL:r>=0&&(t.push(e.subarray(r,s)),r=-1);break;default:r<0&&(r=s)}switch(r>=0&&t.push(e.subarray(r)),t.length){case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(t[2]),this.ma.size=this.protoParseInt(t[3]);break;case 5:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.hdr=this.protoParseInt(t[3]),this.ma.size=this.protoParseInt(t[4]);break;default:throw this.fail(e,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(e){if(0===e.length)return-1;let t=0;for(let r=0;r<e.length;r++){if(e[r]<48||e[r]>57)return-1;t=10*t+(e[r]-48)}return t}}var $=function(n){return n[n.OP_START=0]="OP_START",n[n.OP_PLUS=1]="OP_PLUS",n[n.OP_PLUS_O=2]="OP_PLUS_O",n[n.OP_PLUS_OK=3]="OP_PLUS_OK",n[n.OP_MINUS=4]="OP_MINUS",n[n.OP_MINUS_E=5]="OP_MINUS_E",n[n.OP_MINUS_ER=6]="OP_MINUS_ER",n[n.OP_MINUS_ERR=7]="OP_MINUS_ERR",n[n.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",n[n.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",n[n.OP_M=10]="OP_M",n[n.OP_MS=11]="OP_MS",n[n.OP_MSG=12]="OP_MSG",n[n.OP_MSG_SPC=13]="OP_MSG_SPC",n[n.MSG_ARG=14]="MSG_ARG",n[n.MSG_PAYLOAD=15]="MSG_PAYLOAD",n[n.MSG_END=16]="MSG_END",n[n.OP_H=17]="OP_H",n[n.OP_P=18]="OP_P",n[n.OP_PI=19]="OP_PI",n[n.OP_PIN=20]="OP_PIN",n[n.OP_PING=21]="OP_PING",n[n.OP_PO=22]="OP_PO",n[n.OP_PON=23]="OP_PON",n[n.OP_PONG=24]="OP_PONG",n[n.OP_I=25]="OP_I",n[n.OP_IN=26]="OP_IN",n[n.OP_INF=27]="OP_INF",n[n.OP_INFO=28]="OP_INFO",n[n.OP_INFO_SPC=29]="OP_INFO_SPC",n[n.INFO_ARG=30]="INFO_ARG",n}($||{}),U=function(n){return n[n.CR="\r".charCodeAt(0)]="CR",n[n.E="E".charCodeAt(0)]="E",n[n.e="e".charCodeAt(0)]="e",n[n.F="F".charCodeAt(0)]="F",n[n.f="f".charCodeAt(0)]="f",n[n.G="G".charCodeAt(0)]="G",n[n.g="g".charCodeAt(0)]="g",n[n.H="H".charCodeAt(0)]="H",n[n.h="h".charCodeAt(0)]="h",n[n.I="I".charCodeAt(0)]="I",n[n.i="i".charCodeAt(0)]="i",n[n.K="K".charCodeAt(0)]="K",n[n.k="k".charCodeAt(0)]="k",n[n.M="M".charCodeAt(0)]="M",n[n.m="m".charCodeAt(0)]="m",n[n.MINUS="-".charCodeAt(0)]="MINUS",n[n.N="N".charCodeAt(0)]="N",n[n.n="n".charCodeAt(0)]="n",n[n.NL="\n".charCodeAt(0)]="NL",n[n.O="O".charCodeAt(0)]="O",n[n.o="o".charCodeAt(0)]="o",n[n.P="P".charCodeAt(0)]="P",n[n.p="p".charCodeAt(0)]="p",n[n.PLUS="+".charCodeAt(0)]="PLUS",n[n.R="R".charCodeAt(0)]="R",n[n.r="r".charCodeAt(0)]="r",n[n.S="S".charCodeAt(0)]="S",n[n.s="s".charCodeAt(0)]="s",n[n.SPACE=" ".charCodeAt(0)]="SPACE",n[n.TAB="\t".charCodeAt(0)]="TAB",n}(U||{});function mt(n=""){const e=n.match(/(\d+).(\d+).(\d+)/);if(e)return{major:parseInt(e[1]),minor:parseInt(e[2]),micro:parseInt(e[3])};throw new Error(`'${n}' is not a semver value`)}function Ir(n,e){return n.major<e.major?-1:n.major>e.major?1:n.minor<e.minor?-1:n.minor>e.minor?1:n.micro<e.micro?-1:n.micro>e.micro?1:0}var ee=function(n){return n.JS_KV="js_kv",n.JS_OBJECTSTORE="js_objectstore",n.JS_PULL_MAX_BYTES="js_pull_max_bytes",n.JS_NEW_CONSUMER_CREATE_API="js_new_consumer_create",n.JS_ALLOW_DIRECT="js_allow_direct",n.JS_MULTIPLE_CONSUMER_FILTER="js_multiple_consumer_filter",n.JS_SIMPLIFICATION="js_simplification",n.JS_STREAM_CONSUMER_METADATA="js_stream_consumer_metadata",n.JS_CONSUMER_FILTER_SUBJECTS="js_consumer_filter_subjects",n.JS_STREAM_FIRST_SEQ="js_stream_first_seq",n.JS_STREAM_SUBJECT_TRANSFORM="js_stream_subject_transform",n.JS_STREAM_SOURCE_SUBJECT_TRANSFORM="js_stream_source_subject_transform",n.JS_STREAM_COMPRESSION="js_stream_compression",n.JS_DEFAULT_CONSUMER_LIMITS="js_default_consumer_limits",n}(ee||{});class $s{server;features;disabled;constructor(e){this.features=new Map,this.disabled=[],this.update(e)}resetDisabled(){this.disabled.length=0,this.update(this.server)}disable(e){this.disabled.push(e),this.update(this.server)}isDisabled(e){return-1!==this.disabled.indexOf(e)}update(e){"string"==typeof e&&(e=mt(e)),this.server=e,this.set(ee.JS_KV,"2.6.2"),this.set(ee.JS_OBJECTSTORE,"2.6.3"),this.set(ee.JS_PULL_MAX_BYTES,"2.8.3"),this.set(ee.JS_NEW_CONSUMER_CREATE_API,"2.9.0"),this.set(ee.JS_ALLOW_DIRECT,"2.9.0"),this.set(ee.JS_MULTIPLE_CONSUMER_FILTER,"2.10.0"),this.set(ee.JS_SIMPLIFICATION,"2.9.4"),this.set(ee.JS_STREAM_CONSUMER_METADATA,"2.10.0"),this.set(ee.JS_CONSUMER_FILTER_SUBJECTS,"2.10.0"),this.set(ee.JS_STREAM_FIRST_SEQ,"2.10.0"),this.set(ee.JS_STREAM_SUBJECT_TRANSFORM,"2.10.0"),this.set(ee.JS_STREAM_SOURCE_SUBJECT_TRANSFORM,"2.10.0"),this.set(ee.JS_STREAM_COMPRESSION,"2.10.0"),this.set(ee.JS_DEFAULT_CONSUMER_LIMITS,"2.10.0"),this.disabled.forEach(t=>{this.features.delete(t)})}set(e,t){this.features.set(e,{min:t,ok:Ir(this.server,mt(t))>=0})}get(e){return this.features.get(e)||{min:"unknown",ok:!1}}supports(e){return this.get(e)?.ok||!1}require(e){return"string"==typeof e&&(e=mt(e)),Ir(this.server,e)>=0}}!function(n){"use strict";var e=function(a,l){this.hi=0|a,this.lo=0|l},t=function(a){var l,u=new Float64Array(16);if(a)for(l=0;l<a.length;l++)u[l]=a[l];return u},r=function(){throw new Error("no PRNG")},s=new Uint8Array(16),i=new Uint8Array(32);i[0]=9;var o=t(),c=t([1]),d=t([56129,1]),p=t([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),b=t([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),_=t([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),w=t([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),E=t([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function j(a,l){return a<<l|a>>>32-l}function T(a,l){var u=255&a[l+3];return(u=(u=u<<8|255&a[l+2])<<8|255&a[l+1])<<8|255&a[l+0]}function te(a,l){return new e(a[l]<<24|a[l+1]<<16|a[l+2]<<8|a[l+3],a[l+4]<<24|a[l+5]<<16|a[l+6]<<8|a[l+7])}function z(a,l,u){var f;for(f=0;f<4;f++)a[l+f]=255&u,u>>>=8}function ve(a,l,u){a[l]=u.hi>>24&255,a[l+1]=u.hi>>16&255,a[l+2]=u.hi>>8&255,a[l+3]=255&u.hi,a[l+4]=u.lo>>24&255,a[l+5]=u.lo>>16&255,a[l+6]=u.lo>>8&255,a[l+7]=255&u.lo}function we(a,l,u,f,m){var g,k=0;for(g=0;g<m;g++)k|=a[l+g]^u[f+g];return(1&k-1>>>8)-1}function Ge(a,l,u,f){return we(a,l,u,f,16)}function ft(a,l,u,f){return we(a,l,u,f,32)}function Ct(a,l,u,f,m){var A,F,Y,g=new Uint32Array(16),k=new Uint32Array(16),M=new Uint32Array(16),y=new Uint32Array(4);for(A=0;A<4;A++)k[5*A]=T(f,4*A),k[1+A]=T(u,4*A),k[6+A]=T(l,4*A),k[11+A]=T(u,16+4*A);for(A=0;A<16;A++)M[A]=k[A];for(A=0;A<20;A++){for(F=0;F<4;F++){for(Y=0;Y<4;Y++)y[Y]=k[(5*F+4*Y)%16];for(y[1]^=j(y[0]+y[3]|0,7),y[2]^=j(y[1]+y[0]|0,9),y[3]^=j(y[2]+y[1]|0,13),y[0]^=j(y[3]+y[2]|0,18),Y=0;Y<4;Y++)g[4*F+(F+Y)%4]=y[Y]}for(Y=0;Y<16;Y++)k[Y]=g[Y]}if(m){for(A=0;A<16;A++)k[A]=k[A]+M[A]|0;for(A=0;A<4;A++)k[5*A]=k[5*A]-T(f,4*A)|0,k[6+A]=k[6+A]-T(l,4*A)|0;for(A=0;A<4;A++)z(a,4*A,k[5*A]),z(a,16+4*A,k[6+A])}else for(A=0;A<16;A++)z(a,4*A,k[A]+M[A]|0)}function mr(a,l,u,f){return Ct(a,l,u,f,!1),0}function _t(a,l,u,f){return Ct(a,l,u,f,!0),0}var He=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function Pt(a,l,u,f,m,g,k){var A,F,M=new Uint8Array(16),y=new Uint8Array(64);if(!m)return 0;for(F=0;F<16;F++)M[F]=0;for(F=0;F<8;F++)M[F]=g[F];for(;m>=64;){for(mr(y,M,k,He),F=0;F<64;F++)a[l+F]=(u?u[f+F]:0)^y[F];for(A=1,F=8;F<16;F++)M[F]=255&(A=A+(255&M[F])|0),A>>>=8;m-=64,l+=64,u&&(f+=64)}if(m>0)for(mr(y,M,k,He),F=0;F<m;F++)a[l+F]=(u?u[f+F]:0)^y[F];return 0}function _r(a,l,u,f,m){return Pt(a,l,null,0,u,f,m)}function At(a,l,u,f,m){var g=new Uint8Array(32);return _t(g,f,m,He),_r(a,l,u,f.subarray(16),g)}function Kt(a,l,u,f,m,g,k){var M=new Uint8Array(32);return _t(M,g,k,He),Pt(a,l,u,f,m,g.subarray(16),M)}function dt(a,l){var u,f=0;for(u=0;u<17;u++)a[u]=255&(f=f+(a[u]+l[u]|0)|0),f>>>=8}var Eo=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function Wr(a,l,u,f,m,g){var k,M,y,A,F=new Uint32Array(17),Y=new Uint32Array(17),ue=new Uint32Array(17),Je=new Uint32Array(17),Mt=new Uint32Array(17);for(y=0;y<17;y++)Y[y]=ue[y]=0;for(y=0;y<16;y++)Y[y]=g[y];for(Y[3]&=15,Y[4]&=252,Y[7]&=15,Y[8]&=252,Y[11]&=15,Y[12]&=252,Y[15]&=15;m>0;){for(y=0;y<17;y++)Je[y]=0;for(y=0;y<16&&y<m;++y)Je[y]=u[f+y];for(Je[y]=1,f+=y,m-=y,dt(ue,Je),M=0;M<17;M++)for(F[M]=0,y=0;y<17;y++)F[M]=0|F[M]+ue[y]*(y<=M?Y[M-y]:320*Y[M+17-y]|0);for(M=0;M<17;M++)ue[M]=F[M];for(A=0,y=0;y<16;y++)ue[y]=255&(A=A+ue[y]|0),A>>>=8;for(ue[16]=3&(A=A+ue[16]|0),A=5*(A>>>2)|0,y=0;y<16;y++)ue[y]=255&(A=A+ue[y]|0),A>>>=8;ue[16]=A=A+ue[16]|0}for(y=0;y<17;y++)Mt[y]=ue[y];for(dt(ue,Eo),k=0|-(ue[16]>>>7),y=0;y<17;y++)ue[y]^=k&(Mt[y]^ue[y]);for(y=0;y<16;y++)Je[y]=g[y+16];for(Je[16]=0,dt(ue,Je),y=0;y<16;y++)a[l+y]=ue[y];return 0}function Qn(a,l,u,f,m,g){var k=new Uint8Array(16);return Wr(k,0,u,f,m,g),Ge(a,l,k,0)}function Yr(a,l,u,f,m){var g;if(u<32)return-1;for(Kt(a,0,l,0,u,f,m),Wr(a,16,a,32,u-32,a),g=0;g<16;g++)a[g]=0;return 0}function Xr(a,l,u,f,m){var g,k=new Uint8Array(32);if(u<32||(At(k,0,32,f,m),0!==Qn(l,16,l,32,u-32,k)))return-1;for(Kt(a,0,l,0,u,f,m),g=0;g<32;g++)a[g]=0;return 0}function st(a,l){var u;for(u=0;u<16;u++)a[u]=0|l[u]}function Wt(a){var l,u;for(u=0;u<16;u++)a[u]+=65536,l=Math.floor(a[u]/65536),a[(u+1)*(u<15?1:0)]+=l-1+37*(l-1)*(15===u?1:0),a[u]-=65536*l}function Ot(a,l,u){for(var f,m=~(u-1),g=0;g<16;g++)a[g]^=f=m&(a[g]^l[g]),l[g]^=f}function kt(a,l){var u,f,m,g=t(),k=t();for(u=0;u<16;u++)k[u]=l[u];for(Wt(k),Wt(k),Wt(k),f=0;f<2;f++){for(g[0]=k[0]-65517,u=1;u<15;u++)g[u]=k[u]-65535-(g[u-1]>>16&1),g[u-1]&=65535;g[15]=k[15]-32767-(g[14]>>16&1),m=g[15]>>16&1,g[14]&=65535,Ot(k,g,1-m)}for(u=0;u<16;u++)a[2*u]=255&k[u],a[2*u+1]=k[u]>>8}function es(a,l){var u=new Uint8Array(32),f=new Uint8Array(32);return kt(u,a),kt(f,l),ft(u,0,f,0)}function ts(a){var l=new Uint8Array(32);return kt(l,a),1&l[0]}function Qr(a,l){var u;for(u=0;u<16;u++)a[u]=l[2*u]+(l[2*u+1]<<8);a[15]&=32767}function ze(a,l,u){var f;for(f=0;f<16;f++)a[f]=l[f]+u[f]|0}function Ze(a,l,u){var f;for(f=0;f<16;f++)a[f]=l[f]-u[f]|0}function W(a,l,u){var f,m,g=new Float64Array(31);for(f=0;f<31;f++)g[f]=0;for(f=0;f<16;f++)for(m=0;m<16;m++)g[f+m]+=l[f]*u[m];for(f=0;f<15;f++)g[f]+=38*g[f+16];for(f=0;f<16;f++)a[f]=g[f];Wt(a),Wt(a)}function Be(a,l){W(a,l,l)}function rs(a,l){var f,u=t();for(f=0;f<16;f++)u[f]=l[f];for(f=253;f>=0;f--)Be(u,u),2!==f&&4!==f&&W(u,u,l);for(f=0;f<16;f++)a[f]=u[f]}function ns(a,l){var f,u=t();for(f=0;f<16;f++)u[f]=l[f];for(f=250;f>=0;f--)Be(u,u),1!==f&&W(u,u,l);for(f=0;f<16;f++)a[f]=u[f]}function gr(a,l,u){var g,k,f=new Uint8Array(32),m=new Float64Array(80),M=t(),y=t(),A=t(),F=t(),Y=t(),ue=t();for(k=0;k<31;k++)f[k]=l[k];for(f[31]=127&l[31]|64,f[0]&=248,Qr(m,u),k=0;k<16;k++)y[k]=m[k],F[k]=M[k]=A[k]=0;for(M[0]=F[0]=1,k=254;k>=0;--k)Ot(M,y,g=f[k>>>3]>>>(7&k)&1),Ot(A,F,g),ze(Y,M,A),Ze(M,M,A),ze(A,y,F),Ze(y,y,F),Be(F,Y),Be(ue,M),W(M,A,M),W(A,y,Y),ze(Y,M,A),Ze(M,M,A),Be(y,M),Ze(A,F,ue),W(M,A,d),ze(M,M,F),W(A,A,M),W(M,F,ue),W(F,y,m),Be(y,Y),Ot(M,y,g),Ot(A,F,g);for(k=0;k<16;k++)m[k+16]=M[k],m[k+32]=A[k],m[k+48]=y[k],m[k+64]=F[k];var Je=m.subarray(32),Mt=m.subarray(16);return rs(Je,Je),W(Mt,Mt,Je),kt(a,Mt),0}function br(a,l){return gr(a,l,i)}function ss(a,l){return r(l,32),br(a,l)}function yr(a,l,u){var f=new Uint8Array(32);return gr(f,u,l),_t(a,s,f,He)}var is=Yr,Co=Xr;function Yt(){var g,k,M,a=0,l=0,u=0,f=0,m=65535;for(M=0;M<arguments.length;M++)a+=(g=arguments[M].lo)&m,l+=g>>>16,u+=(k=arguments[M].hi)&m,f+=k>>>16;return new e((u+=(l+=a>>>16)>>>16)&m|(f+=u>>>16)<<16,a&m|l<<16)}function os(a,l){return new e(a.hi>>>l,a.lo>>>l|a.hi<<32-l)}function xr(){var u,a=0,l=0;for(u=0;u<arguments.length;u++)a^=arguments[u].lo,l^=arguments[u].hi;return new e(l,a)}function Xe(a,l){var u,f,m=32-l;return l<32?(u=a.hi>>>l|a.lo<<m,f=a.lo>>>l|a.hi<<m):l<64&&(u=a.lo>>>l|a.hi<<m,f=a.hi>>>l|a.lo<<m),new e(u,f)}function Oo(a,l,u){return new e(a.hi&l.hi^~a.hi&u.hi,a.lo&l.lo^~a.lo&u.lo)}function ko(a,l,u){return new e(a.hi&l.hi^a.hi&u.hi^l.hi&u.hi,a.lo&l.lo^a.lo&u.lo^l.lo&u.lo)}function jo(a){return xr(Xe(a,28),Xe(a,34),Xe(a,39))}function Io(a){return xr(Xe(a,14),Xe(a,18),Xe(a,41))}function Mo(a){return xr(Xe(a,1),Xe(a,8),os(a,7))}function To(a){return xr(Xe(a,19),Xe(a,61),os(a,6))}var No=[new e(1116352408,3609767458),new e(1899447441,602891725),new e(3049323471,3964484399),new e(3921009573,2173295548),new e(961987163,4081628472),new e(1508970993,3053834265),new e(2453635748,2937671579),new e(2870763221,3664609560),new e(3624381080,2734883394),new e(310598401,1164996542),new e(607225278,1323610764),new e(1426881987,3590304994),new e(1925078388,4068182383),new e(2162078206,991336113),new e(2614888103,633803317),new e(3248222580,3479774868),new e(3835390401,2666613458),new e(4022224774,944711139),new e(264347078,2341262773),new e(604807628,2007800933),new e(770255983,1495990901),new e(1249150122,1856431235),new e(1555081692,3175218132),new e(1996064986,2198950837),new e(2554220882,3999719339),new e(2821834349,766784016),new e(2952996808,2566594879),new e(3210313671,3203337956),new e(3336571891,1034457026),new e(3584528711,2466948901),new e(113926993,3758326383),new e(338241895,168717936),new e(666307205,1188179964),new e(773529912,1546045734),new e(1294757372,1522805485),new e(1396182291,2643833823),new e(1695183700,2343527390),new e(1986661051,1014477480),new e(2177026350,1206759142),new e(2456956037,344077627),new e(2730485921,1290863460),new e(2820302411,3158454273),new e(3259730800,3505952657),new e(3345764771,106217008),new e(3516065817,3606008344),new e(3600352804,1432725776),new e(4094571909,1467031594),new e(275423344,851169720),new e(430227734,3100823752),new e(506948616,1363258195),new e(659060556,3750685593),new e(883997877,3785050280),new e(958139571,3318307427),new e(1322822218,3812723403),new e(1537002063,2003034995),new e(1747873779,3602036899),new e(1955562222,1575990012),new e(2024104815,1125592928),new e(2227730452,2716904306),new e(2361852424,442776044),new e(2428436474,593698344),new e(2756734187,3733110249),new e(3204031479,2999351573),new e(3329325298,3815920427),new e(3391569614,3928383900),new e(3515267271,566280711),new e(3940187606,3454069534),new e(4118630271,4000239992),new e(116418474,1914138554),new e(174292421,2731055270),new e(289380356,3203993006),new e(460393269,320620315),new e(685471733,587496836),new e(852142971,1086792851),new e(1017036298,365543100),new e(1126000580,2618297676),new e(1288033470,3409855158),new e(1501505948,4234509866),new e(1607167915,987167468),new e(1816402316,1246189591)];function as(a,l,u){var M,y,A,f=[],m=[],g=[],k=[];for(y=0;y<8;y++)f[y]=g[y]=te(a,8*y);for(var F=0;u>=128;){for(y=0;y<16;y++)k[y]=te(l,8*y+F);for(y=0;y<80;y++){for(A=0;A<8;A++)m[A]=g[A];for(M=Yt(g[7],Io(g[4]),Oo(g[4],g[5],g[6]),No[y],k[y%16]),m[7]=Yt(M,jo(g[0]),ko(g[0],g[1],g[2])),m[3]=Yt(m[3],M),A=0;A<8;A++)g[(A+1)%8]=m[A];if(y%16==15)for(A=0;A<16;A++)k[A]=Yt(k[A],k[(A+9)%16],Mo(k[(A+1)%16]),To(k[(A+14)%16]))}for(y=0;y<8;y++)g[y]=Yt(g[y],f[y]),f[y]=g[y];F+=128,u-=128}for(y=0;y<8;y++)ve(a,8*y,f[y]);return u}var Ro=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function gt(a,l,u){var g,f=new Uint8Array(64),m=new Uint8Array(256),k=u;for(g=0;g<64;g++)f[g]=Ro[g];for(as(f,l,u),u%=128,g=0;g<256;g++)m[g]=0;for(g=0;g<u;g++)m[g]=l[k-u+g];for(m[u]=128,m[(u=256-128*(u<112?1:0))-9]=0,ve(m,u-8,new e(k/536870912|0,k<<3)),as(f,m,u),g=0;g<64;g++)a[g]=f[g];return 0}function vr(a,l){var u=t(),f=t(),m=t(),g=t(),k=t(),M=t(),y=t(),A=t(),F=t();Ze(u,a[1],a[0]),Ze(F,l[1],l[0]),W(u,u,F),ze(f,a[0],a[1]),ze(F,l[0],l[1]),W(f,f,F),W(m,a[3],l[3]),W(m,m,b),W(g,a[2],l[2]),ze(g,g,g),Ze(k,f,u),Ze(M,g,m),ze(y,g,m),ze(A,f,u),W(a[0],k,M),W(a[1],A,y),W(a[2],y,M),W(a[3],k,A)}function cs(a,l,u){var f;for(f=0;f<4;f++)Ot(a[f],l[f],u)}function en(a,l){var u=t(),f=t(),m=t();rs(m,l[2]),W(u,l[0],m),W(f,l[1],m),kt(a,f),a[31]^=ts(u)<<7}function tn(a,l,u){var f,m;for(st(a[0],o),st(a[1],c),st(a[2],c),st(a[3],o),m=255;m>=0;--m)cs(a,l,f=u[m/8|0]>>(7&m)&1),vr(l,a),vr(a,a),cs(a,l,f)}function wr(a,l){var u=[t(),t(),t(),t()];st(u[0],_),st(u[1],w),st(u[2],c),W(u[3],_,w),tn(a,u,l)}function rn(a,l,u){var g,f=new Uint8Array(64),m=[t(),t(),t(),t()];for(u||r(l,32),gt(f,l,32),f[0]&=248,f[31]&=127,f[31]|=64,wr(m,f),en(a,m),g=0;g<32;g++)l[g+32]=a[g];return 0}var a,Sr=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function nn(a,l){var u,f,m,g;for(f=63;f>=32;--f){for(u=0,m=f-32,g=f-12;m<g;++m)l[m]+=u-16*l[f]*Sr[m-(f-32)],u=Math.floor((l[m]+128)/256),l[m]-=256*u;l[m]+=u,l[f]=0}for(u=0,m=0;m<32;m++)l[m]+=u-(l[31]>>4)*Sr[m],u=l[m]>>8,l[m]&=255;for(m=0;m<32;m++)l[m]-=u*Sr[m];for(f=0;f<32;f++)l[f+1]+=l[f]>>8,a[f]=255&l[f]}function sn(a){var u,l=new Float64Array(64);for(u=0;u<64;u++)l[u]=a[u];for(u=0;u<64;u++)a[u]=0;nn(a,l)}function us(a,l,u,f){var M,y,m=new Uint8Array(64),g=new Uint8Array(64),k=new Uint8Array(64),A=new Float64Array(64),F=[t(),t(),t(),t()];gt(m,f,32),m[0]&=248,m[31]&=127,m[31]|=64;var Y=u+64;for(M=0;M<u;M++)a[64+M]=l[M];for(M=0;M<32;M++)a[32+M]=m[32+M];for(gt(k,a.subarray(32),u+32),sn(k),wr(F,k),en(a,F),M=32;M<64;M++)a[M]=f[M];for(gt(g,a,u+64),sn(g),M=0;M<64;M++)A[M]=0;for(M=0;M<32;M++)A[M]=k[M];for(M=0;M<32;M++)for(y=0;y<32;y++)A[M+y]+=g[M]*m[y];return nn(a.subarray(32),A),Y}function on(a,l,u,f){var m,g=new Uint8Array(32),k=new Uint8Array(64),M=[t(),t(),t(),t()],y=[t(),t(),t(),t()];if(u<64||function $o(a,l){var u=t(),f=t(),m=t(),g=t(),k=t(),M=t(),y=t();return st(a[2],c),Qr(a[1],l),Be(m,a[1]),W(g,m,p),Ze(m,m,a[2]),ze(g,a[2],g),Be(k,g),Be(M,k),W(y,M,k),W(u,y,m),W(u,u,g),ns(u,u),W(u,u,m),W(u,u,g),W(u,u,g),W(a[0],u,g),Be(f,a[0]),W(f,f,g),es(f,m)&&W(a[0],a[0],E),Be(f,a[0]),W(f,f,g),es(f,m)?-1:(ts(a[0])===l[31]>>7&&Ze(a[0],o,a[0]),W(a[3],a[0],a[1]),0)}(y,f))return-1;for(m=0;m<u;m++)a[m]=l[m];for(m=0;m<32;m++)a[m+32]=f[m];if(gt(k,a,u),sn(k),tn(M,y,k),wr(y,l.subarray(32)),vr(M,y),en(g,M),u-=64,ft(l,0,g,0)){for(m=0;m<u;m++)a[m]=0;return-1}for(m=0;m<u;m++)a[m]=l[m+64];return u}function hs(a,l){if(32!==a.length)throw new Error("bad key size");if(24!==l.length)throw new Error("bad nonce size")}function $e(){for(var a=0;a<arguments.length;a++)if(!(arguments[a]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function fs(a){for(var l=0;l<a.length;l++)a[l]=0}n.lowlevel={crypto_core_hsalsa20:_t,crypto_stream_xor:Kt,crypto_stream:At,crypto_stream_salsa20_xor:Pt,crypto_stream_salsa20:_r,crypto_onetimeauth:Wr,crypto_onetimeauth_verify:Qn,crypto_verify_16:Ge,crypto_verify_32:ft,crypto_secretbox:Yr,crypto_secretbox_open:Xr,crypto_scalarmult:gr,crypto_scalarmult_base:br,crypto_box_beforenm:yr,crypto_box_afternm:is,crypto_box:function Po(a,l,u,f,m,g){var k=new Uint8Array(32);return yr(k,m,g),is(a,l,u,f,k)},crypto_box_open:function Ao(a,l,u,f,m,g){var k=new Uint8Array(32);return yr(k,m,g),Co(a,l,u,f,k)},crypto_box_keypair:ss,crypto_hash:gt,crypto_sign:us,crypto_sign_keypair:rn,crypto_sign_open:on,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:16,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:64,crypto_sign_PUBLICKEYBYTES:32,crypto_sign_SECRETKEYBYTES:64,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:t,D:p,L:Sr,pack25519:kt,unpack25519:Qr,M:W,A:ze,S:Be,Z:Ze,pow2523:ns,add:vr,set25519:st,modL:nn,scalarmult:tn,scalarbase:wr},n.randomBytes=function(a){var l=new Uint8Array(a);return r(l,a),l},n.secretbox=function(a,l,u){$e(a,l,u),hs(u,l);for(var f=new Uint8Array(32+a.length),m=new Uint8Array(f.length),g=0;g<a.length;g++)f[g+32]=a[g];return Yr(m,f,f.length,l,u),m.subarray(16)},n.secretbox.open=function(a,l,u){$e(a,l,u),hs(u,l);for(var f=new Uint8Array(16+a.length),m=new Uint8Array(f.length),g=0;g<a.length;g++)f[g+16]=a[g];return f.length<32||0!==Xr(m,f,f.length,l,u)?null:m.subarray(32)},n.secretbox.keyLength=32,n.secretbox.nonceLength=24,n.secretbox.overheadLength=16,n.scalarMult=function(a,l){if($e(a,l),32!==a.length)throw new Error("bad n size");if(32!==l.length)throw new Error("bad p size");var u=new Uint8Array(32);return gr(u,a,l),u},n.scalarMult.base=function(a){if($e(a),32!==a.length)throw new Error("bad n size");var l=new Uint8Array(32);return br(l,a),l},n.scalarMult.scalarLength=32,n.scalarMult.groupElementLength=32,n.box=function(a,l,u,f){var m=n.box.before(u,f);return n.secretbox(a,l,m)},n.box.before=function(a,l){$e(a,l),function Fo(a,l){if(32!==a.length)throw new Error("bad public key size");if(32!==l.length)throw new Error("bad secret key size")}(a,l);var u=new Uint8Array(32);return yr(u,a,l),u},n.box.after=n.secretbox,n.box.open=function(a,l,u,f){var m=n.box.before(u,f);return n.secretbox.open(a,l,m)},n.box.open.after=n.secretbox.open,n.box.keyPair=function(){var a=new Uint8Array(32),l=new Uint8Array(32);return ss(a,l),{publicKey:a,secretKey:l}},n.box.keyPair.fromSecretKey=function(a){if($e(a),32!==a.length)throw new Error("bad secret key size");var l=new Uint8Array(32);return br(l,a),{publicKey:l,secretKey:new Uint8Array(a)}},n.box.publicKeyLength=32,n.box.secretKeyLength=32,n.box.sharedKeyLength=32,n.box.nonceLength=24,n.box.overheadLength=n.secretbox.overheadLength,n.sign=function(a,l){if($e(a,l),64!==l.length)throw new Error("bad secret key size");var u=new Uint8Array(64+a.length);return us(u,a,a.length,l),u},n.sign.open=function(a,l){if($e(a,l),32!==l.length)throw new Error("bad public key size");var u=new Uint8Array(a.length),f=on(u,a,a.length,l);if(f<0)return null;for(var m=new Uint8Array(f),g=0;g<m.length;g++)m[g]=u[g];return m},n.sign.detached=function(a,l){for(var u=n.sign(a,l),f=new Uint8Array(64),m=0;m<f.length;m++)f[m]=u[m];return f},n.sign.detached.verify=function(a,l,u){if($e(a,l,u),64!==l.length)throw new Error("bad signature size");if(32!==u.length)throw new Error("bad public key size");var g,f=new Uint8Array(64+a.length),m=new Uint8Array(64+a.length);for(g=0;g<64;g++)f[g]=l[g];for(g=0;g<a.length;g++)f[g+64]=a[g];return on(m,f,f.length,u)>=0},n.sign.keyPair=function(){var a=new Uint8Array(32),l=new Uint8Array(64);return rn(a,l),{publicKey:a,secretKey:l}},n.sign.keyPair.fromSecretKey=function(a){if($e(a),64!==a.length)throw new Error("bad secret key size");for(var l=new Uint8Array(32),u=0;u<l.length;u++)l[u]=a[32+u];return{publicKey:l,secretKey:new Uint8Array(a)}},n.sign.keyPair.fromSeed=function(a){if($e(a),32!==a.length)throw new Error("bad seed size");for(var l=new Uint8Array(32),u=new Uint8Array(64),f=0;f<32;f++)u[f]=a[f];return rn(l,u,!0),{publicKey:l,secretKey:u}},n.sign.publicKeyLength=32,n.sign.secretKeyLength=64,n.sign.seedLength=32,n.sign.signatureLength=64,n.hash=function(a){$e(a);var l=new Uint8Array(64);return gt(l,a,a.length),l},n.hash.hashLength=64,n.verify=function(a,l){return $e(a,l),0!==a.length&&0!==l.length&&a.length===l.length&&0===we(a,0,l,0,a.length)},n.setPRNG=function(a){r=a},(a=typeof globalThis<"u"?globalThis.crypto||globalThis.msCrypto:null)&&a.getRandomValues?n.setPRNG(function(u,f){var m,g=new Uint8Array(f);for(m=0;m<f;m+=65536)a.getRandomValues(g.subarray(m,m+Math.min(f-m,65536)));for(m=0;m<f;m++)u[m]=g[m];fs(g)}):typeof require<"u"&&(a=require("crypto"))&&a.randomBytes&&n.setPRNG(function(u,f){var m,g=a.randomBytes(f);for(m=0;m<f;m++)u[m]=g[m];fs(g)})}(typeof module<"u"&&module.exports?module.exports:globalThis.nacl=globalThis.nacl||{});const sr=typeof module<"u"&&module.exports?module.exports:globalThis.nacl,Us={fromSeed:sr.sign.keyPair.fromSeed,sign:sr.sign.detached,verify:sr.sign.detached.verify,randomBytes:sr.randomBytes};let xn;new Uint16Array([0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920]),Error,function Ls(n){xn=n}(Us);function ni(n){const e=`${R}:${We()}`;if((n=n||{servers:[e]}).servers=n.servers||[],"string"==typeof n.servers&&(n.servers=[n.servers]),n.servers.length>0&&n.port)throw new I("port and servers options are mutually exclusive",O.InvalidOption);0===n.servers.length&&n.port&&(n.servers=[`${R}:${n.port}`]),n.servers&&0===n.servers.length&&(n.servers=[e]);const t=q({maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:12e4,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:2e3,tls:void 0,verbose:!1,waitOnFirstConnect:!1,ignoreAuthErrorAbort:!1},n);if(t.authenticator=function ri(n){const e=[];return"function"==typeof n.authenticator&&e.push(n.authenticator),Array.isArray(n.authenticator)&&e.push(...n.authenticator),n.token&&e.push(function Ys(n){return()=>({auth_token:"function"==typeof n?n():n})}(n.token)),n.user&&e.push(function Ws(n,e){return()=>({user:"function"==typeof n?n():n,pass:"function"==typeof e?e():e})}(n.user,n.pass)),0===e.length?()=>{}:function Vs(n){return e=>{let t={};return n.forEach(r=>{const s=r(e)||{};t=Object.assign(t,s)}),t}}(e)}(t),["reconnectDelayHandler","authenticator"].forEach(r=>{if(t[r]&&"function"!=typeof t[r])throw new I(`${r} option should be a function`,O.NotFunction)}),t.reconnectDelayHandler||(t.reconnectDelayHandler=()=>{let r=t.tls?t.reconnectJitterTLS:t.reconnectJitter;return r&&(r++,r=Math.floor(Math.random()*r)),t.reconnectTimeWait+r}),t.inboxPrefix)try{S(t.inboxPrefix)}catch(r){throw new I(r.message,O.ApiError)}if(t.resolve&&"function"!=typeof hn())throw new I("'resolve' is not supported on this client",O.InvalidOption);return t}const oi=/^INFO\s+([^\r\n]+)\r\n/i,ai=Oe("PONG\r\n"),Pn=Oe("PING\r\n");class ci{echo;no_responders;protocol;verbose;pedantic;jwt;nkey;sig;user;pass;auth_token;tls_required;name;lang;version;headers;constructor(e,t,r){this.protocol=1,this.version=e.version,this.lang=e.lang,this.echo=!t.noEcho&&void 0,this.verbose=t.verbose,this.pedantic=t.pedantic,this.tls_required=!!t.tls||void 0,this.name=t.name,q(this,(t&&"function"==typeof t.authenticator?t.authenticator(r):{})||{})}}class An extends Ae{sid;queue;draining;max;subject;drained;protocol;timer;info;cleanupFn;closed;requestSubject;constructor(e,t,r={}){super(),q(this,r),this.protocol=e,this.subject=t,this.draining=!1,this.noIterator="function"==typeof r.callback,this.closed=B(),r.timeout&&(this.timer=be(r.timeout),this.timer.then(()=>{this.timer=void 0}).catch(s=>{this.stop(s),this.noIterator&&this.callback(s,{})})),this.noIterator||this.iterClosed.then(()=>{this.closed.resolve(),this.unsubscribe()})}setPrePostHandlers(e){if(this.noIterator){const t=this.callback,r=e.ingestionFilterFn?e.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),s=e.protocolFilterFn?e.protocolFilterFn:()=>!0,i=e.dispatchedFn?e.dispatchedFn:()=>{};this.callback=(o,c)=>{const{ingest:d}=r(c);d&&s(c)&&(t(o,c),i(c))}}else this.protocolFilterFn=e.protocolFilterFn,this.dispatchedFn=e.dispatchedFn}callback(e,t){this.cancelTimeout(),e?this.stop(e):this.push(t)}close(){if(!this.isClosed()){this.cancelTimeout();const e=()=>{if(this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch{}this.closed.resolve()};this.noIterator?e():this.push(e)}}unsubscribe(e){this.protocol.unsubscribe(this,e)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){return this.protocol.isClosed()?Promise.reject(I.errorForCode(O.ConnectionClosed)):this.isClosed()?Promise.reject(I.errorForCode(O.SubClosed)):(this.drained||(this.draining=!0,this.protocol.unsub(this),this.drained=this.protocol.flush(B()).then(()=>{this.protocol.subscriptions.cancel(this)}).catch(()=>{this.protocol.subscriptions.cancel(this)})),this.drained)}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class ui{mux;subs;sidCounter;constructor(){this.sidCounter=0,this.mux=null,this.subs=new Map}size(){return this.subs.size}add(e){return this.sidCounter++,e.sid=this.sidCounter,this.subs.set(e.sid,e),e}setMux(e){return this.mux=e,e}getMux(){return this.mux}get(e){return this.subs.get(e)}resub(e){return this.sidCounter++,this.subs.delete(e.sid),e.sid=this.sidCounter,this.subs.set(e.sid,e),e}all(){return Array.from(this.subs.values())}cancel(e){e&&(e.close(),this.subs.delete(e.sid))}handleError(e){if(e&&e.permissionContext){const t=e.permissionContext,r=this.all();let s;if("subscription"===t.operation&&(s=r.find(i=>i.subject===t.subject)),"publish"===t.operation&&(s=r.find(i=>i.requestSubject===t.subject)),s)return s.callback(e,{}),s.close(),this.subs.delete(s.sid),s!==this.mux}return!1}close(){this.subs.forEach(e=>{e.close()})}}class ar{connected;connectedOnce;infoReceived;info;muxSubscriptions;options;outbound;pongs;subscriptions;transport;noMorePublishing;connectError;publisher;_closed;closed;listeners;heartbeats;parser;outMsgs;inMsgs;outBytes;inBytes;pendingLimit;lastError;abortReconnect;servers;server;features;connectPromise;constructor(e,t){this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=32768,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=e,this.publisher=t,this.subscriptions=new ui,this.muxSubscriptions=new Is,this.outbound=new Se,this.pongs=[],this.pendingLimit=e.pendingLimit||this.pendingLimit,this.features=new $s({major:0,minor:0,micro:0}),this.connectPromise=null,this.servers=new ks("string"==typeof e.servers?[e.servers]:e.servers,{randomize:!e.noRandomize}),this.closed=B(),this.parser=new yn(this),this.heartbeats=new Ms(this,this.options.pingInterval||12e4,this.options.maxPingOut||2)}resetOutbound(){this.outbound.reset();const e=this.pongs;this.pongs=[];const t=I.errorForCode(O.Disconnect);t.stack="",e.forEach(r=>{r.reject(t)}),this.parser=new yn(this),this.infoReceived=!1}dispatchStatus(e){this.listeners.forEach(t=>{t.push(e)})}status(){const e=new Ae;return this.listeners.push(e),e}prepare(){var e=this;this.transport&&this.transport.discard(),this.info=void 0,this.resetOutbound();const t=B();return t.catch(()=>{}),this.pongs.unshift(t),this.connectError=r=>{t.reject(r)},this.transport=function ds(){if(!de||"function"!=typeof de.factory)throw new Error("transport fn is not set");return de.factory()}(),this.transport.closed().then(function(){var r=(0,h.Z)(function*(s){e.connected=!1,e.isClosed()||(yield e.disconnected(e.transport.closeError||e.lastError))});return function(s){return r.apply(this,arguments)}}()),t}disconnect(){this.dispatchStatus({type:ct.StaleConnection,data:""}),this.transport.disconnect()}disconnected(e){var t=this;return(0,h.Z)(function*(){t.dispatchStatus({type:Le.Disconnect,data:t.servers.getCurrentServer().toString()}),t.options.reconnect?yield t.dialLoop().then(()=>{t.dispatchStatus({type:Le.Reconnect,data:t.servers.getCurrentServer().toString()}),t.lastError?.code===O.AuthenticationExpired&&(t.lastError=void 0)}).catch(r=>{t._close(r)}):yield t._close(e)})()}dial(e){var t=this;return(0,h.Z)(function*(){const r=t.prepare();let s;try{s=be(t.options.timeout||2e4);const i=t.transport.connect(e,t.options);yield Promise.race([i,s]),(0,h.Z)(function*(){try{var d,o=!1,c=!1;try{for(var b,p=(0,K.Z)(t.transport);o=!(b=yield p.next()).done;o=!1)t.parser.parse(b.value)}catch(_){c=!0,d=_}finally{try{o&&null!=p.return&&(yield p.return())}finally{if(c)throw d}}}catch(_){console.log("reader closed",_)}})().then()}catch(i){r.reject(i)}try{yield Promise.race([s,r]),s&&s.cancel(),t.connected=!0,t.connectError=void 0,t.sendSubscriptions(),t.connectedOnce=!0,t.server.didConnect=!0,t.server.reconnects=0,t.flushPending(),t.heartbeats.start()}catch(i){throw s&&s.cancel(),yield t.transport.close(i),i}})()}_doDial(e){var t=this;return(0,h.Z)(function*(){const r=yield e.resolve({fn:hn(),debug:t.options.debug,randomize:!t.options.noRandomize});let s=null;for(const i of r)try{return s=null,t.dispatchStatus({type:ct.Reconnecting,data:i.toString()}),void(yield t.dial(i))}catch(o){s=o}throw s})()}dialLoop(){return null===this.connectPromise&&(this.connectPromise=this.dodialLoop(),this.connectPromise.then(()=>{}).catch(()=>{}).finally(()=>{this.connectPromise=null})),this.connectPromise}dodialLoop(){var e=this;return(0,h.Z)(function*(){let t;for(;;){e._closed&&e.servers.clear();const r=e.options.reconnectDelayHandler?e.options.reconnectDelayHandler():2e3;let s=r;const i=e.selectServer();if(!i||e.abortReconnect)throw t||(e.lastError?e.lastError:I.errorForCode(O.ConnectionRefused));const o=Date.now();if(0===i.lastConnect||i.lastConnect+r<=o){i.lastConnect=Date.now();try{yield e._doDial(i);break}catch(c){if(t=c,!e.connectedOnce){if(e.options.waitOnFirstConnect)continue;e.servers.removeCurrentServer()}i.reconnects++;const d=e.options.maxReconnectAttempts||0;-1!==d&&i.reconnects>=d&&e.servers.removeCurrentServer()}}else s=Math.min(s,i.lastConnect+r-o),yield D(s)}})()}static connect(e,t){return(0,h.Z)(function*(){const r=new ar(e,t);return yield r.dialLoop(),r})()}static toError(e){const t=e?e.toLowerCase():"";if(-1!==t.indexOf("permissions violation")){const r=new I(e,O.PermissionsViolation),s=e.match(/(Publish|Subscription) to "(\S+)"/);return s&&(r.permissionContext={operation:s[1].toLowerCase(),subject:s[2]}),r}return-1!==t.indexOf("authorization violation")?new I(e,O.AuthorizationViolation):-1!==t.indexOf("user authentication expired")?new I(e,O.AuthenticationExpired):-1!==t.indexOf("authentication timeout")?new I(e,O.AuthenticationTimeout):new I(e,O.ProtocolError)}processMsg(e,t){if(this.inMsgs++,this.inBytes+=t.length,!this.subscriptions.sidCounter)return;const r=this.subscriptions.get(e.sid);r&&(r.received+=1,r.callback&&r.callback(null,new _n(e,t,this)),void 0!==r.max&&r.received>=r.max&&r.unsubscribe())}processError(e){const t=ot(e),r=ar.toError(t),s={type:Le.Error,data:r.code};if(r.isPermissionError()){let i=!1;r.permissionContext&&(s.permissionContext=r.permissionContext,i=this.subscriptions.getMux()?.subject===r.permissionContext.subject),this.subscriptions.handleError(r),this.muxSubscriptions.handleError(i,r),i&&this.subscriptions.setMux(null)}this.dispatchStatus(s),this.handleError(r)}handleError(e){e.isAuthError()?this.handleAuthError(e):(e.isProtocolError()||e.isAuthTimeout())&&(this.lastError=e),e.isPermissionError()||(this.lastError=e)}handleAuthError(e){this.lastError&&e.code===this.lastError.code&&!1===this.options.ignoreAuthErrorAbort&&(this.abortReconnect=!0),this.connectError?this.connectError(e):this.disconnect()}processPing(){this.transport.send(ai)}processPong(){const e=this.pongs.shift();e&&e.resolve()}processInfo(e){const t=JSON.parse(ot(e));this.info=t;const r=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(t);if(!this.infoReceived){this.features.update(mt(t.version)),this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();const{version:i,lang:o}=this.transport;try{const c=new ci({version:i,lang:o},this.options,t.nonce);t.headers&&(c.headers=!0,c.no_responders=!0);const d=JSON.stringify(c);this.transport.send(Oe(`CONNECT ${d}\r\n`)),this.transport.send(Pn)}catch(c){this._close(c)}}r&&this.dispatchStatus({type:Le.Update,data:r}),void 0!==t.ldm&&t.ldm&&this.dispatchStatus({type:Le.LDM,data:this.servers.getCurrentServer().toString()})}push(e){switch(e.kind){case Ie.MSG:{const{msg:t,data:r}=e;this.processMsg(t,r);break}case Ie.OK:break;case Ie.ERR:this.processError(e.data);break;case Ie.PING:this.processPing();break;case Ie.PONG:this.processPong();break;case Ie.INFO:this.processInfo(e.data)}}sendCommand(e,...t){const r=this.outbound.length();let s;s="string"==typeof e?Oe(e):e,this.outbound.fill(s,...t),0===r?queueMicrotask(()=>{this.flushPending()}):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(e,t=ne,r){let s;if(t instanceof Uint8Array)s=t;else{if("string"!=typeof t)throw I.errorForCode(O.BadPayload);s=Ce.encode(t)}let i=s.length;(r=r||{}).reply=r.reply||"";let d,o=ne,c=0;if(r.headers){if(this.info&&!this.info.headers)throw new I("headers",O.ServerOptionNotAvailable);o=r.headers.encode(),c=o.length,i=s.length+c}if(this.info&&i>this.info.max_payload)throw I.errorForCode(O.MaxPayloadExceeded);this.outBytes+=i,this.outMsgs++,r.headers?(d=r.reply?`HPUB ${e} ${r.reply} ${c} ${i}\r\n`:`HPUB ${e} ${c} ${i}\r\n`,this.sendCommand(d,o,s,rr)):(d=r.reply?`PUB ${e} ${r.reply} ${i}\r\n`:`PUB ${e} ${i}\r\n`,this.sendCommand(d,s,rr))}request(e){return this.initMux(),this.muxSubscriptions.add(e),e}subscribe(e){return this.subscriptions.add(e),this._subunsub(e),e}_sub(e){this.sendCommand(e.queue?`SUB ${e.subject} ${e.queue} ${e.sid}\r\n`:`SUB ${e.subject} ${e.sid}\r\n`)}_subunsub(e){return this._sub(e),e.max&&this.unsubscribe(e,e.max),e}unsubscribe(e,t){this.unsub(e,t),(void 0===e.max||e.received>=e.max)&&this.subscriptions.cancel(e)}unsub(e,t){!e||this.isClosed()||(this.sendCommand(t?`UNSUB ${e.sid} ${t}\r\n`:`UNSUB ${e.sid}\r\n`),e.max=t)}resub(e,t){!e||this.isClosed()||(e.subject=t,this.subscriptions.resub(e),this._sub(e))}flush(e){return e||(e=B()),this.pongs.push(e),this.outbound.fill(Pn),this.flushPending(),e}sendSubscriptions(){const e=[];this.subscriptions.all().forEach(t=>{e.push(t.queue?`SUB ${t.subject} ${t.queue} ${t.sid}\r\n`:`SUB ${t.subject} ${t.sid}\r\n`)}),e.length&&this.transport.send(Oe(e.join("")))}_close(e){var t=this;return(0,h.Z)(function*(){t._closed||(t.heartbeats.cancel(),t.connectError&&(t.connectError(e),t.connectError=void 0),t.muxSubscriptions.close(),t.subscriptions.close(),t.listeners.forEach(r=>{r.stop()}),t._closed=!0,yield t.transport.close(e),yield t.closed.resolve(e))})()}close(){return this._close()}isClosed(){return this._closed}drain(){var e=this;const t=this.subscriptions.all(),r=[];return t.forEach(s=>{r.push(s.drain())}),Promise.all(r).then((0,h.Z)(function*(){return e.noMorePublishing=!0,yield e.flush(),e.close()})).catch(()=>{})}flushPending(){if(this.infoReceived&&this.connected&&this.outbound.size()){const e=this.outbound.drain();this.transport.send(e)}}initMux(){if(!this.subscriptions.getMux()){const t=this.muxSubscriptions.init(this.options.inboxPrefix),r=new An(this,`${t}*`);r.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(r),this.subscribe(r)}}selectServer(){const e=this.servers.selectServer();if(void 0!==e)return this.server=e,this.server}getServer(){return this.server}}class On{token;received;ctx;requestSubject;mux;constructor(e,t){this.mux=e,this.requestSubject=t,this.received=0,this.token=Pe.next(),this.ctx=new Error}}class li extends On{callback;done;timer;max;opts;constructor(e,t,r={maxWait:1e3}){if(super(e,t),this.opts=r,"function"!=typeof this.opts.callback)throw new Error("callback is required");this.callback=this.opts.callback,this.max="number"==typeof r.maxMessages&&r.maxMessages>0?r.maxMessages:-1,this.done=B(),this.done.then(()=>{this.callback(null,null)}),this.timer=setTimeout(()=>{this.cancel()},r.maxWait)}cancel(e){e&&this.callback(e,null),clearTimeout(this.timer),this.mux.cancel(this),this.done.resolve()}resolver(e,t){e?(e.stack+=`\n\n${this.ctx.stack}`,this.cancel(e)):(this.callback(null,t),this.opts.strategy===fe.Count&&(this.max--,0===this.max&&this.cancel()),this.opts.strategy===fe.JitterTimer&&(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.cancel()},this.opts.jitter||300)),this.opts.strategy===fe.SentinelMsg&&t&&0===t.data.length&&this.cancel())}}class kn extends On{deferred;timer;constructor(e,t,r={timeout:1e3}){super(e,t),this.deferred=B(),this.timer=be(r.timeout)}resolver(e,t){this.timer&&this.timer.cancel(),e?(e.stack+=`\n\n${this.ctx.stack}`,this.deferred.reject(e)):this.deferred.resolve(t),this.cancel()}cancel(e){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(e||I.errorForCode(O.Cancelled))}}function vt(n){return Tr("durable",n)}function Me(n){return Tr("stream",n)}function Tr(n,e=""){if(""===e)throw Error(`${n} name required`);return[".","*",">","/","\\"," ","\t","\n","\r"].forEach(r=>{if(-1!==e.indexOf(r)){switch(r){case"\n":r="\\n";break;case"\r":r="\\r";break;case"\t":r="\\t"}throw Error(`invalid ${n} name - ${n} name cannot contain '${r}'`)}}),""}function Ut(n,e=""){if(""===e)throw Error(`${n} name required`);const t=function hi(n=""){if(""===n)throw Error("name required");const e=/^[-\w]+$/g;if(null===n.match(e))for(const r of n.split(""))if(null===r.match(e))return`cannot contain '${r}'`;return""}(e);if(t.length)throw new Error(`invalid ${n} name - ${n} name ${t}`)}function ce(n){return 1e6*n}function Nr(n){return Math.floor(n/1e6)}function Rr(n){if(n.data.length>0)return!1;const e=n.headers;return!!e&&e.code>=100&&e.code<200}function $r(n){return Rr(n)&&"Idle Heartbeat"===n.headers?.description}function wt(n){if(0!==n.data.length)return null;const e=n.headers;return e?jn(e.code,e.description):null}var Fe=function(n){return n.MaxBatchExceeded="exceeded maxrequestbatch of",n.MaxExpiresExceeded="exceeded maxrequestexpires of",n.MaxBytesExceeded="exceeded maxrequestmaxbytes of",n.MaxMessageSizeExceeded="message size exceeds maxbytes",n.PushConsumer="consumer is push based",n.MaxWaitingExceeded="exceeded maxwaiting",n.IdleHeartbeatMissed="idle heartbeats missed",n.ConsumerDeleted="consumer deleted",n}(Fe||{});let di=!1;function jn(n,e=""){if(n<300)return null;switch(e=e.toLowerCase(),n){case 404:return new I(e,O.JetStream404NoMessages);case 408:return new I(e,O.JetStream408RequestTimeout);case 409:{const t=e.startsWith(Fe.IdleHeartbeatMissed)?O.JetStreamIdleHeartBeat:O.JetStream409;return new I(e,t)}case 503:return I.errorForCode(O.JetStreamNotEnabled,new Error(e));default:return""===e&&(e=O.Unknown),new I(e,`${n}`)}}class Lt{nc;opts;prefix;timeout;jc;constructor(e,t){this.nc=e,this.opts=function _i(n){return(n=n||{}).domain&&(n.apiPrefix=`$JS.${n.domain}.API`,delete n.domain),q({apiPrefix:"$JS.API",timeout:5e3},n)}(t),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=Re()}getOptions(){return Object.assign({},this.opts)}_parseOpts(){let e=this.opts.apiPrefix;if(!e||0===e.length)throw new Error("invalid empty prefix");"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),this.opts.apiPrefix=e}_request(e,t=null,r){var s=this;return(0,h.Z)(function*(){(r=r||{}).timeout=s.timeout;let i=ne;t&&(i=s.jc.encode(t));const o=yield s.nc.request(e,i,r);return s.parseJsResponse(o)})()}findStream(e){var t=this;return(0,h.Z)(function*(){const r={subject:e},i=yield t._request(`${t.prefix}.STREAM.NAMES`,r);if(!i.streams||1!==i.streams.length)throw new Error("no stream matches subject");return i.streams[0]})()}getConnection(){return this.nc}parseJsResponse(e){const t=this.jc.decode(e.data),r=t;if(r.error){const s=jn(r.error.code,r.error.description);if(null!==s)throw s.api_error=r.error,s}return t}}class gi{static encode(e){if("string"==typeof e)return btoa(e);const t=Array.from(e);return btoa(String.fromCharCode(...t))}static decode(e,t=!1){const r=atob(e);return t?Uint8Array.from(r,s=>s.charCodeAt(0)):r}}class Ft{static encode(e){return Ft.toB64URLEncoding(gi.encode(e))}static decode(e,t=!1){return Ft.decode(Ft.fromB64URLEncoding(e),t)}static toB64URLEncoding(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}static fromB64URLEncoding(e){return e.replace(/_/g,"/").replace(/-/g,"+")}}var In=function(n){return n.Limits="limits",n.Interest="interest",n.Workqueue="workqueue",n}(In||{}),cr=function(n){return n.Old="old",n.New="new",n}(cr||{}),Mn=function(n){return n.File="file",n.Memory="memory",n}(Mn||{}),_e=function(n){return n.All="all",n.Last="last",n.New="new",n.StartSequence="by_start_sequence",n.StartTime="by_start_time",n.LastPerSubject="last_per_subject",n}(_e||{}),Ee=function(n){return n.None="none",n.All="all",n.Explicit="explicit",n.NotSet="",n}(Ee||{}),qt=function(n){return n.Instant="instant",n.Original="original",n}(qt||{}),Ur=function(n){return n.CreateOrUpdate="",n.Update="update",n.Create="create",n}(Ur||{}),Te=function(n){return n.StreamSourceHdr="Nats-Stream-Source",n.LastConsumerSeqHdr="Nats-Last-Consumer",n.LastStreamSeqHdr="Nats-Last-Stream",n.ConsumerStalledHdr="Nats-Consumer-Stalled",n.MessageSizeHdr="Nats-Msg-Size",n.RollupHdr="Nats-Rollup",n.RollupValueSubject="sub",n.RollupValueAll="all",n.PendingMessagesHdr="Nats-Pending-Messages",n.PendingBytesHdr="Nats-Pending-Bytes",n}(Te||{}),Ye=function(n){return n.LastValue="",n.AllHistory="history",n.UpdatesOnly="updates",n}(Ye||{}),Bt=function(n){return n.Stream="Nats-Stream",n.Sequence="Nats-Sequence",n.TimeStamp="Nats-Time-Stamp",n.Subject="Nats-Subject",n}(Bt||{});const qe="KV_";class wi{config;ordered;mack;stream;callbackFn;max;qname;isBind;filters;constructor(e){this.stream="",this.mack=!1,this.ordered=!1,this.config=function yi(n,e={}){return Object.assign({name:n,deliver_policy:_e.All,ack_policy:Ee.Explicit,ack_wait:ce(3e4),replay_policy:qt.Instant},e)}("",e||{})}getOpts(){const e={};if(e.config=Object.assign({},this.config),e.config.filter_subject&&(this.filterSubject(e.config.filter_subject),e.config.filter_subject=void 0),e.config.filter_subjects&&(e.config.filter_subjects?.forEach(t=>{this.filterSubject(t)}),e.config.filter_subjects=void 0),e.mack=this.mack,e.stream=this.stream,e.callbackFn=this.callbackFn,e.max=this.max,e.queue=this.qname,e.ordered=this.ordered,e.config.ack_policy=e.ordered?Ee.None:e.config.ack_policy,e.isBind=e.isBind||!1,this.filters)switch(this.filters.length){case 0:break;case 1:e.config.filter_subject=this.filters[0];break;default:e.config.filter_subjects=this.filters}return e}description(e){return this.config.description=e,this}deliverTo(e){return this.config.deliver_subject=e,this}durable(e){return vt(e),this.config.durable_name=e,this}startSequence(e){if(e<=0)throw new Error("sequence must be greater than 0");return this.config.deliver_policy=_e.StartSequence,this.config.opt_start_seq=e,this}startTime(e){return this.config.deliver_policy=_e.StartTime,this.config.opt_start_time=e.toISOString(),this}deliverAll(){return this.config.deliver_policy=_e.All,this}deliverLastPerSubject(){return this.config.deliver_policy=_e.LastPerSubject,this}deliverLast(){return this.config.deliver_policy=_e.Last,this}deliverNew(){return this.config.deliver_policy=_e.New,this}startAtTimeDelta(e){return this.startTime(new Date(Date.now()-e)),this}headersOnly(){return this.config.headers_only=!0,this}ackNone(){return this.config.ack_policy=Ee.None,this}ackAll(){return this.config.ack_policy=Ee.All,this}ackExplicit(){return this.config.ack_policy=Ee.Explicit,this}ackWait(e){return this.config.ack_wait=ce(e),this}maxDeliver(e){return this.config.max_deliver=e,this}filterSubject(e){return this.filters=this.filters||[],this.filters.push(e),this}replayInstantly(){return this.config.replay_policy=qt.Instant,this}replayOriginal(){return this.config.replay_policy=qt.Original,this}sample(e){if((e=Math.trunc(e))<0||e>100)throw new Error("value must be between 0-100");return this.config.sample_freq=`${e}%`,this}limit(e){return this.config.rate_limit_bps=e,this}maxWaiting(e){return this.config.max_waiting=e,this}maxAckPending(e){return this.config.max_ack_pending=e,this}idleHeartbeat(e){return this.config.idle_heartbeat=ce(e),this}flowControl(){return this.config.flow_control=!0,this}deliverGroup(e){return this.queue(e),this}manualAck(){return this.mack=!0,this}maxMessages(e){return this.max=e,this}callback(e){return this.callbackFn=e,this}queue(e){return this.qname=e,this.config.deliver_group=e,this}orderedConsumer(){return this.ordered=!0,this}bind(e,t){return this.stream=e,this.config.durable_name=t,this.isBind=!0,this}bindStream(e){return this.stream=e,this}inactiveEphemeralThreshold(e){return this.config.inactive_threshold=ce(e),this}maxPullBatch(e){return this.config.max_batch=e,this}maxPullRequestExpires(e){return this.config.max_expires=ce(e),this}memory(){return this.config.mem_storage=!0,this}numReplicas(e){return this.config.num_replicas=e,this}}function ht(n){return new wi(n)}function Tn(n){return"function"==typeof n.getOpts}function Nn(n){const e=n.length;let t=n.indexOf("=");return-1===t&&(t=e),[t,t===e?0:4-t%4]}const Rn=[],$n=[],Lr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";for(let n=0,e=64;n<e;++n)Rn[n]=Lr[n],$n[Lr.charCodeAt(n)]=n;const{toUint8Array:Ei,fromUint8Array:Ci}=function Si(n,e,t=!1){function r(o,c){return Math.floor(3*(o+c)/4-c)}function s(o){return n[o>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]}function i(o,c,d){const p=new Array((d-c)/3);for(let b=c,_=0;b<d;b+=3)p[_++]=s((o[b]<<16)+(o[b+1]<<8)+o[b+2]);return p.join("")}return{byteLength:o=>r.apply(null,Nn(o)),toUint8Array(o){const[c,d]=Nn(o),p=new Uint8Array(r(c,d)),b=d?c-4:c;let _,E,w=0;for(E=0;E<b;E+=4)_=e[o.charCodeAt(E)]<<18|e[o.charCodeAt(E+1)]<<12|e[o.charCodeAt(E+2)]<<6|e[o.charCodeAt(E+3)],p[w++]=_>>16&255,p[w++]=_>>8&255,p[w++]=255&_;return 2===d?(_=e[o.charCodeAt(E)]<<2|e[o.charCodeAt(E+1)]>>4,p[w++]=255&_):1===d&&(_=e[o.charCodeAt(E)]<<10|e[o.charCodeAt(E+1)]<<4|e[o.charCodeAt(E+2)]>>2,p[w++]=_>>8&255,p[w++]=255&_),p},fromUint8Array(o){const d=o.length,p=d%3,b=d-p,_=new Array(Math.ceil(b/16383)+(p?1:0));let E,j,w=0;for(let T=0;T<b;T+=16383)E=T+16383,_[w++]=i(o,T,E>b?b:E);return 1===p?(j=o[b],_[w]=n[j>>2]+n[j<<4&63],t||(_[w]+="==")):2===p&&(j=o[b]<<8|255&o[b+1],_[w]=n[j>>10]+n[j>>4&63]+n[j<<2&63],t||(_[w]+="=")),_.join("")}}}(Rn,$n,!0),Pi=new TextDecoder,Ai=new TextEncoder;class Un{hashSize=32;_buf;_bufIdx;_count;_K;_H;_finalized;constructor(){this._buf=new Uint8Array(64),this._K=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),this.init()}init(){return this._H=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),this._bufIdx=0,this._count=new Uint32Array(2),this._buf.fill(0),this._finalized=!1,this}update(e,t){if(null===e)throw new TypeError("msg must be a string or Uint8Array.");"string"==typeof e&&(e=function Ii(n,e="utf8"){if(/^utf-?8$/i.test(e))return Ai.encode(n);if(/^base64$/i.test(e))return Ei(n);if(/^hex(?:adecimal)?$/i.test(e))return function ki(n){const e=n.length;if(e%2||!/^[0-9a-fA-F]+$/.test(n))throw new TypeError("Invalid hex string.");n=n.toLowerCase();const t=new Uint8Array(Math.floor(e/2)),r=e/2;for(let s=0;s<r;++s)t[s]=parseInt(n.substr(2*s,2),16);return t}(n);throw new TypeError("Unsupported string encoding.")}(e,t));for(let s=0,i=e.length;s<i;s++)this._buf[this._bufIdx++]=e[s],64===this._bufIdx&&(this._transform(),this._bufIdx=0);const r=this._count;return(r[0]+=e.length<<3)<e.length<<3&&r[1]++,r[1]+=e.length>>>29,this}digest(e){if(this._finalized)throw new Error("digest has already been called.");this._finalized=!0;const t=this._buf;let r=this._bufIdx;for(t[r++]=128;56!==r;)64===r&&(this._transform(),r=0),t[r++]=0;const s=this._count;t[56]=s[1]>>>24&255,t[57]=s[1]>>>16&255,t[58]=s[1]>>>8&255,t[59]=s[1]>>>0&255,t[60]=s[0]>>>24&255,t[61]=s[0]>>>16&255,t[62]=s[0]>>>8&255,t[63]=s[0]>>>0&255,this._transform();const i=new Uint8Array(32);for(let o=0;o<8;o++)i[0+(o<<2)]=this._H[o]>>>24&255,i[1+(o<<2)]=this._H[o]>>>16&255,i[2+(o<<2)]=this._H[o]>>>8&255,i[3+(o<<2)]=this._H[o]>>>0&255;return this.init(),e?function ji(n,e="utf8"){if(/^utf-?8$/i.test(e))return Pi.decode(n);if(/^base64$/i.test(e))return Ci(n);if(/^hex(?:adecimal)?$/i.test(e))return function Oi(n){return n.reduce((e,t)=>`${e}${t<16?"0":""}${t.toString(16)}`,"")}(n);throw new TypeError("Unsupported string encoding.")}(i,e):i}_transform(){const e=this._H;let t=e[0],r=e[1],s=e[2],i=e[3],o=e[4],c=e[5],d=e[6],p=e[7];const b=new Uint32Array(16);let _;for(_=0;_<16;_++)b[_]=this._buf[3+(_<<2)]|this._buf[2+(_<<2)]<<8|this._buf[1+(_<<2)]<<16|this._buf[_<<2]<<24;for(_=0;_<64;_++){let w;if(_<16)w=b[_];else{let E=b[_+1&15],j=b[_+14&15];w=b[15&_]=(E>>>7^E>>>18^E>>>3^E<<25^E<<14)+(j>>>17^j>>>19^j>>>10^j<<15^j<<13)+b[15&_]+b[_+9&15]|0}w=w+p+(o>>>6^o>>>11^o>>>25^o<<26^o<<21^o<<7)+(d^o&(c^d))+this._K[_]|0,p=d,d=c,c=o,o=i+w,i=s,s=r,r=t,t=w+(r&s^i&(r^s))+(r>>>2^r>>>13^r>>>22^r<<30^r<<19^r<<10)|0}e[0]=e[0]+t|0,e[1]=e[1]+r|0,e[2]=e[2]+s|0,e[3]=e[3]+i|0,e[4]=e[4]+o|0,e[5]=e[5]+c|0,e[6]=e[6]+d|0,e[7]=e[7]+p|0}}class Dt{err;offset;pageInfo;subject;jsm;filter;payload;constructor(e,t,r,s){if(!e)throw new Error("subject is required");this.subject=e,this.jsm=r,this.offset=0,this.pageInfo={},this.filter=t,this.payload=s||{}}next(){var e=this;return(0,h.Z)(function*(){if(e.err)return[];if(e.pageInfo&&e.offset>=e.pageInfo.total)return[];const t={offset:e.offset};e.payload&&Object.assign(t,e.payload);try{const r=yield e.jsm._request(e.subject,t,{timeout:e.jsm.timeout});return e.pageInfo=r,e.offset+=e.countResponse(r),e.filter(r)}catch(r){throw e.err=r,r}})()}countResponse(e){switch(e?.type){case"io.nats.jetstream.api.v1.stream_names_response":case"io.nats.jetstream.api.v1.stream_list_response":return e.streams.length;case"io.nats.jetstream.api.v1.consumer_list_response":return e.consumers.length;default:return console.error(`jslister.ts: unknown API response for paged output: ${e?.type}`),e.streams?.length||0}return 0}[Symbol.asyncIterator](){var e=this;return je(function*(){let t=yield X(e.next());for(;t.length>0;){for(const r of t)yield r;t=yield X(e.next())}})()}}class Fr extends Lt{constructor(e,t){super(e,t)}add(e,t,r=Ur.Create){var s=this;return(0,h.Z)(function*(){if(Me(e),t.deliver_group&&t.flow_control)throw new Error("jetstream flow control is not supported with queue groups");if(t.deliver_group&&t.idle_heartbeat)throw new Error("jetstream idle heartbeat is not supported with queue groups");const i={};i.config=t,i.stream_name=e,i.action=r,i.config.durable_name&&vt(i.config.durable_name);const o=s.nc;let{min:c,ok:d}=o.features.get(ee.JS_NEW_CONSUMER_CREATE_API);const p=""===t.name?void 0:t.name;if(p&&!d)throw new Error(`consumer 'name' requires server ${c}`);if(p)try{Tr("name",p)}catch(E){const j=E.message,T=j.indexOf("cannot contain");throw-1!==T?new Error(`consumer 'name' ${j.substring(T)}`):E}let b,_="";if(Array.isArray(t.filter_subjects)){const{min:E,ok:j}=o.features.get(ee.JS_MULTIPLE_CONSUMER_FILTER);if(!j)throw new Error(`consumer 'filter_subjects' requires server ${E}`);d=!1}if(t.metadata){const{min:E,ok:j}=o.features.get(ee.JS_STREAM_CONSUMER_METADATA);if(!j)throw new Error(`consumer 'metadata' requires server ${E}`)}if(d&&(_=t.name??t.durable_name??""),""!==_){let E=t.filter_subject??void 0;">"===E&&(E=void 0),b=void 0!==E?`${s.prefix}.CONSUMER.CREATE.${e}.${_}.${E}`:`${s.prefix}.CONSUMER.CREATE.${e}.${_}`}else b=t.durable_name?`${s.prefix}.CONSUMER.DURABLE.CREATE.${e}.${t.durable_name}`:`${s.prefix}.CONSUMER.CREATE.${e}`;return yield s._request(b,i)})()}update(e,t,r){var s=this;return(0,h.Z)(function*(){const i=yield s.info(e,t);return s.add(e,Object.assign(i.config,r),Ur.Update)})()}info(e,t){var r=this;return(0,h.Z)(function*(){return Me(e),vt(t),yield r._request(`${r.prefix}.CONSUMER.INFO.${e}.${t}`)})()}delete(e,t){var r=this;return(0,h.Z)(function*(){return Me(e),vt(t),(yield r._request(`${r.prefix}.CONSUMER.DELETE.${e}.${t}`)).success})()}list(e){return Me(e),new Dt(`${this.prefix}.CONSUMER.LIST.${e}`,s=>s.consumers,this)}}const Ln=Uint8Array.of(43,65,67,75),Mi=Uint8Array.of(45,78,65,75),Gt=Uint8Array.of(43,87,80,73),Ti=Uint8Array.of(43,78,88,84),Ni=Uint8Array.of(43,84,69,82,77),Ri=Uint8Array.of(32);function Ht(n){return new Ui(n)}class Ui{msg;di;didAck;constructor(e){this.msg=e,this.didAck=!1}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=function $i(n){const e=n.split(".");if(9===e.length&&e.splice(2,0,"_",""),e.length<11||"$JS"!==e[0]||"ACK"!==e[1])throw new Error("not js message");const t={};return t.domain="_"===e[2]?"":e[2],t.account_hash=e[3],t.stream=e[4],t.consumer=e[5],t.redeliveryCount=parseInt(e[6],10),t.redelivered=t.redeliveryCount>1,t.streamSequence=parseInt(e[7],10),t.deliverySequence=parseInt(e[8],10),t.timestampNanos=parseInt(e[9],10),t.pending=parseInt(e[10],10),t}(this.reply)),this.di}get redelivered(){return this.info.redeliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(e){this.didAck||(this.didAck=!this.isWIP(e),this.msg.respond(e))}isWIP(e){return 4===e.length&&e[0]===Gt[0]&&e[1]===Gt[1]&&e[2]===Gt[2]&&e[3]===Gt[3]}ackAck(){var e=this;return(0,h.Z)(function*(){if(!e.didAck&&(e.didAck=!0,e.msg.reply)){const r=e.msg.publisher,s=new kn(r.muxSubscriptions,e.msg.reply);r.request(s);try{r.publish(e.msg.reply,Ln,{reply:`${r.muxSubscriptions.baseInbox}${s.token}`})}catch(i){s.cancel(i)}try{return yield Promise.race([s.timer,s.deferred]),!0}catch(i){s.cancel(i)}}return!1})()}ack(){this.doAck(Ln)}nak(e){let t=Mi;e&&(t=function js(){return{encode:n=>Ce.encode(n),decode:n=>le.decode(n)}}().encode(`-NAK ${JSON.stringify({delay:ce(e)})}`)),this.doAck(t)}working(){this.doAck(Gt)}next(e,t={batch:1}){const r={};r.batch=t.batch||1,r.no_wait=t.no_wait||!1,t.expires&&t.expires>0&&(r.expires=ce(t.expires));const s=Re().encode(r),i=Se.concat(Ti,Ri,s);this.msg.respond(i,e?{reply:e}:void 0)}term(){this.doAck(Ni)}json(){return this.msg.json()}string(){return this.msg.string()}}function St(n,e,t=!1){if(!0===t&&!n)throw I.errorForCode(O.ApiError,new Error(`${e} is not a function`));if(n&&"function"!=typeof n)throw I.errorForCode(O.ApiError,new Error(`${e} is not a function`))}class Li extends Ae{sub;adapter;subIterDone;constructor(e,t,r){var s;super(),s=this,St(r.adapter,"adapter",!0),this.adapter=r.adapter,r.callback&&St(r.callback,"callback"),this.noIterator="function"==typeof r.callback,r.ingestionFilterFn&&(St(r.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=r.ingestionFilterFn),r.protocolFilterFn&&(St(r.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=r.protocolFilterFn),r.dispatchedFn&&(St(r.dispatchedFn,"dispatchedFn"),this.dispatchedFn=r.dispatchedFn),r.cleanupFn&&St(r.cleanupFn,"cleanupFn");let i=(b,_)=>{this.callback(b,_)};if(r.callback){const b=r.callback;i=(_,w)=>{const[E,j]=this.adapter(_,w);if(E)return void b(E,null);const{ingest:T}=this.ingestionFilterFn?this.ingestionFilterFn(j,this):{ingest:!0};T&&(!this.protocolFilterFn||this.protocolFilterFn(j))&&(b(E,j),this.dispatchedFn&&j&&this.dispatchedFn(j))}}const{max:o,queue:c,timeout:d}=r,p={queue:c,timeout:d,callback:i};var b;o&&o>0&&(p.max=o),this.sub=e.subscribe(t,p),r.cleanupFn&&(this.sub.cleanupFn=r.cleanupFn),this.noIterator||this.iterClosed.then(()=>{this.unsubscribe()}),this.subIterDone=B(),Promise.all([this.sub.closed,this.iterClosed]).then(()=>{this.subIterDone.resolve()}).catch(()=>{this.subIterDone.resolve()}),(b=(0,h.Z)(function*(_){yield _.closed,s.stop()}),function(_){return b.apply(this,arguments)})(this.sub).then().catch()}unsubscribe(e){this.sub.unsubscribe(e)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(e,t){this.sub.cancelTimeout();const[r,s]=this.adapter(e,t);r&&this.stop(r),s&&this.push(s)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}class qr{interval;maxOut;cancelAfter;timer;autoCancelTimer;last;missed;count;callback;constructor(e,t,r={maxOut:2}){this.interval=e,this.maxOut=r?.maxOut||2,this.cancelAfter=r?.cancelAfter||0,this.last=Date.now(),this.missed=0,this.count=0,this.callback=t,this._schedule()}cancel(){this.autoCancelTimer&&clearTimeout(this.autoCancelTimer),this.timer&&clearInterval(this.timer),this.timer=0,this.autoCancelTimer=0}work(){this.last=Date.now(),this.missed=0}_change(e,t=0,r=2){this.interval=e,this.maxOut=r,this.cancelAfter=t,this.restart()}restart(){this.cancel(),this._schedule()}_schedule(){this.cancelAfter>0&&(this.autoCancelTimer=setTimeout(()=>{this.cancel()},this.cancelAfter)),this.timer=setInterval(()=>{if(this.count++,Date.now()-this.last>this.interval&&this.missed++,this.missed>=this.maxOut)try{!0===this.callback(this.missed)&&this.cancel()}catch(e){console.log(e)}},this.interval)}}var nt,rt=function(n){return n[n.Unset=-1]="Unset",n[n.Consume=0]="Consume",n[n.Fetch=1]="Fetch",n}(rt||{}),Br=function(n){return n.HeartbeatsMissed="heartbeats_missed",n}(Br||{}),ur=function(n){return n.DebugEvent="debug",n.Discard="discard",n.Next="next",n}(ur||{});class Dr extends Ae{consumer;opts;sub;monitor;pending;inbox;refilling;stack;pong;callback;timeout;cleanupHandler;listeners;statusIterator;constructor(e,t,r=!1){var s;super(),s=this,this.consumer=e,this.opts=this.parseOptions(t,r),this.callback=t.callback||null,this.noIterator="function"==typeof this.callback,this.monitor=null,this.pong=null,this.pending={msgs:0,bytes:0,requests:0},this.refilling=r,this.stack=(new Error).stack.split("\n").slice(1).join("\n"),this.timeout=null,this.inbox=S(e.api.nc.options.inboxPrefix),this.listeners=[];const{max_messages:i,max_bytes:o,idle_heartbeat:c,threshold_bytes:d,threshold_messages:p}=this.opts;this.closed().then(()=>{if(this.cleanupHandler)try{this.cleanupHandler()}catch{}});const{sub:b}=this;b&&b.unsubscribe(),this.sub=e.api.nc.subscribe(this.inbox,{callback:(_,w)=>{if(_)this.stop();else{if(this.monitor?.work(),w.subject===this.inbox){if($r(w))return;const j=w.headers?.code,T=w.headers?.description?.toLowerCase()||"unknown",{msgsLeft:te,bytesLeft:z}=this.parseDiscard(w.headers);if(te>0||z>0)this.pending.msgs-=te,this.pending.bytes-=z,this.pending.requests--,this.notify(ur.Discard,{msgsLeft:te,bytesLeft:z});else{const ve=()=>{const we=new I(T,`${j}`);return we.stack+=`\n\n${this.stack}`,we};if(400===j){const we=ve();this._push(()=>{this.stop(we)})}else if(409===j&&"consumer deleted"===T){const we=ve();this.stop(we)}else this.notify(ur.DebugEvent,`${j} ${T}`)}}else this._push(Ht(w)),this.received++,this.pending.msgs&&this.pending.msgs--,this.pending.bytes&&(this.pending.bytes-=w.size());if(0===this.pending.msgs&&0===this.pending.bytes&&(this.pending.requests=0),this.refilling){if(i&&this.pending.msgs<=p||o&&this.pending.bytes<=d){const j=this.pullOptions();this.pull(j)}}else 0===this.pending.requests&&this._push(()=>{this.stop()})}}}),this.sub.closed.then(()=>{this.sub.draining&&this._push(()=>{this.stop()})}),c&&(this.monitor=new qr(c,_=>(this.notify(Br.HeartbeatsMissed,_),this.resetPending().then(()=>{}).catch(()=>{}),!1),{maxOut:2})),(0,h.Z)(function*(){const _=e.api.nc.status();s.statusIterator=_;var j,w=!1,E=!1;try{for(var te,T=(0,K.Z)(_);w=!(te=yield T.next()).done;w=!1)switch(te.value.type){case Le.Disconnect:s.monitor?.cancel();break;case Le.Reconnect:s.resetPending().then(ve=>{ve&&s.monitor?.restart()}).catch(()=>{})}}catch(z){E=!0,j=z}finally{try{w&&null!=T.return&&(yield T.return())}finally{if(E)throw j}}})(),this.pull(this.pullOptions())}_push(e){if(this.callback){const t="function"==typeof e?e:null;try{t?t():this.callback(e)}catch(r){this.stop(r)}}else super.push(e)}notify(e,t){this.listeners.length>0&&this.listeners.forEach(r=>{r.done||r.push({type:e,data:t})})}resetPending(){return this.consumer.info().then(e=>(this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),!0)).catch(e=>("consumer not found"===e.message&&this.stop(e),!1))}pull(e){this.pending.bytes+=e.max_bytes??0,this.pending.msgs+=e.batch??0,this.pending.requests++;const t=this.consumer.api.nc;this._push(()=>{t.publish(`${this.consumer.api.prefix}.CONSUMER.MSG.NEXT.${this.consumer.stream}.${this.consumer.name}`,this.consumer.api.jc.encode(e),{reply:this.inbox}),this.notify(ur.Next,e)})}pullOptions(){return{batch:this.opts.max_messages-this.pending.msgs,max_bytes:this.opts.max_bytes-this.pending.bytes,idle_heartbeat:ce(this.opts.idle_heartbeat),expires:ce(this.opts.expires)}}parseDiscard(e){const t={msgsLeft:0,bytesLeft:0},r=e?.get(Te.PendingMessagesHdr);r&&(t.msgsLeft=parseInt(r));const s=e?.get(Te.PendingBytesHdr);return s&&(t.bytesLeft=parseInt(s)),t}trackTimeout(e){this.timeout=e}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}clearTimers(){this.monitor?.cancel(),this.monitor=null,this.timeout?.cancel(),this.timeout=null}setCleanupHandler(e){this.cleanupHandler=e}stop(e){this.sub?.unsubscribe(),this.clearTimers(),this.statusIterator?.stop(),this._push(()=>{super.stop(e),this.listeners.forEach(t=>{t.stop()})})}parseOptions(e,t=!1){const r=e||{};if(r.max_messages=r.max_messages||0,r.max_bytes=r.max_bytes||0,0!==r.max_messages&&0!==r.max_bytes)throw new Error("only specify one of max_messages or max_bytes");if(0===r.max_messages&&(r.max_messages=100),r.expires=r.expires||3e4,r.expires<1e3)throw new Error("expires should be at least 1000ms");if(r.idle_heartbeat=r.idle_heartbeat||r.expires/2,r.idle_heartbeat=r.idle_heartbeat>3e4?3e4:r.idle_heartbeat,t){const s=Math.round(.75*r.max_messages)||1;r.threshold_messages=r.threshold_messages||s;const i=Math.round(.75*r.max_bytes)||1;r.threshold_bytes=r.threshold_bytes||i}return r}status(){const e=new Ae;return this.listeners.push(e),Promise.resolve(e)}}class Fn extends Ae{src;constructor(){super()}setSource(e){this.src&&(this.src.setCleanupHandler(),this.src.stop()),this.src=e,this.src.setCleanupHandler(()=>{this.close().catch()})}stop(e){this.src?.stop(e),super.stop(e)}close(){return this.stop(),this.iterClosed}status(){return Promise.reject(new Error("ordered consumers don't report consumer status"))}}class qn{api;_info;stream;name;constructor(e,t){this.api=e,this._info=t,this.stream=t.stream_name,this.name=t.name}consume(e={max_messages:100,expires:3e4}){return Promise.resolve(new Dr(this,e,!0))}fetch(e={max_messages:100,expires:3e4}){const t=new Dr(this,e,!1),s=be(Math.round(1.05*t.opts.expires));return t.closed().then(()=>{s.cancel()}),s.catch(()=>{t.close().catch()}),t.trackTimeout(s),Promise.resolve(t)}next(e={expires:3e4}){const t=B(),r=e;r.max_messages=1;const s=new Dr(this,r,!1),i=Math.round(1.05*s.opts.expires);i>=6e4&&(0,h.Z)(function*(){var p,c=!1,d=!1;try{for(var _,b=(0,K.Z)(yield s.status());c=!(_=yield b.next()).done;c=!1){const w=_.value;if(w.type===Br.HeartbeatsMissed&&w.data>=2){t.reject(new Error("consumer missed heartbeats"));break}}}catch(w){d=!0,p=w}finally{try{c&&null!=b.return&&(yield b.return())}finally{if(d)throw p}}})().catch(),(0,h.Z)(function*(){var p,c=!1,d=!1;try{for(var _,b=(0,K.Z)(s);c=!(_=yield b.next()).done;c=!1){t.resolve(_.value);break}}catch(w){d=!0,p=w}finally{try{c&&null!=b.return&&(yield b.return())}finally{if(d)throw p}}})().catch();const o=be(i);return s.closed().then(()=>{t.resolve(null),o.cancel()}).catch(c=>{t.reject(c)}),o.catch(c=>{t.resolve(null),s.close().catch()}),s.trackTimeout(o),t}delete(){const{stream_name:e,name:t}=this._info;return this.api.delete(e,t)}info(e=!1){if(e)return Promise.resolve(this._info);const{stream_name:t,name:r}=this._info;return this.api.info(t,r).then(s=>(this._info=s,this._info))}}class Fi{api;consumerOpts;consumer;opts;cursor;stream;namePrefix;serial;currentConsumer;userCallback;iter;type;startSeq;constructor(e,t,r={}){this.api=e,this.stream=t,this.cursor={stream_seq:1,deliver_seq:0},this.namePrefix=Pe.next(),this.serial=0,this.currentConsumer=null,this.userCallback=null,this.iter=null,this.type=rt.Unset,this.consumerOpts=r,this.startSeq=this.consumerOpts.opt_start_seq||0,this.cursor.stream_seq=this.startSeq>0?this.startSeq-1:0}getConsumerOpts(e){this.serial++;const r={name:`${this.namePrefix}_${this.serial}`,deliver_policy:_e.StartSequence,opt_start_seq:e=0===e?1:e,ack_policy:Ee.None,inactive_threshold:ce(3e5),num_replicas:1};return!0===this.consumerOpts.headers_only&&(r.headers_only=!0),Array.isArray(this.consumerOpts.filterSubjects)&&(r.filter_subjects=this.consumerOpts.filterSubjects),"string"==typeof this.consumerOpts.filterSubjects&&(r.filter_subject=this.consumerOpts.filterSubjects),e===this.startSeq+1&&(r.deliver_policy=this.consumerOpts.deliver_policy||_e.StartSequence,(this.consumerOpts.deliver_policy===_e.LastPerSubject||this.consumerOpts.deliver_policy===_e.New||this.consumerOpts.deliver_policy===_e.Last)&&(delete r.opt_start_seq,r.deliver_policy=this.consumerOpts.deliver_policy),r.deliver_policy===_e.LastPerSubject&&typeof r.filter_subjects>"u"&&typeof r.filter_subject>"u"&&(r.filter_subject=">"),this.consumerOpts.opt_start_time&&(delete r.opt_start_seq,r.deliver_policy=_e.StartTime,r.opt_start_time=this.consumerOpts.opt_start_time),this.consumerOpts.inactive_threshold&&(r.inactive_threshold=ce(this.consumerOpts.inactive_threshold))),r}resetConsumer(e=0){var t=this;return(0,h.Z)(function*(){if(t.consumer)for(;;)try{yield t.delete();break}catch(i){if("TIMEOUT"!==i.message)throw i}e=0===e?1:e,t.cursor.deliver_seq=0;const r=t.getConsumerOpts(e);let s;for(r.max_deliver=1,r.mem_storage=!0;;)try{s=yield t.api.add(t.stream,r);break}catch(i){if("TIMEOUT"!==i.message)throw i}return s})()}internalHandler(e){return t=>{if(this.serial!==e)return;const r=t.info.deliverySequence;r===this.cursor.deliver_seq+1?(this.cursor.deliver_seq=r,this.cursor.stream_seq=t.info.streamSequence,this.userCallback?this.userCallback(t):this.iter?.push(t)):this.reset(this.opts)}}reset(e={max_messages:100,expires:3e4},t=!1){var r=this;return(0,h.Z)(function*(){r.currentConsumer=yield r.resetConsumer(r.cursor.stream_seq+1),null===r.iter&&(r.iter=new Fn),r.consumer=new qn(r.api,r.currentConsumer),e.callback=r.internalHandler(r.serial);let i=null;if(r.type===rt.Fetch&&t)i=yield r.consumer.fetch(e);else{if(r.type!==rt.Consume)return Promise.reject("reset called with unset consumer type");i=yield r.consumer.consume(e)}return r.iter.setSource(i),r.iter})()}consume(e={max_messages:100,expires:3e4}){if(this.type===rt.Fetch)return Promise.reject(new Error("ordered consumer initialized as fetch"));if(this.type===rt.Consume)return Promise.reject(new Error("ordered consumer doesn't support concurrent consume"));const{callback:t}=e;return t&&(this.userCallback=t),this.type=rt.Consume,this.opts=e,this.reset(e)}fetch(e={max_messages:100,expires:3e4}){if(this.type===rt.Consume)return Promise.reject(new Error("ordered consumer already initialized as consume"));if(!1===this.iter?.done)return Promise.reject(new Error("ordered consumer doesn't support concurrent fetch"));const{callback:t}=e;return t&&(this.userCallback=t),this.type=rt.Fetch,this.opts=e,this.iter=new Fn,this.reset(e,!0)}next(e={expires:3e4}){var t=this;return(0,h.Z)(function*(){const r=B(),s=e;return s.max_messages=1,s.callback=o=>{t.userCallback=null,r.resolve(o)},(yield t.fetch(s)).iterClosed.then(()=>{r.resolve(null)}).catch(o=>{r.reject(o)}),r})()}delete(){return this.currentConsumer?this.api.delete(this.stream,this.currentConsumer.name).then(e=>Promise.resolve(e)).catch(e=>Promise.reject(e)).finally(()=>{this.currentConsumer=null}):Promise.resolve(!1)}info(e){var t=this;return(0,h.Z)(function*(){return null==t.currentConsumer?(t.currentConsumer=yield t.resetConsumer(t.serial),Promise.resolve(t.currentConsumer)):e&&t.currentConsumer?Promise.resolve(t.currentConsumer):t.api.info(t.stream,t.currentConsumer.name)})()}}function lr(n){if(void 0===n)return;const{domain:e}=n;if(void 0===e)return n;const t=Object.assign({},n);if(delete t.domain,""===e)return t;if(t.external)throw new Error("domain and external are both set");return t.external={api:`$JS.${e}.API`},t}const Gr="OBJ_";class Bn{api;notified;constructor(e){this.api=e,this.notified=!1}checkVersion(){const e=this.api.nc.features.get(ee.JS_SIMPLIFICATION);return e.ok?Promise.resolve():Promise.reject(new Error(`consumers framework is only supported on servers ${e.min} or better`))}get(e,t={}){var r=this;return(0,h.Z)(function*(){return"object"==typeof t?r.ordered(e,t):(yield r.checkVersion(),r.api.info(e,t).then(s=>void 0!==s.config.deliver_subject?Promise.reject(new Error("push consumer not supported")):new qn(r.api,s)).catch(s=>Promise.reject(s)))})()}ordered(e,t){var r=this;return(0,h.Z)(function*(){yield r.checkVersion();const s=r.api;return new zr(s.nc,s.opts).info(e).then(o=>Promise.resolve(new Fi(r.api,e,t))).catch(o=>Promise.reject(o))})()}}class hr{api;_info;constructor(e,t){this.api=e,this._info=t}get name(){return this._info.config.name}alternates(){return this.info().then(e=>e.alternates?e.alternates:[])}best(){var e=this;return(0,h.Z)(function*(){if(yield e.info(),e._info.alternates){const t=yield e.api.info(e._info.alternates[0].name);return new hr(e.api,t)}return e})()}info(e=!1,t){return e?Promise.resolve(this._info):this.api.info(this.name,t).then(r=>(this._info=r,this._info))}getConsumer(e){return new Bn(new Fr(this.api.nc,this.api.opts)).get(this.name,e)}getMessage(e){return this.api.getMessage(this.name,e)}deleteMessage(e,t){return this.api.deleteMessage(this.name,e,t)}}const fr="KV-Operation",Bi=/^[-/=.\w]+$/,Di=/^[-/=.>*\w]+$/,Gi=/^[-\w]+$/;function Hi(n){if(n.startsWith(".")||n.endsWith(".")||!Bi.test(n))throw new Error(`invalid key: ${n}`)}function zi(n){if(n.startsWith(".")||n.endsWith(".")||!Di.test(n))throw new Error(`invalid key: ${n}`)}function Zi(n){if(n.startsWith(".")||n.endsWith("."))throw new Error(`invalid key: ${n}`);const e=n.split(".");let t=!1;for(let r=0;r<e.length;r++)switch(e[r]){case"*":t=!0;break;case">":if(r!==e.length-1)throw new Error(`invalid key: ${n}`);t=!0}return t}function dr(n){if(!Gi.test(n))throw new Error(`invalid bucket name: ${n}`)}var n;(n=nt||(nt={})).MsgIdHdr="Nats-Msg-Id",n.ExpectedStreamHdr="Nats-Expected-Stream",n.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",n.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",n.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence";class zt{js;jsm;stream;bucket;direct;codec;prefix;editPrefix;useJsPrefix;_prefixLen;constructor(e,t,r){dr(e),this.js=t,this.jsm=r,this.bucket=e,this.prefix="$KV",this.editPrefix="",this.useJsPrefix=!1,this._prefixLen=0}static create(e,t,r={}){return(0,h.Z)(function*(){dr(t);const s=yield e.jetstreamManager(),i=new zt(t,e,s);return yield i.init(r),i})()}static bind(e,t,r={}){return(0,h.Z)(function*(){const s=yield e.jetstreamManager(),i=yield s.streams.info(`${qe}${t}`);dr(i.config.name);const o=new zt(t,e,s);return Object.assign(o,i),o.codec=r.codec||{key:{encode:n=>n,decode:n=>n},value:{encode:n=>n,decode:n=>n}},o.direct=i.config.allow_direct??!1,o.initializePrefixes(i),o})()}init(e={}){var t=this;return(0,h.Z)(function*(){const r=Object.assign(function qi(){return{replicas:1,history:1,timeout:2e3,maxBucketSize:-1,maxValueSize:-1,codec:{key:{encode:n=>n,decode:n=>n},value:{encode:n=>n,decode:n=>n}},storage:Mn.File}}(),e);t.codec=r.codec;const s={};t.stream=s.name=e.streamName??t.bucketName(),s.retention=In.Limits,s.max_msgs_per_subject=r.history,r.maxBucketSize&&(r.max_bytes=r.maxBucketSize),r.max_bytes&&(s.max_bytes=r.max_bytes),s.max_msg_size=r.maxValueSize,s.storage=r.storage;const i=e.placementCluster??"";if(i&&(e.placement={},e.placement.cluster=i,e.placement.tags=[]),e.placement&&(s.placement=e.placement),e.republish&&(s.republish=e.republish),e.description&&(s.description=e.description),e.mirror){const w=Object.assign({},e.mirror);w.name.startsWith(qe)||(w.name=`${qe}${w.name}`),s.mirror=w,s.mirror_direct=!0}else if(e.sources){const w=e.sources.map(E=>{const j=Object.assign({},E);j.name.startsWith(qe)||(j.name=`${qe}${j.name}`)});s.sources=w}else s.subjects=[t.subjectForBucket()];e.metadata&&(s.metadata=e.metadata);const o=t.js.nc,c=o.getServerVersion(),d=!!c&&Ir(c,mt("2.7.2"))>=0;s.discard=d?cr.New:cr.Old;const{ok:p,min:b}=o.features.get(ee.JS_ALLOW_DIRECT);if(!p&&!0===e.allow_direct)return Promise.reject(new Error(`allow_direct is not available on server version ${c?`${c.major}.${c.minor}.${c.micro}`:"unknown"} - requires ${b}`));let _;e.allow_direct="boolean"==typeof e.allow_direct?e.allow_direct:p,s.allow_direct=e.allow_direct,t.direct=s.allow_direct,s.num_replicas=r.replicas,r.ttl&&(s.max_age=ce(r.ttl)),s.allow_rollup_hdrs=!0;try{_=yield t.jsm.streams.info(s.name),!_.config.allow_direct&&!0===t.direct&&(t.direct=!1)}catch(w){if("stream not found"!==w.message)throw w;_=yield t.jsm.streams.add(s)}t.initializePrefixes(_)})()}initializePrefixes(e){this._prefixLen=0,this.prefix=`$KV.${this.bucket}`,this.useJsPrefix="$JS.API"!==this.js.apiPrefix;const{mirror:t}=e.config;if(t){let r=t.name;if(r.startsWith(qe)&&(r=r.substring(3)),t.external&&""!==t.external.api){const s=t.name.substring(3);this.useJsPrefix=!1,this.prefix=`$KV.${s}`,this.editPrefix=`${t.external.api}.$KV.${r}`}else this.editPrefix=this.prefix}}bucketName(){return this.stream??`${qe}${this.bucket}`}subjectForBucket(){return`${this.prefix}.${this.bucket}.>`}subjectForKey(e,t=!1){const r=[];return t?(this.useJsPrefix&&r.push(this.js.apiPrefix),r.push(""!==this.editPrefix?this.editPrefix:this.prefix)):this.prefix&&r.push(this.prefix),r.push(e),r.join(".")}fullKeyName(e){return""!==this.prefix?`${this.prefix}.${e}`:`$KV.${this.bucket}.${e}`}get prefixLen(){return 0===this._prefixLen&&(this._prefixLen=this.prefix.length+1),this._prefixLen}encodeKey(e){const t=[];for(const r of e.split("."))switch(r){case">":case"*":t.push(r);break;default:t.push(this.codec.key.encode(r))}return t.join(".")}decodeKey(e){const t=[];for(const r of e.split("."))switch(r){case">":case"*":t.push(r);break;default:t.push(this.codec.key.decode(r))}return t.join(".")}validateKey=Hi;validateSearchKey=zi;hasWildcards=Zi;close(){return Promise.resolve()}dataLen(e,t){const r=t&&t.get(Te.MessageSizeHdr)||"";return""!==r?parseInt(r,10):e.length}smToEntry(e){return new Yi(this.bucket,this.prefixLen,e)}jmToEntry(e){const t=this.decodeKey(e.subject.substring(this.prefixLen));return new Xi(this.bucket,t,e)}create(e,t){var r=this;return(0,h.Z)(function*(){let s;try{const o=yield r.put(e,t,{previousSeq:0});return Promise.resolve(o)}catch(o){if(s=o,10071!==o?.api_error?.err_code)return Promise.reject(o)}let i=0;try{const o=yield r.get(e);return"DEL"===o?.operation||"PURGE"===o?.operation?(i=null!==o?o.revision:0,r.update(e,t,i)):Promise.reject(s)}catch(o){return Promise.reject(o)}})()}update(e,t,r){if(r<=0)throw new Error("version must be greater than 0");return this.put(e,t,{previousSeq:r})}put(e,t,r={}){var s=this;return(0,h.Z)(function*(){const i=s.encodeKey(e);s.validateKey(i);const o={};if(void 0!==r.previousSeq){const c=tt();o.headers=c,c.set(nt.ExpectedLastSubjectSequenceHdr,`${r.previousSeq}`)}try{return(yield s.js.publish(s.subjectForKey(i,!0),t,o)).seq}catch(c){const d=c;return d.isJetStreamError()?(d.message=d.api_error?.description,d.code=`${d.api_error?.code}`,Promise.reject(d)):Promise.reject(c)}})()}get(e,t){var r=this;return(0,h.Z)(function*(){const s=r.encodeKey(e);r.validateKey(s);let o,i={last_by_subj:r.subjectForKey(s)};t&&t.revision>0&&(i={seq:t.revision});try{o=r.direct?yield r.jsm.direct.getMessage(r.bucketName(),i):yield r.jsm.streams.getMessage(r.bucketName(),i);const c=r.smToEntry(o);return c.key!==s?null:c}catch(c){if(c.code===O.JetStream404NoMessages)return null;throw c}})()}purge(e){return this._deleteOrPurge(e,"PURGE")}delete(e){return this._deleteOrPurge(e,"DEL")}purgeDeletes(e=18e5){var t=this;return(0,h.Z)(function*(){const r=B(),s=[],i=yield t.watch({key:">",initializedFn:()=>{r.resolve()}});(0,h.Z)(function*(){var _,p=!1,b=!1;try{for(var E,w=(0,K.Z)(i);p=!(E=yield w.next()).done;p=!1){const j=E.value;("DEL"===j.operation||"PURGE"===j.operation)&&s.push(j)}}catch(j){b=!0,_=j}finally{try{p&&null!=w.return&&(yield w.return())}finally{if(b)throw _}}})().then(),yield r,i.stop();const o=Date.now()-e,c=s.map(p=>{const b=t.subjectForKey(p.key);return p.created.getTime()>=o?t.jsm.streams.purge(t.stream,{filter:b,keep:1}):t.jsm.streams.purge(t.stream,{filter:b,keep:0})}),d=yield Promise.all(c);return d.unshift({success:!0,purged:0}),d.reduce((p,b)=>(p.purged+=b.purged,p))})()}_deleteOrPurge(e,t){var r=this;return(0,h.Z)(function*(){if(!r.hasWildcards(e))return r._doDeleteOrPurge(e,t);const s=yield r.keys(e),i=[];var d,o=!1,c=!1;try{for(var b,p=(0,K.Z)(s);o=!(b=yield p.next()).done;o=!1)i.push(r._doDeleteOrPurge(b.value,t)),100===i.length&&(yield Promise.all(i),i.length=0)}catch(_){c=!0,d=_}finally{try{o&&null!=p.return&&(yield p.return())}finally{if(c)throw d}}i.length>0&&(yield Promise.all(i))})()}_doDeleteOrPurge(e,t){var r=this;return(0,h.Z)(function*(){const s=r.encodeKey(e);r.validateKey(s);const i=tt();i.set(fr,t),"PURGE"===t&&i.set(Te.RollupHdr,Te.RollupValueSubject),yield r.js.publish(r.subjectForKey(s,!0),ne,{headers:i})})()}_buildCC(e,t,r={}){const s=this.encodeKey(e);this.validateSearchKey(e);let i=_e.LastPerSubject;return t===Ye.AllHistory&&(i=_e.All),t===Ye.UpdatesOnly&&(i=_e.New),Object.assign({deliver_policy:i,ack_policy:Ee.None,filter_subject:this.fullKeyName(s),flow_control:!0,idle_heartbeat:ce(5e3)},r)}remove(e){return this.purge(e)}history(e={}){var t=this;return(0,h.Z)(function*(){const r=e.key??">",s=new Ae,i={};let o;i.headers_only=e.headers_only||!1,o=()=>{s.stop()};let c=0;const d=t._buildCC(r,Ye.AllHistory,i),p=d.filter_subject,b=ht(d);b.bindStream(t.stream),b.orderedConsumer(),b.callback((w,E)=>{if(w)s.stop(w);else if(E){const j=t.jmToEntry(E);s.push(j),s.received++,(o&&c>0&&s.received>=c||0===E.info.pending)&&(s.push(o),o=void 0)}});const _=yield t.js.subscribe(p,b);if(o){const{info:{last:w}}=_,E=w.num_pending+w.delivered.consumer_seq;if(0===E||s.received>=E)try{o()}catch(j){s.stop(j)}finally{o=void 0}else c=E}return s._data=_,s.iterClosed.then(()=>{_.unsubscribe()}),_.closed.then(()=>{s.stop()}).catch(w=>{s.stop(w)}),s})()}watch(e={}){var t=this;return(0,h.Z)(function*(){const r=e.key??">",s=new Ae,i={};i.headers_only=e.headers_only||!1;let o=Ye.LastValue;e.include===Ye.AllHistory?o=Ye.AllHistory:e.include===Ye.UpdatesOnly&&(o=Ye.UpdatesOnly);const c=!0===e.ignoreDeletes;let d=e.initializedFn,p=0;const b=t._buildCC(r,o,i),_=b.filter_subject,w=ht(b);w.bindStream(t.stream),w.orderedConsumer(),w.callback((j,T)=>{if(j)s.stop(j);else if(T){const te=t.jmToEntry(T);if(c&&"DEL"===te.operation)return;s.push(te),s.received++,d&&(p>0&&s.received>=p||0===T.info.pending)&&(s.push(d),d=void 0)}});const E=yield t.js.subscribe(_,w);if(d){const{info:{last:j}}=E,T=j.num_pending+j.delivered.consumer_seq;if(0===T||s.received>=T)try{d()}catch(te){s.stop(te)}finally{d=void 0}else p=T}return s._data=E,s.iterClosed.then(()=>{E.unsubscribe()}),E.closed.then(()=>{s.stop()}).catch(j=>{s.stop(j)}),s})()}keys(e=">"){var t=this;return(0,h.Z)(function*(){const r=new Ae,s=t._buildCC(e,Ye.LastValue,{headers_only:!0}),i=s.filter_subject,o=ht(s);o.bindStream(t.stream),o.orderedConsumer();const c=yield t.js.subscribe(i,o);return(0,h.Z)(function*(){var _,p=!1,b=!1;try{for(var E,w=(0,K.Z)(c);p=!(E=yield w.next()).done;p=!1){const j=E.value;{const T=j.headers?.get(fr);if("DEL"!==T&&"PURGE"!==T){const te=t.decodeKey(j.subject.substring(t.prefixLen));r.push(te)}0===j.info.pending&&c.unsubscribe()}}}catch(j){b=!0,_=j}finally{try{p&&null!=w.return&&(yield w.return())}finally{if(b)throw _}}})().then(()=>{r.stop()}).catch(p=>{r.stop(p)}),0===c.info.last.num_pending&&c.unsubscribe(),r})()}purgeBucket(e){return this.jsm.streams.purge(this.bucketName(),e)}destroy(){return this.jsm.streams.delete(this.bucketName())}status(){var e=this;return(0,h.Z)(function*(){const r=e.js.nc.info?.cluster??"",s=e.bucketName(),i=yield e.jsm.streams.info(s);return new Hn(i,r)})()}}class Hn{si;cluster;constructor(e,t=""){this.si=e,this.cluster=t}get bucket(){return this.si.config.name.startsWith(qe)?this.si.config.name.substring(3):this.si.config.name}get values(){return this.si.state.messages}get history(){return this.si.config.max_msgs_per_subject}get ttl(){return Nr(this.si.config.max_age)}get bucket_location(){return this.cluster}get backingStore(){return this.si.config.storage}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get description(){return this.si.config.description??""}get maxBucketSize(){return this.si.config.max_bytes}get maxValueSize(){return this.si.config.max_msg_size}get max_bytes(){return this.si.config.max_bytes}get placement(){return this.si.config.placement||{cluster:"",tags:[]}}get placementCluster(){return this.si.config.placement?.cluster??""}get republish(){return this.si.config.republish??{src:"",dest:""}}get streamInfo(){return this.si}get size(){return this.si.state.bytes}get metadata(){return this.si.config.metadata??{}}}const zn="SHA-256=";class Hr{si;backingStore;constructor(e){this.si=e,this.backingStore="JetStream"}get bucket(){return function Vi(n){return n.startsWith(Gr)?n.substring(4):n}(this.si.config.name)}get description(){return this.si.config.description??""}get ttl(){return this.si.config.max_age}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get sealed(){return this.si.config.sealed}get size(){return this.si.state.bytes}get streamInfo(){return this.si}get metadata(){return this.si.config.metadata}}class zr extends Lt{constructor(e,t){super(e,t)}checkStreamConfigVersions(e){const t=this.nc;if(e.metadata){const{min:s,ok:i}=t.features.get(ee.JS_STREAM_CONSUMER_METADATA);if(!i)throw new Error(`stream 'metadata' requires server ${s}`)}if(e.first_seq){const{min:s,ok:i}=t.features.get(ee.JS_STREAM_FIRST_SEQ);if(!i)throw new Error(`stream 'first_seq' requires server ${s}`)}if(e.subject_transform){const{min:s,ok:i}=t.features.get(ee.JS_STREAM_SUBJECT_TRANSFORM);if(!i)throw new Error(`stream 'subject_transform' requires server ${s}`)}if(e.compression){const{min:s,ok:i}=t.features.get(ee.JS_STREAM_COMPRESSION);if(!i)throw new Error(`stream 'compression' requires server ${s}`)}if(e.consumer_limits){const{min:s,ok:i}=t.features.get(ee.JS_DEFAULT_CONSUMER_LIMITS);if(!i)throw new Error(`stream 'consumer_limits' requires server ${s}`)}function r(s,i){if((i.subject_transforms?.length||0)>0){const{min:c,ok:d}=t.features.get(ee.JS_STREAM_SOURCE_SUBJECT_TRANSFORM);if(!d)throw new Error(`${s} 'subject_transforms' requires server ${c}`)}}e.sources&&e.sources.forEach(s=>{r("stream sources",s)}),e.mirror&&r("stream mirror",e.mirror)}add(e={}){var t=this;return(0,h.Z)(function*(){t.checkStreamConfigVersions(e),Me(e.name),e.mirror=lr(e.mirror),e.sources=e.sources?.map(lr);const s=yield t._request(`${t.prefix}.STREAM.CREATE.${e.name}`,e);return t._fixInfo(s),s})()}delete(e){var t=this;return(0,h.Z)(function*(){return Me(e),(yield t._request(`${t.prefix}.STREAM.DELETE.${e}`)).success})()}update(e,t={}){var r=this;return(0,h.Z)(function*(){if("object"==typeof e){const d=e;e=d.name,t=d,console.trace("\x1b[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  \x1b[0m")}r.checkStreamConfigVersions(t),Me(e);const s=yield r.info(e),i=Object.assign(s.config,t);i.mirror=lr(i.mirror),i.sources=i.sources?.map(lr);const c=yield r._request(`${r.prefix}.STREAM.UPDATE.${e}`,i);return r._fixInfo(c),c})()}info(e,t){var r=this;return(0,h.Z)(function*(){Me(e);const s=`${r.prefix}.STREAM.INFO.${e}`;let o=yield r._request(s,t),{total:c,limit:d}=o,p=o.state.subjects?Object.getOwnPropertyNames(o.state.subjects).length:1;if(c&&c>p){const b=[o],_=t||{};let w=0;for(;c>p;){w++,_.offset=d*w;const j=yield r._request(s,_);c=j.total,b.push(j);const T=Object.getOwnPropertyNames(j.state.subjects).length;if(p+=T,T<d)break}let E={};for(let j=0;j<b.length;j++)o=b[j],o.state.subjects&&(E=Object.assign(E,o.state.subjects));o.offset=0,o.total=0,o.limit=0,o.state.subjects=E}return r._fixInfo(o),o})()}list(e=""){return new Dt(`${this.prefix}.STREAM.LIST`,i=>{const o=i;return o.streams.forEach(c=>{this._fixInfo(c)}),o.streams},this,e?.length?{subject:e}:{})}_fixInfo(e){e.config.sealed=e.config.sealed||!1,e.config.deny_delete=e.config.deny_delete||!1,e.config.deny_purge=e.config.deny_purge||!1,e.config.allow_rollup_hdrs=e.config.allow_rollup_hdrs||!1}purge(e,t){var r=this;return(0,h.Z)(function*(){if(t){const{keep:i,seq:o}=t;if("number"==typeof i&&"number"==typeof o)throw new Error("can specify one of keep or seq")}return Me(e),yield r._request(`${r.prefix}.STREAM.PURGE.${e}`,t)})()}deleteMessage(e,t,r=!0){var s=this;return(0,h.Z)(function*(){Me(e);const i={seq:t};return r||(i.no_erase=!0),(yield s._request(`${s.prefix}.STREAM.MSG.DELETE.${e}`,i)).success})()}getMessage(e,t){var r=this;return(0,h.Z)(function*(){Me(e);const i=yield r._request(`${r.prefix}.STREAM.MSG.GET.${e}`,t);return new Ki(i)})()}find(e){return this.findStream(e)}listKvs(){return new Dt(`${this.prefix}.STREAM.LIST`,r=>{const i=r.streams.filter(d=>d.config.name.startsWith(qe));i.forEach(d=>{this._fixInfo(d)});let o="";return i.length&&(o=this.nc.info?.cluster??""),i.map(d=>new Hn(d,o))},this)}listObjectStores(){return new Dt(`${this.prefix}.STREAM.LIST`,r=>{const i=r.streams.filter(c=>c.config.name.startsWith(Gr));return i.forEach(c=>{this._fixInfo(c)}),i.map(c=>new Hr(c))},this)}names(e=""){return new Dt(`${this.prefix}.STREAM.NAMES`,i=>i.streams,this,e?.length?{subject:e}:{})}get(e){var t=this;return(0,h.Z)(function*(){const r=yield t.info(e);return Promise.resolve(new hr(t,r))})()}}let Ki=(()=>class n{_header;smr;static jc;constructor(t){this.smr=t}get subject(){return this.smr.message.subject}get seq(){return this.smr.message.seq}get timestamp(){return this.smr.message.time}get time(){return new Date(Date.parse(this.timestamp))}get data(){return this.smr.message.data?this._parse(this.smr.message.data):ne}get header(){if(!this._header)if(this.smr.message.hdrs){const t=this._parse(this.smr.message.hdrs);this._header=ut.decode(t)}else this._header=tt();return this._header}_parse(t){const r=atob(t),s=r.length,i=new Uint8Array(s);for(let o=0;o<s;o++)i[o]=r.charCodeAt(o);return i}json(t){return Re(t).decode(this.data)}string(){return le.decode(this.data)}})();class Wi{api;constructor(e){this.api=e}get(e){return this.api.info(e).then(t=>new hr(this.api,t))}}class Yi{bucket;sm;prefixLen;constructor(e,t,r){this.bucket=e,this.prefixLen=t,this.sm=r}get key(){return this.sm.subject.substring(this.prefixLen)}get value(){return this.sm.data}get delta(){return 0}get created(){return this.sm.time}get revision(){return this.sm.seq}get operation(){return this.sm.header.get(fr)||"PUT"}get length(){const e=this.sm.header.get(Te.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class Xi{bucket;key;sm;constructor(e,t,r){this.bucket=e,this.key=t,this.sm=r}get value(){return this.sm.data}get created(){return new Date(Nr(this.sm.info.timestampNanos))}get revision(){return this.sm.seq}get operation(){return this.sm.headers?.get(fr)||"PUT"}get delta(){return this.sm.info.pending}get length(){const e=this.sm.headers?.get(Te.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class Zr{info;hdrs;constructor(e){this.info=e}get name(){return this.info.name}get description(){return this.info.description??""}get headers(){return this.hdrs||(this.hdrs=ut.fromRecord(this.info.headers||{})),this.hdrs}get options(){return this.info.options}get bucket(){return this.info.bucket}get chunks(){return this.info.chunks}get deleted(){return this.info.deleted??!1}get digest(){return this.info.digest}get mtime(){return this.info.mtime}get nuid(){return this.info.nuid}get size(){return this.info.size}get revision(){return this.info.revision}get metadata(){return this.info.metadata||{}}isLink(){return void 0!==this.info.options?.link}}function Zn(n){const e={name:n.name,description:n.description??"",options:n.options,metadata:n.metadata};return n.headers&&(e.headers=n.headers.toRecord()),e}class Zt{jsm;js;stream;name;constructor(e,t,r){this.name=e,this.jsm=t,this.js=r}_checkNotEmpty(e){return e&&0!==e.length?{name:e}:{name:e,error:new Error("name cannot be empty")}}info(e){var t=this;return(0,h.Z)(function*(){const r=yield t.rawInfo(e);return r?new Zr(r):null})()}list(){var e=this;return(0,h.Z)(function*(){const t=[],r=yield e.watch({ignoreDeletes:!0,includeHistory:!0});var o,s=!1,i=!1;try{for(var d,c=(0,K.Z)(r);s=!(d=yield c.next()).done;s=!1){const p=d.value;if(null===p)break;t.push(p)}}catch(p){i=!0,o=p}finally{try{s&&null!=c.return&&(yield c.return())}finally{if(i)throw o}}return Promise.resolve(t)})()}rawInfo(e){var t=this;return(0,h.Z)(function*(){const{name:r,error:s}=t._checkNotEmpty(e);if(s)return Promise.reject(s);const i=t._metaSubject(r);try{const o=yield t.jsm.streams.getMessage(t.stream,{last_by_subj:i}),d=Re().decode(o.data);return d.revision=o.seq,d}catch(o){return"404"===o.code?null:Promise.reject(o)}})()}_si(e){var t=this;return(0,h.Z)(function*(){try{return yield t.jsm.streams.info(t.stream,e)}catch(r){return"404"===r.code?null:Promise.reject(r)}})()}seal(){var e=this;return(0,h.Z)(function*(){let t=yield e._si();return null===t?Promise.reject(new Error("object store not found")):(t.config.sealed=!0,t=yield e.jsm.streams.update(e.stream,t.config),Promise.resolve(new Hr(t)))})()}status(e){var t=this;return(0,h.Z)(function*(){const r=yield t._si(e);return null===r?Promise.reject(new Error("object store not found")):Promise.resolve(new Hr(r))})()}destroy(){return this.jsm.streams.delete(this.stream)}_put(e,t,r){var s=this;return(0,h.Z)(function*(){const i=s.js.getOptions();(r=r||{timeout:i.timeout}).timeout=r.timeout||i.timeout,r.previousRevision=r.previousRevision??void 0;const{timeout:o,previousRevision:c}=r,p=s.js.nc.info?.max_payload||1024;(e=e||{}).options=e.options||{};let b=e.options?.max_chunk_size||131072;b=b>p?p:b,e.options.max_chunk_size=b;const _=yield s.info(e.name),{name:w,error:E}=s._checkNotEmpty(e.name);if(E)return Promise.reject(E);const j=Pe.next(),T=s._chunkSubject(j),te=s._metaSubject(w),z=Object.assign({bucket:s.name,nuid:j,size:0,chunks:0},Zn(e)),ve=B(),we=[],Ge=new Se;try{const ft=t?t.getReader():null,Ct=new Un;for(;;){const{done:mr,value:_t}=ft?yield ft.read():{done:!0,value:void 0};if(mr){if(Ge.size()>0){const dt=Ge.drain();Ct.update(dt),z.chunks++,z.size+=dt.length,we.push(s.js.publish(T,dt,{timeout:o}))}yield Promise.all(we),we.length=0,z.mtime=(new Date).toISOString();const He=Ct.digest("base64"),Pt=He.length%3,_r=Pt>0?"=".repeat(Pt):"";z.digest=`${zn}${He}${_r}`,z.deleted=!1;const At=tt();"number"==typeof c&&At.set(nt.ExpectedLastSubjectSequenceHdr,`${c}`),At.set(Te.RollupHdr,Te.RollupValueSubject);const Kt=yield s.js.publish(te,Re().encode(z),{headers:At,timeout:o});if(z.revision=Kt.seq,_)try{yield s.jsm.streams.purge(s.stream,{filter:`$O.${s.name}.C.${_.nuid}`})}catch{}ve.resolve(new Zr(z));break}if(_t)for(Ge.fill(_t);Ge.size()>b;){z.chunks++,z.size+=b;const He=Ge.drain(e.options.max_chunk_size);Ct.update(He),we.push(s.js.publish(T,He,{timeout:o}))}}}catch(ft){yield s.jsm.streams.purge(s.stream,{filter:T}),ve.reject(ft)}return ve})()}putBlob(e,t,r){return null===t&&(t=new Uint8Array(0)),this.put(e,function s(i){return new ReadableStream({pull(o){o.enqueue(i),o.close()}})}(t),r)}put(e,t,r){return e?.options?.link?Promise.reject(new Error("link cannot be set when putting the object in bucket")):this._put(e,t,r)}getBlob(e){var t=this;return(0,h.Z)(function*(){function s(){return(s=(0,h.Z)(function*(c){const d=new Se,p=c.getReader();for(;;){const{done:b,value:_}=yield p.read();if(b)return d.drain();_&&_.length&&d.fill(_)}})).apply(this,arguments)}const i=yield t.get(e);if(null===i)return Promise.resolve(null);const o=yield Promise.all([i.error,function r(c){return s.apply(this,arguments)}(i.data)]);return o[0]?Promise.reject(o[0]):Promise.resolve(o[1])})()}get(e){var t=this;return(0,h.Z)(function*(){const r=yield t.rawInfo(e);if(null===r||r.deleted)return Promise.resolve(null);if(r.options&&r.options.link){const _=r.options.link.name||"";if(""===_)throw new Error("link is a bucket");return(r.options.link.bucket!==t.name?yield Zt.create(t.js,r.options.link.bucket):t).get(_)}const s=B(),i={info:new Zr(r),error:s};if(0===r.size)return i.data=function Qi(){return new ReadableStream({pull(n){n.enqueue(new Uint8Array(0)),n.close()}})}(),s.resolve(null),Promise.resolve(i);let o;const c=ht();c.orderedConsumer();const d=new Un,p=`$O.${t.name}.C.${r.nuid}`,b=yield t.js.subscribe(p,c);return(0,h.Z)(function*(){var E,_=!1,w=!1;try{for(var T,j=(0,K.Z)(b);_=!(T=yield j.next()).done;_=!1){const te=T.value;if(te.data.length>0&&(d.update(te.data),o.enqueue(te.data)),0===te.info.pending){const z=d.digest("base64"),ve=z.length%3,we=ve>0?"=".repeat(ve):"",Ge=`${zn}${z}${we}`;Ge!==r.digest?o.error(new Error(`received a corrupt object, digests do not match received: ${r.digest} calculated ${Ge}`)):o.close(),b.unsubscribe()}}}catch(te){w=!0,E=te}finally{try{_&&null!=j.return&&(yield j.return())}finally{if(w)throw E}}})().then(()=>{s.resolve()}).catch(_=>{o.error(_),s.reject(_)}),i.data=new ReadableStream({start(_){o=_},cancel(){b.unsubscribe()}}),i})()}linkStore(e,t){if(!(t instanceof Zt))return Promise.reject("bucket required");const r=t,{name:s,error:i}=this._checkNotEmpty(e);return i?Promise.reject(i):this._put({name:s,options:{link:{bucket:r.name}}},null)}link(e,t){var r=this;return(0,h.Z)(function*(){const{name:s,error:i}=r._checkNotEmpty(e);if(i)return Promise.reject(i);if(t.deleted)return Promise.reject(new Error("src object is deleted"));if(t.isLink())return Promise.reject(new Error("src object is a link"));const o=yield r.rawInfo(e);if(null!==o&&!o.deleted)return Promise.reject(new Error("an object already exists with that name"));const d={name:s,options:{link:{bucket:t.bucket,name:t.name}}};yield r.js.publish(r._metaSubject(e),JSON.stringify(d));const p=yield r.info(e);return Promise.resolve(p)})()}delete(e){var t=this;return(0,h.Z)(function*(){const r=yield t.rawInfo(e);if(null===r)return Promise.resolve({purged:0,success:!1});r.deleted=!0,r.size=0,r.chunks=0,r.digest="";const s=Re(),i=tt();return i.set(Te.RollupHdr,Te.RollupValueSubject),yield t.js.publish(t._metaSubject(r.name),s.encode(r),{headers:i}),t.jsm.streams.purge(t.stream,{filter:t._chunkSubject(r.nuid)})})()}update(e,t={}){var r=this;return(0,h.Z)(function*(){const s=yield r.rawInfo(e);if(null===s)return Promise.reject(new Error("object not found"));if(s.deleted)return Promise.reject(new Error("cannot update meta for a deleted object"));t.name=t.name??s.name;const{name:i,error:o}=r._checkNotEmpty(t.name);if(o)return Promise.reject(o);if(e!==t.name){const p=yield r.info(t.name);if(p&&!p.deleted)return Promise.reject(new Error("an object already exists with that name"))}t.name=i;const c=Object.assign({},s,Zn(t)),d=yield r.js.publish(r._metaSubject(c.name),JSON.stringify(c));return e!==t.name&&(yield r.jsm.streams.purge(r.stream,{filter:r._metaSubject(e)})),Promise.resolve(d)})()}watch(e={}){var t=this;return(0,h.Z)(function*(){e.includeHistory=e.includeHistory??!1,e.ignoreDeletes=e.ignoreDeletes??!1;let r=!1;const s=new Ae,i=t._metaSubjectAll();try{yield t.jsm.streams.getMessage(t.stream,{last_by_subj:i})}catch(p){"404"===p.code?(s.push(null),r=!0):s.stop(p)}const o=Re(),c=ht();c.orderedConsumer(),e.includeHistory?c.deliverLastPerSubject():(r=!0,c.deliverNew()),c.callback((p,b)=>{if(p)s.stop(p);else if(null!==b){const _=o.decode(b.data);_.deleted&&!0===e.ignoreDeletes||s.push(_),0===b.info?.pending&&!r&&(r=!0,s.push(null))}});const d=yield t.js.subscribe(i,c);return s._data=d,s.iterClosed.then(()=>{d.unsubscribe()}),d.closed.then(()=>{s.stop()}).catch(p=>{s.stop(p)}),s})()}_chunkSubject(e){return`$O.${this.name}.C.${e}`}_metaSubject(e){return`$O.${this.name}.M.${Ft.encode(e)}`}_metaSubjectAll(){return`$O.${this.name}.M.>`}init(e={}){var t=this;return(0,h.Z)(function*(){try{t.stream=function Ji(n){return dr(n),`${Gr}${n}`}(t.name)}catch(i){return Promise.reject(i)}const r=e?.ttl||0;delete e.ttl;const s=Object.assign({max_age:r},e);s.name=t.stream,s.allow_direct=!0,s.allow_rollup_hdrs=!0,s.discard=cr.New,s.subjects=[`$O.${t.name}.C.>`,`$O.${t.name}.M.>`],e.placement&&(s.placement=e.placement),e.metadata&&(s.metadata=e.metadata);try{yield t.jsm.streams.info(s.name)}catch(i){"stream not found"===i.message&&(yield t.jsm.streams.add(s))}})()}static create(e,t,r={}){return(0,h.Z)(function*(){const s=yield e.jetstreamManager(),i=new Zt(t,s,e);return yield i.init(r),Promise.resolve(i)})()}}class eo{js;jsm;constructor(e){this.js=e}kv(e,t={}){const r=this.js,{ok:s,min:i}=r.nc.features.get(ee.JS_KV);return s?t.bindOnly?zt.bind(this.js,e):zt.create(this.js,e,t):Promise.reject(new Error(`kv is only supported on servers ${i} or better`))}os(e,t={}){if("function"!=typeof crypto?.subtle?.digest)return Promise.reject(new Error("objectstore: unable to calculate hashes - crypto.subtle.digest with sha256 support is required"));const r=this.js,{ok:s,min:i}=r.nc.features.get(ee.JS_OBJECTSTORE);return s?Zt.create(this.js,e,t):Promise.reject(new Error(`objectstore is only supported on servers ${i} or better`))}}class Jr extends Lt{consumers;streams;consumerAPI;streamAPI;constructor(e,t){super(e,t),this.consumerAPI=new Fr(e,t),this.streamAPI=new zr(e,t),this.consumers=new Bn(this.consumerAPI),this.streams=new Wi(this.streamAPI)}jetstreamManager(){return this.nc.jetstreamManager(this.opts)}get apiPrefix(){return this.prefix}get views(){return new eo(this)}publish(e,t=ne,r){var s=this;return(0,h.Z)(function*(){(r=r||{}).expect=r.expect||{};const i=r?.headers||tt();r&&(r.msgID&&i.set(nt.MsgIdHdr,r.msgID),r.expect.lastMsgID&&i.set(nt.ExpectedLastMsgIdHdr,r.expect.lastMsgID),r.expect.streamName&&i.set(nt.ExpectedStreamHdr,r.expect.streamName),"number"==typeof r.expect.lastSequence&&i.set(nt.ExpectedLastSeqHdr,`${r.expect.lastSequence}`),"number"==typeof r.expect.lastSubjectSequence&&i.set(nt.ExpectedLastSubjectSequenceHdr,`${r.expect.lastSubjectSequence}`));const o=r.timeout||s.timeout,c={};o&&(c.timeout=o),r&&(c.headers=i);let b,{retries:d,retry_delay:p}=r;d=d||1,p=p||250;for(let w=0;w<d;w++)try{b=yield s.nc.request(e,t,c);break}catch(E){if(!("503"===E.code&&w+1<d))throw E;yield D(p)}const _=s.parseJsResponse(b);if(""===_.stream)throw I.errorForCode(O.JetStreamInvalidAck);return _.duplicate=!!_.duplicate&&_.duplicate,_})()}pull(e,t,r=0){var s=this;return(0,h.Z)(function*(){Me(e),vt(t);let i=s.timeout;r>i&&(i=r);const o={batch:1,no_wait:0===(r=r<0?0:ce(r)),expires:r},c=yield s.nc.request(`${s.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,s.jc.encode(o),{noMux:!0,timeout:i}),d=wt(c);if(d)throw d;return Ht(c)})()}fetch(e,t,r={}){Me(e),vt(t);let s=null;const i=(r.max_bytes??0)>0;let o=0;const c=i?r.max_bytes:0;let d=null;const p={};if(p.batch=r.batch||1,c){const z=this.nc.features.get(ee.JS_PULL_MAX_BYTES);if(!z.ok)throw new Error(`max_bytes is only supported on servers ${z.min} or better`);p.max_bytes=c}p.no_wait=r.no_wait||!1,p.no_wait&&p.expires&&(p.expires=0);const b=r.expires||0;if(b&&(p.expires=ce(b)),0===b&&!1===p.no_wait)throw new Error("expires or no_wait is required");const _=r.idle_heartbeat||0;_&&(p.idle_heartbeat=ce(_),!0===r.delay_heartbeat&&(p.idle_heartbeat=ce(4*_)));const w=new Ae,E=p.batch;let j=0;w.protocolFilterFn=(z,ve=!1)=>!$r(z.msg)||(d?.work(),!1),w.dispatchedFn=z=>{if(z){if(i&&(o+=z.data.length),j++,s&&0===z.info.pending)return;(1===w.getPending()&&0===z.info.pending||E===j||c>0&&o>=c)&&w.stop()}};const T=S(this.nc.options.inboxPrefix),te=this.nc.subscribe(T,{max:r.batch,callback:(z,ve)=>{null===z&&(z=wt(ve)),null!==z?(s&&(s.cancel(),s=null),function De(n){return"string"==typeof n.code}(z)?w.stop(null===Vn(z)?void 0:z):w.stop(z)):(d?.work(),w.received++,w.push(Ht(ve)))}});return b&&(s=be(b),s.catch(()=>{te.isClosed()||(te.drain().catch(()=>{}),s=null),d&&d.cancel()})),(0,h.Z)(function*(){try{_&&(d=new qr(_,z=>(w.push(()=>{w.err=new I(`${Fe.IdleHeartbeatMissed}: ${z}`,O.JetStreamIdleHeartBeat)}),!0)))}catch{}yield te.closed,null!==s&&(s.cancel(),s=null),d&&d.cancel(),w.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(p),{reply:T}),w}pullSubscribe(e,t=ht()){var r=this;return(0,h.Z)(function*(){const s=yield r._processOptions(e,t);if(s.ordered)throw new Error("pull subscribers cannot be be ordered");if(s.config.deliver_subject)throw new Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");const i=s.config.ack_policy;if(i===Ee.None||i===Ee.All)throw new Error("ack policy for pull consumers must be explicit");const o=r._buildTypedSubscriptionOpts(s),c=new to(r,s.deliver,o);c.info=s;try{yield r._maybeCreateConsumer(s)}catch(d){throw c.unsubscribe(),d}return c})()}subscribe(e,t=ht()){var r=this;return(0,h.Z)(function*(){const s=yield r._processOptions(e,t);if(!s.isBind&&!s.config.deliver_subject)throw new Error("push consumer requires deliver_subject");const i=r._buildTypedSubscriptionOpts(s),o=new Jn(r,s.deliver,i);o.info=s;try{yield r._maybeCreateConsumer(s)}catch(c){throw o.unsubscribe(),c}return o._maybeSetupHbMonitoring(),o})()}_processOptions(e,t=ht()){var r=this;return(0,h.Z)(function*(){const s=Tn(t)?t.getOpts():t;if(s.isBind=!!Tn(t)&&t.isBind,s.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},s.ordered){if(s.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},s.config.ack_policy!==Ee.NotSet&&s.config.ack_policy!==Ee.None)throw new I("ordered consumer: ack_policy can only be set to 'none'",O.ApiError);if(s.config.durable_name&&s.config.durable_name.length>0)throw new I("ordered consumer: durable_name cannot be set",O.ApiError);if(s.config.deliver_subject&&s.config.deliver_subject.length>0)throw new I("ordered consumer: deliver_subject cannot be set",O.ApiError);if(void 0!==s.config.max_deliver&&s.config.max_deliver>1)throw new I("ordered consumer: max_deliver cannot be set",O.ApiError);if(s.config.deliver_group&&s.config.deliver_group.length>0)throw new I("ordered consumer: deliver_group cannot be set",O.ApiError);s.config.deliver_subject=S(r.nc.options.inboxPrefix),s.config.ack_policy=Ee.None,s.config.max_deliver=1,s.config.flow_control=!0,s.config.idle_heartbeat=s.config.idle_heartbeat||ce(5e3),s.config.ack_wait=ce(792e5),s.config.mem_storage=!0,s.config.num_replicas=1}if(s.config.ack_policy===Ee.NotSet&&(s.config.ack_policy=Ee.All),s.api=r,s.config=s.config||{},s.stream=s.stream?s.stream:yield r.findStream(e),s.attached=!1,s.config.durable_name)try{const i=yield r.consumerAPI.info(s.stream,s.config.durable_name);if(i){if(i.config.filter_subject&&i.config.filter_subject!==e)throw new Error("subject does not match consumer");const o=s.config.deliver_group??"";if(""===o&&!0===i.push_bound)throw new Error("duplicate subscription");const c=i.config.deliver_group??"";if(o!==c)throw""===c?new Error("durable requires no queue group"):new Error(`durable requires queue group '${c}'`);s.last=i,s.config=i.config,s.attached=!0,s.config.durable_name||(s.name=i.name)}}catch(i){if("404"!==i.code)throw i}return!s.attached&&void 0===s.config.filter_subject&&void 0===s.config.filter_subjects&&(s.config.filter_subject=e),s.deliver=s.config.deliver_subject||S(r.nc.options.inboxPrefix),s})()}_buildTypedSubscriptionOpts(e){const t={};return t.adapter=function ro(n){return n?so:no}(void 0===e.callbackFn),t.ingestionFilterFn=Jr.ingestionFn(e.ordered),t.protocolFilterFn=(r,s=!1)=>{const i=r;return!Rr(i.msg)||(s||i.msg.respond(),!1)},!e.mack&&e.config.ack_policy!==Ee.None&&(t.dispatchedFn=io),e.callbackFn&&(t.callback=e.callbackFn),t.max=e.max||0,t.queue=e.queue,t}_maybeCreateConsumer(e){var t=this;return(0,h.Z)(function*(){if(e.attached)return;if(e.isBind)throw new Error(`unable to bind - durable consumer ${e.config.durable_name} doesn't exist in ${e.stream}`);e.config=Object.assign({deliver_policy:_e.All,ack_policy:Ee.Explicit,ack_wait:ce(3e4),replay_policy:qt.Instant},e.config);const r=yield t.consumerAPI.add(e.stream,e.config);if(Array.isArray(e.config.filter_subjects&&!Array.isArray(r.config.filter_subjects)))throw new Error("jetstream server doesn't support consumers with multiple filter subjects");e.name=r.name,e.config=r.config,e.last=r})()}static ingestionFn(e){return(t,r)=>{const s=r;if(!t)return{ingest:!1,protocol:!1};const i=t;if(wt(i.msg)||s.monitor?.work(),$r(i.msg)){const c=!e||s._checkHbOrderConsumer(i.msg);return e||s.info.flow_control.heartbeat_count++,{ingest:c,protocol:!0}}return Rr(i.msg)?(s.info.flow_control.fc_count++,{ingest:!0,protocol:!0}):{ingest:!e||s._checkOrderedConsumer(t),protocol:!1}}}}class Jn extends Li{js;monitor;constructor(e,t,r){super(e.nc,t,r),this.js=e,this.monitor=null,this.sub.closed.then(()=>{this.monitor&&this.monitor.cancel()})}set info(e){this.sub.info=e}get info(){return this.sub.info}_resetOrderedConsumer(e){if(null===this.info||this.sub.isClosed())return;const t=S(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,t);const s=this.info;s.ordered_consumer_sequence.delivery_seq=0,s.flow_control.heartbeat_count=0,s.flow_control.fc_count=0,s.flow_control.consumer_restarts++,s.deliver=t,s.config.deliver_subject=t,s.config.deliver_policy=_e.StartSequence,s.config.opt_start_seq=e;const i={};i.stream_name=this.info.stream,i.config=s.config,this.js._request(`${s.api.prefix}.CONSUMER.CREATE.${s.stream}`,i).then(c=>{const d=c;this.info.config=d.config,this.info.name=d.name}).catch(c=>{const d=new I(`unable to recreate ordered consumer ${s.stream} at seq ${e}`,O.RequestError,c);this.sub.callback(d,{})})}_maybeSetupHbMonitoring(){const e=this.info?.config?.idle_heartbeat||0;e&&this._setupHbMonitoring(Nr(e))}_setupHbMonitoring(e,t=0){const r={cancelAfter:0,maxOut:2};t&&(r.cancelAfter=t);const s=this.sub;this.monitor=new qr(e,o=>{const c=function fi(n,e,t){const r=tt(n,e),i=new _n({hdr:1,sid:0,size:0},ne,{});return i._headers=r,i._subject=t,i}(409,`${Fe.IdleHeartbeatMissed}: ${o}`,this.sub.subject);return this.info?.ordered?!!this.js.nc.protocol.connected&&(this._resetOrderedConsumer((this.info?.ordered_consumer_sequence?.stream_seq||0)+1),!1):(this.sub.callback(null,c),!s.noIterator)},r)}_checkHbOrderConsumer(e){const t=e.headers.get(Te.ConsumerStalledHdr);""!==t&&this.js.nc.publish(t);const r=parseInt(e.headers.get(Te.LastConsumerSeqHdr),10),s=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,r!==s.delivery_seq&&this._resetOrderedConsumer(s.stream_seq+1),!1}_checkOrderedConsumer(e){const t=this.info.ordered_consumer_sequence,r=e.info.streamSequence,s=e.info.deliverySequence;return s!=t.delivery_seq+1?(this._resetOrderedConsumer(t.stream_seq+1),!1):(t.delivery_seq=s,t.stream_seq=r,!0)}destroy(){var e=this;return(0,h.Z)(function*(){e.isClosed()||(yield e.drain());const t=e.sub.info,s=`${t.api.prefix}.CONSUMER.DELETE.${t.stream}.${t.config.durable_name||t.name}`;yield t.api._request(s)})()}consumerInfo(){var e=this;return(0,h.Z)(function*(){const t=e.sub.info,s=`${t.api.prefix}.CONSUMER.INFO.${t.stream}.${t.config.durable_name||t.name}`,i=yield t.api._request(s);return t.last=i,i})()}}class to extends Jn{constructor(e,t,r){super(e,t,r)}pull(e={batch:1}){const{stream:t,config:r,name:s}=this.sub.info,i=r.durable_name??s,o={};if(o.batch=e.batch||1,o.no_wait=e.no_wait||!1,(e.max_bytes??0)>0){const p=this.js.nc.features.get(ee.JS_PULL_MAX_BYTES);if(!p.ok)throw new Error(`max_bytes is only supported on servers ${p.min} or better`);o.max_bytes=e.max_bytes}let c=0;e.expires&&e.expires>0&&(c=e.expires,o.expires=ce(c));let d=0;if(e.idle_heartbeat&&e.idle_heartbeat>0&&(d=e.idle_heartbeat,o.idle_heartbeat=ce(d)),d&&0===c)throw new Error("idle_heartbeat requires expires");if(d>c)throw new Error("expires must be greater than idle_heartbeat");if(this.info){this.monitor&&this.monitor.cancel(),c&&d&&(this.monitor?this.monitor._change(d,c):this._setupHbMonitoring(d,c));const p=this.info.api,_=this.sub.subject;p.nc.publish(`${p.prefix}.CONSUMER.MSG.NEXT.${t}.${i}`,p.jc.encode(o),{reply:_})}}}function no(n,e){return n||(n=wt(e))?[n,null]:[null,Ht(e)]}function so(n,e){if(n)return[n,null];const t=wt(e);return null!==t?[Vn(t),null]:[null,Ht(e)]}function Vn(n){if(null!==n)switch(n.code){case O.JetStream404NoMessages:case O.JetStream408RequestTimeout:return null;case O.JetStream409:return function pi(n){if(n.code!==O.JetStream409)return!1;const e=[Fe.MaxBatchExceeded,Fe.MaxExpiresExceeded,Fe.MaxBytesExceeded,Fe.MaxMessageSizeExceeded,Fe.PushConsumer,Fe.IdleHeartbeatMissed,Fe.ConsumerDeleted];return di&&e.push(Fe.MaxWaitingExceeded),void 0!==e.find(t=>-1!==n.message.indexOf(t))}(n)?n:null;default:return n}return null}function io(n){n&&n.ack()}class oo extends Lt{constructor(e,t){super(e,t)}getMessage(e,t){var r=this;return(0,h.Z)(function*(){Me(e);let s=t;const{last_by_subj:i}=s;i&&(s=null);const o=s?r.jc.encode(s):ne,c=r.opts.apiPrefix||"$JS.API",d=i?`${c}.DIRECT.GET.${e}.${i}`:`${c}.DIRECT.GET.${e}`,p=yield r.nc.request(d,o),b=wt(p);if(b)return Promise.reject(b);const _=new ao(p);return Promise.resolve(_)})()}}let ao=(()=>class n{data;header;static jc;constructor(t){if(!t.headers)throw new Error("headers expected");this.data=t.data,this.header=t.headers}get subject(){return this.header.get(Bt.Subject)}get seq(){const t=this.header.get(Bt.Sequence);return"string"==typeof t?parseInt(t):0}get time(){return new Date(Date.parse(this.timestamp))}get timestamp(){return this.header.get(Bt.TimeStamp)}get stream(){return this.header.get(Bt.Stream)}json(t){return Re(t).decode(this.data)}string(){return le.decode(this.data)}})();class co extends Lt{streams;consumers;direct;constructor(e,t){super(e,t),this.streams=new zr(e,t),this.consumers=new Fr(e,t),this.direct=new oo(e,t)}getAccountInfo(){var e=this;return(0,h.Z)(function*(){return yield e._request(`${e.prefix}.INFO`)})()}jetstream(){return this.nc.jetstream(this.getOptions())}advisories(){const e=new Ae;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(t,r)=>{if(t)throw t;try{const s=this.parseJsResponse(r),i=s.type.split(".");e.push({kind:i[i.length-1],data:s})}catch(s){e.stop(s)}}}),e}}class Kn{msg;constructor(e){this.msg=e}get data(){return this.msg.data}get sid(){return this.msg.sid}get subject(){return this.msg.subject}get reply(){return this.msg.reply||""}get headers(){return this.msg.headers}respond(e,t){return this.msg.respond(e,t)}respondError(e,t,r,s){return(s=s||{}).headers=s.headers||tt(),s.headers?.set(v,`${e}`),s.headers?.set(x,t),this.msg.respond(r,s)}json(e){return this.msg.json(e)}string(){return this.msg.string()}}class Jt{subject;queue;srv;constructor(e,t="",r=""){""!==t&&function ho(n,e){if(-1!==e.indexOf(" "))throw new Error(`${n} cannot contain spaces: '${e}'`);e.split(".").forEach(r=>{if(">"===r)throw new Error(`${n} name cannot contain internal '>': '${e}'`)})}("service group",t);let s="";if(e instanceof Vt)this.srv=e,s="";else{if(!(e instanceof Jt))throw new Error("unknown ServiceGroup type");{const i=e;this.srv=i.srv,""===r&&""!==i.queue&&(r=i.queue),s=i.subject}}this.subject=this.calcSubject(s,t),this.queue=r}calcSubject(e,t=""){return""===t?e:""!==e?`${e}.${t}`:t}addEndpoint(e="",t){const r="function"==typeof(t=t||{subject:e})?{handler:t,subject:e}:t;Ut("endpoint",e);let{subject:s,handler:i,metadata:o,queue:c}=r;return s=s||e,c=c||this.queue,function lo(n,e){if(""===e)throw new Error(`${n} cannot be empty`);if(-1!==e.indexOf(" "))throw new Error(`${n} cannot contain spaces: '${e}'`);const t=e.split(".");t.forEach((r,s)=>{if(">"===r&&s!==t.length-1)throw new Error(`${n} cannot have internal '>': '${e}'`)})}("endpoint subject",s),s=this.calcSubject(this.subject,s),this.srv._addEndpoint({name:e,subject:s,queue:c,handler:i,metadata:o})}addGroup(e="",t=""){return new Jt(this,e,t)}}class Vt{nc;_id;config;handlers;internal;_stopped;_done;started;static controlSubject(e,t="",r="",s){const i=s??"$SRV";return""===t&&""===r?`${i}.${e}`:(Ut("control subject name",t),""!==r?(Ut("control subject id",r),`${i}.${e}.${t}.${r}`):`${i}.${e}.${t}`)}constructor(e,t={name:"",version:""}){this.nc=e,this.config=Object.assign({},t),this.config.queue||(this.config.queue="q"),Ut("name",this.config.name),Ut("queue",this.config.queue),mt(this.config.version),this._id=Pe.next(),this.internal=[],this._done=B(),this._stopped=!1,this.handlers=[],this.started=(new Date).toISOString(),this.reset(),this.nc.closed().then(()=>{this.close().catch()}).catch(r=>{this.close(r).catch()})}get subjects(){return this.handlers.filter(e=>!1===e.internal).map(e=>e.subject)}get id(){return this._id}get name(){return this.config.name}get description(){return this.config.description??""}get version(){return this.config.version}get metadata(){return this.config.metadata}errorToHeader(e){const t=tt();if(e instanceof P){const r=e;t.set(x,r.message),t.set(v,`${r.code}`)}else t.set(x,e.message),t.set(v,"500");return t}setupHandler(e,t=!1){const r=t?"":e.queue?e.queue:this.config.queue,{name:s,subject:i,handler:o}=e,c=e;c.internal=t,t&&this.internal.push(c),c.stats=new fo(s,i,r),c.queue=r;const d=o?(p,b)=>{if(p)return void this.close(p);const _=Date.now();try{o(p,new Kn(b))}catch(w){c.stats.countError(w),b?.respond(ne,{headers:this.errorToHeader(w)})}finally{c.stats.countLatency(_)}}:void 0;return c.sub=this.nc.subscribe(i,{callback:d,queue:r}),c.sub.closed.then(()=>{this._stopped||this.close(new Error(`required subscription ${e.subject} stopped`)).catch()}).catch(p=>{if(!this._stopped){const b=new Error(`required subscription ${e.subject} errored: ${p.message}`);b.stack=p.stack,this.close(b).catch()}}),c}info(){return{type:Nt.INFO,name:this.name,id:this.id,version:this.version,description:this.description,metadata:this.metadata,endpoints:this.endpoints()}}endpoints(){return this.handlers.map(e=>{const{subject:t,metadata:r,name:s,queue:i}=e;return{subject:t,metadata:r,name:s,queue_group:i}})}stats(){var e=this;return(0,h.Z)(function*(){const t=[];for(const r of e.handlers){if("function"==typeof e.config.statsHandler)try{r.stats.data=yield e.config.statsHandler(r)}catch(s){r.stats.countError(s)}t.push(r.stats.stats(r.qi))}return{type:Nt.STATS,name:e.name,id:e.id,version:e.version,started:e.started,metadata:e.metadata,endpoints:t}})()}addInternalHandler(e,t){const r=`${e}`.toUpperCase();this._doAddInternalHandler(`${r}-all`,e,t),this._doAddInternalHandler(`${r}-kind`,e,t,this.name),this._doAddInternalHandler(`${r}`,e,t,this.name,this.id)}_doAddInternalHandler(e,t,r,s="",i=""){const o={};o.name=e,o.subject=Vt.controlSubject(t,s,i),o.handler=r,this.setupHandler(o,!0)}start(){const e=Re(),s=e.encode(this.ping());return this.addInternalHandler(N.PING,(o,c)=>o?(this.close(o).then().catch(),Promise.reject(o)):(c.respond(s),Promise.resolve())),this.addInternalHandler(N.STATS,(o,c)=>o?(this.close(o),Promise.reject(o)):this.stats().then(d=>(c?.respond(e.encode(d)),Promise.resolve()))),this.addInternalHandler(N.INFO,(o,c)=>o?(this.close(o),Promise.reject(o)):(c?.respond(e.encode(this.info())),Promise.resolve())),this.handlers.forEach(o=>{const{subject:c}=o;"string"==typeof c&&null!==o.handler&&this.setupHandler(o)}),Promise.resolve(this)}close(e){if(this._stopped)return this._done;this._stopped=!0;let t=[];return this.nc.isClosed()||(t=this.handlers.concat(this.internal).map(r=>r.sub.drain())),Promise.allSettled(t).then(()=>{this._done.resolve(e||null)}),this._done}get stopped(){return this._done}get isStopped(){return this._stopped}stop(e){return this.close(e)}ping(){return{type:Nt.PING,name:this.name,id:this.id,version:this.version,metadata:this.metadata}}reset(){if(this.started=(new Date).toISOString(),this.handlers)for(const e of this.handlers)e.stats.reset(e.qi)}addGroup(e,t){return new Jt(this,e,t)}addEndpoint(e,t){return new Jt(this).addEndpoint(e,t)}_addEndpoint(e){const t=new Ae;t.noIterator="function"==typeof e.handler,t.noIterator||(e.handler=(s,i)=>{s?this.stop(s).catch():t.push(new Kn(i))},t.iterClosed.then(()=>{this.close().catch()}));const r=this.setupHandler(e,!1);return r.qi=t,this.handlers.push(r),t}}class fo{name;subject;average_processing_time;num_requests;processing_time;num_errors;last_error;data;metadata;queue;constructor(e,t,r=""){this.name=e,this.subject=t,this.average_processing_time=0,this.num_errors=0,this.num_requests=0,this.processing_time=0,this.queue=r}reset(e){this.num_requests=0,this.processing_time=0,this.average_processing_time=0,this.num_errors=0,this.last_error=void 0,this.data=void 0;const t=e;t&&(t.time=0,t.processed=0)}countLatency(e){this.num_requests++,this.processing_time+=ce(Date.now()-e),this.average_processing_time=Math.round(this.processing_time/this.num_requests)}countError(e){this.num_errors++,this.last_error=e.message}_stats(){const{name:e,subject:t,average_processing_time:r,num_errors:s,num_requests:i,processing_time:o,last_error:c,data:d,queue:p}=this;return{name:e,subject:t,average_processing_time:r,num_errors:s,num_requests:i,processing_time:o,last_error:c,data:d,queue_group:p}}stats(e){const t=e;return!1===t?.noIterator&&(this.processing_time=t.time,this.num_requests=t.processed,this.average_processing_time=this.processing_time>0&&this.num_requests>0?this.processing_time/this.num_requests:0),this._stats()}}class po{nc;prefix;opts;constructor(e,t={strategy:fe.JitterTimer,maxWait:2e3},r){this.nc=e,this.prefix=r,this.opts=t}ping(e="",t=""){return this.q(N.PING,e,t)}stats(e="",t=""){return this.q(N.STATS,e,t)}info(e="",t=""){return this.q(N.INFO,e,t)}q(e,t="",r=""){var s=this;return(0,h.Z)(function*(){const i=new Ae,o=Re(),c=Vt.controlSubject(e,t,r,s.prefix),d=yield s.nc.requestMany(c,ne,s.opts);return(0,h.Z)(function*(){var _,p=!1,b=!1;try{for(var E,w=(0,K.Z)(d);p=!(E=yield w.next()).done;p=!1){const j=E.value;try{const T=o.decode(j.data);i.push(T)}catch(T){i.push(()=>{i.stop(T)})}}}catch(j){b=!0,_=j}finally{try{p&&null!=w.return&&(yield w.return())}finally{if(b)throw _}}i.push(()=>{i.stop()})})().catch(p=>{i.stop(p)}),i})()}}class Vr{options;protocol;draining;listeners;_services;constructor(e){this.draining=!1,this.options=ni(e),this.listeners=[]}static connect(e={}){return new Promise((t,r)=>{const s=new Vr(e);ar.connect(s.options,s).then(i=>{s.protocol=i,(0,h.Z)(function*(){var d,o=!1,c=!1;try{for(var b,p=(0,K.Z)(i.status());o=!(b=yield p.next()).done;o=!1){const _=b.value;s.listeners.forEach(w=>{w.push(_)})}}catch(_){c=!0,d=_}finally{try{o&&null!=p.return&&(yield p.return())}finally{if(c)throw d}}})(),t(s)}).catch(i=>{r(i)})})}closed(){return this.protocol.closed}close(){var e=this;return(0,h.Z)(function*(){yield e.protocol.close()})()}_check(e,t,r){if(this.isClosed())throw I.errorForCode(O.ConnectionClosed);if(t&&this.isDraining()||r&&this.protocol.noMorePublishing)throw I.errorForCode(O.ConnectionDraining);if(0===(e=e||"").length)throw I.errorForCode(O.BadSubject)}publish(e,t,r){this._check(e,!1,!0),this.protocol.publish(e,t,r)}subscribe(e,t={}){this._check(e,!0,!1);const r=new An(this.protocol,e,t);return this.protocol.subscribe(r),r}_resub(e,t,r){this._check(t,!0,!1);const s=e;s.max=r,r&&(s.max=r+s.received),this.protocol.resub(s,t)}requestMany(e,t=ne,r={maxWait:1e3,maxMessages:-1}){try{this._check(e,!0,!0)}catch(c){return Promise.reject(c)}if(r.strategy=r.strategy||fe.Timer,r.maxWait=r.maxWait||1e3,r.maxWait<1)return Promise.reject(new I("timeout",O.InvalidOption));const s=new Ae;function i(c){s.push(()=>{s.stop(c)})}function o(c,d){c||null===d?i(null===c?void 0:c):s.push(d)}if(r.noMux){const c=(new Error).stack;let d="number"==typeof r.maxMessages&&r.maxMessages>0?r.maxMessages:-1;const p=this.subscribe(S(this.options.inboxPrefix),{callback:(E,j)=>{if(0===j?.data?.length&&j?.headers?.status===O.NoResponders&&(E=I.errorForCode(O.NoResponders)),E)return E.stack+=`\n\n${c}`,void b(E);o(null,j),r.strategy===fe.Count&&(d--,0===d&&b()),r.strategy===fe.JitterTimer&&(w(),_=setTimeout(()=>{b()},300)),r.strategy===fe.SentinelMsg&&j&&0===j.data.length&&b()}});p.closed.then(()=>{i()}).catch(E=>{s.stop(E)});const b=E=>{E&&s.push(()=>{throw E}),w(),p.drain().then(()=>{i()}).catch(j=>{i()})};s.iterClosed.then(()=>{w(),p?.unsubscribe()}).catch(E=>{w(),p?.unsubscribe()});try{this.publish(e,t,{reply:p.getSubject()})}catch(E){b(E)}let _=setTimeout(()=>{b()},r.maxWait);const w=()=>{_&&clearTimeout(_)}}else{const c=r;c.callback=o,s.iterClosed.then(()=>{d.cancel()}).catch(p=>{d.cancel(p)});const d=new li(this.protocol.muxSubscriptions,e,c);this.protocol.request(d);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${d.token}`,headers:r.headers})}catch(p){d.cancel(p)}}return Promise.resolve(s)}request(e,t,r={timeout:1e3,noMux:!1}){try{this._check(e,!0,!0)}catch(s){return Promise.reject(s)}if(r.timeout=r.timeout||1e3,r.timeout<1)return Promise.reject(new I("timeout",O.InvalidOption));if(!r.noMux&&r.reply)return Promise.reject(new I("reply can only be used with noMux",O.InvalidOption));if(r.noMux){const s=r.reply?r.reply:S(this.options.inboxPrefix),i=B(),o=new Error;return this.subscribe(s,{max:1,timeout:r.timeout,callback:(d,p)=>{d?(d.code!==O.Timeout&&(d.stack+=`\n\n${o.stack}`),i.reject(d)):(d=mn(p))?(d.stack+=`\n\n${o.stack}`,i.reject(d)):i.resolve(p)}}).requestSubject=e,this.protocol.publish(e,t,{reply:s,headers:r.headers}),i}{const s=new kn(this.protocol.muxSubscriptions,e,r);this.protocol.request(s);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${s.token}`,headers:r.headers})}catch(o){s.cancel(o)}const i=Promise.race([s.timer,s.deferred]);return i.catch(()=>{s.cancel()}),i}}flush(){return this.isClosed()?Promise.reject(I.errorForCode(O.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(I.errorForCode(O.ConnectionClosed)):this.isDraining()?Promise.reject(I.errorForCode(O.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){const e=this.protocol.getServer();return e?e.listen:""}status(){const e=new Ae;return e.iterClosed.then(()=>{const t=this.listeners.indexOf(e);this.listeners.splice(t,1)}),this.listeners.push(e),e}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}jetstreamManager(e={}){var t=this;return(0,h.Z)(function*(){const r=new co(t,e);try{yield r.getAccountInfo()}catch(s){const i=s;throw i.code===O.NoResponders&&(i.code=O.JetStreamNotEnabled),i}return r})()}jetstream(e={}){return new Jr(this,e)}getServerVersion(){const e=this.info;return e?mt(e.version):void 0}rtt(){var e=this;return(0,h.Z)(function*(){if(!e.protocol._closed&&!e.protocol.connected)throw I.errorForCode(O.Disconnect);const t=Date.now();return yield e.flush(),Date.now()-t})()}get features(){return this.protocol.features}get services(){return this._services||(this._services=new mo(this)),this._services}}class mo{nc;constructor(e){this.nc=e}add(e){try{return new Vt(this.nc,e).start()}catch(t){return Promise.reject(t)}}client(e,t){return new po(this.nc,e,t)}}class vo{version;lang;closeError;connected;done;socket;options;socketClosed;encrypted;peeked;yields;signal;closedNotification;constructor(){this.version="1.18.0",this.lang="nats.ws",this.connected=!1,this.done=!1,this.socketClosed=!1,this.encrypted=!1,this.peeked=!1,this.yields=[],this.signal=B(),this.closedNotification=B()}connect(e,t){var r=this;return(0,h.Z)(function*(){const i=B();if(t.tls)return i.reject(new I("tls",O.InvalidOption)),i;r.options=t;const o=e.src;if(t.wsFactory){const{socket:c,encrypted:d}=yield t.wsFactory(e.src,t);r.socket=c,r.encrypted=d}else r.encrypted=0===o.indexOf("wss://"),r.socket=new WebSocket(o);return r.socket.binaryType="arraybuffer",r.socket.onopen=()=>{r.isDiscarded()},r.socket.onmessage=c=>{if(r.isDiscarded())return;if(r.yields.push(new Uint8Array(c.data)),r.peeked)return void r.signal.resolve();const d=Se.concat(...r.yields),p=function gs(n){const e=function _s(n){for(let e=0;e<n.length;e++){const t=e+1;if(n.byteLength>t&&n[e]===ps&&n[t]===ms)return t+1}return 0}(n);if(e>0){const r=new Uint8Array(n).slice(0,e);return le.decode(r)}return""}(d);if(""!==p){const b=oi.exec(p);if(!b)return t.debug&&console.error("!!!",Q(d)),void i.reject(new Error("unexpected response from server"));try{(function si(n,e){const{proto:t,tls_required:r,tls_available:s}=n;if((void 0===t||t<1)&&e.noEcho)throw new I("noEcho",O.ServerOptionNotAvailable);if(e.tls&&!r&&!s)throw new I("tls",O.ServerOptionNotAvailable)})(JSON.parse(b[1]),r.options),r.peeked=!0,r.connected=!0,r.signal.resolve(),i.resolve()}catch(_){return void i.reject(_)}}},r.socket.onclose=c=>{if(r.isDiscarded())return;let d;r.socketClosed=!0,r.done||(c.wasClean||(d=new Error(c.reason)),r._closed(d))},r.socket.onerror=c=>{if(r.isDiscarded())return;const p=new I(c.message,O.Unknown,new Error(c.error));i.reject(p)},i})()}disconnect(){this._closed(void 0,!0)}_closed(e,t=!0){var r=this;return(0,h.Z)(function*(){if(!r.isDiscarded()&&r.connected&&!r.done){if(r.closeError=e,!e)for(;!r.socketClosed&&r.socket.bufferedAmount>0;)yield D(100);r.done=!0;try{r.socket.close(e?1002:1e3,e?e.message:void 0)}catch{}t&&r.closedNotification.resolve(e)}})()}get isClosed(){return this.done}[Symbol.asyncIterator](){return this.iterate()}iterate(){var e=this;return je(function*(){for(;;){if(e.isDiscarded())return;0===e.yields.length&&(yield X(e.signal));const t=e.yields;e.yields=[];for(let r=0;r<t.length;r++)e.options.debug&&console.info(`> ${Q(t[r])}`),yield t[r];if(e.done)break;0===e.yields.length&&(t.length=0,e.yields=t,e.signal=B())}})()}isEncrypted(){return this.connected&&this.encrypted}send(e){if(!this.isDiscarded())try{return this.socket.send(e.buffer),void(this.options.debug&&console.info(`< ${Q(e)}`))}catch(t){this.options.debug&&console.error(`!!! ${Q(e)}: ${t}`)}}close(e){return this._closed(e,!1)}closed(){return this.closedNotification}isDiscarded(){return!!this.done&&(this.discard(),!0)}discard(){this.done=!0;try{this.socket?.close()}catch{}}}function wo(n){/^(.*:\/\/)(.*)/.test(n)||(n=`https://${n}`);let t=new URL(n);const r=t.protocol.toLowerCase();let s,i;"https:"!==r&&"http"!==r&&(n=n.replace(/^(.*:\/\/)(.*)/gm,"$2"),t=new URL(`http://${n}`));const o=t.hostname,c=t.pathname,d=t.search||"";switch(r){case"http:":case"ws:":case"nats:":i=t.port||"80",s="ws:";break;default:i=t.port||"443",s="wss:"}return`${s}//${o}:${i}${c}${d}`}Z(6021);let Kr=class{#e;#t;#r;#n=Re();#s;constructor(e){this.#e=e||{name:""}}connect(e,t,r){var s=this;return(0,h.Z)(function*(){try{s.#t=yield function So(n={}){return function Ke(n){de=n}({defaultPort:443,urlParseFn:wo,factory:()=>new vo}),Vr.connect(n)}({servers:e,user:t,pass:r})}catch(i){console.error(i)}s.#r=yield s.#t.jetstream()})()}publish(e,t){var r=this;return(0,h.Z)(function*(){try{const s={data:t};yield r.#r.publish(e,r.#n.encode(s))}catch(s){console.log(s)}})()}unsubscribe(){void 0!==this.#s?this.#s.close():console.error("Should have subscribed first")}subscribe(e=pr.Pull,t,r){return new pe.Observable(s=>{(e===pr.Pull?this.#o(t):this.#i(t,r)).then(o=>{this.#s=o,s.next(o)})})}#i(e,t){var r=this;return(0,h.Z)(function*(){return t?(yield r.#r.consumers.get(r.#e.name,{filterSubjects:e,inactive_threshold:1e3,deliver_policy:t})).consume():(yield r.#r.consumers.get(r.#e.name,{filterSubjects:e,inactive_threshold:1e3})).consume()})()}#o(e){var t=this;return(0,h.Z)(function*(){return(yield t.#r.consumers.get(t.#e.name,e)).consume()})()}request(e,t){const r=new pe.Subject;let s;return s=(0,pe.from)(null!=t&&""!==t&&0!==t&&!1!==t?this.#t.request(`core.${e}`,this.#n.encode({data:t})):this.#t.request(`core.${e}`,this.#n.encode({data:{}}))),s.subscribe(c=>{r.next(this.#n.decode(c.data))}),r.asObservable()}drain(){var e=this;return(0,h.Z)(function*(){yield e.#t.drain()})()}};Kr=(0,C.gn)([(0,xe.Injectable)({providedIn:"root"})],Kr);var pr=function(n){return n.Pull="pull",n.Push="push",n}(pr||{}),Wn=function(n){return n.None="none",n.All="all",n.Explicit="explicit",n.NotSet="",n}(Wn||{}),Yn=function(n){return n.Limits="limits",n.Interest="interest",n.Workqueue="workqueue",n}(Yn||{}),Xn=function(n){return n.All="all",n.Last="last",n.New="new",n.StartSequence="by_start_sequence",n.StartTime="by_start_time",n.LastPerSubject="last_per_subject",n}(Xn||{})},9191:(Tt,Ne,Z)=>{Z.r(Ne),Z.d(Ne,{AppStoreComponent:()=>ct,AppStoreService:()=>he});var h=Z(5861),C=Z(5863),xe=Z(6701),pe=Z(9159),K=Z(2182),oe=Z(575),X=Z(8426),Ue=Z(743),je=Z(1189),ne=Z(2998),Ce=Z(7842),le=Z(6107),pt=Z(6984),Oe=Z(3433),ot=Z(6488),Ve=Z(25);function Qe(O,De){if(1&O&&(C.\u0275\u0275elementStart(0,"span"),C.\u0275\u0275text(1),C.\u0275\u0275elementEnd()),2&O){const L=De.$implicit;C.\u0275\u0275classMap(L.icon),C.\u0275\u0275advance(1),C.\u0275\u0275textInterpolate1(" ",L.label," ")}}function yt(O,De){if(1&O){const L=C.\u0275\u0275getCurrentView();C.\u0275\u0275elementContainerStart(0),C.\u0275\u0275elementStart(1,"his-card-list",19),C.\u0275\u0275listener("setChange",function(I){C.\u0275\u0275restoreView(L);const V=C.\u0275\u0275nextContext(2);return C.\u0275\u0275resetView(V.appStoreService.onFavoriteClick(I))})("clickCard",function(I){C.\u0275\u0275restoreView(L);const V=C.\u0275\u0275nextContext(2);return C.\u0275\u0275resetView(V.appStoreService.onNavAppClick(I))}),C.\u0275\u0275elementEnd(),C.\u0275\u0275elementContainerEnd()}if(2&O){const L=De.$implicit;C.\u0275\u0275advance(1),C.\u0275\u0275property("myAppStore",L)}}function at(O,De){if(1&O&&(C.\u0275\u0275elementContainerStart(0),C.\u0275\u0275elementStart(1,"div",15),C.\u0275\u0275element(2,"p-divider",16),C.\u0275\u0275elementStart(3,"div",17),C.\u0275\u0275template(4,yt,2,1,"ng-container",18),C.\u0275\u0275elementEnd()(),C.\u0275\u0275elementContainerEnd()),2&O){const L=C.\u0275\u0275nextContext();C.\u0275\u0275advance(4),C.\u0275\u0275property("ngForOf",L.appStoreService.myAppStores())}}function J(O,De){if(1&O){const L=C.\u0275\u0275getCurrentView();C.\u0275\u0275elementContainerStart(0),C.\u0275\u0275elementStart(1,"his-card-list",22),C.\u0275\u0275listener("setChange",function(I){C.\u0275\u0275restoreView(L);const V=C.\u0275\u0275nextContext(2);return C.\u0275\u0275resetView(V.appStoreService.onFavoriteClick(I))})("clickCard",function(I){C.\u0275\u0275restoreView(L);const V=C.\u0275\u0275nextContext(2);return C.\u0275\u0275resetView(V.appStoreService.onNavAppClick(I))}),C.\u0275\u0275elementEnd(),C.\u0275\u0275elementContainerEnd()}if(2&O){const L=De.$implicit;C.\u0275\u0275advance(1),C.\u0275\u0275property("myAppStore",L)("isListView",!0)}}function ae(O,De){if(1&O&&(C.\u0275\u0275elementStart(0,"div",20),C.\u0275\u0275element(1,"p-divider",16),C.\u0275\u0275elementStart(2,"div",21),C.\u0275\u0275template(3,J,2,2,"ng-container",18),C.\u0275\u0275elementEnd()()),2&O){const L=C.\u0275\u0275nextContext();C.\u0275\u0275advance(3),C.\u0275\u0275property("ngForOf",L.appStoreService.myAppStores())}}let ge=(()=>{class O{#e="ws://localhost:8080";#t=(0,C.inject)(pe.JetstreamWsService);connect(){var L=this;return(0,h.Z)(function*(){console.log("connected"),yield L.#t.connect(L.#e)})()}disconnect(){var L=this;return(0,h.Z)(function*(){yield L.#t.drain()})()}static#r=this.\u0275fac=function(H){return new(H||O)};static#n=this.\u0275prov=C.\u0275\u0275defineInjectable({token:O,factory:O.\u0275fac,providedIn:"root"})}return O})(),he=(()=>{class O{constructor(){this.myAppStores=(0,C.signal)([]),this.userAppStores=(0,C.signal)([]),this.appOpenedIndex=[],this.#e=(0,C.inject)(xe.Router),this.#t=(0,C.inject)(pe.JetstreamWsService),this.#r=(0,C.inject)(K.SharedService),this.#n=(0,C.inject)(ge)}#e;#t;#r;#n;convertToExtended(L){return L.map(H=>({...H,isOpen:!1}))}getAppStoreList(L){var H=this;return(0,h.Z)(function*(){H.#t.request("UserAppStore.myAppStore",L).subscribe(I=>{H.myAppStores.set(H.convertToExtended(I))})})()}getUserStoreList(L){var H=this;return(0,h.Z)(function*(){H.#t.request("UserAppStore.list",L).subscribe(I=>{H.userAppStores.set(I)})})()}getAppStoresByKeyword(L){return L?this.myAppStores().filter(H=>H.title.includes(L)):this.myAppStores()}getAppStore(L){return this.myAppStores().filter(I=>I.url===L)[0]}pubUserAppStoreFavorite(L){var H=this;return(0,h.Z)(function*(){yield H.#t.publish("UserAppStore.update.isFavorite",L)})()}initAppStore(){var L=this;return(0,h.Z)(function*(){const H=yield L.#r.getValue(history.state.token);console.log("get token",H),yield L.getAppStoreList(H.userCode.code),yield L.getUserStoreList(H.userCode.code)})()}onFavoriteClick(L){this.myAppStores.update(H=>(console.log("userAppStores",this.userAppStores()),H.map(I=>{if(I.appId===L){I.isFavorite=!I.isFavorite;const V=this.userAppStores().find(fe=>fe.appId===L);console.log("appId",L),console.log("userAppStoreID",V?.appId),V&&(V.isFavorite=I.isFavorite,this.pubUserAppStoreFavorite(V))}return I})))}onNavAppClick(L){this.#e.navigate([L])}setAppClose(L){if(this.myAppStores.update(H=>H.map(I=>(I.appId===L&&(I.isOpen=!1),I))),console.log(this.appOpenedIndex),this.appOpenedIndex.length>1){const H=this.appOpenedIndex.findIndex(I=>I.appId===L);this.appOpenedIndex.splice(H,1),console.log(H),console.log(this.appOpenedIndex[this.appOpenedIndex.length-1]),this.#e.navigate([this.appOpenedIndex[this.appOpenedIndex.length-1].url])}else this.appOpenedIndex.splice(1,1),this.#e.navigateByUrl("/home")}setAppOpen(L){const H=this.myAppStores().filter(V=>V.appId===L)[0];H&&(this.myAppStores.update(V=>V.map(fe=>(fe.appId===L&&(fe.isOpen=!0),fe))),this.appOpenedIndex.find(V=>((V,fe)=>V.url===fe.url)(V,H))||this.appOpenedIndex.push(H))}static#s=this.\u0275fac=function(H){return new(H||O)};static#i=this.\u0275prov=C.\u0275\u0275defineInjectable({token:O,factory:O.\u0275fac,providedIn:"root"})}return O})();var Le=Object.freeze({__proto__:null,default:[{icon:"material-symbols-outlined",label:"grid_view",value:"grid"},{icon:"material-symbols-outlined",label:"view_agenda",value:"list"}]});let ct=(()=>{class O{constructor(){this.isGridView=(0,C.signal)(!0),this.Options=[],this.value="grid",this.appStoreService=(0,C.inject)(he),this.userAccountService=(0,C.inject)(ot.Ng),this.#e=(0,C.inject)(K.SharedService),this.#t=(0,C.inject)(Oe.TranslateService)}#e;#t;ngOnInit(){var L=this;return(0,h.Z)(function*(){L.#t.setDefaultLang("zh-Hant"),L.Options=Object.values(Le)[0]})()}onBackClick(){window.history.back()}onSelectedChange(){this.isGridView.set("grid"===this.value)}static#r=this.\u0275fac=function(H){return new(H||O)};static#n=this.\u0275cmp=C.\u0275\u0275defineComponent({type:O,selectors:[["his-app-store"]],standalone:!0,features:[C.\u0275\u0275StandaloneFeature],decls:21,vars:9,consts:[[1,"content-container"],[1,"top-bar-container"],["styleClass","mr-2","size","xlarge","shape","circle",3,"image"],[1,"title"],[1,"toolbar-container"],[1,"icon-container","title-box"],["pButton","","pRipple","","type","button","icon","pi pi-angle-left",1,"p-button-rounded","p-button-secondary","p-button-outlined",3,"click"],[1,"icon-container"],[1,"p-input-icon-left"],[1,"pi","pi-search"],["type","text","pInputText","","placeholder","\u67e5\u8a62"],["optionLabel","name","optionValue","value",3,"options","ngModel","ngModelChange","onOptionClick"],["pTemplate",""],[4,"ngIf","ngIfElse"],["listView",""],[1,"appstore-container"],[1,"first-class"],[1,"flex","flex-wrap","card-content"],[4,"ngFor","ngForOf"],[1,"grid-style",3,"myAppStore","setChange","clickCard"],[1,"appstore-container","listView"],[1,"flex","flex-wrap","list-content"],[1,"list-style",3,"myAppStore","isListView","setChange","clickCard"]],template:function(H,I){if(1&H&&(C.\u0275\u0275elementStart(0,"div",0)(1,"div",1),C.\u0275\u0275element(2,"p-avatar",2),C.\u0275\u0275elementStart(3,"div",3),C.\u0275\u0275text(4),C.\u0275\u0275pipe(5,"translate"),C.\u0275\u0275elementEnd()(),C.\u0275\u0275elementStart(6,"div",4)(7,"div",5)(8,"button",6),C.\u0275\u0275listener("click",function(){return I.onBackClick()}),C.\u0275\u0275elementEnd(),C.\u0275\u0275elementStart(9,"div")(10,"h3"),C.\u0275\u0275text(11,"\u7a0b\u5f0f\u96c6"),C.\u0275\u0275elementEnd()()(),C.\u0275\u0275elementStart(12,"div",7)(13,"span",8),C.\u0275\u0275element(14,"i",9)(15,"input",10),C.\u0275\u0275elementEnd(),C.\u0275\u0275elementStart(16,"p-selectButton",11),C.\u0275\u0275listener("ngModelChange",function(fe){return I.value=fe})("onOptionClick",function(){return I.onSelectedChange()}),C.\u0275\u0275template(17,Qe,2,3,"ng-template",12),C.\u0275\u0275elementEnd()()(),C.\u0275\u0275template(18,at,5,1,"ng-container",13),C.\u0275\u0275template(19,ae,4,1,"ng-template",null,14,C.\u0275\u0275templateRefExtractor),C.\u0275\u0275elementEnd()),2&H){const V=C.\u0275\u0275reference(20);C.\u0275\u0275advance(2),C.\u0275\u0275propertyInterpolate("image",I.userAccountService.userImage().image),C.\u0275\u0275advance(2),C.\u0275\u0275textInterpolate2(" ",I.userAccountService.userAccount().userCode.display,",",C.\u0275\u0275pipeBind1(5,7,"\u6b61\u8fce\u56de\u4f86")," "),C.\u0275\u0275advance(12),C.\u0275\u0275property("options",I.Options)("ngModel",I.value),C.\u0275\u0275advance(2),C.\u0275\u0275property("ngIf",I.isGridView())("ngIfElse",V)}},dependencies:[oe.CommonModule,oe.NgForOf,oe.NgIf,je.ButtonModule,je.ButtonDirective,Ve.PrimeTemplate,Ce.DividerModule,Ce.Divider,Ue.SelectButtonModule,Ue.SelectButton,X.FormsModule,X.NgControlStatus,X.NgModel,ne.InputTextModule,ne.InputText,le.AvatarModule,le.Avatar,pt.D,Oe.TranslateModule,Oe.TranslatePipe],styles:["[_nghost-%COMP%]     .grid-style{margin:6px;width:calc(20% - 12px);max-width:320px}[_nghost-%COMP%]     .grid-style.second-class .p-image.p-component{background:linear-gradient(0deg,rgba(0,0,0,.2) 0%,rgba(0,0,0,0) 100%),var(--tertiary-main)}[_nghost-%COMP%]     .grid-style.third-class .p-image.p-component{background:linear-gradient(0deg,rgba(0,0,0,.2) 0%,rgba(0,0,0,0) 100%),var(--indigo-500)}[_nghost-%COMP%]     .grid-style.fourth-class .p-image.p-component{background:linear-gradient(0deg,rgba(0,0,0,.2) 0%,rgba(0,0,0,0) 100%),var(--orange-500)}[_nghost-%COMP%]     .list-style .p-image.p-component{width:56px;height:56px}[_nghost-%COMP%]     .p-selectbutton .p-button{border-radius:0}[_nghost-%COMP%]     .p-selectbutton .p-button:first-child{border-radius:6px 0 0 6px}[_nghost-%COMP%]     .p-selectbutton .p-button:last-child{border-radius:0 6px 6px 0}.content-container[_ngcontent-%COMP%]{padding:32px;height:100%;display:flex;flex-direction:column;background-color:var(--surface-ground);overflow:auto}.appstore-container[_ngcontent-%COMP%]{padding:var(--spacing-xs) var(--spacing-lg)}.appstore-container.listView[_ngcontent-%COMP%]{width:100%;margin:0 auto}.appstore-container[_ngcontent-%COMP%]   .card-content[_ngcontent-%COMP%]{width:95%;margin:0 auto;transform:translate(-6px);padding-bottom:var(--spacing-md)}.appstore-container[_ngcontent-%COMP%]   .list-content[_ngcontent-%COMP%]{gap:12px}.top-bar-container[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center}.icon-container[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:8px}.icon-container[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.5rem;font-style:normal;font-weight:700;line-height:2rem;letter-spacing:.03rem;color:var(--surface-on-surface)}.list-style[_ngcontent-%COMP%]{cursor:pointer;width:100%}[_nghost-%COMP%]     .p-buttonset .p-button-icon-only{justify-content:center;width:2rem;height:2rem}[_nghost-%COMP%]     .p-buttonset .p-button-icon-only .p-button-icon{font-size:1rem;padding-left:3px}[_nghost-%COMP%]     .p-divider.p-divider-horizontal{margin:12px 0}[_nghost-%COMP%]     .first-class .p-divider-solid.p-divider-horizontal:before{border-color:var(--primary-main);border-width:4px}[_nghost-%COMP%]     .second-class .p-divider-solid.p-divider-horizontal:before{border-color:var(--tertiary-main);border-width:4px}[_nghost-%COMP%]     .third-class .p-divider-solid.p-divider-horizontal:before{border-color:var(--indigo-500);border-width:4px}[_nghost-%COMP%]     .fourth-class .p-divider-solid.p-divider-horizontal:before{border-color:var(--orange-500);border-width:4px}.title[_ngcontent-%COMP%]{padding-left:24px;font-size:28px;font-weight:700;line-height:40px;letter-spacing:1.12px;color:var(--primary-main)}.toolbar-container[_ngcontent-%COMP%]{padding:var(--spacing-xs) var(--spacing-lg);display:flex;justify-content:space-between;width:100%;margin:var(--spacing-lg) 0 var(--spacing-sm)}"]})}return O})()},6488:(Tt,Ne,Z)=>{Z.d(Ne,{Ng:()=>K,iw:()=>oe});var h=Z(5863),C=Z(9159),xe=Z(6390);let K=(()=>{class X{constructor(){this.#e=(0,h.inject)(C.JetstreamWsService),this.userAccount=(0,h.signal)({}),this.userImage=(0,h.signal)({})}#e;getUserImage(je){this.#e.request("UserImage.GetUserImage",je).subscribe(ne=>{this.userImage.set(ne),console.log("get image",ne)})}static#t=this.\u0275fac=function(ne){return new(ne||X)};static#r=this.\u0275prov=h.\u0275\u0275defineInjectable({token:X,factory:X.\u0275fac,providedIn:"root"})}return X})(),oe=(()=>{class X{#e;constructor(){this.#e=(0,h.inject)(C.JetstreamWsService),this.userProfile=(0,h.signal)({}),this.userProfile.set({_id:"jidweqjiefwi",userCode:{code:"Neo",display:"alphaTeam-001"},appId:"web-client",profile:{isDockVisible:!0},updatedBy:new xe.Coding,updatedAt:new Date})}static#t=this.\u0275fac=function(ne){return new(ne||X)};static#r=this.\u0275prov=h.\u0275\u0275defineInjectable({token:X,factory:X.\u0275fac,providedIn:"root"})}return X})()},6984:(Tt,Ne,Z)=>{Z.d(Ne,{D:()=>at});var h=Z(5863),C=Z(575),xe=Z(1189),pe=Z(7069),K=Z(6701);function oe(J,ae){if(1&J&&(h.\u0275\u0275elementContainerStart(0),h.\u0275\u0275elementContainer(1,5),h.\u0275\u0275elementContainerEnd()),2&J){const G=h.\u0275\u0275nextContext(2);h.\u0275\u0275advance(1),h.\u0275\u0275property("ngTemplateOutlet",G.footerTemplate)}}function X(J,ae){if(1&J){const G=h.\u0275\u0275getCurrentView();h.\u0275\u0275elementContainerStart(0),h.\u0275\u0275elementStart(1,"div",4),h.\u0275\u0275listener("click",function(){h.\u0275\u0275restoreView(G);const he=h.\u0275\u0275nextContext();return h.\u0275\u0275resetView(he.directToApp(he.myAppStore.url))}),h.\u0275\u0275elementContainer(2,5)(3,5),h.\u0275\u0275template(4,oe,2,1,"ng-container",0),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementContainerEnd()}if(2&J){const G=h.\u0275\u0275nextContext(),ge=h.\u0275\u0275reference(3),he=h.\u0275\u0275reference(5);h.\u0275\u0275advance(2),h.\u0275\u0275property("ngTemplateOutlet",ge),h.\u0275\u0275advance(1),h.\u0275\u0275property("ngTemplateOutlet",he),h.\u0275\u0275advance(1),h.\u0275\u0275property("ngIf",G.footerTemplate)}}function Ue(J,ae){if(1&J){const G=h.\u0275\u0275getCurrentView();h.\u0275\u0275elementContainerStart(0),h.\u0275\u0275elementStart(1,"div",6),h.\u0275\u0275listener("click",function(){h.\u0275\u0275restoreView(G);const he=h.\u0275\u0275nextContext();return h.\u0275\u0275resetView(he.directToApp(he.myAppStore.url))}),h.\u0275\u0275elementContainer(2,5),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementContainerEnd()}if(2&J){h.\u0275\u0275nextContext();const G=h.\u0275\u0275reference(7);h.\u0275\u0275advance(2),h.\u0275\u0275property("ngTemplateOutlet",G)}}function je(J,ae){if(1&J&&(h.\u0275\u0275elementStart(0,"div",7)(1,"div",8)(2,"span",9),h.\u0275\u0275text(3),h.\u0275\u0275elementEnd()()()),2&J){const G=h.\u0275\u0275nextContext();h.\u0275\u0275advance(3),h.\u0275\u0275textInterpolate1(" ",G.myAppStore.icon," ")}}function ne(J,ae){1&J&&(h.\u0275\u0275elementContainerStart(0),h.\u0275\u0275element(1,"span",15),h.\u0275\u0275elementContainerEnd())}function Ce(J,ae){1&J&&(h.\u0275\u0275elementContainerStart(0),h.\u0275\u0275element(1,"span",16),h.\u0275\u0275elementContainerEnd())}function le(J,ae){if(1&J){const G=h.\u0275\u0275getCurrentView();h.\u0275\u0275elementStart(0,"div",10)(1,"div",11)(2,"span",12),h.\u0275\u0275text(3),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(4,"button",13),h.\u0275\u0275listener("click",function(he){h.\u0275\u0275restoreView(G);const Pe=h.\u0275\u0275nextContext();return Pe.changeFavorite(Pe.myAppStore.appId),h.\u0275\u0275resetView(he.stopPropagation())}),h.\u0275\u0275template(5,ne,2,0,"ng-container",0),h.\u0275\u0275template(6,Ce,2,0,"ng-container",0),h.\u0275\u0275elementEnd()(),h.\u0275\u0275elementStart(7,"h5",14),h.\u0275\u0275text(8),h.\u0275\u0275elementEnd()()}if(2&J){const G=h.\u0275\u0275nextContext();h.\u0275\u0275advance(3),h.\u0275\u0275textInterpolate(G.myAppStore.versionNo),h.\u0275\u0275advance(2),h.\u0275\u0275property("ngIf",1==G.myAppStore.isFavorite),h.\u0275\u0275advance(1),h.\u0275\u0275property("ngIf",!0!==G.myAppStore.isFavorite),h.\u0275\u0275advance(2),h.\u0275\u0275textInterpolate(G.myAppStore.title)}}function pt(J,ae){1&J&&(h.\u0275\u0275elementContainerStart(0),h.\u0275\u0275element(1,"span",15),h.\u0275\u0275elementContainerEnd())}function Oe(J,ae){1&J&&(h.\u0275\u0275elementContainerStart(0),h.\u0275\u0275element(1,"span",16),h.\u0275\u0275elementContainerEnd())}function ot(J,ae){1&J&&(h.\u0275\u0275elementStart(0,"span"),h.\u0275\u0275text(1,"\u3001"),h.\u0275\u0275elementEnd())}function Ve(J,ae){if(1&J&&(h.\u0275\u0275elementContainerStart(0),h.\u0275\u0275text(1),h.\u0275\u0275template(2,ot,2,0,"span",0),h.\u0275\u0275elementContainerEnd()),2&J){const G=ae.$implicit,ge=ae.last;h.\u0275\u0275advance(1),h.\u0275\u0275textInterpolate1(" ",G.title,""),h.\u0275\u0275advance(1),h.\u0275\u0275property("ngIf",!ge)}}function Qe(J,ae){if(1&J){const G=h.\u0275\u0275getCurrentView();h.\u0275\u0275elementStart(0,"div",17)(1,"button",13),h.\u0275\u0275listener("click",function(he){h.\u0275\u0275restoreView(G);const Pe=h.\u0275\u0275nextContext();return Pe.changeFavorite(Pe.myAppStore.appId),h.\u0275\u0275resetView(he.stopPropagation())}),h.\u0275\u0275template(2,pt,2,0,"ng-container",0),h.\u0275\u0275template(3,Oe,2,0,"ng-container",0),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(4,"div",8)(5,"span",9),h.\u0275\u0275text(6),h.\u0275\u0275elementEnd()(),h.\u0275\u0275elementStart(7,"div",14),h.\u0275\u0275text(8),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(9,"div",18),h.\u0275\u0275template(10,Ve,3,2,"ng-container",19),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(11,"div",20),h.\u0275\u0275text(12),h.\u0275\u0275elementEnd(),h.\u0275\u0275elementStart(13,"div",20),h.\u0275\u0275text(14),h.\u0275\u0275elementEnd()()}if(2&J){const G=h.\u0275\u0275nextContext();h.\u0275\u0275advance(2),h.\u0275\u0275property("ngIf",1==G.myAppStore.isFavorite),h.\u0275\u0275advance(1),h.\u0275\u0275property("ngIf",!0!==G.myAppStore.isFavorite),h.\u0275\u0275advance(3),h.\u0275\u0275textInterpolate1(" ",G.myAppStore.icon," "),h.\u0275\u0275advance(2),h.\u0275\u0275textInterpolate(G.myAppStore.title),h.\u0275\u0275advance(2),h.\u0275\u0275property("ngForOf",G.myAppStore.appPages),h.\u0275\u0275advance(2),h.\u0275\u0275textInterpolate1("\u7dad\u8b77\u4eba\u54e1\uff1a",G.myAppStore.home.maintainer.display,""),h.\u0275\u0275advance(2),h.\u0275\u0275textInterpolate(G.myAppStore.versionNo)}}let at=(()=>{class J{constructor(){this.setChange=new h.EventEmitter,this.clickCard=new h.EventEmitter}directToApp(G){console.log("in component directToApp",G),this.clickCard.emit(G)}changeFavorite(G){this.setChange.emit(G)}static#e=this.\u0275fac=function(ge){return new(ge||J)};static#t=this.\u0275cmp=h.\u0275\u0275defineComponent({type:J,selectors:[["his-card-list"]],inputs:{myAppStore:"myAppStore",isListView:"isListView",headerTemplate:"headerTemplate",bodyTemplate:"bodyTemplate",footerTemplate:"footerTemplate"},outputs:{setChange:"setChange",clickCard:"clickCard"},standalone:!0,features:[h.\u0275\u0275StandaloneFeature],decls:8,vars:2,consts:[[4,"ngIf"],["gridViewHeader",""],["gridViewBody",""],["listViewHeader",""],[1,"p-card","p-commponent","app-grid-card",3,"click"],[3,"ngTemplateOutlet"],[1,"p-card","p-commponent","app-list-card",3,"click"],[1,"grid-header-container"],[1,"p-image","p-component"],[1,"material-symbols-outlined","icon-style"],[1,"grid-body-container"],[1,"btnBox"],[1,"subtitle","caption-s"],[3,"click"],[1,"title","label-l"],[1,"pi","pi-star-fill","selected"],[1,"pi","pi-star"],[1,"list-header-container"],[1,"content","caption-l"],[4,"ngFor","ngForOf"],[1,"subtitle","caption-m"]],template:function(ge,he){1&ge&&(h.\u0275\u0275template(0,X,5,3,"ng-container",0),h.\u0275\u0275template(1,Ue,3,1,"ng-container",0),h.\u0275\u0275template(2,je,4,1,"ng-template",null,1,h.\u0275\u0275templateRefExtractor),h.\u0275\u0275template(4,le,9,4,"ng-template",null,2,h.\u0275\u0275templateRefExtractor),h.\u0275\u0275template(6,Qe,15,7,"ng-template",null,3,h.\u0275\u0275templateRefExtractor)),2&ge&&(h.\u0275\u0275property("ngIf",!he.isListView),h.\u0275\u0275advance(1),h.\u0275\u0275property("ngIf",he.isListView))},dependencies:[C.CommonModule,C.NgForOf,C.NgIf,C.NgTemplateOutlet,pe.ImageModule,xe.ButtonModule,K.RouterModule],styles:[".app-grid-card[_ngcontent-%COMP%]{display:flex;padding:var(--spacing-md) var(--spacing-sm);gap:8px;border-radius:12px;height:100px;cursor:pointer}.app-list-card[_ngcontent-%COMP%]{display:flex;padding:4px 12px;flex-direction:row;gap:8px;border-radius:12px}.grid-header-container[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;align-items:flex-start}.list-header-container[_ngcontent-%COMP%]{height:100%;width:100%;display:flex;flex-direction:row;align-items:center;padding:var(--spacing-xs) var(--spacing-xxl);gap:var(--spacing-sm)}.list-header-container[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{color:var(--surface-on-surface)}.list-header-container[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{padding-left:5px;flex:1}.list-header-container[_ngcontent-%COMP%]   .pi[_ngcontent-%COMP%]{transition:all .3s}.list-header-container[_ngcontent-%COMP%]   .pi.selected[_ngcontent-%COMP%]{color:var(--yellow-500)}.grid-body-container[_ngcontent-%COMP%]{display:flex;flex:1;flex-direction:column}.grid-body-container[_ngcontent-%COMP%]   .btnBox[_ngcontent-%COMP%]{width:100%;display:flex;justify-content:flex-end;align-items:center;gap:var(--spacing-sm)}.grid-body-container[_ngcontent-%COMP%]   .btnBox[_ngcontent-%COMP%]   .pi[_ngcontent-%COMP%]{transition:all .3s}.grid-body-container[_ngcontent-%COMP%]   .btnBox[_ngcontent-%COMP%]   .pi.selected[_ngcontent-%COMP%]{color:var(--yellow-500)}button[_ngcontent-%COMP%]{cursor:pointer;background-color:transparent;border:none}.icon-style[_ngcontent-%COMP%]{width:100%;height:100%;display:flex;justify-content:center;align-items:center;color:var(--surface-a);font-size:48px}[_nghost-%COMP%]     .p-button{padding:0;color:var(--surface-on-surface)}[_nghost-%COMP%]     .body-container .p-button.p-button-icon-only{height:2rem}[_nghost-%COMP%]     .body-container .p-button.p-button-icon-only .pi{font-size:.7rem}[_nghost-%COMP%]     .p-image.p-component{display:block;width:72px;height:72px;background-color:var(--primary-main);border-radius:18px;overflow:hidden;padding:8px;position:relative;background:linear-gradient(0deg,rgba(0,0,0,.2) 0%,rgba(0,0,0,0) 100%),var(--primary-main);box-shadow:0 2px 1px -1px #00000005,0 1px 1px #00000024,0 1px 3px #0000001f}[_nghost-%COMP%]     .p-image.p-component img{display:block;width:100%;height:100%}[_nghost-%COMP%]     .app-grid-card .p-button{height:2rem}[_nghost-%COMP%]     .app-grid-card.p-card{transition:all .3s}[_nghost-%COMP%]     .app-grid-card.p-card:hover{transform:translateY(-3px);border-bottom:3px solid var(--primary-main)}[_nghost-%COMP%]     .app-list-card.p-card{transition:all .3s}"]})}return J})()},6296:(Tt,Ne,Z)=>{function h(xe){var pe,K,oe,X=2;for(typeof Symbol<"u"&&(K=Symbol.asyncIterator,oe=Symbol.iterator);X--;){if(K&&null!=(pe=xe[K]))return pe.call(xe);if(oe&&null!=(pe=xe[oe]))return new C(pe.call(xe));K="@@asyncIterator",oe="@@iterator"}throw new TypeError("Object is not async iterable")}function C(xe){function pe(K){if(Object(K)!==K)return Promise.reject(new TypeError(K+" is not an object."));var oe=K.done;return Promise.resolve(K.value).then(function(X){return{value:X,done:oe}})}return(C=function(oe){this.s=oe,this.n=oe.next}).prototype={s:null,n:null,next:function(){return pe(this.n.apply(this.s,arguments))},return:function(oe){var X=this.s.return;return void 0===X?Promise.resolve({value:oe,done:!0}):pe(X.apply(this.s,arguments))},throw:function(oe){var X=this.s.return;return void 0===X?Promise.reject(oe):pe(X.apply(this.s,arguments))}},new C(xe)}Z.d(Ne,{Z:()=>h})},7582:(Tt,Ne,Z)=>{function K(x,v,P,S){var q,R=arguments.length,N=R<3?v:null===S?S=Object.getOwnPropertyDescriptor(v,P):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)N=Reflect.decorate(x,v,P,S);else for(var Q=x.length-1;Q>=0;Q--)(q=x[Q])&&(N=(R<3?q(N):R>3?q(v,P,N):q(v,P))||N);return R>3&&N&&Object.defineProperty(v,P,N),N}function le(x,v,P,S){return new(P||(P=Promise))(function(N,q){function Q(B){try{D(S.next(B))}catch(ye){q(ye)}}function be(B){try{D(S.throw(B))}catch(ye){q(ye)}}function D(B){B.done?N(B.value):function R(N){return N instanceof P?N:new P(function(q){q(N)})}(B.value).then(Q,be)}D((S=S.apply(x,v||[])).next())})}function ae(x){return this instanceof ae?(this.v=x,this):new ae(x)}function G(x,v,P){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var R,S=P.apply(x,v||[]),N=[];return R={},q("next"),q("throw"),q("return"),R[Symbol.asyncIterator]=function(){return this},R;function q(me){S[me]&&(R[me]=function(Se){return new Promise(function(de,Ke){N.push([me,Se,de,Ke])>1||Q(me,Se)})})}function Q(me,Se){try{!function be(me){me.value instanceof ae?Promise.resolve(me.value.v).then(D,B):ye(N[0][2],me)}(S[me](Se))}catch(de){ye(N[0][3],de)}}function D(me){Q("next",me)}function B(me){Q("throw",me)}function ye(me,Se){me(Se),N.shift(),N.length&&Q(N[0][0],N[0][1])}}function he(x){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var P,v=x[Symbol.asyncIterator];return v?v.call(x):(x=function Ve(x){var v="function"==typeof Symbol&&Symbol.iterator,P=v&&x[v],S=0;if(P)return P.call(x);if(x&&"number"==typeof x.length)return{next:function(){return x&&S>=x.length&&(x=void 0),{value:x&&x[S++],done:!x}}};throw new TypeError(v?"Object is not iterable.":"Symbol.iterator is not defined.")}(x),P={},S("next"),S("throw"),S("return"),P[Symbol.asyncIterator]=function(){return this},P);function S(N){P[N]=x[N]&&function(q){return new Promise(function(Q,be){!function R(N,q,Q,be){Promise.resolve(be).then(function(D){N({value:D,done:Q})},q)}(Q,be,(q=x[N](q)).done,q.value)})}}}Z.d(Ne,{FC:()=>G,KL:()=>he,gn:()=>K,mG:()=>le,qq:()=>ae}),"function"==typeof SuppressedError&&SuppressedError}}]);